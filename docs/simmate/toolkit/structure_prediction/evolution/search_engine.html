<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.2"/>
    <title>simmate.toolkit.structure_prediction.evolution.search_engine API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../evolution.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;simmate.toolkit.structure_prediction.evolution</a>

<a href="https://github.com/jacksund/simmate">            <img src="https://github.com/jacksund/simmate/blob/main/src/simmate/website/static_files/images/simmate-logo.svg?raw=true" class="logo" alt="project logo"/>
</a>
            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#SearchEngine">SearchEngine</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SearchEngine.__init__">SearchEngine</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchEngine.run">run</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                        <a class="pdoc-button git-button" href="https://github.com/jacksund/simmate/tree/main/src/simmate/toolkit/structure_prediction/evolution/search_engine.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../../../../simmate.html">simmate</a><wbr>.<a href="./../../../toolkit.html">toolkit</a><wbr>.<a href="./../../structure_prediction.html">structure_prediction</a><wbr>.<a href="./../evolution.html">evolution</a><wbr>.search_engine    </h1>

                
                        <input id="search_engine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="search_engine-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span> <span class="nn">simmate.toolkit</span> <span class="kn">import</span> <span class="n">Composition</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">simmate.database</span> <span class="kn">import</span> <span class="n">connect</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">simmate.database.workflow_results</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>    <span class="n">EvolutionarySearch</span> <span class="k">as</span> <span class="n">SearchDatatable</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>    <span class="n">StructureSource</span> <span class="k">as</span> <span class="n">SourceDatatable</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="p">)</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">simmate.toolkit.creators</span> <span class="k">as</span> <span class="nn">creation_module</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span> <span class="nn">simmate.toolkit.transformations.from_ase</span> <span class="k">as</span> <span class="nn">transform_module</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">simmate.toolkit.validators.fingerprint.pcrystalnn</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>    <span class="n">PartialCrystalNNFingerprint</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="p">)</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span> <span class="nn">simmate.workflow_engine</span> <span class="kn">import</span> <span class="n">Workflow</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="k">class</span> <span class="nc">SearchEngine</span><span class="p">:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    **WARNING** This search engine assumes you have properly configured</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    Prefect Cloud and a cloud database backend (e.g. Postgres). In the future,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    we will accommodate local runs and other backends.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    This class is the entry point for predicting crystal structures with an</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    evolutionary search algorithm.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">    Once you initialize a SearchEngine with a composition (and any other</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    optional parameters), you simply need to call the run() method to start</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    the search:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    ``` python</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        from simmate.toolkit.structure_prediction import SearchEngine</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        search_engine = SearchEngine(</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">            composition=&quot;C4&quot;,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">            labels=[&quot;WarWulf&quot;],  # optional</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">            workflow_command=&quot;mpirun -n 8 vasp_std &gt; vasp.out&quot;,  # optional</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        )</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        search.run()</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    ```</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    This class is only for creating (or continuing) searches. If you only want</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    to view results, you should instead look directly at the database table for</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    previously ran searches:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    ``` python</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">       from simmate.shortcuts import SearchResults</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">       search_results = SearchResults.objects.get(composition=&quot;Sr4 Si4 N8&quot;)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    ```</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    If you start a separate terminal from where a search is running, you can</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">    actually use this table to view results WHILE the search is still running!</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    You can also access the search results from your search_engine object. So</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">    once your search is finished or stopped, you can do:</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    ``` python</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">       search_results = search_engine.search_datatable</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">    ```</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">    To better understand how to view/analyze results, please read the documentation</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">    for the SearchResults class.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">    #### Alternative Codes &amp; Softwares</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">    [USPEX](https://uspex-team.org/en),</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">    [XtalOpt](https://github.com/xtalopt/XtalOpt),</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">    [CALYPSO](http://www.calypso.cn/),</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">    [AIRSS](https://www.mtg.msm.cam.ac.uk/Codes/AIRSS),</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">    [ASE-GA](https://wiki.fysik.dtu.dk/ase/ase/ga/ga.html#module-ase.ga),</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    [GASP](https://github.com/henniggroup/GASP-python)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="n">composition</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Composition</span><span class="p">],</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="n">workflow</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Workflow</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relaxation.vasp.staged&quot;</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="n">workflow_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="n">max_structures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="n">limit_best_survival</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="n">singleshot_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="n">nfirst_generation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">nsteadystate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">steadystate_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>            <span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;RandomSymStructure&quot;</span><span class="p">),</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>            <span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;from_ase.Heredity&quot;</span><span class="p">),</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;from_ase.SoftMutation&quot;</span><span class="p">),</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;from_ase.MirrorMutation&quot;</span><span class="p">),</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.LatticeStrain&quot;</span><span class="p">),</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.RotationalMutation&quot;</span><span class="p">),</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span><span class="p">),</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.CoordinatePerturbation&quot;</span><span class="p">),</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="p">],</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TruncatedSelection&quot;</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="c1"># TODO: maybe use **workflow_run_kwargs...?</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        Sets up the search engine and its settings.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        - `composition`:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">            The composition to run the evolutionary search for. Note that the</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            number of sites is fixed to what is set here. (Ca2N vs Ca4N2)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        - `workflow`:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">            The workflow to run all individuals through. Note, the result_database</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">            of this workflow will be treated as the individuals in this search.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">            The default is &quot;relaxation.vasp.staged&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        - `workflow_command`:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">            The command that will be passed to the workflow.run() method.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        - `max_structures`:</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">            The maximum number of individuals that will be calculated before</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">            stopping the search. The default is 3000.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        - `limit_best_survival`:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">            The search is stopped when the best individual remains unbeaten for</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">            this number of new individuals. The default is 250.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        - `singleshot_sources`:</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">            TODO: This is not implemented yet</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        - `nfirst_generation`:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">            No mutations or &quot;child&quot; individuals will be carried out until this</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">            number of individuals have been calculated. The default is 20.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        - `nsteadystate`:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">            The total number of individuals from steady-state sources that will</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">            be running/submitted at any given time. The default is 40.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">        - `steadystate_sources`:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">            A list of tuples where each tuple is (percent, source). The percent</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            determines the number of steady stage calculations that will be</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">            running for this at any given time. For example, 0.25 means</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            0.25*40=10 individuals will be running/submitted at all times. The</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">            source can be from either the toolkit.creator or toolkit.transformations</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">            modules. Don&#39;t change this default unless you know what you&#39;re doing!</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">        - `selector`:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            The defualt method to use for choosing the parent individual(s). The</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">            default is TruncatedSelection.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="c1"># make sure we were givent a Composition object, and if not, we have</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="c1"># a string that should be converted to one.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">Composition</span><span class="p">):</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">composition</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span> <span class="o">=</span> <span class="n">workflow_command</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="c1"># TODO: consider grabbing these from the database so that we can update</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="c1"># them at any point.</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span> <span class="o">=</span> <span class="n">limit_best_survival</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span> <span class="o">=</span> <span class="n">max_structures</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsteadystate</span> <span class="o">=</span> <span class="n">nsteadystate</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nfirst_generation</span> <span class="o">=</span> <span class="n">nfirst_generation</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="c1"># Initialize the selector</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">if</span> <span class="n">selector</span> <span class="o">==</span> <span class="s2">&quot;TruncatedSelection&quot;</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="kn">from</span> <span class="nn">simmate.toolkit.structure_prediction.evolution.selectors</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                <span class="n">TruncatedSelection</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">TruncatedSelection</span><span class="p">()</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># BUG</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We only support TruncatedSelection right now&quot;</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="s2">&quot;The default parent selection for mutations will use &quot;</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="c1"># Initialize the workflow if a string was given.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="c1"># Otherwise we should already have a workflow class.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="k">if</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s2">&quot;relaxation.vasp.staged&quot;</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="kn">from</span> <span class="nn">simmate.workflows.relaxation</span> <span class="kn">import</span> <span class="n">Relaxation__Vasp__Staged</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">Relaxation__Vasp__Staged</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="c1"># Point to the structure datatable that we&#39;ll pull from</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="c1"># BUG: For now, I assume its the results table of the workflow</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">individuals_datatable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">database_table</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                <span class="s2">&quot;quality04relaxation&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">related_model</span>  <span class="c1"># gives quality04relaxation table</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">calculation_datatable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">database_table</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>            <span class="c1"># BUG: these need to be merged and moved outside this if statement</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                <span class="s2">&quot;Only `relaxation.vasp.staged` is supported in early testing&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>            <span class="sa">f</span><span class="s2">&quot;All individuals will be evaulated through the &quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">name_full</span><span class="si">}</span><span class="s2"> workflow.&quot;</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="p">)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="c1"># BUG: I&#39;ll need to rewrite this in the future bc I don&#39;t really account</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="c1"># for other workflows yet. It would make sense that our workflow changes</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="c1"># as the search progresses (e.g. we incorporate DeePMD relaxation once ready)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="c1"># Check if there is an existing search and grab it if so. Otherwise, add</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="c1"># the search entry to the DB.</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="n">SearchDatatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span> <span class="o">=</span> <span class="n">SearchDatatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="c1"># TODO: update, add logs, compare... I need to decide what to do here.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="c1"># also, run _check_stop_condition() to avoid unneccessary restart.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span> <span class="o">=</span> <span class="n">SearchDatatable</span><span class="p">(</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                <span class="n">workflows</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">name_full</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="p">],</span>  <span class="c1"># as a list bc we can add new ones later</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                <span class="n">individuals_datatable_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">individuals_datatable</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="n">max_structures</span><span class="o">=</span><span class="n">max_structures</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="n">limit_best_survival</span><span class="o">=</span><span class="n">limit_best_survival</span><span class="p">,</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="s2">&quot;To track the progress while this search runs, you can use the following&quot;</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="s2">&quot; in a separate python terminal:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">from simmate.shortcuts import SearchResults</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">search = SearchResults.objects.get(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="sa">f</span><span class="s2">&quot;So your search ID is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="s2">&quot;View the documentation on the EvolutionarySearch datatable for more info.&quot;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="p">)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="c1"># Grab the list of singleshot sources that have been ran before</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="c1"># and based off of that list, remove repeated sources</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="n">past_singleshot_sources</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_singleshot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="n">singleshot_sources</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="n">source</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">singleshot_sources</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">past_singleshot_sources</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="p">]</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="c1"># BUG: what if I want to rerun any of these even though its been ran before?</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="c1"># An example would be rerunning substituitions when new structures are available</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="c1"># Initialize the single-shot sources</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">singleshot_sources</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="c1"># if we are given a string, we want initialize the class</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="c1"># otherwise it should be a class alreadys</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_common_class</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="c1"># and add it to our final list</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="c1"># Initialize the steady-state sources, which are given as a list of</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="c1"># (proportion, class/class_str, kwargs) for each. As we go through these,</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="c1"># we also collect the proportion list for them.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">steadystate_sources</span><span class="p">:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>            <span class="c1"># There are certain transformation sources that don&#39;t work for single-element</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="c1"># structures, so we check for this here and remove them.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="p">]:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> is not possible with single-element structures.&quot;</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                    <span class="s2">&quot; This is being removed from your steadystate_sources.&quot;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                <span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                <span class="k">continue</span>  <span class="c1"># skips to next source</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="c1"># store proportion value</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proportion</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="c1"># if we are given a string, we want initialize the class</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="c1"># otherwise it should be a class already</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_common_class</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            <span class="c1"># and add it to our final list</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="c1"># Make sure the proportions sum to 1, otherwise scale them. We then convert</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="c1"># these to steady-state integers (and round to the nearest integer)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">sum_proportions</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="k">if</span> <span class="n">sum_proportions</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="s2">&quot;Warning: fractions for steady-state sources do not add to 1.&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="s2">&quot;We have scaled all sources to equal one to fix this.&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="n">p</span> <span class="o">/</span> <span class="n">sum_proportions</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="p">]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="c1"># While these are percent values, we want specific counts. We convert to</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="c1"># those here.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_counts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">nsteadystate</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="p">]</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="c1"># Throughout our search, we want to keep track of which workflows we&#39;ve</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="c1"># submitted to prefect for each structure source as well as how long</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="c1"># we were holding a steady-state of submissions. We therefore keep</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="c1"># a log of Sources in our database -- where even if we&#39;ve ran this search</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="c1"># before, we still want new entries for each.</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources_db</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">source_db</span> <span class="o">=</span> <span class="n">SourceDatatable</span><span class="p">(</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">is_steadystate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="n">is_singleshot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="n">search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="p">,</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_db</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="n">source_db</span> <span class="o">=</span> <span class="n">SourceDatatable</span><span class="p">(</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                <span class="n">is_steadystate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="n">is_singleshot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="n">search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_db</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="c1"># Initialize the fingerprint database</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="c1"># For this we need to grab all previously calculated structures of this</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="c1"># compositon too pass in too.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating fingerprints for past structures...&quot;</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span> <span class="o">=</span> <span class="n">PartialCrystalNNFingerprint</span><span class="p">(</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">structure_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals</span><span class="p">,</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="c1"># BUG: should we only do structures that were successfully calculated?</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="c1"># If not, there&#39;s a chance a structure fails because of something like a</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="c1"># crashed slurm job, but it&#39;s never submitted again...</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="c1"># OPTIMIZE: should we only do final structures? Or should I include input</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="c1"># structures and even all ionic steps as well...?</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="c1"># See if the singleshot sources have been ran yet. For restarted calculations</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="c1"># this will likely not be needed (unless a new source was added)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_singleshot_sources</span><span class="p">()</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="c1"># this loop will go until I hit &#39;break&#39; below</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="c1"># TODO: maybe write summary files to csv...? This may be a mute</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="c1"># point because I expect we can follow along in the web UI in the future</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="c1"># To that end, I can add a &quot;URL&quot; property</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="c1"># Check the stop condition</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="c1"># If it is True, we can stop the calc.</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_condition</span><span class="p">():</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                <span class="k">break</span>  <span class="c1"># break out of the while loop</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="c1"># Otherwise, keep going!</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="c1"># update the fingerprint database with all of the completed structures</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span><span class="o">.</span><span class="n">update_fingerprint_database</span><span class="p">()</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="c1"># Go through the running workflows and see if we need to submit</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="c1"># new ones to meet our steadystate target(s)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_steadystate_workflows</span><span class="p">()</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="c1"># TODO: Go through the triggered actions</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="c1"># self._check_triggered_actions()</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="c1"># To save our database load, sleep until we run checks again.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="c1"># OPTIMIZE: ask Prefect if their is an equivalent to Dask&#39;s gather/wait</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="c1"># functions, so we know exactly when a workflow completes</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="c1"># https://docs.dask.org/en/stable/futures.html#waiting-on-futures</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sleeping for </span><span class="si">{</span><span class="n">sleep_step</span><span class="si">}</span><span class="s2"> seconds before running checks again.&quot;</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_step</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping the search (remaining calcs will be left to finish).&quot;</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="k">def</span> <span class="nf">_check_stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="c1"># first see if we&#39;ve hit our maximum limit for structures.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="c1"># Note: because we are only looking at the results table, this is really</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="c1"># only counting the number of successfully calculated individuals.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="c1"># Nothing is done to stop those that are still running or to count</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="c1"># structures that failed to be calculated</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="c1"># {f&quot;{self.fitness_field}__isnull&quot;=False} # when I allow other fitness fxns</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                <span class="sa">f</span><span class="s2">&quot;Maximum number of completed calculations hit (n=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="c1"># The 2nd stop condition is based on how long we&#39;ve have the same</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="c1"># &quot;best&quot; individual. If the number of new individuals calculated (without</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="c1"># any becoming the new &quot;best&quot;) is greater than limit_best_survival, then</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="c1"># we can stop the search.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="c1"># grab the best individual for reference</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="n">best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">best_individual</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="c1"># We need this if-statement in case no structures have completed yet.</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">best</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="c1"># count the number of new individuals added AFTER the best one. If it is</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="c1"># more than limit_best_survival, we stop the search.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="n">num_new_structures_since_best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="c1"># check energies to ensure we only count completed calculations</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="n">energy_per_atom__gt</span><span class="o">=</span><span class="n">best</span><span class="o">.</span><span class="n">energy_per_atom</span><span class="p">,</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="n">created_at__gte</span><span class="o">=</span><span class="n">best</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="k">if</span> <span class="n">num_new_structures_since_best</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                <span class="sa">f</span><span class="s2">&quot;Best individual has not changed after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="s2">&quot; new individuals added.&quot;</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="c1"># If we reached this point, then we haven&#39;t hit a stop condition yet!</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>    <span class="k">def</span> <span class="nf">_check_singleshot_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Singleshot sources not implemented yet. Skipping this step.&quot;</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="k">def</span> <span class="nf">_check_steadystate_workflows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="c1"># we iterate through each steady-state source and check to see how many</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="c1"># jobs are still running for it. If it&#39;s less than the target steady-state,</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="c1"># then we need to submit more!</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">source_db</span><span class="p">,</span> <span class="n">njobs_target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="p">,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span><span class="p">,</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_counts</span><span class="p">,</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="c1"># This loop says for the number of steady state runs we are short,</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="c1"># create that many new individuals! max(x,0) ensure we don&#39;t get a</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="c1"># negative value. A value of 0 means we are at steady-state and can</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="c1"># just skip this loop.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">njobs_target</span> <span class="o">-</span> <span class="n">source_db</span><span class="o">.</span><span class="n">nprefect_flow_runs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)):</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                <span class="c1"># now we need to make a new individual and submit it!</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                <span class="n">parent_ids</span><span class="p">,</span> <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_new_structure</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                <span class="c1"># sometimes we fail to make a structure with the source. In cases</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                <span class="c1"># like this, we warn the user, but just move on. This means</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                <span class="c1"># we will be short of our steady-state target. The warning for</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                <span class="c1"># this is done inside _make_new_structure</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                    <span class="k">break</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                <span class="c1"># submit the structure workflow</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                <span class="c1"># Note, we only pass the workflow_command if it&#39;s been supplied.</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                    <span class="p">{</span><span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                <span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                <span class="n">flow_run_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">run_cloud</span><span class="p">(</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                    <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                    <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                <span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Submitted workflow run to prefect cloud.&quot;</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="c1"># Attached the flow_run_id to our source so we know how many</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="c1"># associated jobs are running.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="n">source_db</span><span class="o">.</span><span class="n">prefect_flow_run_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="c1"># update the source on the calculation</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                <span class="c1"># TODO: use the flow run id from above to grab the calc</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="n">calculation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_datatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                    <span class="n">prefect_flow_run_id</span><span class="o">=</span><span class="n">flow_run_id</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                <span class="n">calculation</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                <span class="n">calculation</span><span class="o">.</span><span class="n">source_id</span> <span class="o">=</span> <span class="n">parent_ids</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                <span class="n">calculation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>    <span class="k">def</span> <span class="nf">_make_new_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="c1"># check if we have a transformation or a creator</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="c1"># OPTIMIZE: is there a faster way? check subclass maybe?</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="k">if</span> <span class="s2">&quot;transformation&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="n">is_transformation</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="k">elif</span> <span class="s2">&quot;creator&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="n">is_transformation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                <span class="s2">&quot;Make sure your steady-state sources are either creators or transformations!&quot;</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not meet this requirement.&quot;</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="c1"># transformations require that we have completed structures in the</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="c1"># database. We want to wait until there&#39;s a set amount before</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="c1"># we start mutating the best. We check that here.</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="n">is_transformation</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfirst_generation</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="p">):</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                <span class="s2">&quot;Search isn&#39;t ready for transformations yet.&quot;</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                <span class="sa">f</span><span class="s2">&quot; Skipping </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>            <span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="c1"># Until we get a new valid structure (or run out of attempts), keep trying</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="c1"># with our given source. Assume we don&#39;t have a valid structure until</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="c1"># proven otherwise</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to create a structure with </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="n">new_structure</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">new_structure</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="o">&lt;=</span> <span class="n">max_attempts</span><span class="p">:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="c1"># add an attempt</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>            <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="k">if</span> <span class="n">is_transformation</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                <span class="c1"># grab parent structures using the selection method</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                <span class="n">parent_ids</span><span class="p">,</span> <span class="n">parent_structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_parents</span><span class="p">(</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                    <span class="n">nselect</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">ninput</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>                <span class="p">)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                <span class="c1"># make a new structure</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>                <span class="n">new_structure</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">apply_transformation</span><span class="p">(</span><span class="n">parent_structures</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_transformation</span><span class="p">:</span>  <span class="c1"># if it&#39;s a creator</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>                <span class="n">parent_ids</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                <span class="c1"># make a new structure</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                <span class="n">new_structure</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">create_structure</span><span class="p">()</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="c1"># check to see if the structure is new and unique so that we don&#39;t</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>            <span class="c1"># have any repeat calculations.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>            <span class="k">if</span> <span class="n">new_structure</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                <span class="c1"># this will return false if the structure is NOT unique</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span><span class="o">.</span><span class="n">check_structure</span><span class="p">(</span><span class="n">new_structure</span><span class="p">):</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                    <span class="c1"># if it is not unique, we can throw away the structure and</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>                    <span class="c1"># try the loop again.</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated structure is not unique. Trying again.&quot;</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>                    <span class="n">new_structure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>        <span class="c1"># see if we got a structure or if we hit the max attempts and there&#39;s</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="c1"># a serious problem!</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_structure</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="s2">&quot;Failed to create a structure! Consider changing your settings or&quot;</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                <span class="s2">&quot; contact our team for help.&quot;</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="c1"># Otherwise we were successful</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creation Successful.&quot;</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="c1"># return the structure and its parents</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="k">return</span> <span class="n">parent_ids</span><span class="p">,</span> <span class="n">new_structure</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>    <span class="k">def</span> <span class="nf">_select_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nselect</span><span class="p">):</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="c1"># our selectors just require a dataframe where we specify the fitness</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="c1"># column. So we query our individuals database to give this as an input.</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="n">individuals_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>            <span class="s2">&quot;energy_per_atom&quot;</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="p">)[:</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="c1"># NOTE: I assume we&#39;ll never need more than the best 200 structures, which</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="c1"># may not be true in special cases.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="c1"># From these individuals, select our parent structures</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="n">parents_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>            <span class="n">nselect</span><span class="p">,</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="n">individuals_df</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="s2">&quot;energy_per_atom&quot;</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="c1"># grab the id column of the parents and convert it to a list</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">parents_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="c1"># Now lets grab these structures from our database and convert them</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="c1"># to a list of pymatgen structures.</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>        <span class="c1"># We have to make separate queries for this instead of doing &quot;id__in=parent_ids&quot;.</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="c1"># This is because (1) order may be important and (2) we may have duplicate</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="c1"># entries. For example, a hereditary mutation can request parent ids of [123,123]</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>        <span class="c1"># in which case we want to give the same input structure twice!</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>        <span class="n">parent_structures</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s2">&quot;structure_string&quot;</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>            <span class="o">.</span><span class="n">to_toolkit</span><span class="p">()</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>            <span class="k">for</span> <span class="n">parent_id</span> <span class="ow">in</span> <span class="n">parent_ids</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        <span class="p">]</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="c1"># When there&#39;s only one structure selected we return the structure and</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="c1"># id independently -- not within a list</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="k">if</span> <span class="n">nselect</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">parent_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>            <span class="n">parent_structures</span> <span class="o">=</span> <span class="n">parent_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="c1"># for record keeping, we also want to return the ids for each structure</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="k">return</span> <span class="n">parent_ids</span><span class="p">,</span> <span class="n">parent_structures</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>    <span class="k">def</span> <span class="nf">_init_common_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_str</span><span class="p">):</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="c1"># CREATORS</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="k">if</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="s2">&quot;RandomSymStructure&quot;</span><span class="p">,</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>            <span class="s2">&quot;PyXtalStructure&quot;</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="p">]:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>            <span class="n">creator_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">creation_module</span><span class="p">,</span> <span class="n">class_str</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="k">return</span> <span class="n">creator_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="c1"># TRANSFORMATIONS</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>            <span class="s2">&quot;from_ase.Heredity&quot;</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="s2">&quot;from_ase.SoftMutation&quot;</span><span class="p">,</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="s2">&quot;from_ase.MirrorMutation&quot;</span><span class="p">,</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="s2">&quot;from_ase.LatticeStrain&quot;</span><span class="p">,</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="s2">&quot;from_ase.RotationalMutation&quot;</span><span class="p">,</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span><span class="p">,</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="s2">&quot;from_ase.CoordinatePerturbation&quot;</span><span class="p">,</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="p">]:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>            <span class="c1"># all start with &quot;from_ase&quot; so I assume that import for now</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="n">ase_class_str</span> <span class="o">=</span> <span class="n">class_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>            <span class="n">mutation_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transform_module</span><span class="p">,</span> <span class="n">ase_class_str</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="k">return</span> <span class="n">mutation_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="c1"># !!! There aren&#39;t any common transformations that don&#39;t accept composition</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="c1"># as an input, but I expect this to change in the future.</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="p">[]:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="n">mutation_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transform_module</span><span class="p">,</span> <span class="n">class_str</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="k">return</span> <span class="n">mutation_class</span><span class="p">()</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="c1"># These are commonly used single-shot sources</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;prototypes_aflow&quot;</span><span class="p">:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;substitution&quot;</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;third_party_structures&quot;</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;third_party_substitution&quot;</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_str</span><span class="si">}</span><span class="s2"> is not recognized as a common input. Make sure you&quot;</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                <span class="s2">&quot;don&#39;t have any typos, and if you are using a custom class, provide&quot;</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                <span class="s2">&quot;your input as an object.&quot;</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="p">)</span>
</span></pre></div>


            </section>
                <section id="SearchEngine">
                            <input id="SearchEngine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SearchEngine</span>:

                <label class="view-source-button" for="SearchEngine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchEngine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchEngine-24"><a href="#SearchEngine-24"><span class="linenos"> 24</span></a><span class="k">class</span> <span class="nc">SearchEngine</span><span class="p">:</span>
</span><span id="SearchEngine-25"><a href="#SearchEngine-25"><span class="linenos"> 25</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SearchEngine-26"><a href="#SearchEngine-26"><span class="linenos"> 26</span></a><span class="sd">    **WARNING** This search engine assumes you have properly configured</span>
</span><span id="SearchEngine-27"><a href="#SearchEngine-27"><span class="linenos"> 27</span></a><span class="sd">    Prefect Cloud and a cloud database backend (e.g. Postgres). In the future,</span>
</span><span id="SearchEngine-28"><a href="#SearchEngine-28"><span class="linenos"> 28</span></a><span class="sd">    we will accommodate local runs and other backends.</span>
</span><span id="SearchEngine-29"><a href="#SearchEngine-29"><span class="linenos"> 29</span></a>
</span><span id="SearchEngine-30"><a href="#SearchEngine-30"><span class="linenos"> 30</span></a><span class="sd">    This class is the entry point for predicting crystal structures with an</span>
</span><span id="SearchEngine-31"><a href="#SearchEngine-31"><span class="linenos"> 31</span></a><span class="sd">    evolutionary search algorithm.</span>
</span><span id="SearchEngine-32"><a href="#SearchEngine-32"><span class="linenos"> 32</span></a>
</span><span id="SearchEngine-33"><a href="#SearchEngine-33"><span class="linenos"> 33</span></a><span class="sd">    Once you initialize a SearchEngine with a composition (and any other</span>
</span><span id="SearchEngine-34"><a href="#SearchEngine-34"><span class="linenos"> 34</span></a><span class="sd">    optional parameters), you simply need to call the run() method to start</span>
</span><span id="SearchEngine-35"><a href="#SearchEngine-35"><span class="linenos"> 35</span></a><span class="sd">    the search:</span>
</span><span id="SearchEngine-36"><a href="#SearchEngine-36"><span class="linenos"> 36</span></a>
</span><span id="SearchEngine-37"><a href="#SearchEngine-37"><span class="linenos"> 37</span></a><span class="sd">    ``` python</span>
</span><span id="SearchEngine-38"><a href="#SearchEngine-38"><span class="linenos"> 38</span></a>
</span><span id="SearchEngine-39"><a href="#SearchEngine-39"><span class="linenos"> 39</span></a><span class="sd">        from simmate.toolkit.structure_prediction import SearchEngine</span>
</span><span id="SearchEngine-40"><a href="#SearchEngine-40"><span class="linenos"> 40</span></a>
</span><span id="SearchEngine-41"><a href="#SearchEngine-41"><span class="linenos"> 41</span></a><span class="sd">        search_engine = SearchEngine(</span>
</span><span id="SearchEngine-42"><a href="#SearchEngine-42"><span class="linenos"> 42</span></a><span class="sd">            composition=&quot;C4&quot;,</span>
</span><span id="SearchEngine-43"><a href="#SearchEngine-43"><span class="linenos"> 43</span></a><span class="sd">            labels=[&quot;WarWulf&quot;],  # optional</span>
</span><span id="SearchEngine-44"><a href="#SearchEngine-44"><span class="linenos"> 44</span></a><span class="sd">            workflow_command=&quot;mpirun -n 8 vasp_std &gt; vasp.out&quot;,  # optional</span>
</span><span id="SearchEngine-45"><a href="#SearchEngine-45"><span class="linenos"> 45</span></a><span class="sd">        )</span>
</span><span id="SearchEngine-46"><a href="#SearchEngine-46"><span class="linenos"> 46</span></a>
</span><span id="SearchEngine-47"><a href="#SearchEngine-47"><span class="linenos"> 47</span></a><span class="sd">        search.run()</span>
</span><span id="SearchEngine-48"><a href="#SearchEngine-48"><span class="linenos"> 48</span></a><span class="sd">    ```</span>
</span><span id="SearchEngine-49"><a href="#SearchEngine-49"><span class="linenos"> 49</span></a>
</span><span id="SearchEngine-50"><a href="#SearchEngine-50"><span class="linenos"> 50</span></a><span class="sd">    This class is only for creating (or continuing) searches. If you only want</span>
</span><span id="SearchEngine-51"><a href="#SearchEngine-51"><span class="linenos"> 51</span></a><span class="sd">    to view results, you should instead look directly at the database table for</span>
</span><span id="SearchEngine-52"><a href="#SearchEngine-52"><span class="linenos"> 52</span></a><span class="sd">    previously ran searches:</span>
</span><span id="SearchEngine-53"><a href="#SearchEngine-53"><span class="linenos"> 53</span></a>
</span><span id="SearchEngine-54"><a href="#SearchEngine-54"><span class="linenos"> 54</span></a><span class="sd">    ``` python</span>
</span><span id="SearchEngine-55"><a href="#SearchEngine-55"><span class="linenos"> 55</span></a>
</span><span id="SearchEngine-56"><a href="#SearchEngine-56"><span class="linenos"> 56</span></a><span class="sd">       from simmate.shortcuts import SearchResults</span>
</span><span id="SearchEngine-57"><a href="#SearchEngine-57"><span class="linenos"> 57</span></a>
</span><span id="SearchEngine-58"><a href="#SearchEngine-58"><span class="linenos"> 58</span></a><span class="sd">       search_results = SearchResults.objects.get(composition=&quot;Sr4 Si4 N8&quot;)</span>
</span><span id="SearchEngine-59"><a href="#SearchEngine-59"><span class="linenos"> 59</span></a>
</span><span id="SearchEngine-60"><a href="#SearchEngine-60"><span class="linenos"> 60</span></a><span class="sd">    ```</span>
</span><span id="SearchEngine-61"><a href="#SearchEngine-61"><span class="linenos"> 61</span></a>
</span><span id="SearchEngine-62"><a href="#SearchEngine-62"><span class="linenos"> 62</span></a><span class="sd">    If you start a separate terminal from where a search is running, you can</span>
</span><span id="SearchEngine-63"><a href="#SearchEngine-63"><span class="linenos"> 63</span></a><span class="sd">    actually use this table to view results WHILE the search is still running!</span>
</span><span id="SearchEngine-64"><a href="#SearchEngine-64"><span class="linenos"> 64</span></a>
</span><span id="SearchEngine-65"><a href="#SearchEngine-65"><span class="linenos"> 65</span></a><span class="sd">    You can also access the search results from your search_engine object. So</span>
</span><span id="SearchEngine-66"><a href="#SearchEngine-66"><span class="linenos"> 66</span></a><span class="sd">    once your search is finished or stopped, you can do:</span>
</span><span id="SearchEngine-67"><a href="#SearchEngine-67"><span class="linenos"> 67</span></a>
</span><span id="SearchEngine-68"><a href="#SearchEngine-68"><span class="linenos"> 68</span></a><span class="sd">    ``` python</span>
</span><span id="SearchEngine-69"><a href="#SearchEngine-69"><span class="linenos"> 69</span></a><span class="sd">       search_results = search_engine.search_datatable</span>
</span><span id="SearchEngine-70"><a href="#SearchEngine-70"><span class="linenos"> 70</span></a><span class="sd">    ```</span>
</span><span id="SearchEngine-71"><a href="#SearchEngine-71"><span class="linenos"> 71</span></a>
</span><span id="SearchEngine-72"><a href="#SearchEngine-72"><span class="linenos"> 72</span></a><span class="sd">    To better understand how to view/analyze results, please read the documentation</span>
</span><span id="SearchEngine-73"><a href="#SearchEngine-73"><span class="linenos"> 73</span></a><span class="sd">    for the SearchResults class.</span>
</span><span id="SearchEngine-74"><a href="#SearchEngine-74"><span class="linenos"> 74</span></a>
</span><span id="SearchEngine-75"><a href="#SearchEngine-75"><span class="linenos"> 75</span></a><span class="sd">    #### Alternative Codes &amp; Softwares</span>
</span><span id="SearchEngine-76"><a href="#SearchEngine-76"><span class="linenos"> 76</span></a>
</span><span id="SearchEngine-77"><a href="#SearchEngine-77"><span class="linenos"> 77</span></a><span class="sd">    [USPEX](https://uspex-team.org/en),</span>
</span><span id="SearchEngine-78"><a href="#SearchEngine-78"><span class="linenos"> 78</span></a><span class="sd">    [XtalOpt](https://github.com/xtalopt/XtalOpt),</span>
</span><span id="SearchEngine-79"><a href="#SearchEngine-79"><span class="linenos"> 79</span></a><span class="sd">    [CALYPSO](http://www.calypso.cn/),</span>
</span><span id="SearchEngine-80"><a href="#SearchEngine-80"><span class="linenos"> 80</span></a><span class="sd">    [AIRSS](https://www.mtg.msm.cam.ac.uk/Codes/AIRSS),</span>
</span><span id="SearchEngine-81"><a href="#SearchEngine-81"><span class="linenos"> 81</span></a><span class="sd">    [ASE-GA](https://wiki.fysik.dtu.dk/ase/ase/ga/ga.html#module-ase.ga),</span>
</span><span id="SearchEngine-82"><a href="#SearchEngine-82"><span class="linenos"> 82</span></a><span class="sd">    [GASP](https://github.com/henniggroup/GASP-python)</span>
</span><span id="SearchEngine-83"><a href="#SearchEngine-83"><span class="linenos"> 83</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SearchEngine-84"><a href="#SearchEngine-84"><span class="linenos"> 84</span></a>
</span><span id="SearchEngine-85"><a href="#SearchEngine-85"><span class="linenos"> 85</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SearchEngine-86"><a href="#SearchEngine-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchEngine-87"><a href="#SearchEngine-87"><span class="linenos"> 87</span></a>        <span class="n">composition</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Composition</span><span class="p">],</span>
</span><span id="SearchEngine-88"><a href="#SearchEngine-88"><span class="linenos"> 88</span></a>        <span class="n">workflow</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Workflow</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relaxation.vasp.staged&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-89"><a href="#SearchEngine-89"><span class="linenos"> 89</span></a>        <span class="n">workflow_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SearchEngine-90"><a href="#SearchEngine-90"><span class="linenos"> 90</span></a>        <span class="n">max_structures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
</span><span id="SearchEngine-91"><a href="#SearchEngine-91"><span class="linenos"> 91</span></a>        <span class="n">limit_best_survival</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
</span><span id="SearchEngine-92"><a href="#SearchEngine-92"><span class="linenos"> 92</span></a>        <span class="n">singleshot_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="SearchEngine-93"><a href="#SearchEngine-93"><span class="linenos"> 93</span></a>        <span class="n">nfirst_generation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="SearchEngine-94"><a href="#SearchEngine-94"><span class="linenos"> 94</span></a>        <span class="n">nsteadystate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="SearchEngine-95"><a href="#SearchEngine-95"><span class="linenos"> 95</span></a>        <span class="n">steadystate_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine-96"><a href="#SearchEngine-96"><span class="linenos"> 96</span></a>            <span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;RandomSymStructure&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-97"><a href="#SearchEngine-97"><span class="linenos"> 97</span></a>            <span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;from_ase.Heredity&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-98"><a href="#SearchEngine-98"><span class="linenos"> 98</span></a>            <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;from_ase.SoftMutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-99"><a href="#SearchEngine-99"><span class="linenos"> 99</span></a>            <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;from_ase.MirrorMutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-100"><a href="#SearchEngine-100"><span class="linenos">100</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.LatticeStrain&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-101"><a href="#SearchEngine-101"><span class="linenos">101</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.RotationalMutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-102"><a href="#SearchEngine-102"><span class="linenos">102</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-103"><a href="#SearchEngine-103"><span class="linenos">103</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.CoordinatePerturbation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine-104"><a href="#SearchEngine-104"><span class="linenos">104</span></a>        <span class="p">],</span>
</span><span id="SearchEngine-105"><a href="#SearchEngine-105"><span class="linenos">105</span></a>        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TruncatedSelection&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-106"><a href="#SearchEngine-106"><span class="linenos">106</span></a>        <span class="c1"># TODO: maybe use **workflow_run_kwargs...?</span>
</span><span id="SearchEngine-107"><a href="#SearchEngine-107"><span class="linenos">107</span></a>    <span class="p">):</span>
</span><span id="SearchEngine-108"><a href="#SearchEngine-108"><span class="linenos">108</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SearchEngine-109"><a href="#SearchEngine-109"><span class="linenos">109</span></a><span class="sd">        Sets up the search engine and its settings.</span>
</span><span id="SearchEngine-110"><a href="#SearchEngine-110"><span class="linenos">110</span></a>
</span><span id="SearchEngine-111"><a href="#SearchEngine-111"><span class="linenos">111</span></a><span class="sd">        #### Parameters</span>
</span><span id="SearchEngine-112"><a href="#SearchEngine-112"><span class="linenos">112</span></a>
</span><span id="SearchEngine-113"><a href="#SearchEngine-113"><span class="linenos">113</span></a><span class="sd">        - `composition`:</span>
</span><span id="SearchEngine-114"><a href="#SearchEngine-114"><span class="linenos">114</span></a><span class="sd">            The composition to run the evolutionary search for. Note that the</span>
</span><span id="SearchEngine-115"><a href="#SearchEngine-115"><span class="linenos">115</span></a><span class="sd">            number of sites is fixed to what is set here. (Ca2N vs Ca4N2)</span>
</span><span id="SearchEngine-116"><a href="#SearchEngine-116"><span class="linenos">116</span></a>
</span><span id="SearchEngine-117"><a href="#SearchEngine-117"><span class="linenos">117</span></a><span class="sd">        - `workflow`:</span>
</span><span id="SearchEngine-118"><a href="#SearchEngine-118"><span class="linenos">118</span></a><span class="sd">            The workflow to run all individuals through. Note, the result_database</span>
</span><span id="SearchEngine-119"><a href="#SearchEngine-119"><span class="linenos">119</span></a><span class="sd">            of this workflow will be treated as the individuals in this search.</span>
</span><span id="SearchEngine-120"><a href="#SearchEngine-120"><span class="linenos">120</span></a><span class="sd">            The default is &quot;relaxation.vasp.staged&quot;</span>
</span><span id="SearchEngine-121"><a href="#SearchEngine-121"><span class="linenos">121</span></a>
</span><span id="SearchEngine-122"><a href="#SearchEngine-122"><span class="linenos">122</span></a><span class="sd">        - `workflow_command`:</span>
</span><span id="SearchEngine-123"><a href="#SearchEngine-123"><span class="linenos">123</span></a><span class="sd">            The command that will be passed to the workflow.run() method.</span>
</span><span id="SearchEngine-124"><a href="#SearchEngine-124"><span class="linenos">124</span></a>
</span><span id="SearchEngine-125"><a href="#SearchEngine-125"><span class="linenos">125</span></a><span class="sd">        - `max_structures`:</span>
</span><span id="SearchEngine-126"><a href="#SearchEngine-126"><span class="linenos">126</span></a><span class="sd">            The maximum number of individuals that will be calculated before</span>
</span><span id="SearchEngine-127"><a href="#SearchEngine-127"><span class="linenos">127</span></a><span class="sd">            stopping the search. The default is 3000.</span>
</span><span id="SearchEngine-128"><a href="#SearchEngine-128"><span class="linenos">128</span></a>
</span><span id="SearchEngine-129"><a href="#SearchEngine-129"><span class="linenos">129</span></a><span class="sd">        - `limit_best_survival`:</span>
</span><span id="SearchEngine-130"><a href="#SearchEngine-130"><span class="linenos">130</span></a><span class="sd">            The search is stopped when the best individual remains unbeaten for</span>
</span><span id="SearchEngine-131"><a href="#SearchEngine-131"><span class="linenos">131</span></a><span class="sd">            this number of new individuals. The default is 250.</span>
</span><span id="SearchEngine-132"><a href="#SearchEngine-132"><span class="linenos">132</span></a>
</span><span id="SearchEngine-133"><a href="#SearchEngine-133"><span class="linenos">133</span></a><span class="sd">        - `singleshot_sources`:</span>
</span><span id="SearchEngine-134"><a href="#SearchEngine-134"><span class="linenos">134</span></a><span class="sd">            TODO: This is not implemented yet</span>
</span><span id="SearchEngine-135"><a href="#SearchEngine-135"><span class="linenos">135</span></a>
</span><span id="SearchEngine-136"><a href="#SearchEngine-136"><span class="linenos">136</span></a><span class="sd">        - `nfirst_generation`:</span>
</span><span id="SearchEngine-137"><a href="#SearchEngine-137"><span class="linenos">137</span></a><span class="sd">            No mutations or &quot;child&quot; individuals will be carried out until this</span>
</span><span id="SearchEngine-138"><a href="#SearchEngine-138"><span class="linenos">138</span></a><span class="sd">            number of individuals have been calculated. The default is 20.</span>
</span><span id="SearchEngine-139"><a href="#SearchEngine-139"><span class="linenos">139</span></a>
</span><span id="SearchEngine-140"><a href="#SearchEngine-140"><span class="linenos">140</span></a><span class="sd">        - `nsteadystate`:</span>
</span><span id="SearchEngine-141"><a href="#SearchEngine-141"><span class="linenos">141</span></a><span class="sd">            The total number of individuals from steady-state sources that will</span>
</span><span id="SearchEngine-142"><a href="#SearchEngine-142"><span class="linenos">142</span></a><span class="sd">            be running/submitted at any given time. The default is 40.</span>
</span><span id="SearchEngine-143"><a href="#SearchEngine-143"><span class="linenos">143</span></a>
</span><span id="SearchEngine-144"><a href="#SearchEngine-144"><span class="linenos">144</span></a><span class="sd">        - `steadystate_sources`:</span>
</span><span id="SearchEngine-145"><a href="#SearchEngine-145"><span class="linenos">145</span></a><span class="sd">            A list of tuples where each tuple is (percent, source). The percent</span>
</span><span id="SearchEngine-146"><a href="#SearchEngine-146"><span class="linenos">146</span></a><span class="sd">            determines the number of steady stage calculations that will be</span>
</span><span id="SearchEngine-147"><a href="#SearchEngine-147"><span class="linenos">147</span></a><span class="sd">            running for this at any given time. For example, 0.25 means</span>
</span><span id="SearchEngine-148"><a href="#SearchEngine-148"><span class="linenos">148</span></a><span class="sd">            0.25*40=10 individuals will be running/submitted at all times. The</span>
</span><span id="SearchEngine-149"><a href="#SearchEngine-149"><span class="linenos">149</span></a><span class="sd">            source can be from either the toolkit.creator or toolkit.transformations</span>
</span><span id="SearchEngine-150"><a href="#SearchEngine-150"><span class="linenos">150</span></a><span class="sd">            modules. Don&#39;t change this default unless you know what you&#39;re doing!</span>
</span><span id="SearchEngine-151"><a href="#SearchEngine-151"><span class="linenos">151</span></a>
</span><span id="SearchEngine-152"><a href="#SearchEngine-152"><span class="linenos">152</span></a><span class="sd">        - `selector`:</span>
</span><span id="SearchEngine-153"><a href="#SearchEngine-153"><span class="linenos">153</span></a><span class="sd">            The defualt method to use for choosing the parent individual(s). The</span>
</span><span id="SearchEngine-154"><a href="#SearchEngine-154"><span class="linenos">154</span></a><span class="sd">            default is TruncatedSelection.</span>
</span><span id="SearchEngine-155"><a href="#SearchEngine-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchEngine-156"><a href="#SearchEngine-156"><span class="linenos">156</span></a>
</span><span id="SearchEngine-157"><a href="#SearchEngine-157"><span class="linenos">157</span></a>        <span class="c1"># make sure we were givent a Composition object, and if not, we have</span>
</span><span id="SearchEngine-158"><a href="#SearchEngine-158"><span class="linenos">158</span></a>        <span class="c1"># a string that should be converted to one.</span>
</span><span id="SearchEngine-159"><a href="#SearchEngine-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">Composition</span><span class="p">):</span>
</span><span id="SearchEngine-160"><a href="#SearchEngine-160"><span class="linenos">160</span></a>            <span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
</span><span id="SearchEngine-161"><a href="#SearchEngine-161"><span class="linenos">161</span></a>
</span><span id="SearchEngine-162"><a href="#SearchEngine-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">composition</span>
</span><span id="SearchEngine-163"><a href="#SearchEngine-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span> <span class="o">=</span> <span class="n">workflow_command</span>
</span><span id="SearchEngine-164"><a href="#SearchEngine-164"><span class="linenos">164</span></a>
</span><span id="SearchEngine-165"><a href="#SearchEngine-165"><span class="linenos">165</span></a>        <span class="c1"># TODO: consider grabbing these from the database so that we can update</span>
</span><span id="SearchEngine-166"><a href="#SearchEngine-166"><span class="linenos">166</span></a>        <span class="c1"># them at any point.</span>
</span><span id="SearchEngine-167"><a href="#SearchEngine-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span> <span class="o">=</span> <span class="n">limit_best_survival</span>
</span><span id="SearchEngine-168"><a href="#SearchEngine-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span> <span class="o">=</span> <span class="n">max_structures</span>
</span><span id="SearchEngine-169"><a href="#SearchEngine-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsteadystate</span> <span class="o">=</span> <span class="n">nsteadystate</span>
</span><span id="SearchEngine-170"><a href="#SearchEngine-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nfirst_generation</span> <span class="o">=</span> <span class="n">nfirst_generation</span>
</span><span id="SearchEngine-171"><a href="#SearchEngine-171"><span class="linenos">171</span></a>
</span><span id="SearchEngine-172"><a href="#SearchEngine-172"><span class="linenos">172</span></a>        <span class="c1"># Initialize the selector</span>
</span><span id="SearchEngine-173"><a href="#SearchEngine-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">selector</span> <span class="o">==</span> <span class="s2">&quot;TruncatedSelection&quot;</span><span class="p">:</span>
</span><span id="SearchEngine-174"><a href="#SearchEngine-174"><span class="linenos">174</span></a>            <span class="kn">from</span> <span class="nn">simmate.toolkit.structure_prediction.evolution.selectors</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="SearchEngine-175"><a href="#SearchEngine-175"><span class="linenos">175</span></a>                <span class="n">TruncatedSelection</span><span class="p">,</span>
</span><span id="SearchEngine-176"><a href="#SearchEngine-176"><span class="linenos">176</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-177"><a href="#SearchEngine-177"><span class="linenos">177</span></a>
</span><span id="SearchEngine-178"><a href="#SearchEngine-178"><span class="linenos">178</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">TruncatedSelection</span><span class="p">()</span>
</span><span id="SearchEngine-179"><a href="#SearchEngine-179"><span class="linenos">179</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># BUG</span>
</span><span id="SearchEngine-180"><a href="#SearchEngine-180"><span class="linenos">180</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We only support TruncatedSelection right now&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-181"><a href="#SearchEngine-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span>
</span><span id="SearchEngine-182"><a href="#SearchEngine-182"><span class="linenos">182</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-183"><a href="#SearchEngine-183"><span class="linenos">183</span></a>            <span class="s2">&quot;The default parent selection for mutations will use &quot;</span>
</span><span id="SearchEngine-184"><a href="#SearchEngine-184"><span class="linenos">184</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SearchEngine-185"><a href="#SearchEngine-185"><span class="linenos">185</span></a>        <span class="p">)</span>
</span><span id="SearchEngine-186"><a href="#SearchEngine-186"><span class="linenos">186</span></a>
</span><span id="SearchEngine-187"><a href="#SearchEngine-187"><span class="linenos">187</span></a>        <span class="c1"># Initialize the workflow if a string was given.</span>
</span><span id="SearchEngine-188"><a href="#SearchEngine-188"><span class="linenos">188</span></a>        <span class="c1"># Otherwise we should already have a workflow class.</span>
</span><span id="SearchEngine-189"><a href="#SearchEngine-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s2">&quot;relaxation.vasp.staged&quot;</span><span class="p">:</span>
</span><span id="SearchEngine-190"><a href="#SearchEngine-190"><span class="linenos">190</span></a>            <span class="kn">from</span> <span class="nn">simmate.workflows.relaxation</span> <span class="kn">import</span> <span class="n">Relaxation__Vasp__Staged</span>
</span><span id="SearchEngine-191"><a href="#SearchEngine-191"><span class="linenos">191</span></a>
</span><span id="SearchEngine-192"><a href="#SearchEngine-192"><span class="linenos">192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">Relaxation__Vasp__Staged</span>
</span><span id="SearchEngine-193"><a href="#SearchEngine-193"><span class="linenos">193</span></a>
</span><span id="SearchEngine-194"><a href="#SearchEngine-194"><span class="linenos">194</span></a>            <span class="c1"># Point to the structure datatable that we&#39;ll pull from</span>
</span><span id="SearchEngine-195"><a href="#SearchEngine-195"><span class="linenos">195</span></a>            <span class="c1"># BUG: For now, I assume its the results table of the workflow</span>
</span><span id="SearchEngine-196"><a href="#SearchEngine-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">individuals_datatable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">database_table</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span>
</span><span id="SearchEngine-197"><a href="#SearchEngine-197"><span class="linenos">197</span></a>                <span class="s2">&quot;quality04relaxation&quot;</span>
</span><span id="SearchEngine-198"><a href="#SearchEngine-198"><span class="linenos">198</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">related_model</span>  <span class="c1"># gives quality04relaxation table</span>
</span><span id="SearchEngine-199"><a href="#SearchEngine-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">calculation_datatable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">database_table</span>
</span><span id="SearchEngine-200"><a href="#SearchEngine-200"><span class="linenos">200</span></a>            <span class="c1"># BUG: these need to be merged and moved outside this if statement</span>
</span><span id="SearchEngine-201"><a href="#SearchEngine-201"><span class="linenos">201</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchEngine-202"><a href="#SearchEngine-202"><span class="linenos">202</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="SearchEngine-203"><a href="#SearchEngine-203"><span class="linenos">203</span></a>                <span class="s2">&quot;Only `relaxation.vasp.staged` is supported in early testing&quot;</span>
</span><span id="SearchEngine-204"><a href="#SearchEngine-204"><span class="linenos">204</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-205"><a href="#SearchEngine-205"><span class="linenos">205</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-206"><a href="#SearchEngine-206"><span class="linenos">206</span></a>            <span class="sa">f</span><span class="s2">&quot;All individuals will be evaulated through the &quot;</span>
</span><span id="SearchEngine-207"><a href="#SearchEngine-207"><span class="linenos">207</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">name_full</span><span class="si">}</span><span class="s2"> workflow.&quot;</span>
</span><span id="SearchEngine-208"><a href="#SearchEngine-208"><span class="linenos">208</span></a>        <span class="p">)</span>
</span><span id="SearchEngine-209"><a href="#SearchEngine-209"><span class="linenos">209</span></a>        <span class="c1"># BUG: I&#39;ll need to rewrite this in the future bc I don&#39;t really account</span>
</span><span id="SearchEngine-210"><a href="#SearchEngine-210"><span class="linenos">210</span></a>        <span class="c1"># for other workflows yet. It would make sense that our workflow changes</span>
</span><span id="SearchEngine-211"><a href="#SearchEngine-211"><span class="linenos">211</span></a>        <span class="c1"># as the search progresses (e.g. we incorporate DeePMD relaxation once ready)</span>
</span><span id="SearchEngine-212"><a href="#SearchEngine-212"><span class="linenos">212</span></a>
</span><span id="SearchEngine-213"><a href="#SearchEngine-213"><span class="linenos">213</span></a>        <span class="c1"># Check if there is an existing search and grab it if so. Otherwise, add</span>
</span><span id="SearchEngine-214"><a href="#SearchEngine-214"><span class="linenos">214</span></a>        <span class="c1"># the search entry to the DB.</span>
</span><span id="SearchEngine-215"><a href="#SearchEngine-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="n">SearchDatatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="SearchEngine-216"><a href="#SearchEngine-216"><span class="linenos">216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span> <span class="o">=</span> <span class="n">SearchDatatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="SearchEngine-217"><a href="#SearchEngine-217"><span class="linenos">217</span></a>                <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
</span><span id="SearchEngine-218"><a href="#SearchEngine-218"><span class="linenos">218</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="SearchEngine-219"><a href="#SearchEngine-219"><span class="linenos">219</span></a>            <span class="c1"># TODO: update, add logs, compare... I need to decide what to do here.</span>
</span><span id="SearchEngine-220"><a href="#SearchEngine-220"><span class="linenos">220</span></a>            <span class="c1"># also, run _check_stop_condition() to avoid unneccessary restart.</span>
</span><span id="SearchEngine-221"><a href="#SearchEngine-221"><span class="linenos">221</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchEngine-222"><a href="#SearchEngine-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span> <span class="o">=</span> <span class="n">SearchDatatable</span><span class="p">(</span>
</span><span id="SearchEngine-223"><a href="#SearchEngine-223"><span class="linenos">223</span></a>                <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
</span><span id="SearchEngine-224"><a href="#SearchEngine-224"><span class="linenos">224</span></a>                <span class="n">workflows</span><span class="o">=</span><span class="p">[</span>
</span><span id="SearchEngine-225"><a href="#SearchEngine-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">name_full</span>
</span><span id="SearchEngine-226"><a href="#SearchEngine-226"><span class="linenos">226</span></a>                <span class="p">],</span>  <span class="c1"># as a list bc we can add new ones later</span>
</span><span id="SearchEngine-227"><a href="#SearchEngine-227"><span class="linenos">227</span></a>                <span class="n">individuals_datatable_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">individuals_datatable</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="SearchEngine-228"><a href="#SearchEngine-228"><span class="linenos">228</span></a>                <span class="n">max_structures</span><span class="o">=</span><span class="n">max_structures</span><span class="p">,</span>
</span><span id="SearchEngine-229"><a href="#SearchEngine-229"><span class="linenos">229</span></a>                <span class="n">limit_best_survival</span><span class="o">=</span><span class="n">limit_best_survival</span><span class="p">,</span>
</span><span id="SearchEngine-230"><a href="#SearchEngine-230"><span class="linenos">230</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-231"><a href="#SearchEngine-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine-232"><a href="#SearchEngine-232"><span class="linenos">232</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-233"><a href="#SearchEngine-233"><span class="linenos">233</span></a>            <span class="s2">&quot;To track the progress while this search runs, you can use the following&quot;</span>
</span><span id="SearchEngine-234"><a href="#SearchEngine-234"><span class="linenos">234</span></a>            <span class="s2">&quot; in a separate python terminal:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine-235"><a href="#SearchEngine-235"><span class="linenos">235</span></a>            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">from simmate.shortcuts import SearchResults</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine-236"><a href="#SearchEngine-236"><span class="linenos">236</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">search = SearchResults.objects.get(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine-237"><a href="#SearchEngine-237"><span class="linenos">237</span></a>            <span class="sa">f</span><span class="s2">&quot;So your search ID is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine-238"><a href="#SearchEngine-238"><span class="linenos">238</span></a>            <span class="s2">&quot;View the documentation on the EvolutionarySearch datatable for more info.&quot;</span>
</span><span id="SearchEngine-239"><a href="#SearchEngine-239"><span class="linenos">239</span></a>        <span class="p">)</span>
</span><span id="SearchEngine-240"><a href="#SearchEngine-240"><span class="linenos">240</span></a>
</span><span id="SearchEngine-241"><a href="#SearchEngine-241"><span class="linenos">241</span></a>        <span class="c1"># Grab the list of singleshot sources that have been ran before</span>
</span><span id="SearchEngine-242"><a href="#SearchEngine-242"><span class="linenos">242</span></a>        <span class="c1"># and based off of that list, remove repeated sources</span>
</span><span id="SearchEngine-243"><a href="#SearchEngine-243"><span class="linenos">243</span></a>        <span class="n">past_singleshot_sources</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchEngine-244"><a href="#SearchEngine-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_singleshot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SearchEngine-245"><a href="#SearchEngine-245"><span class="linenos">245</span></a>            <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SearchEngine-246"><a href="#SearchEngine-246"><span class="linenos">246</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="SearchEngine-247"><a href="#SearchEngine-247"><span class="linenos">247</span></a>        <span class="p">)</span>
</span><span id="SearchEngine-248"><a href="#SearchEngine-248"><span class="linenos">248</span></a>        <span class="n">singleshot_sources</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine-249"><a href="#SearchEngine-249"><span class="linenos">249</span></a>            <span class="n">source</span>
</span><span id="SearchEngine-250"><a href="#SearchEngine-250"><span class="linenos">250</span></a>            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">singleshot_sources</span>
</span><span id="SearchEngine-251"><a href="#SearchEngine-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">past_singleshot_sources</span>
</span><span id="SearchEngine-252"><a href="#SearchEngine-252"><span class="linenos">252</span></a>        <span class="p">]</span>
</span><span id="SearchEngine-253"><a href="#SearchEngine-253"><span class="linenos">253</span></a>        <span class="c1"># BUG: what if I want to rerun any of these even though its been ran before?</span>
</span><span id="SearchEngine-254"><a href="#SearchEngine-254"><span class="linenos">254</span></a>        <span class="c1"># An example would be rerunning substituitions when new structures are available</span>
</span><span id="SearchEngine-255"><a href="#SearchEngine-255"><span class="linenos">255</span></a>
</span><span id="SearchEngine-256"><a href="#SearchEngine-256"><span class="linenos">256</span></a>        <span class="c1"># Initialize the single-shot sources</span>
</span><span id="SearchEngine-257"><a href="#SearchEngine-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine-258"><a href="#SearchEngine-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">singleshot_sources</span><span class="p">:</span>
</span><span id="SearchEngine-259"><a href="#SearchEngine-259"><span class="linenos">259</span></a>
</span><span id="SearchEngine-260"><a href="#SearchEngine-260"><span class="linenos">260</span></a>            <span class="c1"># if we are given a string, we want initialize the class</span>
</span><span id="SearchEngine-261"><a href="#SearchEngine-261"><span class="linenos">261</span></a>            <span class="c1"># otherwise it should be a class alreadys</span>
</span><span id="SearchEngine-262"><a href="#SearchEngine-262"><span class="linenos">262</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SearchEngine-263"><a href="#SearchEngine-263"><span class="linenos">263</span></a>                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_common_class</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine-264"><a href="#SearchEngine-264"><span class="linenos">264</span></a>
</span><span id="SearchEngine-265"><a href="#SearchEngine-265"><span class="linenos">265</span></a>            <span class="c1"># and add it to our final list</span>
</span><span id="SearchEngine-266"><a href="#SearchEngine-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine-267"><a href="#SearchEngine-267"><span class="linenos">267</span></a>
</span><span id="SearchEngine-268"><a href="#SearchEngine-268"><span class="linenos">268</span></a>        <span class="c1"># Initialize the steady-state sources, which are given as a list of</span>
</span><span id="SearchEngine-269"><a href="#SearchEngine-269"><span class="linenos">269</span></a>        <span class="c1"># (proportion, class/class_str, kwargs) for each. As we go through these,</span>
</span><span id="SearchEngine-270"><a href="#SearchEngine-270"><span class="linenos">270</span></a>        <span class="c1"># we also collect the proportion list for them.</span>
</span><span id="SearchEngine-271"><a href="#SearchEngine-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine-272"><a href="#SearchEngine-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine-273"><a href="#SearchEngine-273"><span class="linenos">273</span></a>        <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">steadystate_sources</span><span class="p">:</span>
</span><span id="SearchEngine-274"><a href="#SearchEngine-274"><span class="linenos">274</span></a>
</span><span id="SearchEngine-275"><a href="#SearchEngine-275"><span class="linenos">275</span></a>            <span class="c1"># There are certain transformation sources that don&#39;t work for single-element</span>
</span><span id="SearchEngine-276"><a href="#SearchEngine-276"><span class="linenos">276</span></a>            <span class="c1"># structures, so we check for this here and remove them.</span>
</span><span id="SearchEngine-277"><a href="#SearchEngine-277"><span class="linenos">277</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="SearchEngine-278"><a href="#SearchEngine-278"><span class="linenos">278</span></a>                <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span>
</span><span id="SearchEngine-279"><a href="#SearchEngine-279"><span class="linenos">279</span></a>            <span class="p">]:</span>
</span><span id="SearchEngine-280"><a href="#SearchEngine-280"><span class="linenos">280</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-281"><a href="#SearchEngine-281"><span class="linenos">281</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> is not possible with single-element structures.&quot;</span>
</span><span id="SearchEngine-282"><a href="#SearchEngine-282"><span class="linenos">282</span></a>                    <span class="s2">&quot; This is being removed from your steadystate_sources.&quot;</span>
</span><span id="SearchEngine-283"><a href="#SearchEngine-283"><span class="linenos">283</span></a>                <span class="p">)</span>
</span><span id="SearchEngine-284"><a href="#SearchEngine-284"><span class="linenos">284</span></a>                <span class="k">continue</span>  <span class="c1"># skips to next source</span>
</span><span id="SearchEngine-285"><a href="#SearchEngine-285"><span class="linenos">285</span></a>
</span><span id="SearchEngine-286"><a href="#SearchEngine-286"><span class="linenos">286</span></a>            <span class="c1"># store proportion value</span>
</span><span id="SearchEngine-287"><a href="#SearchEngine-287"><span class="linenos">287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proportion</span><span class="p">)</span>
</span><span id="SearchEngine-288"><a href="#SearchEngine-288"><span class="linenos">288</span></a>
</span><span id="SearchEngine-289"><a href="#SearchEngine-289"><span class="linenos">289</span></a>            <span class="c1"># if we are given a string, we want initialize the class</span>
</span><span id="SearchEngine-290"><a href="#SearchEngine-290"><span class="linenos">290</span></a>            <span class="c1"># otherwise it should be a class already</span>
</span><span id="SearchEngine-291"><a href="#SearchEngine-291"><span class="linenos">291</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SearchEngine-292"><a href="#SearchEngine-292"><span class="linenos">292</span></a>                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_common_class</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine-293"><a href="#SearchEngine-293"><span class="linenos">293</span></a>            <span class="c1"># and add it to our final list</span>
</span><span id="SearchEngine-294"><a href="#SearchEngine-294"><span class="linenos">294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine-295"><a href="#SearchEngine-295"><span class="linenos">295</span></a>
</span><span id="SearchEngine-296"><a href="#SearchEngine-296"><span class="linenos">296</span></a>        <span class="c1"># Make sure the proportions sum to 1, otherwise scale them. We then convert</span>
</span><span id="SearchEngine-297"><a href="#SearchEngine-297"><span class="linenos">297</span></a>        <span class="c1"># these to steady-state integers (and round to the nearest integer)</span>
</span><span id="SearchEngine-298"><a href="#SearchEngine-298"><span class="linenos">298</span></a>        <span class="n">sum_proportions</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span><span class="p">)</span>
</span><span id="SearchEngine-299"><a href="#SearchEngine-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="n">sum_proportions</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SearchEngine-300"><a href="#SearchEngine-300"><span class="linenos">300</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-301"><a href="#SearchEngine-301"><span class="linenos">301</span></a>                <span class="s2">&quot;Warning: fractions for steady-state sources do not add to 1.&quot;</span>
</span><span id="SearchEngine-302"><a href="#SearchEngine-302"><span class="linenos">302</span></a>                <span class="s2">&quot;We have scaled all sources to equal one to fix this.&quot;</span>
</span><span id="SearchEngine-303"><a href="#SearchEngine-303"><span class="linenos">303</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-304"><a href="#SearchEngine-304"><span class="linenos">304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine-305"><a href="#SearchEngine-305"><span class="linenos">305</span></a>                <span class="n">p</span> <span class="o">/</span> <span class="n">sum_proportions</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span>
</span><span id="SearchEngine-306"><a href="#SearchEngine-306"><span class="linenos">306</span></a>            <span class="p">]</span>
</span><span id="SearchEngine-307"><a href="#SearchEngine-307"><span class="linenos">307</span></a>        <span class="c1"># While these are percent values, we want specific counts. We convert to</span>
</span><span id="SearchEngine-308"><a href="#SearchEngine-308"><span class="linenos">308</span></a>        <span class="c1"># those here.</span>
</span><span id="SearchEngine-309"><a href="#SearchEngine-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_counts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine-310"><a href="#SearchEngine-310"><span class="linenos">310</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">nsteadystate</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span>
</span><span id="SearchEngine-311"><a href="#SearchEngine-311"><span class="linenos">311</span></a>        <span class="p">]</span>
</span><span id="SearchEngine-312"><a href="#SearchEngine-312"><span class="linenos">312</span></a>
</span><span id="SearchEngine-313"><a href="#SearchEngine-313"><span class="linenos">313</span></a>        <span class="c1"># Throughout our search, we want to keep track of which workflows we&#39;ve</span>
</span><span id="SearchEngine-314"><a href="#SearchEngine-314"><span class="linenos">314</span></a>        <span class="c1"># submitted to prefect for each structure source as well as how long</span>
</span><span id="SearchEngine-315"><a href="#SearchEngine-315"><span class="linenos">315</span></a>        <span class="c1"># we were holding a steady-state of submissions. We therefore keep</span>
</span><span id="SearchEngine-316"><a href="#SearchEngine-316"><span class="linenos">316</span></a>        <span class="c1"># a log of Sources in our database -- where even if we&#39;ve ran this search</span>
</span><span id="SearchEngine-317"><a href="#SearchEngine-317"><span class="linenos">317</span></a>        <span class="c1"># before, we still want new entries for each.</span>
</span><span id="SearchEngine-318"><a href="#SearchEngine-318"><span class="linenos">318</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources_db</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine-319"><a href="#SearchEngine-319"><span class="linenos">319</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span><span class="p">:</span>
</span><span id="SearchEngine-320"><a href="#SearchEngine-320"><span class="linenos">320</span></a>            <span class="n">source_db</span> <span class="o">=</span> <span class="n">SourceDatatable</span><span class="p">(</span>
</span><span id="SearchEngine-321"><a href="#SearchEngine-321"><span class="linenos">321</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="SearchEngine-322"><a href="#SearchEngine-322"><span class="linenos">322</span></a>                <span class="n">is_steadystate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SearchEngine-323"><a href="#SearchEngine-323"><span class="linenos">323</span></a>                <span class="n">is_singleshot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchEngine-324"><a href="#SearchEngine-324"><span class="linenos">324</span></a>                <span class="n">search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="p">,</span>
</span><span id="SearchEngine-325"><a href="#SearchEngine-325"><span class="linenos">325</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-326"><a href="#SearchEngine-326"><span class="linenos">326</span></a>            <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine-327"><a href="#SearchEngine-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_db</span><span class="p">)</span>
</span><span id="SearchEngine-328"><a href="#SearchEngine-328"><span class="linenos">328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine-329"><a href="#SearchEngine-329"><span class="linenos">329</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="p">:</span>
</span><span id="SearchEngine-330"><a href="#SearchEngine-330"><span class="linenos">330</span></a>            <span class="n">source_db</span> <span class="o">=</span> <span class="n">SourceDatatable</span><span class="p">(</span>
</span><span id="SearchEngine-331"><a href="#SearchEngine-331"><span class="linenos">331</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="SearchEngine-332"><a href="#SearchEngine-332"><span class="linenos">332</span></a>                <span class="n">is_steadystate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchEngine-333"><a href="#SearchEngine-333"><span class="linenos">333</span></a>                <span class="n">is_singleshot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SearchEngine-334"><a href="#SearchEngine-334"><span class="linenos">334</span></a>                <span class="n">search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="p">,</span>
</span><span id="SearchEngine-335"><a href="#SearchEngine-335"><span class="linenos">335</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-336"><a href="#SearchEngine-336"><span class="linenos">336</span></a>            <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine-337"><a href="#SearchEngine-337"><span class="linenos">337</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_db</span><span class="p">)</span>
</span><span id="SearchEngine-338"><a href="#SearchEngine-338"><span class="linenos">338</span></a>
</span><span id="SearchEngine-339"><a href="#SearchEngine-339"><span class="linenos">339</span></a>        <span class="c1"># Initialize the fingerprint database</span>
</span><span id="SearchEngine-340"><a href="#SearchEngine-340"><span class="linenos">340</span></a>        <span class="c1"># For this we need to grab all previously calculated structures of this</span>
</span><span id="SearchEngine-341"><a href="#SearchEngine-341"><span class="linenos">341</span></a>        <span class="c1"># compositon too pass in too.</span>
</span><span id="SearchEngine-342"><a href="#SearchEngine-342"><span class="linenos">342</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating fingerprints for past structures...&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-343"><a href="#SearchEngine-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span> <span class="o">=</span> <span class="n">PartialCrystalNNFingerprint</span><span class="p">(</span>
</span><span id="SearchEngine-344"><a href="#SearchEngine-344"><span class="linenos">344</span></a>            <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span>
</span><span id="SearchEngine-345"><a href="#SearchEngine-345"><span class="linenos">345</span></a>            <span class="n">structure_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals</span><span class="p">,</span>
</span><span id="SearchEngine-346"><a href="#SearchEngine-346"><span class="linenos">346</span></a>        <span class="p">)</span>
</span><span id="SearchEngine-347"><a href="#SearchEngine-347"><span class="linenos">347</span></a>        <span class="c1"># BUG: should we only do structures that were successfully calculated?</span>
</span><span id="SearchEngine-348"><a href="#SearchEngine-348"><span class="linenos">348</span></a>        <span class="c1"># If not, there&#39;s a chance a structure fails because of something like a</span>
</span><span id="SearchEngine-349"><a href="#SearchEngine-349"><span class="linenos">349</span></a>        <span class="c1"># crashed slurm job, but it&#39;s never submitted again...</span>
</span><span id="SearchEngine-350"><a href="#SearchEngine-350"><span class="linenos">350</span></a>        <span class="c1"># OPTIMIZE: should we only do final structures? Or should I include input</span>
</span><span id="SearchEngine-351"><a href="#SearchEngine-351"><span class="linenos">351</span></a>        <span class="c1"># structures and even all ionic steps as well...?</span>
</span><span id="SearchEngine-352"><a href="#SearchEngine-352"><span class="linenos">352</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-353"><a href="#SearchEngine-353"><span class="linenos">353</span></a>
</span><span id="SearchEngine-354"><a href="#SearchEngine-354"><span class="linenos">354</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="SearchEngine-355"><a href="#SearchEngine-355"><span class="linenos">355</span></a>
</span><span id="SearchEngine-356"><a href="#SearchEngine-356"><span class="linenos">356</span></a>        <span class="c1"># See if the singleshot sources have been ran yet. For restarted calculations</span>
</span><span id="SearchEngine-357"><a href="#SearchEngine-357"><span class="linenos">357</span></a>        <span class="c1"># this will likely not be needed (unless a new source was added)</span>
</span><span id="SearchEngine-358"><a href="#SearchEngine-358"><span class="linenos">358</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_singleshot_sources</span><span class="p">()</span>
</span><span id="SearchEngine-359"><a href="#SearchEngine-359"><span class="linenos">359</span></a>
</span><span id="SearchEngine-360"><a href="#SearchEngine-360"><span class="linenos">360</span></a>        <span class="c1"># this loop will go until I hit &#39;break&#39; below</span>
</span><span id="SearchEngine-361"><a href="#SearchEngine-361"><span class="linenos">361</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="SearchEngine-362"><a href="#SearchEngine-362"><span class="linenos">362</span></a>
</span><span id="SearchEngine-363"><a href="#SearchEngine-363"><span class="linenos">363</span></a>            <span class="c1"># TODO: maybe write summary files to csv...? This may be a mute</span>
</span><span id="SearchEngine-364"><a href="#SearchEngine-364"><span class="linenos">364</span></a>            <span class="c1"># point because I expect we can follow along in the web UI in the future</span>
</span><span id="SearchEngine-365"><a href="#SearchEngine-365"><span class="linenos">365</span></a>            <span class="c1"># To that end, I can add a &quot;URL&quot; property</span>
</span><span id="SearchEngine-366"><a href="#SearchEngine-366"><span class="linenos">366</span></a>
</span><span id="SearchEngine-367"><a href="#SearchEngine-367"><span class="linenos">367</span></a>            <span class="c1"># Check the stop condition</span>
</span><span id="SearchEngine-368"><a href="#SearchEngine-368"><span class="linenos">368</span></a>            <span class="c1"># If it is True, we can stop the calc.</span>
</span><span id="SearchEngine-369"><a href="#SearchEngine-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_condition</span><span class="p">():</span>
</span><span id="SearchEngine-370"><a href="#SearchEngine-370"><span class="linenos">370</span></a>                <span class="k">break</span>  <span class="c1"># break out of the while loop</span>
</span><span id="SearchEngine-371"><a href="#SearchEngine-371"><span class="linenos">371</span></a>            <span class="c1"># Otherwise, keep going!</span>
</span><span id="SearchEngine-372"><a href="#SearchEngine-372"><span class="linenos">372</span></a>
</span><span id="SearchEngine-373"><a href="#SearchEngine-373"><span class="linenos">373</span></a>            <span class="c1"># update the fingerprint database with all of the completed structures</span>
</span><span id="SearchEngine-374"><a href="#SearchEngine-374"><span class="linenos">374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span><span class="o">.</span><span class="n">update_fingerprint_database</span><span class="p">()</span>
</span><span id="SearchEngine-375"><a href="#SearchEngine-375"><span class="linenos">375</span></a>
</span><span id="SearchEngine-376"><a href="#SearchEngine-376"><span class="linenos">376</span></a>            <span class="c1"># Go through the running workflows and see if we need to submit</span>
</span><span id="SearchEngine-377"><a href="#SearchEngine-377"><span class="linenos">377</span></a>            <span class="c1"># new ones to meet our steadystate target(s)</span>
</span><span id="SearchEngine-378"><a href="#SearchEngine-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_steadystate_workflows</span><span class="p">()</span>
</span><span id="SearchEngine-379"><a href="#SearchEngine-379"><span class="linenos">379</span></a>
</span><span id="SearchEngine-380"><a href="#SearchEngine-380"><span class="linenos">380</span></a>            <span class="c1"># TODO: Go through the triggered actions</span>
</span><span id="SearchEngine-381"><a href="#SearchEngine-381"><span class="linenos">381</span></a>            <span class="c1"># self._check_triggered_actions()</span>
</span><span id="SearchEngine-382"><a href="#SearchEngine-382"><span class="linenos">382</span></a>
</span><span id="SearchEngine-383"><a href="#SearchEngine-383"><span class="linenos">383</span></a>            <span class="c1"># To save our database load, sleep until we run checks again.</span>
</span><span id="SearchEngine-384"><a href="#SearchEngine-384"><span class="linenos">384</span></a>            <span class="c1"># OPTIMIZE: ask Prefect if their is an equivalent to Dask&#39;s gather/wait</span>
</span><span id="SearchEngine-385"><a href="#SearchEngine-385"><span class="linenos">385</span></a>            <span class="c1"># functions, so we know exactly when a workflow completes</span>
</span><span id="SearchEngine-386"><a href="#SearchEngine-386"><span class="linenos">386</span></a>            <span class="c1"># https://docs.dask.org/en/stable/futures.html#waiting-on-futures</span>
</span><span id="SearchEngine-387"><a href="#SearchEngine-387"><span class="linenos">387</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sleeping for </span><span class="si">{</span><span class="n">sleep_step</span><span class="si">}</span><span class="s2"> seconds before running checks again.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-388"><a href="#SearchEngine-388"><span class="linenos">388</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_step</span><span class="p">)</span>
</span><span id="SearchEngine-389"><a href="#SearchEngine-389"><span class="linenos">389</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping the search (remaining calcs will be left to finish).&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-390"><a href="#SearchEngine-390"><span class="linenos">390</span></a>
</span><span id="SearchEngine-391"><a href="#SearchEngine-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">_check_stop_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchEngine-392"><a href="#SearchEngine-392"><span class="linenos">392</span></a>
</span><span id="SearchEngine-393"><a href="#SearchEngine-393"><span class="linenos">393</span></a>        <span class="c1"># first see if we&#39;ve hit our maximum limit for structures.</span>
</span><span id="SearchEngine-394"><a href="#SearchEngine-394"><span class="linenos">394</span></a>        <span class="c1"># Note: because we are only looking at the results table, this is really</span>
</span><span id="SearchEngine-395"><a href="#SearchEngine-395"><span class="linenos">395</span></a>        <span class="c1"># only counting the number of successfully calculated individuals.</span>
</span><span id="SearchEngine-396"><a href="#SearchEngine-396"><span class="linenos">396</span></a>        <span class="c1"># Nothing is done to stop those that are still running or to count</span>
</span><span id="SearchEngine-397"><a href="#SearchEngine-397"><span class="linenos">397</span></a>        <span class="c1"># structures that failed to be calculated</span>
</span><span id="SearchEngine-398"><a href="#SearchEngine-398"><span class="linenos">398</span></a>        <span class="c1"># {f&quot;{self.fitness_field}__isnull&quot;=False} # when I allow other fitness fxns</span>
</span><span id="SearchEngine-399"><a href="#SearchEngine-399"><span class="linenos">399</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span><span class="p">:</span>
</span><span id="SearchEngine-400"><a href="#SearchEngine-400"><span class="linenos">400</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-401"><a href="#SearchEngine-401"><span class="linenos">401</span></a>                <span class="sa">f</span><span class="s2">&quot;Maximum number of completed calculations hit (n=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SearchEngine-402"><a href="#SearchEngine-402"><span class="linenos">402</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-403"><a href="#SearchEngine-403"><span class="linenos">403</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SearchEngine-404"><a href="#SearchEngine-404"><span class="linenos">404</span></a>        <span class="c1"># The 2nd stop condition is based on how long we&#39;ve have the same</span>
</span><span id="SearchEngine-405"><a href="#SearchEngine-405"><span class="linenos">405</span></a>        <span class="c1"># &quot;best&quot; individual. If the number of new individuals calculated (without</span>
</span><span id="SearchEngine-406"><a href="#SearchEngine-406"><span class="linenos">406</span></a>        <span class="c1"># any becoming the new &quot;best&quot;) is greater than limit_best_survival, then</span>
</span><span id="SearchEngine-407"><a href="#SearchEngine-407"><span class="linenos">407</span></a>        <span class="c1"># we can stop the search.</span>
</span><span id="SearchEngine-408"><a href="#SearchEngine-408"><span class="linenos">408</span></a>
</span><span id="SearchEngine-409"><a href="#SearchEngine-409"><span class="linenos">409</span></a>        <span class="c1"># grab the best individual for reference</span>
</span><span id="SearchEngine-410"><a href="#SearchEngine-410"><span class="linenos">410</span></a>        <span class="n">best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">best_individual</span>
</span><span id="SearchEngine-411"><a href="#SearchEngine-411"><span class="linenos">411</span></a>
</span><span id="SearchEngine-412"><a href="#SearchEngine-412"><span class="linenos">412</span></a>        <span class="c1"># We need this if-statement in case no structures have completed yet.</span>
</span><span id="SearchEngine-413"><a href="#SearchEngine-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">best</span><span class="p">:</span>
</span><span id="SearchEngine-414"><a href="#SearchEngine-414"><span class="linenos">414</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="SearchEngine-415"><a href="#SearchEngine-415"><span class="linenos">415</span></a>
</span><span id="SearchEngine-416"><a href="#SearchEngine-416"><span class="linenos">416</span></a>        <span class="c1"># count the number of new individuals added AFTER the best one. If it is</span>
</span><span id="SearchEngine-417"><a href="#SearchEngine-417"><span class="linenos">417</span></a>        <span class="c1"># more than limit_best_survival, we stop the search.</span>
</span><span id="SearchEngine-418"><a href="#SearchEngine-418"><span class="linenos">418</span></a>        <span class="n">num_new_structures_since_best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="SearchEngine-419"><a href="#SearchEngine-419"><span class="linenos">419</span></a>            <span class="c1"># check energies to ensure we only count completed calculations</span>
</span><span id="SearchEngine-420"><a href="#SearchEngine-420"><span class="linenos">420</span></a>            <span class="n">energy_per_atom__gt</span><span class="o">=</span><span class="n">best</span><span class="o">.</span><span class="n">energy_per_atom</span><span class="p">,</span>
</span><span id="SearchEngine-421"><a href="#SearchEngine-421"><span class="linenos">421</span></a>            <span class="n">created_at__gte</span><span class="o">=</span><span class="n">best</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
</span><span id="SearchEngine-422"><a href="#SearchEngine-422"><span class="linenos">422</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="SearchEngine-423"><a href="#SearchEngine-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="n">num_new_structures_since_best</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span><span class="p">:</span>
</span><span id="SearchEngine-424"><a href="#SearchEngine-424"><span class="linenos">424</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-425"><a href="#SearchEngine-425"><span class="linenos">425</span></a>                <span class="sa">f</span><span class="s2">&quot;Best individual has not changed after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SearchEngine-426"><a href="#SearchEngine-426"><span class="linenos">426</span></a>                <span class="s2">&quot; new individuals added.&quot;</span>
</span><span id="SearchEngine-427"><a href="#SearchEngine-427"><span class="linenos">427</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-428"><a href="#SearchEngine-428"><span class="linenos">428</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SearchEngine-429"><a href="#SearchEngine-429"><span class="linenos">429</span></a>        <span class="c1"># If we reached this point, then we haven&#39;t hit a stop condition yet!</span>
</span><span id="SearchEngine-430"><a href="#SearchEngine-430"><span class="linenos">430</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="SearchEngine-431"><a href="#SearchEngine-431"><span class="linenos">431</span></a>
</span><span id="SearchEngine-432"><a href="#SearchEngine-432"><span class="linenos">432</span></a>    <span class="k">def</span> <span class="nf">_check_singleshot_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchEngine-433"><a href="#SearchEngine-433"><span class="linenos">433</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Singleshot sources not implemented yet. Skipping this step.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-434"><a href="#SearchEngine-434"><span class="linenos">434</span></a>
</span><span id="SearchEngine-435"><a href="#SearchEngine-435"><span class="linenos">435</span></a>    <span class="k">def</span> <span class="nf">_check_steadystate_workflows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchEngine-436"><a href="#SearchEngine-436"><span class="linenos">436</span></a>
</span><span id="SearchEngine-437"><a href="#SearchEngine-437"><span class="linenos">437</span></a>        <span class="c1"># we iterate through each steady-state source and check to see how many</span>
</span><span id="SearchEngine-438"><a href="#SearchEngine-438"><span class="linenos">438</span></a>        <span class="c1"># jobs are still running for it. If it&#39;s less than the target steady-state,</span>
</span><span id="SearchEngine-439"><a href="#SearchEngine-439"><span class="linenos">439</span></a>        <span class="c1"># then we need to submit more!</span>
</span><span id="SearchEngine-440"><a href="#SearchEngine-440"><span class="linenos">440</span></a>        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">source_db</span><span class="p">,</span> <span class="n">njobs_target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="SearchEngine-441"><a href="#SearchEngine-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="p">,</span>
</span><span id="SearchEngine-442"><a href="#SearchEngine-442"><span class="linenos">442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span><span class="p">,</span>
</span><span id="SearchEngine-443"><a href="#SearchEngine-443"><span class="linenos">443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_counts</span><span class="p">,</span>
</span><span id="SearchEngine-444"><a href="#SearchEngine-444"><span class="linenos">444</span></a>        <span class="p">):</span>
</span><span id="SearchEngine-445"><a href="#SearchEngine-445"><span class="linenos">445</span></a>            <span class="c1"># This loop says for the number of steady state runs we are short,</span>
</span><span id="SearchEngine-446"><a href="#SearchEngine-446"><span class="linenos">446</span></a>            <span class="c1"># create that many new individuals! max(x,0) ensure we don&#39;t get a</span>
</span><span id="SearchEngine-447"><a href="#SearchEngine-447"><span class="linenos">447</span></a>            <span class="c1"># negative value. A value of 0 means we are at steady-state and can</span>
</span><span id="SearchEngine-448"><a href="#SearchEngine-448"><span class="linenos">448</span></a>            <span class="c1"># just skip this loop.</span>
</span><span id="SearchEngine-449"><a href="#SearchEngine-449"><span class="linenos">449</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">njobs_target</span> <span class="o">-</span> <span class="n">source_db</span><span class="o">.</span><span class="n">nprefect_flow_runs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)):</span>
</span><span id="SearchEngine-450"><a href="#SearchEngine-450"><span class="linenos">450</span></a>
</span><span id="SearchEngine-451"><a href="#SearchEngine-451"><span class="linenos">451</span></a>                <span class="c1"># now we need to make a new individual and submit it!</span>
</span><span id="SearchEngine-452"><a href="#SearchEngine-452"><span class="linenos">452</span></a>                <span class="n">parent_ids</span><span class="p">,</span> <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_new_structure</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine-453"><a href="#SearchEngine-453"><span class="linenos">453</span></a>
</span><span id="SearchEngine-454"><a href="#SearchEngine-454"><span class="linenos">454</span></a>                <span class="c1"># sometimes we fail to make a structure with the source. In cases</span>
</span><span id="SearchEngine-455"><a href="#SearchEngine-455"><span class="linenos">455</span></a>                <span class="c1"># like this, we warn the user, but just move on. This means</span>
</span><span id="SearchEngine-456"><a href="#SearchEngine-456"><span class="linenos">456</span></a>                <span class="c1"># we will be short of our steady-state target. The warning for</span>
</span><span id="SearchEngine-457"><a href="#SearchEngine-457"><span class="linenos">457</span></a>                <span class="c1"># this is done inside _make_new_structure</span>
</span><span id="SearchEngine-458"><a href="#SearchEngine-458"><span class="linenos">458</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span><span class="p">:</span>
</span><span id="SearchEngine-459"><a href="#SearchEngine-459"><span class="linenos">459</span></a>                    <span class="k">break</span>
</span><span id="SearchEngine-460"><a href="#SearchEngine-460"><span class="linenos">460</span></a>
</span><span id="SearchEngine-461"><a href="#SearchEngine-461"><span class="linenos">461</span></a>                <span class="c1"># submit the structure workflow</span>
</span><span id="SearchEngine-462"><a href="#SearchEngine-462"><span class="linenos">462</span></a>                <span class="c1"># Note, we only pass the workflow_command if it&#39;s been supplied.</span>
</span><span id="SearchEngine-463"><a href="#SearchEngine-463"><span class="linenos">463</span></a>                <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchEngine-464"><a href="#SearchEngine-464"><span class="linenos">464</span></a>                    <span class="p">{</span><span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="SearchEngine-465"><a href="#SearchEngine-465"><span class="linenos">465</span></a>                <span class="p">)</span>
</span><span id="SearchEngine-466"><a href="#SearchEngine-466"><span class="linenos">466</span></a>                <span class="n">flow_run_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">run_cloud</span><span class="p">(</span>
</span><span id="SearchEngine-467"><a href="#SearchEngine-467"><span class="linenos">467</span></a>                    <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
</span><span id="SearchEngine-468"><a href="#SearchEngine-468"><span class="linenos">468</span></a>                    <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
</span><span id="SearchEngine-469"><a href="#SearchEngine-469"><span class="linenos">469</span></a>                <span class="p">)</span>
</span><span id="SearchEngine-470"><a href="#SearchEngine-470"><span class="linenos">470</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Submitted workflow run to prefect cloud.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-471"><a href="#SearchEngine-471"><span class="linenos">471</span></a>
</span><span id="SearchEngine-472"><a href="#SearchEngine-472"><span class="linenos">472</span></a>                <span class="c1"># Attached the flow_run_id to our source so we know how many</span>
</span><span id="SearchEngine-473"><a href="#SearchEngine-473"><span class="linenos">473</span></a>                <span class="c1"># associated jobs are running.</span>
</span><span id="SearchEngine-474"><a href="#SearchEngine-474"><span class="linenos">474</span></a>                <span class="n">source_db</span><span class="o">.</span><span class="n">prefect_flow_run_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">)</span>
</span><span id="SearchEngine-475"><a href="#SearchEngine-475"><span class="linenos">475</span></a>                <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine-476"><a href="#SearchEngine-476"><span class="linenos">476</span></a>
</span><span id="SearchEngine-477"><a href="#SearchEngine-477"><span class="linenos">477</span></a>                <span class="c1"># update the source on the calculation</span>
</span><span id="SearchEngine-478"><a href="#SearchEngine-478"><span class="linenos">478</span></a>                <span class="c1"># TODO: use the flow run id from above to grab the calc</span>
</span><span id="SearchEngine-479"><a href="#SearchEngine-479"><span class="linenos">479</span></a>                <span class="n">calculation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_datatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="SearchEngine-480"><a href="#SearchEngine-480"><span class="linenos">480</span></a>                    <span class="n">prefect_flow_run_id</span><span class="o">=</span><span class="n">flow_run_id</span>
</span><span id="SearchEngine-481"><a href="#SearchEngine-481"><span class="linenos">481</span></a>                <span class="p">)</span>
</span><span id="SearchEngine-482"><a href="#SearchEngine-482"><span class="linenos">482</span></a>                <span class="n">calculation</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SearchEngine-483"><a href="#SearchEngine-483"><span class="linenos">483</span></a>                <span class="n">calculation</span><span class="o">.</span><span class="n">source_id</span> <span class="o">=</span> <span class="n">parent_ids</span>
</span><span id="SearchEngine-484"><a href="#SearchEngine-484"><span class="linenos">484</span></a>                <span class="n">calculation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine-485"><a href="#SearchEngine-485"><span class="linenos">485</span></a>
</span><span id="SearchEngine-486"><a href="#SearchEngine-486"><span class="linenos">486</span></a>    <span class="k">def</span> <span class="nf">_make_new_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SearchEngine-487"><a href="#SearchEngine-487"><span class="linenos">487</span></a>
</span><span id="SearchEngine-488"><a href="#SearchEngine-488"><span class="linenos">488</span></a>        <span class="c1"># check if we have a transformation or a creator</span>
</span><span id="SearchEngine-489"><a href="#SearchEngine-489"><span class="linenos">489</span></a>        <span class="c1"># OPTIMIZE: is there a faster way? check subclass maybe?</span>
</span><span id="SearchEngine-490"><a href="#SearchEngine-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="s2">&quot;transformation&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
</span><span id="SearchEngine-491"><a href="#SearchEngine-491"><span class="linenos">491</span></a>            <span class="n">is_transformation</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SearchEngine-492"><a href="#SearchEngine-492"><span class="linenos">492</span></a>        <span class="k">elif</span> <span class="s2">&quot;creator&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
</span><span id="SearchEngine-493"><a href="#SearchEngine-493"><span class="linenos">493</span></a>            <span class="n">is_transformation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SearchEngine-494"><a href="#SearchEngine-494"><span class="linenos">494</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchEngine-495"><a href="#SearchEngine-495"><span class="linenos">495</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="SearchEngine-496"><a href="#SearchEngine-496"><span class="linenos">496</span></a>                <span class="s2">&quot;Make sure your steady-state sources are either creators or transformations!&quot;</span>
</span><span id="SearchEngine-497"><a href="#SearchEngine-497"><span class="linenos">497</span></a>                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not meet this requirement.&quot;</span>
</span><span id="SearchEngine-498"><a href="#SearchEngine-498"><span class="linenos">498</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-499"><a href="#SearchEngine-499"><span class="linenos">499</span></a>
</span><span id="SearchEngine-500"><a href="#SearchEngine-500"><span class="linenos">500</span></a>        <span class="c1"># transformations require that we have completed structures in the</span>
</span><span id="SearchEngine-501"><a href="#SearchEngine-501"><span class="linenos">501</span></a>        <span class="c1"># database. We want to wait until there&#39;s a set amount before</span>
</span><span id="SearchEngine-502"><a href="#SearchEngine-502"><span class="linenos">502</span></a>        <span class="c1"># we start mutating the best. We check that here.</span>
</span><span id="SearchEngine-503"><a href="#SearchEngine-503"><span class="linenos">503</span></a>        <span class="k">if</span> <span class="n">is_transformation</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="SearchEngine-504"><a href="#SearchEngine-504"><span class="linenos">504</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfirst_generation</span>
</span><span id="SearchEngine-505"><a href="#SearchEngine-505"><span class="linenos">505</span></a>        <span class="p">):</span>
</span><span id="SearchEngine-506"><a href="#SearchEngine-506"><span class="linenos">506</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-507"><a href="#SearchEngine-507"><span class="linenos">507</span></a>                <span class="s2">&quot;Search isn&#39;t ready for transformations yet.&quot;</span>
</span><span id="SearchEngine-508"><a href="#SearchEngine-508"><span class="linenos">508</span></a>                <span class="sa">f</span><span class="s2">&quot; Skipping </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SearchEngine-509"><a href="#SearchEngine-509"><span class="linenos">509</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-510"><a href="#SearchEngine-510"><span class="linenos">510</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="SearchEngine-511"><a href="#SearchEngine-511"><span class="linenos">511</span></a>
</span><span id="SearchEngine-512"><a href="#SearchEngine-512"><span class="linenos">512</span></a>        <span class="c1"># Until we get a new valid structure (or run out of attempts), keep trying</span>
</span><span id="SearchEngine-513"><a href="#SearchEngine-513"><span class="linenos">513</span></a>        <span class="c1"># with our given source. Assume we don&#39;t have a valid structure until</span>
</span><span id="SearchEngine-514"><a href="#SearchEngine-514"><span class="linenos">514</span></a>        <span class="c1"># proven otherwise</span>
</span><span id="SearchEngine-515"><a href="#SearchEngine-515"><span class="linenos">515</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to create a structure with </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-516"><a href="#SearchEngine-516"><span class="linenos">516</span></a>        <span class="n">new_structure</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SearchEngine-517"><a href="#SearchEngine-517"><span class="linenos">517</span></a>        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SearchEngine-518"><a href="#SearchEngine-518"><span class="linenos">518</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">new_structure</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="o">&lt;=</span> <span class="n">max_attempts</span><span class="p">:</span>
</span><span id="SearchEngine-519"><a href="#SearchEngine-519"><span class="linenos">519</span></a>            <span class="c1"># add an attempt</span>
</span><span id="SearchEngine-520"><a href="#SearchEngine-520"><span class="linenos">520</span></a>            <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SearchEngine-521"><a href="#SearchEngine-521"><span class="linenos">521</span></a>            <span class="k">if</span> <span class="n">is_transformation</span><span class="p">:</span>
</span><span id="SearchEngine-522"><a href="#SearchEngine-522"><span class="linenos">522</span></a>                <span class="c1"># grab parent structures using the selection method</span>
</span><span id="SearchEngine-523"><a href="#SearchEngine-523"><span class="linenos">523</span></a>                <span class="n">parent_ids</span><span class="p">,</span> <span class="n">parent_structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_parents</span><span class="p">(</span>
</span><span id="SearchEngine-524"><a href="#SearchEngine-524"><span class="linenos">524</span></a>                    <span class="n">nselect</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">ninput</span>
</span><span id="SearchEngine-525"><a href="#SearchEngine-525"><span class="linenos">525</span></a>                <span class="p">)</span>
</span><span id="SearchEngine-526"><a href="#SearchEngine-526"><span class="linenos">526</span></a>                <span class="c1"># make a new structure</span>
</span><span id="SearchEngine-527"><a href="#SearchEngine-527"><span class="linenos">527</span></a>                <span class="n">new_structure</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">apply_transformation</span><span class="p">(</span><span class="n">parent_structures</span><span class="p">)</span>
</span><span id="SearchEngine-528"><a href="#SearchEngine-528"><span class="linenos">528</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_transformation</span><span class="p">:</span>  <span class="c1"># if it&#39;s a creator</span>
</span><span id="SearchEngine-529"><a href="#SearchEngine-529"><span class="linenos">529</span></a>                <span class="n">parent_ids</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SearchEngine-530"><a href="#SearchEngine-530"><span class="linenos">530</span></a>                <span class="c1"># make a new structure</span>
</span><span id="SearchEngine-531"><a href="#SearchEngine-531"><span class="linenos">531</span></a>                <span class="n">new_structure</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">create_structure</span><span class="p">()</span>
</span><span id="SearchEngine-532"><a href="#SearchEngine-532"><span class="linenos">532</span></a>
</span><span id="SearchEngine-533"><a href="#SearchEngine-533"><span class="linenos">533</span></a>            <span class="c1"># check to see if the structure is new and unique so that we don&#39;t</span>
</span><span id="SearchEngine-534"><a href="#SearchEngine-534"><span class="linenos">534</span></a>            <span class="c1"># have any repeat calculations.</span>
</span><span id="SearchEngine-535"><a href="#SearchEngine-535"><span class="linenos">535</span></a>            <span class="k">if</span> <span class="n">new_structure</span><span class="p">:</span>
</span><span id="SearchEngine-536"><a href="#SearchEngine-536"><span class="linenos">536</span></a>                <span class="c1"># this will return false if the structure is NOT unique</span>
</span><span id="SearchEngine-537"><a href="#SearchEngine-537"><span class="linenos">537</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span><span class="o">.</span><span class="n">check_structure</span><span class="p">(</span><span class="n">new_structure</span><span class="p">):</span>
</span><span id="SearchEngine-538"><a href="#SearchEngine-538"><span class="linenos">538</span></a>                    <span class="c1"># if it is not unique, we can throw away the structure and</span>
</span><span id="SearchEngine-539"><a href="#SearchEngine-539"><span class="linenos">539</span></a>                    <span class="c1"># try the loop again.</span>
</span><span id="SearchEngine-540"><a href="#SearchEngine-540"><span class="linenos">540</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated structure is not unique. Trying again.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-541"><a href="#SearchEngine-541"><span class="linenos">541</span></a>                    <span class="n">new_structure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SearchEngine-542"><a href="#SearchEngine-542"><span class="linenos">542</span></a>
</span><span id="SearchEngine-543"><a href="#SearchEngine-543"><span class="linenos">543</span></a>        <span class="c1"># see if we got a structure or if we hit the max attempts and there&#39;s</span>
</span><span id="SearchEngine-544"><a href="#SearchEngine-544"><span class="linenos">544</span></a>        <span class="c1"># a serious problem!</span>
</span><span id="SearchEngine-545"><a href="#SearchEngine-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_structure</span><span class="p">:</span>
</span><span id="SearchEngine-546"><a href="#SearchEngine-546"><span class="linenos">546</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine-547"><a href="#SearchEngine-547"><span class="linenos">547</span></a>                <span class="s2">&quot;Failed to create a structure! Consider changing your settings or&quot;</span>
</span><span id="SearchEngine-548"><a href="#SearchEngine-548"><span class="linenos">548</span></a>                <span class="s2">&quot; contact our team for help.&quot;</span>
</span><span id="SearchEngine-549"><a href="#SearchEngine-549"><span class="linenos">549</span></a>            <span class="p">)</span>
</span><span id="SearchEngine-550"><a href="#SearchEngine-550"><span class="linenos">550</span></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="SearchEngine-551"><a href="#SearchEngine-551"><span class="linenos">551</span></a>
</span><span id="SearchEngine-552"><a href="#SearchEngine-552"><span class="linenos">552</span></a>        <span class="c1"># Otherwise we were successful</span>
</span><span id="SearchEngine-553"><a href="#SearchEngine-553"><span class="linenos">553</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creation Successful.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-554"><a href="#SearchEngine-554"><span class="linenos">554</span></a>
</span><span id="SearchEngine-555"><a href="#SearchEngine-555"><span class="linenos">555</span></a>        <span class="c1"># return the structure and its parents</span>
</span><span id="SearchEngine-556"><a href="#SearchEngine-556"><span class="linenos">556</span></a>        <span class="k">return</span> <span class="n">parent_ids</span><span class="p">,</span> <span class="n">new_structure</span>
</span><span id="SearchEngine-557"><a href="#SearchEngine-557"><span class="linenos">557</span></a>
</span><span id="SearchEngine-558"><a href="#SearchEngine-558"><span class="linenos">558</span></a>    <span class="k">def</span> <span class="nf">_select_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nselect</span><span class="p">):</span>
</span><span id="SearchEngine-559"><a href="#SearchEngine-559"><span class="linenos">559</span></a>
</span><span id="SearchEngine-560"><a href="#SearchEngine-560"><span class="linenos">560</span></a>        <span class="c1"># our selectors just require a dataframe where we specify the fitness</span>
</span><span id="SearchEngine-561"><a href="#SearchEngine-561"><span class="linenos">561</span></a>        <span class="c1"># column. So we query our individuals database to give this as an input.</span>
</span><span id="SearchEngine-562"><a href="#SearchEngine-562"><span class="linenos">562</span></a>        <span class="n">individuals_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
</span><span id="SearchEngine-563"><a href="#SearchEngine-563"><span class="linenos">563</span></a>            <span class="s2">&quot;energy_per_atom&quot;</span>
</span><span id="SearchEngine-564"><a href="#SearchEngine-564"><span class="linenos">564</span></a>        <span class="p">)[:</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</span><span id="SearchEngine-565"><a href="#SearchEngine-565"><span class="linenos">565</span></a>        <span class="c1"># NOTE: I assume we&#39;ll never need more than the best 200 structures, which</span>
</span><span id="SearchEngine-566"><a href="#SearchEngine-566"><span class="linenos">566</span></a>        <span class="c1"># may not be true in special cases.</span>
</span><span id="SearchEngine-567"><a href="#SearchEngine-567"><span class="linenos">567</span></a>
</span><span id="SearchEngine-568"><a href="#SearchEngine-568"><span class="linenos">568</span></a>        <span class="c1"># From these individuals, select our parent structures</span>
</span><span id="SearchEngine-569"><a href="#SearchEngine-569"><span class="linenos">569</span></a>        <span class="n">parents_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
</span><span id="SearchEngine-570"><a href="#SearchEngine-570"><span class="linenos">570</span></a>            <span class="n">nselect</span><span class="p">,</span>
</span><span id="SearchEngine-571"><a href="#SearchEngine-571"><span class="linenos">571</span></a>            <span class="n">individuals_df</span><span class="p">,</span>
</span><span id="SearchEngine-572"><a href="#SearchEngine-572"><span class="linenos">572</span></a>            <span class="s2">&quot;energy_per_atom&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-573"><a href="#SearchEngine-573"><span class="linenos">573</span></a>        <span class="p">)</span>
</span><span id="SearchEngine-574"><a href="#SearchEngine-574"><span class="linenos">574</span></a>
</span><span id="SearchEngine-575"><a href="#SearchEngine-575"><span class="linenos">575</span></a>        <span class="c1"># grab the id column of the parents and convert it to a list</span>
</span><span id="SearchEngine-576"><a href="#SearchEngine-576"><span class="linenos">576</span></a>        <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">parents_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="SearchEngine-577"><a href="#SearchEngine-577"><span class="linenos">577</span></a>
</span><span id="SearchEngine-578"><a href="#SearchEngine-578"><span class="linenos">578</span></a>        <span class="c1"># Now lets grab these structures from our database and convert them</span>
</span><span id="SearchEngine-579"><a href="#SearchEngine-579"><span class="linenos">579</span></a>        <span class="c1"># to a list of pymatgen structures.</span>
</span><span id="SearchEngine-580"><a href="#SearchEngine-580"><span class="linenos">580</span></a>        <span class="c1"># We have to make separate queries for this instead of doing &quot;id__in=parent_ids&quot;.</span>
</span><span id="SearchEngine-581"><a href="#SearchEngine-581"><span class="linenos">581</span></a>        <span class="c1"># This is because (1) order may be important and (2) we may have duplicate</span>
</span><span id="SearchEngine-582"><a href="#SearchEngine-582"><span class="linenos">582</span></a>        <span class="c1"># entries. For example, a hereditary mutation can request parent ids of [123,123]</span>
</span><span id="SearchEngine-583"><a href="#SearchEngine-583"><span class="linenos">583</span></a>        <span class="c1"># in which case we want to give the same input structure twice!</span>
</span><span id="SearchEngine-584"><a href="#SearchEngine-584"><span class="linenos">584</span></a>        <span class="n">parent_structures</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine-585"><a href="#SearchEngine-585"><span class="linenos">585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals_completed</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s2">&quot;structure_string&quot;</span><span class="p">)</span>
</span><span id="SearchEngine-586"><a href="#SearchEngine-586"><span class="linenos">586</span></a>            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">)</span>
</span><span id="SearchEngine-587"><a href="#SearchEngine-587"><span class="linenos">587</span></a>            <span class="o">.</span><span class="n">to_toolkit</span><span class="p">()</span>
</span><span id="SearchEngine-588"><a href="#SearchEngine-588"><span class="linenos">588</span></a>            <span class="k">for</span> <span class="n">parent_id</span> <span class="ow">in</span> <span class="n">parent_ids</span>
</span><span id="SearchEngine-589"><a href="#SearchEngine-589"><span class="linenos">589</span></a>        <span class="p">]</span>
</span><span id="SearchEngine-590"><a href="#SearchEngine-590"><span class="linenos">590</span></a>
</span><span id="SearchEngine-591"><a href="#SearchEngine-591"><span class="linenos">591</span></a>        <span class="c1"># When there&#39;s only one structure selected we return the structure and</span>
</span><span id="SearchEngine-592"><a href="#SearchEngine-592"><span class="linenos">592</span></a>        <span class="c1"># id independently -- not within a list</span>
</span><span id="SearchEngine-593"><a href="#SearchEngine-593"><span class="linenos">593</span></a>        <span class="k">if</span> <span class="n">nselect</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SearchEngine-594"><a href="#SearchEngine-594"><span class="linenos">594</span></a>            <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">parent_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SearchEngine-595"><a href="#SearchEngine-595"><span class="linenos">595</span></a>            <span class="n">parent_structures</span> <span class="o">=</span> <span class="n">parent_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SearchEngine-596"><a href="#SearchEngine-596"><span class="linenos">596</span></a>
</span><span id="SearchEngine-597"><a href="#SearchEngine-597"><span class="linenos">597</span></a>        <span class="c1"># for record keeping, we also want to return the ids for each structure</span>
</span><span id="SearchEngine-598"><a href="#SearchEngine-598"><span class="linenos">598</span></a>        <span class="k">return</span> <span class="n">parent_ids</span><span class="p">,</span> <span class="n">parent_structures</span>
</span><span id="SearchEngine-599"><a href="#SearchEngine-599"><span class="linenos">599</span></a>
</span><span id="SearchEngine-600"><a href="#SearchEngine-600"><span class="linenos">600</span></a>    <span class="k">def</span> <span class="nf">_init_common_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_str</span><span class="p">):</span>
</span><span id="SearchEngine-601"><a href="#SearchEngine-601"><span class="linenos">601</span></a>
</span><span id="SearchEngine-602"><a href="#SearchEngine-602"><span class="linenos">602</span></a>        <span class="c1"># CREATORS</span>
</span><span id="SearchEngine-603"><a href="#SearchEngine-603"><span class="linenos">603</span></a>        <span class="k">if</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="SearchEngine-604"><a href="#SearchEngine-604"><span class="linenos">604</span></a>            <span class="s2">&quot;RandomSymStructure&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-605"><a href="#SearchEngine-605"><span class="linenos">605</span></a>            <span class="s2">&quot;PyXtalStructure&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-606"><a href="#SearchEngine-606"><span class="linenos">606</span></a>        <span class="p">]:</span>
</span><span id="SearchEngine-607"><a href="#SearchEngine-607"><span class="linenos">607</span></a>            <span class="n">creator_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">creation_module</span><span class="p">,</span> <span class="n">class_str</span><span class="p">)</span>
</span><span id="SearchEngine-608"><a href="#SearchEngine-608"><span class="linenos">608</span></a>            <span class="k">return</span> <span class="n">creator_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
</span><span id="SearchEngine-609"><a href="#SearchEngine-609"><span class="linenos">609</span></a>
</span><span id="SearchEngine-610"><a href="#SearchEngine-610"><span class="linenos">610</span></a>        <span class="c1"># TRANSFORMATIONS</span>
</span><span id="SearchEngine-611"><a href="#SearchEngine-611"><span class="linenos">611</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="SearchEngine-612"><a href="#SearchEngine-612"><span class="linenos">612</span></a>            <span class="s2">&quot;from_ase.Heredity&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-613"><a href="#SearchEngine-613"><span class="linenos">613</span></a>            <span class="s2">&quot;from_ase.SoftMutation&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-614"><a href="#SearchEngine-614"><span class="linenos">614</span></a>            <span class="s2">&quot;from_ase.MirrorMutation&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-615"><a href="#SearchEngine-615"><span class="linenos">615</span></a>            <span class="s2">&quot;from_ase.LatticeStrain&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-616"><a href="#SearchEngine-616"><span class="linenos">616</span></a>            <span class="s2">&quot;from_ase.RotationalMutation&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-617"><a href="#SearchEngine-617"><span class="linenos">617</span></a>            <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-618"><a href="#SearchEngine-618"><span class="linenos">618</span></a>            <span class="s2">&quot;from_ase.CoordinatePerturbation&quot;</span><span class="p">,</span>
</span><span id="SearchEngine-619"><a href="#SearchEngine-619"><span class="linenos">619</span></a>        <span class="p">]:</span>
</span><span id="SearchEngine-620"><a href="#SearchEngine-620"><span class="linenos">620</span></a>            <span class="c1"># all start with &quot;from_ase&quot; so I assume that import for now</span>
</span><span id="SearchEngine-621"><a href="#SearchEngine-621"><span class="linenos">621</span></a>            <span class="n">ase_class_str</span> <span class="o">=</span> <span class="n">class_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SearchEngine-622"><a href="#SearchEngine-622"><span class="linenos">622</span></a>            <span class="n">mutation_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transform_module</span><span class="p">,</span> <span class="n">ase_class_str</span><span class="p">)</span>
</span><span id="SearchEngine-623"><a href="#SearchEngine-623"><span class="linenos">623</span></a>            <span class="k">return</span> <span class="n">mutation_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">)</span>
</span><span id="SearchEngine-624"><a href="#SearchEngine-624"><span class="linenos">624</span></a>
</span><span id="SearchEngine-625"><a href="#SearchEngine-625"><span class="linenos">625</span></a>        <span class="c1"># !!! There aren&#39;t any common transformations that don&#39;t accept composition</span>
</span><span id="SearchEngine-626"><a href="#SearchEngine-626"><span class="linenos">626</span></a>        <span class="c1"># as an input, but I expect this to change in the future.</span>
</span><span id="SearchEngine-627"><a href="#SearchEngine-627"><span class="linenos">627</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="p">[]:</span>
</span><span id="SearchEngine-628"><a href="#SearchEngine-628"><span class="linenos">628</span></a>            <span class="n">mutation_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transform_module</span><span class="p">,</span> <span class="n">class_str</span><span class="p">)</span>
</span><span id="SearchEngine-629"><a href="#SearchEngine-629"><span class="linenos">629</span></a>            <span class="k">return</span> <span class="n">mutation_class</span><span class="p">()</span>
</span><span id="SearchEngine-630"><a href="#SearchEngine-630"><span class="linenos">630</span></a>
</span><span id="SearchEngine-631"><a href="#SearchEngine-631"><span class="linenos">631</span></a>        <span class="c1"># These are commonly used single-shot sources</span>
</span><span id="SearchEngine-632"><a href="#SearchEngine-632"><span class="linenos">632</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;prototypes_aflow&quot;</span><span class="p">:</span>
</span><span id="SearchEngine-633"><a href="#SearchEngine-633"><span class="linenos">633</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="SearchEngine-634"><a href="#SearchEngine-634"><span class="linenos">634</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;substitution&quot;</span><span class="p">:</span>
</span><span id="SearchEngine-635"><a href="#SearchEngine-635"><span class="linenos">635</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="SearchEngine-636"><a href="#SearchEngine-636"><span class="linenos">636</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;third_party_structures&quot;</span><span class="p">:</span>
</span><span id="SearchEngine-637"><a href="#SearchEngine-637"><span class="linenos">637</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="SearchEngine-638"><a href="#SearchEngine-638"><span class="linenos">638</span></a>        <span class="k">elif</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;third_party_substitution&quot;</span><span class="p">:</span>
</span><span id="SearchEngine-639"><a href="#SearchEngine-639"><span class="linenos">639</span></a>            <span class="k">pass</span>  <span class="c1"># TODO</span>
</span><span id="SearchEngine-640"><a href="#SearchEngine-640"><span class="linenos">640</span></a>
</span><span id="SearchEngine-641"><a href="#SearchEngine-641"><span class="linenos">641</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchEngine-642"><a href="#SearchEngine-642"><span class="linenos">642</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="SearchEngine-643"><a href="#SearchEngine-643"><span class="linenos">643</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_str</span><span class="si">}</span><span class="s2"> is not recognized as a common input. Make sure you&quot;</span>
</span><span id="SearchEngine-644"><a href="#SearchEngine-644"><span class="linenos">644</span></a>                <span class="s2">&quot;don&#39;t have any typos, and if you are using a custom class, provide&quot;</span>
</span><span id="SearchEngine-645"><a href="#SearchEngine-645"><span class="linenos">645</span></a>                <span class="s2">&quot;your input as an object.&quot;</span>
</span><span id="SearchEngine-646"><a href="#SearchEngine-646"><span class="linenos">646</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p><strong>WARNING</strong> This search engine assumes you have properly configured
Prefect Cloud and a cloud database backend (e.g. Postgres). In the future,
we will accommodate local runs and other backends.</p>

<p>This class is the entry point for predicting crystal structures with an
evolutionary search algorithm.</p>

<p>Once you initialize a SearchEngine with a composition (and any other
optional parameters), you simply need to call the run() method to start
the search:</p>

<div class="pdoc-code codehilite"><pre><span></span><code>    <span class="kn">from</span> <span class="nn"><a href="../../structure_prediction.html">simmate.toolkit.structure_prediction</a></span> <span class="kn">import</span> <span class="n">SearchEngine</span>

    <span class="n">search_engine</span> <span class="o">=</span> <span class="n">SearchEngine</span><span class="p">(</span>
        <span class="n">composition</span><span class="o">=</span><span class="s2">&quot;C4&quot;</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WarWulf&quot;</span><span class="p">],</span>  <span class="c1"># optional</span>
        <span class="n">workflow_command</span><span class="o">=</span><span class="s2">&quot;mpirun -n 8 vasp_std &gt; vasp.out&quot;</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="p">)</span>

    <span class="n">search</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>This class is only for creating (or continuing) searches. If you only want
to view results, you should instead look directly at the database table for
previously ran searches:</p>

<div class="pdoc-code codehilite"><pre><span></span><code>   <span class="kn">from</span> <span class="nn">simmate.shortcuts</span> <span class="kn">import</span> <span class="n">SearchResults</span>

   <span class="n">search_results</span> <span class="o">=</span> <span class="n">SearchResults</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="s2">&quot;Sr4 Si4 N8&quot;</span><span class="p">)</span>
</code></pre></div>

<p>If you start a separate terminal from where a search is running, you can
actually use this table to view results WHILE the search is still running!</p>

<p>You can also access the search results from your search_engine object. So
once your search is finished or stopped, you can do:</p>

<div class="pdoc-code codehilite"><pre><span></span><code>   <span class="n">search_results</span> <span class="o">=</span> <span class="n">search_engine</span><span class="o">.</span><span class="n">search_datatable</span>
</code></pre></div>

<p>To better understand how to view/analyze results, please read the documentation
for the SearchResults class.</p>

<h4 id="alternative-codes-softwares">Alternative Codes &amp; Softwares</h4>

<p><a href="https://uspex-team.org/en">USPEX</a>,
<a href="https://github.com/xtalopt/XtalOpt">XtalOpt</a>,
<a href="http://www.calypso.cn/">CALYPSO</a>,
<a href="https://www.mtg.msm.cam.ac.uk/Codes/AIRSS">AIRSS</a>,
<a href="https://wiki.fysik.dtu.dk/ase/ase/ga/ga.html#module-ase.ga">ASE-GA</a>,
<a href="https://github.com/henniggroup/GASP-python">GASP</a></p>
</div>


                            <div id="SearchEngine.__init__" class="classattr">
                                        <input id="SearchEngine.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SearchEngine</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">composition</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><a href="../../base_data_types/composition.html#Composition">simmate.toolkit.base_data_types.composition.Composition</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">workflow</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><a href="../../../workflow_engine/workflow.html#Workflow">simmate.workflow_engine.workflow.Workflow</a></span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;relaxation.vasp.staged&#39;</span>,</span><span class="param">	<span class="n">workflow_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_structures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span>,</span><span class="param">	<span class="n">limit_best_survival</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span>,</span><span class="param">	<span class="n">singleshot_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">nfirst_generation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>,</span><span class="param">	<span class="n">nsteadystate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>,</span><span class="param">	<span class="n">steadystate_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;RandomSymStructure&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;from_ase.Heredity&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;from_ase.SoftMutation&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;from_ase.MirrorMutation&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;from_ase.LatticeStrain&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;from_ase.RotationalMutation&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;from_ase.AtomicPermutation&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;from_ase.CoordinatePerturbation&#39;</span><span class="p">)]</span>,</span><span class="param">	<span class="n">selector</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;TruncatedSelection&#39;</span></span>)</span>

                <label class="view-source-button" for="SearchEngine.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchEngine.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchEngine.__init__-85"><a href="#SearchEngine.__init__-85"><span class="linenos"> 85</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-86"><a href="#SearchEngine.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-87"><a href="#SearchEngine.__init__-87"><span class="linenos"> 87</span></a>        <span class="n">composition</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Composition</span><span class="p">],</span>
</span><span id="SearchEngine.__init__-88"><a href="#SearchEngine.__init__-88"><span class="linenos"> 88</span></a>        <span class="n">workflow</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Workflow</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relaxation.vasp.staged&quot;</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-89"><a href="#SearchEngine.__init__-89"><span class="linenos"> 89</span></a>        <span class="n">workflow_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-90"><a href="#SearchEngine.__init__-90"><span class="linenos"> 90</span></a>        <span class="n">max_structures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-91"><a href="#SearchEngine.__init__-91"><span class="linenos"> 91</span></a>        <span class="n">limit_best_survival</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-92"><a href="#SearchEngine.__init__-92"><span class="linenos"> 92</span></a>        <span class="n">singleshot_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="SearchEngine.__init__-93"><a href="#SearchEngine.__init__-93"><span class="linenos"> 93</span></a>        <span class="n">nfirst_generation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-94"><a href="#SearchEngine.__init__-94"><span class="linenos"> 94</span></a>        <span class="n">nsteadystate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-95"><a href="#SearchEngine.__init__-95"><span class="linenos"> 95</span></a>        <span class="n">steadystate_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine.__init__-96"><a href="#SearchEngine.__init__-96"><span class="linenos"> 96</span></a>            <span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;RandomSymStructure&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-97"><a href="#SearchEngine.__init__-97"><span class="linenos"> 97</span></a>            <span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;from_ase.Heredity&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-98"><a href="#SearchEngine.__init__-98"><span class="linenos"> 98</span></a>            <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;from_ase.SoftMutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-99"><a href="#SearchEngine.__init__-99"><span class="linenos"> 99</span></a>            <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;from_ase.MirrorMutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-100"><a href="#SearchEngine.__init__-100"><span class="linenos">100</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.LatticeStrain&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-101"><a href="#SearchEngine.__init__-101"><span class="linenos">101</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.RotationalMutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-102"><a href="#SearchEngine.__init__-102"><span class="linenos">102</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-103"><a href="#SearchEngine.__init__-103"><span class="linenos">103</span></a>            <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;from_ase.CoordinatePerturbation&quot;</span><span class="p">),</span>
</span><span id="SearchEngine.__init__-104"><a href="#SearchEngine.__init__-104"><span class="linenos">104</span></a>        <span class="p">],</span>
</span><span id="SearchEngine.__init__-105"><a href="#SearchEngine.__init__-105"><span class="linenos">105</span></a>        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TruncatedSelection&quot;</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-106"><a href="#SearchEngine.__init__-106"><span class="linenos">106</span></a>        <span class="c1"># TODO: maybe use **workflow_run_kwargs...?</span>
</span><span id="SearchEngine.__init__-107"><a href="#SearchEngine.__init__-107"><span class="linenos">107</span></a>    <span class="p">):</span>
</span><span id="SearchEngine.__init__-108"><a href="#SearchEngine.__init__-108"><span class="linenos">108</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SearchEngine.__init__-109"><a href="#SearchEngine.__init__-109"><span class="linenos">109</span></a><span class="sd">        Sets up the search engine and its settings.</span>
</span><span id="SearchEngine.__init__-110"><a href="#SearchEngine.__init__-110"><span class="linenos">110</span></a>
</span><span id="SearchEngine.__init__-111"><a href="#SearchEngine.__init__-111"><span class="linenos">111</span></a><span class="sd">        #### Parameters</span>
</span><span id="SearchEngine.__init__-112"><a href="#SearchEngine.__init__-112"><span class="linenos">112</span></a>
</span><span id="SearchEngine.__init__-113"><a href="#SearchEngine.__init__-113"><span class="linenos">113</span></a><span class="sd">        - `composition`:</span>
</span><span id="SearchEngine.__init__-114"><a href="#SearchEngine.__init__-114"><span class="linenos">114</span></a><span class="sd">            The composition to run the evolutionary search for. Note that the</span>
</span><span id="SearchEngine.__init__-115"><a href="#SearchEngine.__init__-115"><span class="linenos">115</span></a><span class="sd">            number of sites is fixed to what is set here. (Ca2N vs Ca4N2)</span>
</span><span id="SearchEngine.__init__-116"><a href="#SearchEngine.__init__-116"><span class="linenos">116</span></a>
</span><span id="SearchEngine.__init__-117"><a href="#SearchEngine.__init__-117"><span class="linenos">117</span></a><span class="sd">        - `workflow`:</span>
</span><span id="SearchEngine.__init__-118"><a href="#SearchEngine.__init__-118"><span class="linenos">118</span></a><span class="sd">            The workflow to run all individuals through. Note, the result_database</span>
</span><span id="SearchEngine.__init__-119"><a href="#SearchEngine.__init__-119"><span class="linenos">119</span></a><span class="sd">            of this workflow will be treated as the individuals in this search.</span>
</span><span id="SearchEngine.__init__-120"><a href="#SearchEngine.__init__-120"><span class="linenos">120</span></a><span class="sd">            The default is &quot;relaxation.vasp.staged&quot;</span>
</span><span id="SearchEngine.__init__-121"><a href="#SearchEngine.__init__-121"><span class="linenos">121</span></a>
</span><span id="SearchEngine.__init__-122"><a href="#SearchEngine.__init__-122"><span class="linenos">122</span></a><span class="sd">        - `workflow_command`:</span>
</span><span id="SearchEngine.__init__-123"><a href="#SearchEngine.__init__-123"><span class="linenos">123</span></a><span class="sd">            The command that will be passed to the workflow.run() method.</span>
</span><span id="SearchEngine.__init__-124"><a href="#SearchEngine.__init__-124"><span class="linenos">124</span></a>
</span><span id="SearchEngine.__init__-125"><a href="#SearchEngine.__init__-125"><span class="linenos">125</span></a><span class="sd">        - `max_structures`:</span>
</span><span id="SearchEngine.__init__-126"><a href="#SearchEngine.__init__-126"><span class="linenos">126</span></a><span class="sd">            The maximum number of individuals that will be calculated before</span>
</span><span id="SearchEngine.__init__-127"><a href="#SearchEngine.__init__-127"><span class="linenos">127</span></a><span class="sd">            stopping the search. The default is 3000.</span>
</span><span id="SearchEngine.__init__-128"><a href="#SearchEngine.__init__-128"><span class="linenos">128</span></a>
</span><span id="SearchEngine.__init__-129"><a href="#SearchEngine.__init__-129"><span class="linenos">129</span></a><span class="sd">        - `limit_best_survival`:</span>
</span><span id="SearchEngine.__init__-130"><a href="#SearchEngine.__init__-130"><span class="linenos">130</span></a><span class="sd">            The search is stopped when the best individual remains unbeaten for</span>
</span><span id="SearchEngine.__init__-131"><a href="#SearchEngine.__init__-131"><span class="linenos">131</span></a><span class="sd">            this number of new individuals. The default is 250.</span>
</span><span id="SearchEngine.__init__-132"><a href="#SearchEngine.__init__-132"><span class="linenos">132</span></a>
</span><span id="SearchEngine.__init__-133"><a href="#SearchEngine.__init__-133"><span class="linenos">133</span></a><span class="sd">        - `singleshot_sources`:</span>
</span><span id="SearchEngine.__init__-134"><a href="#SearchEngine.__init__-134"><span class="linenos">134</span></a><span class="sd">            TODO: This is not implemented yet</span>
</span><span id="SearchEngine.__init__-135"><a href="#SearchEngine.__init__-135"><span class="linenos">135</span></a>
</span><span id="SearchEngine.__init__-136"><a href="#SearchEngine.__init__-136"><span class="linenos">136</span></a><span class="sd">        - `nfirst_generation`:</span>
</span><span id="SearchEngine.__init__-137"><a href="#SearchEngine.__init__-137"><span class="linenos">137</span></a><span class="sd">            No mutations or &quot;child&quot; individuals will be carried out until this</span>
</span><span id="SearchEngine.__init__-138"><a href="#SearchEngine.__init__-138"><span class="linenos">138</span></a><span class="sd">            number of individuals have been calculated. The default is 20.</span>
</span><span id="SearchEngine.__init__-139"><a href="#SearchEngine.__init__-139"><span class="linenos">139</span></a>
</span><span id="SearchEngine.__init__-140"><a href="#SearchEngine.__init__-140"><span class="linenos">140</span></a><span class="sd">        - `nsteadystate`:</span>
</span><span id="SearchEngine.__init__-141"><a href="#SearchEngine.__init__-141"><span class="linenos">141</span></a><span class="sd">            The total number of individuals from steady-state sources that will</span>
</span><span id="SearchEngine.__init__-142"><a href="#SearchEngine.__init__-142"><span class="linenos">142</span></a><span class="sd">            be running/submitted at any given time. The default is 40.</span>
</span><span id="SearchEngine.__init__-143"><a href="#SearchEngine.__init__-143"><span class="linenos">143</span></a>
</span><span id="SearchEngine.__init__-144"><a href="#SearchEngine.__init__-144"><span class="linenos">144</span></a><span class="sd">        - `steadystate_sources`:</span>
</span><span id="SearchEngine.__init__-145"><a href="#SearchEngine.__init__-145"><span class="linenos">145</span></a><span class="sd">            A list of tuples where each tuple is (percent, source). The percent</span>
</span><span id="SearchEngine.__init__-146"><a href="#SearchEngine.__init__-146"><span class="linenos">146</span></a><span class="sd">            determines the number of steady stage calculations that will be</span>
</span><span id="SearchEngine.__init__-147"><a href="#SearchEngine.__init__-147"><span class="linenos">147</span></a><span class="sd">            running for this at any given time. For example, 0.25 means</span>
</span><span id="SearchEngine.__init__-148"><a href="#SearchEngine.__init__-148"><span class="linenos">148</span></a><span class="sd">            0.25*40=10 individuals will be running/submitted at all times. The</span>
</span><span id="SearchEngine.__init__-149"><a href="#SearchEngine.__init__-149"><span class="linenos">149</span></a><span class="sd">            source can be from either the toolkit.creator or toolkit.transformations</span>
</span><span id="SearchEngine.__init__-150"><a href="#SearchEngine.__init__-150"><span class="linenos">150</span></a><span class="sd">            modules. Don&#39;t change this default unless you know what you&#39;re doing!</span>
</span><span id="SearchEngine.__init__-151"><a href="#SearchEngine.__init__-151"><span class="linenos">151</span></a>
</span><span id="SearchEngine.__init__-152"><a href="#SearchEngine.__init__-152"><span class="linenos">152</span></a><span class="sd">        - `selector`:</span>
</span><span id="SearchEngine.__init__-153"><a href="#SearchEngine.__init__-153"><span class="linenos">153</span></a><span class="sd">            The defualt method to use for choosing the parent individual(s). The</span>
</span><span id="SearchEngine.__init__-154"><a href="#SearchEngine.__init__-154"><span class="linenos">154</span></a><span class="sd">            default is TruncatedSelection.</span>
</span><span id="SearchEngine.__init__-155"><a href="#SearchEngine.__init__-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchEngine.__init__-156"><a href="#SearchEngine.__init__-156"><span class="linenos">156</span></a>
</span><span id="SearchEngine.__init__-157"><a href="#SearchEngine.__init__-157"><span class="linenos">157</span></a>        <span class="c1"># make sure we were givent a Composition object, and if not, we have</span>
</span><span id="SearchEngine.__init__-158"><a href="#SearchEngine.__init__-158"><span class="linenos">158</span></a>        <span class="c1"># a string that should be converted to one.</span>
</span><span id="SearchEngine.__init__-159"><a href="#SearchEngine.__init__-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">Composition</span><span class="p">):</span>
</span><span id="SearchEngine.__init__-160"><a href="#SearchEngine.__init__-160"><span class="linenos">160</span></a>            <span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-161"><a href="#SearchEngine.__init__-161"><span class="linenos">161</span></a>
</span><span id="SearchEngine.__init__-162"><a href="#SearchEngine.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">composition</span>
</span><span id="SearchEngine.__init__-163"><a href="#SearchEngine.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_command</span> <span class="o">=</span> <span class="n">workflow_command</span>
</span><span id="SearchEngine.__init__-164"><a href="#SearchEngine.__init__-164"><span class="linenos">164</span></a>
</span><span id="SearchEngine.__init__-165"><a href="#SearchEngine.__init__-165"><span class="linenos">165</span></a>        <span class="c1"># TODO: consider grabbing these from the database so that we can update</span>
</span><span id="SearchEngine.__init__-166"><a href="#SearchEngine.__init__-166"><span class="linenos">166</span></a>        <span class="c1"># them at any point.</span>
</span><span id="SearchEngine.__init__-167"><a href="#SearchEngine.__init__-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">limit_best_survival</span> <span class="o">=</span> <span class="n">limit_best_survival</span>
</span><span id="SearchEngine.__init__-168"><a href="#SearchEngine.__init__-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_structures</span> <span class="o">=</span> <span class="n">max_structures</span>
</span><span id="SearchEngine.__init__-169"><a href="#SearchEngine.__init__-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsteadystate</span> <span class="o">=</span> <span class="n">nsteadystate</span>
</span><span id="SearchEngine.__init__-170"><a href="#SearchEngine.__init__-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nfirst_generation</span> <span class="o">=</span> <span class="n">nfirst_generation</span>
</span><span id="SearchEngine.__init__-171"><a href="#SearchEngine.__init__-171"><span class="linenos">171</span></a>
</span><span id="SearchEngine.__init__-172"><a href="#SearchEngine.__init__-172"><span class="linenos">172</span></a>        <span class="c1"># Initialize the selector</span>
</span><span id="SearchEngine.__init__-173"><a href="#SearchEngine.__init__-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">selector</span> <span class="o">==</span> <span class="s2">&quot;TruncatedSelection&quot;</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-174"><a href="#SearchEngine.__init__-174"><span class="linenos">174</span></a>            <span class="kn">from</span> <span class="nn">simmate.toolkit.structure_prediction.evolution.selectors</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="SearchEngine.__init__-175"><a href="#SearchEngine.__init__-175"><span class="linenos">175</span></a>                <span class="n">TruncatedSelection</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-176"><a href="#SearchEngine.__init__-176"><span class="linenos">176</span></a>            <span class="p">)</span>
</span><span id="SearchEngine.__init__-177"><a href="#SearchEngine.__init__-177"><span class="linenos">177</span></a>
</span><span id="SearchEngine.__init__-178"><a href="#SearchEngine.__init__-178"><span class="linenos">178</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">TruncatedSelection</span><span class="p">()</span>
</span><span id="SearchEngine.__init__-179"><a href="#SearchEngine.__init__-179"><span class="linenos">179</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># BUG</span>
</span><span id="SearchEngine.__init__-180"><a href="#SearchEngine.__init__-180"><span class="linenos">180</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We only support TruncatedSelection right now&quot;</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-181"><a href="#SearchEngine.__init__-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span>
</span><span id="SearchEngine.__init__-182"><a href="#SearchEngine.__init__-182"><span class="linenos">182</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-183"><a href="#SearchEngine.__init__-183"><span class="linenos">183</span></a>            <span class="s2">&quot;The default parent selection for mutations will use &quot;</span>
</span><span id="SearchEngine.__init__-184"><a href="#SearchEngine.__init__-184"><span class="linenos">184</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SearchEngine.__init__-185"><a href="#SearchEngine.__init__-185"><span class="linenos">185</span></a>        <span class="p">)</span>
</span><span id="SearchEngine.__init__-186"><a href="#SearchEngine.__init__-186"><span class="linenos">186</span></a>
</span><span id="SearchEngine.__init__-187"><a href="#SearchEngine.__init__-187"><span class="linenos">187</span></a>        <span class="c1"># Initialize the workflow if a string was given.</span>
</span><span id="SearchEngine.__init__-188"><a href="#SearchEngine.__init__-188"><span class="linenos">188</span></a>        <span class="c1"># Otherwise we should already have a workflow class.</span>
</span><span id="SearchEngine.__init__-189"><a href="#SearchEngine.__init__-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">workflow</span> <span class="o">==</span> <span class="s2">&quot;relaxation.vasp.staged&quot;</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-190"><a href="#SearchEngine.__init__-190"><span class="linenos">190</span></a>            <span class="kn">from</span> <span class="nn">simmate.workflows.relaxation</span> <span class="kn">import</span> <span class="n">Relaxation__Vasp__Staged</span>
</span><span id="SearchEngine.__init__-191"><a href="#SearchEngine.__init__-191"><span class="linenos">191</span></a>
</span><span id="SearchEngine.__init__-192"><a href="#SearchEngine.__init__-192"><span class="linenos">192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">Relaxation__Vasp__Staged</span>
</span><span id="SearchEngine.__init__-193"><a href="#SearchEngine.__init__-193"><span class="linenos">193</span></a>
</span><span id="SearchEngine.__init__-194"><a href="#SearchEngine.__init__-194"><span class="linenos">194</span></a>            <span class="c1"># Point to the structure datatable that we&#39;ll pull from</span>
</span><span id="SearchEngine.__init__-195"><a href="#SearchEngine.__init__-195"><span class="linenos">195</span></a>            <span class="c1"># BUG: For now, I assume its the results table of the workflow</span>
</span><span id="SearchEngine.__init__-196"><a href="#SearchEngine.__init__-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">individuals_datatable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">database_table</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-197"><a href="#SearchEngine.__init__-197"><span class="linenos">197</span></a>                <span class="s2">&quot;quality04relaxation&quot;</span>
</span><span id="SearchEngine.__init__-198"><a href="#SearchEngine.__init__-198"><span class="linenos">198</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">related_model</span>  <span class="c1"># gives quality04relaxation table</span>
</span><span id="SearchEngine.__init__-199"><a href="#SearchEngine.__init__-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">calculation_datatable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">database_table</span>
</span><span id="SearchEngine.__init__-200"><a href="#SearchEngine.__init__-200"><span class="linenos">200</span></a>            <span class="c1"># BUG: these need to be merged and moved outside this if statement</span>
</span><span id="SearchEngine.__init__-201"><a href="#SearchEngine.__init__-201"><span class="linenos">201</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-202"><a href="#SearchEngine.__init__-202"><span class="linenos">202</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-203"><a href="#SearchEngine.__init__-203"><span class="linenos">203</span></a>                <span class="s2">&quot;Only `relaxation.vasp.staged` is supported in early testing&quot;</span>
</span><span id="SearchEngine.__init__-204"><a href="#SearchEngine.__init__-204"><span class="linenos">204</span></a>            <span class="p">)</span>
</span><span id="SearchEngine.__init__-205"><a href="#SearchEngine.__init__-205"><span class="linenos">205</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-206"><a href="#SearchEngine.__init__-206"><span class="linenos">206</span></a>            <span class="sa">f</span><span class="s2">&quot;All individuals will be evaulated through the &quot;</span>
</span><span id="SearchEngine.__init__-207"><a href="#SearchEngine.__init__-207"><span class="linenos">207</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">name_full</span><span class="si">}</span><span class="s2"> workflow.&quot;</span>
</span><span id="SearchEngine.__init__-208"><a href="#SearchEngine.__init__-208"><span class="linenos">208</span></a>        <span class="p">)</span>
</span><span id="SearchEngine.__init__-209"><a href="#SearchEngine.__init__-209"><span class="linenos">209</span></a>        <span class="c1"># BUG: I&#39;ll need to rewrite this in the future bc I don&#39;t really account</span>
</span><span id="SearchEngine.__init__-210"><a href="#SearchEngine.__init__-210"><span class="linenos">210</span></a>        <span class="c1"># for other workflows yet. It would make sense that our workflow changes</span>
</span><span id="SearchEngine.__init__-211"><a href="#SearchEngine.__init__-211"><span class="linenos">211</span></a>        <span class="c1"># as the search progresses (e.g. we incorporate DeePMD relaxation once ready)</span>
</span><span id="SearchEngine.__init__-212"><a href="#SearchEngine.__init__-212"><span class="linenos">212</span></a>
</span><span id="SearchEngine.__init__-213"><a href="#SearchEngine.__init__-213"><span class="linenos">213</span></a>        <span class="c1"># Check if there is an existing search and grab it if so. Otherwise, add</span>
</span><span id="SearchEngine.__init__-214"><a href="#SearchEngine.__init__-214"><span class="linenos">214</span></a>        <span class="c1"># the search entry to the DB.</span>
</span><span id="SearchEngine.__init__-215"><a href="#SearchEngine.__init__-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="n">SearchDatatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="SearchEngine.__init__-216"><a href="#SearchEngine.__init__-216"><span class="linenos">216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span> <span class="o">=</span> <span class="n">SearchDatatable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-217"><a href="#SearchEngine.__init__-217"><span class="linenos">217</span></a>                <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-218"><a href="#SearchEngine.__init__-218"><span class="linenos">218</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="SearchEngine.__init__-219"><a href="#SearchEngine.__init__-219"><span class="linenos">219</span></a>            <span class="c1"># TODO: update, add logs, compare... I need to decide what to do here.</span>
</span><span id="SearchEngine.__init__-220"><a href="#SearchEngine.__init__-220"><span class="linenos">220</span></a>            <span class="c1"># also, run _check_stop_condition() to avoid unneccessary restart.</span>
</span><span id="SearchEngine.__init__-221"><a href="#SearchEngine.__init__-221"><span class="linenos">221</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-222"><a href="#SearchEngine.__init__-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span> <span class="o">=</span> <span class="n">SearchDatatable</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-223"><a href="#SearchEngine.__init__-223"><span class="linenos">223</span></a>                <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-224"><a href="#SearchEngine.__init__-224"><span class="linenos">224</span></a>                <span class="n">workflows</span><span class="o">=</span><span class="p">[</span>
</span><span id="SearchEngine.__init__-225"><a href="#SearchEngine.__init__-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">name_full</span>
</span><span id="SearchEngine.__init__-226"><a href="#SearchEngine.__init__-226"><span class="linenos">226</span></a>                <span class="p">],</span>  <span class="c1"># as a list bc we can add new ones later</span>
</span><span id="SearchEngine.__init__-227"><a href="#SearchEngine.__init__-227"><span class="linenos">227</span></a>                <span class="n">individuals_datatable_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">individuals_datatable</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-228"><a href="#SearchEngine.__init__-228"><span class="linenos">228</span></a>                <span class="n">max_structures</span><span class="o">=</span><span class="n">max_structures</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-229"><a href="#SearchEngine.__init__-229"><span class="linenos">229</span></a>                <span class="n">limit_best_survival</span><span class="o">=</span><span class="n">limit_best_survival</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-230"><a href="#SearchEngine.__init__-230"><span class="linenos">230</span></a>            <span class="p">)</span>
</span><span id="SearchEngine.__init__-231"><a href="#SearchEngine.__init__-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine.__init__-232"><a href="#SearchEngine.__init__-232"><span class="linenos">232</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-233"><a href="#SearchEngine.__init__-233"><span class="linenos">233</span></a>            <span class="s2">&quot;To track the progress while this search runs, you can use the following&quot;</span>
</span><span id="SearchEngine.__init__-234"><a href="#SearchEngine.__init__-234"><span class="linenos">234</span></a>            <span class="s2">&quot; in a separate python terminal:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine.__init__-235"><a href="#SearchEngine.__init__-235"><span class="linenos">235</span></a>            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">from simmate.shortcuts import SearchResults</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine.__init__-236"><a href="#SearchEngine.__init__-236"><span class="linenos">236</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">search = SearchResults.objects.get(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine.__init__-237"><a href="#SearchEngine.__init__-237"><span class="linenos">237</span></a>            <span class="sa">f</span><span class="s2">&quot;So your search ID is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="SearchEngine.__init__-238"><a href="#SearchEngine.__init__-238"><span class="linenos">238</span></a>            <span class="s2">&quot;View the documentation on the EvolutionarySearch datatable for more info.&quot;</span>
</span><span id="SearchEngine.__init__-239"><a href="#SearchEngine.__init__-239"><span class="linenos">239</span></a>        <span class="p">)</span>
</span><span id="SearchEngine.__init__-240"><a href="#SearchEngine.__init__-240"><span class="linenos">240</span></a>
</span><span id="SearchEngine.__init__-241"><a href="#SearchEngine.__init__-241"><span class="linenos">241</span></a>        <span class="c1"># Grab the list of singleshot sources that have been ran before</span>
</span><span id="SearchEngine.__init__-242"><a href="#SearchEngine.__init__-242"><span class="linenos">242</span></a>        <span class="c1"># and based off of that list, remove repeated sources</span>
</span><span id="SearchEngine.__init__-243"><a href="#SearchEngine.__init__-243"><span class="linenos">243</span></a>        <span class="n">past_singleshot_sources</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchEngine.__init__-244"><a href="#SearchEngine.__init__-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_singleshot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-245"><a href="#SearchEngine.__init__-245"><span class="linenos">245</span></a>            <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-246"><a href="#SearchEngine.__init__-246"><span class="linenos">246</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="SearchEngine.__init__-247"><a href="#SearchEngine.__init__-247"><span class="linenos">247</span></a>        <span class="p">)</span>
</span><span id="SearchEngine.__init__-248"><a href="#SearchEngine.__init__-248"><span class="linenos">248</span></a>        <span class="n">singleshot_sources</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine.__init__-249"><a href="#SearchEngine.__init__-249"><span class="linenos">249</span></a>            <span class="n">source</span>
</span><span id="SearchEngine.__init__-250"><a href="#SearchEngine.__init__-250"><span class="linenos">250</span></a>            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">singleshot_sources</span>
</span><span id="SearchEngine.__init__-251"><a href="#SearchEngine.__init__-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">past_singleshot_sources</span>
</span><span id="SearchEngine.__init__-252"><a href="#SearchEngine.__init__-252"><span class="linenos">252</span></a>        <span class="p">]</span>
</span><span id="SearchEngine.__init__-253"><a href="#SearchEngine.__init__-253"><span class="linenos">253</span></a>        <span class="c1"># BUG: what if I want to rerun any of these even though its been ran before?</span>
</span><span id="SearchEngine.__init__-254"><a href="#SearchEngine.__init__-254"><span class="linenos">254</span></a>        <span class="c1"># An example would be rerunning substituitions when new structures are available</span>
</span><span id="SearchEngine.__init__-255"><a href="#SearchEngine.__init__-255"><span class="linenos">255</span></a>
</span><span id="SearchEngine.__init__-256"><a href="#SearchEngine.__init__-256"><span class="linenos">256</span></a>        <span class="c1"># Initialize the single-shot sources</span>
</span><span id="SearchEngine.__init__-257"><a href="#SearchEngine.__init__-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine.__init__-258"><a href="#SearchEngine.__init__-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">singleshot_sources</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-259"><a href="#SearchEngine.__init__-259"><span class="linenos">259</span></a>
</span><span id="SearchEngine.__init__-260"><a href="#SearchEngine.__init__-260"><span class="linenos">260</span></a>            <span class="c1"># if we are given a string, we want initialize the class</span>
</span><span id="SearchEngine.__init__-261"><a href="#SearchEngine.__init__-261"><span class="linenos">261</span></a>            <span class="c1"># otherwise it should be a class alreadys</span>
</span><span id="SearchEngine.__init__-262"><a href="#SearchEngine.__init__-262"><span class="linenos">262</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-263"><a href="#SearchEngine.__init__-263"><span class="linenos">263</span></a>                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_common_class</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-264"><a href="#SearchEngine.__init__-264"><span class="linenos">264</span></a>
</span><span id="SearchEngine.__init__-265"><a href="#SearchEngine.__init__-265"><span class="linenos">265</span></a>            <span class="c1"># and add it to our final list</span>
</span><span id="SearchEngine.__init__-266"><a href="#SearchEngine.__init__-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-267"><a href="#SearchEngine.__init__-267"><span class="linenos">267</span></a>
</span><span id="SearchEngine.__init__-268"><a href="#SearchEngine.__init__-268"><span class="linenos">268</span></a>        <span class="c1"># Initialize the steady-state sources, which are given as a list of</span>
</span><span id="SearchEngine.__init__-269"><a href="#SearchEngine.__init__-269"><span class="linenos">269</span></a>        <span class="c1"># (proportion, class/class_str, kwargs) for each. As we go through these,</span>
</span><span id="SearchEngine.__init__-270"><a href="#SearchEngine.__init__-270"><span class="linenos">270</span></a>        <span class="c1"># we also collect the proportion list for them.</span>
</span><span id="SearchEngine.__init__-271"><a href="#SearchEngine.__init__-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine.__init__-272"><a href="#SearchEngine.__init__-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine.__init__-273"><a href="#SearchEngine.__init__-273"><span class="linenos">273</span></a>        <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">steadystate_sources</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-274"><a href="#SearchEngine.__init__-274"><span class="linenos">274</span></a>
</span><span id="SearchEngine.__init__-275"><a href="#SearchEngine.__init__-275"><span class="linenos">275</span></a>            <span class="c1"># There are certain transformation sources that don&#39;t work for single-element</span>
</span><span id="SearchEngine.__init__-276"><a href="#SearchEngine.__init__-276"><span class="linenos">276</span></a>            <span class="c1"># structures, so we check for this here and remove them.</span>
</span><span id="SearchEngine.__init__-277"><a href="#SearchEngine.__init__-277"><span class="linenos">277</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="SearchEngine.__init__-278"><a href="#SearchEngine.__init__-278"><span class="linenos">278</span></a>                <span class="s2">&quot;from_ase.AtomicPermutation&quot;</span>
</span><span id="SearchEngine.__init__-279"><a href="#SearchEngine.__init__-279"><span class="linenos">279</span></a>            <span class="p">]:</span>
</span><span id="SearchEngine.__init__-280"><a href="#SearchEngine.__init__-280"><span class="linenos">280</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-281"><a href="#SearchEngine.__init__-281"><span class="linenos">281</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> is not possible with single-element structures.&quot;</span>
</span><span id="SearchEngine.__init__-282"><a href="#SearchEngine.__init__-282"><span class="linenos">282</span></a>                    <span class="s2">&quot; This is being removed from your steadystate_sources.&quot;</span>
</span><span id="SearchEngine.__init__-283"><a href="#SearchEngine.__init__-283"><span class="linenos">283</span></a>                <span class="p">)</span>
</span><span id="SearchEngine.__init__-284"><a href="#SearchEngine.__init__-284"><span class="linenos">284</span></a>                <span class="k">continue</span>  <span class="c1"># skips to next source</span>
</span><span id="SearchEngine.__init__-285"><a href="#SearchEngine.__init__-285"><span class="linenos">285</span></a>
</span><span id="SearchEngine.__init__-286"><a href="#SearchEngine.__init__-286"><span class="linenos">286</span></a>            <span class="c1"># store proportion value</span>
</span><span id="SearchEngine.__init__-287"><a href="#SearchEngine.__init__-287"><span class="linenos">287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proportion</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-288"><a href="#SearchEngine.__init__-288"><span class="linenos">288</span></a>
</span><span id="SearchEngine.__init__-289"><a href="#SearchEngine.__init__-289"><span class="linenos">289</span></a>            <span class="c1"># if we are given a string, we want initialize the class</span>
</span><span id="SearchEngine.__init__-290"><a href="#SearchEngine.__init__-290"><span class="linenos">290</span></a>            <span class="c1"># otherwise it should be a class already</span>
</span><span id="SearchEngine.__init__-291"><a href="#SearchEngine.__init__-291"><span class="linenos">291</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-292"><a href="#SearchEngine.__init__-292"><span class="linenos">292</span></a>                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_common_class</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-293"><a href="#SearchEngine.__init__-293"><span class="linenos">293</span></a>            <span class="c1"># and add it to our final list</span>
</span><span id="SearchEngine.__init__-294"><a href="#SearchEngine.__init__-294"><span class="linenos">294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-295"><a href="#SearchEngine.__init__-295"><span class="linenos">295</span></a>
</span><span id="SearchEngine.__init__-296"><a href="#SearchEngine.__init__-296"><span class="linenos">296</span></a>        <span class="c1"># Make sure the proportions sum to 1, otherwise scale them. We then convert</span>
</span><span id="SearchEngine.__init__-297"><a href="#SearchEngine.__init__-297"><span class="linenos">297</span></a>        <span class="c1"># these to steady-state integers (and round to the nearest integer)</span>
</span><span id="SearchEngine.__init__-298"><a href="#SearchEngine.__init__-298"><span class="linenos">298</span></a>        <span class="n">sum_proportions</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-299"><a href="#SearchEngine.__init__-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="n">sum_proportions</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-300"><a href="#SearchEngine.__init__-300"><span class="linenos">300</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-301"><a href="#SearchEngine.__init__-301"><span class="linenos">301</span></a>                <span class="s2">&quot;Warning: fractions for steady-state sources do not add to 1.&quot;</span>
</span><span id="SearchEngine.__init__-302"><a href="#SearchEngine.__init__-302"><span class="linenos">302</span></a>                <span class="s2">&quot;We have scaled all sources to equal one to fix this.&quot;</span>
</span><span id="SearchEngine.__init__-303"><a href="#SearchEngine.__init__-303"><span class="linenos">303</span></a>            <span class="p">)</span>
</span><span id="SearchEngine.__init__-304"><a href="#SearchEngine.__init__-304"><span class="linenos">304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine.__init__-305"><a href="#SearchEngine.__init__-305"><span class="linenos">305</span></a>                <span class="n">p</span> <span class="o">/</span> <span class="n">sum_proportions</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span>
</span><span id="SearchEngine.__init__-306"><a href="#SearchEngine.__init__-306"><span class="linenos">306</span></a>            <span class="p">]</span>
</span><span id="SearchEngine.__init__-307"><a href="#SearchEngine.__init__-307"><span class="linenos">307</span></a>        <span class="c1"># While these are percent values, we want specific counts. We convert to</span>
</span><span id="SearchEngine.__init__-308"><a href="#SearchEngine.__init__-308"><span class="linenos">308</span></a>        <span class="c1"># those here.</span>
</span><span id="SearchEngine.__init__-309"><a href="#SearchEngine.__init__-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_counts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchEngine.__init__-310"><a href="#SearchEngine.__init__-310"><span class="linenos">310</span></a>            <span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">nsteadystate</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_source_proportions</span>
</span><span id="SearchEngine.__init__-311"><a href="#SearchEngine.__init__-311"><span class="linenos">311</span></a>        <span class="p">]</span>
</span><span id="SearchEngine.__init__-312"><a href="#SearchEngine.__init__-312"><span class="linenos">312</span></a>
</span><span id="SearchEngine.__init__-313"><a href="#SearchEngine.__init__-313"><span class="linenos">313</span></a>        <span class="c1"># Throughout our search, we want to keep track of which workflows we&#39;ve</span>
</span><span id="SearchEngine.__init__-314"><a href="#SearchEngine.__init__-314"><span class="linenos">314</span></a>        <span class="c1"># submitted to prefect for each structure source as well as how long</span>
</span><span id="SearchEngine.__init__-315"><a href="#SearchEngine.__init__-315"><span class="linenos">315</span></a>        <span class="c1"># we were holding a steady-state of submissions. We therefore keep</span>
</span><span id="SearchEngine.__init__-316"><a href="#SearchEngine.__init__-316"><span class="linenos">316</span></a>        <span class="c1"># a log of Sources in our database -- where even if we&#39;ve ran this search</span>
</span><span id="SearchEngine.__init__-317"><a href="#SearchEngine.__init__-317"><span class="linenos">317</span></a>        <span class="c1"># before, we still want new entries for each.</span>
</span><span id="SearchEngine.__init__-318"><a href="#SearchEngine.__init__-318"><span class="linenos">318</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources_db</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine.__init__-319"><a href="#SearchEngine.__init__-319"><span class="linenos">319</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-320"><a href="#SearchEngine.__init__-320"><span class="linenos">320</span></a>            <span class="n">source_db</span> <span class="o">=</span> <span class="n">SourceDatatable</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-321"><a href="#SearchEngine.__init__-321"><span class="linenos">321</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-322"><a href="#SearchEngine.__init__-322"><span class="linenos">322</span></a>                <span class="n">is_steadystate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-323"><a href="#SearchEngine.__init__-323"><span class="linenos">323</span></a>                <span class="n">is_singleshot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-324"><a href="#SearchEngine.__init__-324"><span class="linenos">324</span></a>                <span class="n">search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-325"><a href="#SearchEngine.__init__-325"><span class="linenos">325</span></a>            <span class="p">)</span>
</span><span id="SearchEngine.__init__-326"><a href="#SearchEngine.__init__-326"><span class="linenos">326</span></a>            <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine.__init__-327"><a href="#SearchEngine.__init__-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">singleshot_sources_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_db</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-328"><a href="#SearchEngine.__init__-328"><span class="linenos">328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchEngine.__init__-329"><a href="#SearchEngine.__init__-329"><span class="linenos">329</span></a>        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources</span><span class="p">:</span>
</span><span id="SearchEngine.__init__-330"><a href="#SearchEngine.__init__-330"><span class="linenos">330</span></a>            <span class="n">source_db</span> <span class="o">=</span> <span class="n">SourceDatatable</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-331"><a href="#SearchEngine.__init__-331"><span class="linenos">331</span></a>                <span class="n">name</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-332"><a href="#SearchEngine.__init__-332"><span class="linenos">332</span></a>                <span class="n">is_steadystate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-333"><a href="#SearchEngine.__init__-333"><span class="linenos">333</span></a>                <span class="n">is_singleshot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-334"><a href="#SearchEngine.__init__-334"><span class="linenos">334</span></a>                <span class="n">search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-335"><a href="#SearchEngine.__init__-335"><span class="linenos">335</span></a>            <span class="p">)</span>
</span><span id="SearchEngine.__init__-336"><a href="#SearchEngine.__init__-336"><span class="linenos">336</span></a>            <span class="n">source_db</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="SearchEngine.__init__-337"><a href="#SearchEngine.__init__-337"><span class="linenos">337</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">steadystate_sources_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_db</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-338"><a href="#SearchEngine.__init__-338"><span class="linenos">338</span></a>
</span><span id="SearchEngine.__init__-339"><a href="#SearchEngine.__init__-339"><span class="linenos">339</span></a>        <span class="c1"># Initialize the fingerprint database</span>
</span><span id="SearchEngine.__init__-340"><a href="#SearchEngine.__init__-340"><span class="linenos">340</span></a>        <span class="c1"># For this we need to grab all previously calculated structures of this</span>
</span><span id="SearchEngine.__init__-341"><a href="#SearchEngine.__init__-341"><span class="linenos">341</span></a>        <span class="c1"># compositon too pass in too.</span>
</span><span id="SearchEngine.__init__-342"><a href="#SearchEngine.__init__-342"><span class="linenos">342</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating fingerprints for past structures...&quot;</span><span class="p">)</span>
</span><span id="SearchEngine.__init__-343"><a href="#SearchEngine.__init__-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span> <span class="o">=</span> <span class="n">PartialCrystalNNFingerprint</span><span class="p">(</span>
</span><span id="SearchEngine.__init__-344"><a href="#SearchEngine.__init__-344"><span class="linenos">344</span></a>            <span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-345"><a href="#SearchEngine.__init__-345"><span class="linenos">345</span></a>            <span class="n">structure_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_datatable</span><span class="o">.</span><span class="n">individuals</span><span class="p">,</span>
</span><span id="SearchEngine.__init__-346"><a href="#SearchEngine.__init__-346"><span class="linenos">346</span></a>        <span class="p">)</span>
</span><span id="SearchEngine.__init__-347"><a href="#SearchEngine.__init__-347"><span class="linenos">347</span></a>        <span class="c1"># BUG: should we only do structures that were successfully calculated?</span>
</span><span id="SearchEngine.__init__-348"><a href="#SearchEngine.__init__-348"><span class="linenos">348</span></a>        <span class="c1"># If not, there&#39;s a chance a structure fails because of something like a</span>
</span><span id="SearchEngine.__init__-349"><a href="#SearchEngine.__init__-349"><span class="linenos">349</span></a>        <span class="c1"># crashed slurm job, but it&#39;s never submitted again...</span>
</span><span id="SearchEngine.__init__-350"><a href="#SearchEngine.__init__-350"><span class="linenos">350</span></a>        <span class="c1"># OPTIMIZE: should we only do final structures? Or should I include input</span>
</span><span id="SearchEngine.__init__-351"><a href="#SearchEngine.__init__-351"><span class="linenos">351</span></a>        <span class="c1"># structures and even all ionic steps as well...?</span>
</span><span id="SearchEngine.__init__-352"><a href="#SearchEngine.__init__-352"><span class="linenos">352</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sets up the search engine and its settings.</p>

<h4 id="parameters">Parameters</h4>

<ul>
<li><p><code>composition</code>:
The composition to run the evolutionary search for. Note that the
number of sites is fixed to what is set here. (Ca2N vs Ca4N2)</p></li>
<li><p><code>workflow</code>:
The workflow to run all individuals through. Note, the result_database
of this workflow will be treated as the individuals in this search.
The default is "relaxation.vasp.staged"</p></li>
<li><p><code>workflow_command</code>:
The command that will be passed to the workflow.run() method.</p></li>
<li><p><code>max_structures</code>:
The maximum number of individuals that will be calculated before
stopping the search. The default is 3000.</p></li>
<li><p><code>limit_best_survival</code>:
The search is stopped when the best individual remains unbeaten for
this number of new individuals. The default is 250.</p></li>
<li><p><code>singleshot_sources</code>:
TODO: This is not implemented yet</p></li>
<li><p><code>nfirst_generation</code>:
No mutations or "child" individuals will be carried out until this
number of individuals have been calculated. The default is 20.</p></li>
<li><p><code>nsteadystate</code>:
The total number of individuals from steady-state sources that will
be running/submitted at any given time. The default is 40.</p></li>
<li><p><code>steadystate_sources</code>:
A list of tuples where each tuple is (percent, source). The percent
determines the number of steady stage calculations that will be
running for this at any given time. For example, 0.25 means
0.25*40=10 individuals will be running/submitted at all times. The
source can be from either the toolkit.creator or toolkit.transformations
modules. Don't change this default unless you know what you're doing!</p></li>
<li><p><code>selector</code>:
The defualt method to use for choosing the parent individual(s). The
default is TruncatedSelection.</p></li>
</ul>
</div>


                            </div>
                            <div id="SearchEngine.run" class="classattr">
                                        <input id="SearchEngine.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sleep_step</span><span class="o">=</span><span class="mi">10</span></span>)</span>

                <label class="view-source-button" for="SearchEngine.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchEngine.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchEngine.run-354"><a href="#SearchEngine.run-354"><span class="linenos">354</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="SearchEngine.run-355"><a href="#SearchEngine.run-355"><span class="linenos">355</span></a>
</span><span id="SearchEngine.run-356"><a href="#SearchEngine.run-356"><span class="linenos">356</span></a>        <span class="c1"># See if the singleshot sources have been ran yet. For restarted calculations</span>
</span><span id="SearchEngine.run-357"><a href="#SearchEngine.run-357"><span class="linenos">357</span></a>        <span class="c1"># this will likely not be needed (unless a new source was added)</span>
</span><span id="SearchEngine.run-358"><a href="#SearchEngine.run-358"><span class="linenos">358</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_singleshot_sources</span><span class="p">()</span>
</span><span id="SearchEngine.run-359"><a href="#SearchEngine.run-359"><span class="linenos">359</span></a>
</span><span id="SearchEngine.run-360"><a href="#SearchEngine.run-360"><span class="linenos">360</span></a>        <span class="c1"># this loop will go until I hit &#39;break&#39; below</span>
</span><span id="SearchEngine.run-361"><a href="#SearchEngine.run-361"><span class="linenos">361</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="SearchEngine.run-362"><a href="#SearchEngine.run-362"><span class="linenos">362</span></a>
</span><span id="SearchEngine.run-363"><a href="#SearchEngine.run-363"><span class="linenos">363</span></a>            <span class="c1"># TODO: maybe write summary files to csv...? This may be a mute</span>
</span><span id="SearchEngine.run-364"><a href="#SearchEngine.run-364"><span class="linenos">364</span></a>            <span class="c1"># point because I expect we can follow along in the web UI in the future</span>
</span><span id="SearchEngine.run-365"><a href="#SearchEngine.run-365"><span class="linenos">365</span></a>            <span class="c1"># To that end, I can add a &quot;URL&quot; property</span>
</span><span id="SearchEngine.run-366"><a href="#SearchEngine.run-366"><span class="linenos">366</span></a>
</span><span id="SearchEngine.run-367"><a href="#SearchEngine.run-367"><span class="linenos">367</span></a>            <span class="c1"># Check the stop condition</span>
</span><span id="SearchEngine.run-368"><a href="#SearchEngine.run-368"><span class="linenos">368</span></a>            <span class="c1"># If it is True, we can stop the calc.</span>
</span><span id="SearchEngine.run-369"><a href="#SearchEngine.run-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_stop_condition</span><span class="p">():</span>
</span><span id="SearchEngine.run-370"><a href="#SearchEngine.run-370"><span class="linenos">370</span></a>                <span class="k">break</span>  <span class="c1"># break out of the while loop</span>
</span><span id="SearchEngine.run-371"><a href="#SearchEngine.run-371"><span class="linenos">371</span></a>            <span class="c1"># Otherwise, keep going!</span>
</span><span id="SearchEngine.run-372"><a href="#SearchEngine.run-372"><span class="linenos">372</span></a>
</span><span id="SearchEngine.run-373"><a href="#SearchEngine.run-373"><span class="linenos">373</span></a>            <span class="c1"># update the fingerprint database with all of the completed structures</span>
</span><span id="SearchEngine.run-374"><a href="#SearchEngine.run-374"><span class="linenos">374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fingerprint_validator</span><span class="o">.</span><span class="n">update_fingerprint_database</span><span class="p">()</span>
</span><span id="SearchEngine.run-375"><a href="#SearchEngine.run-375"><span class="linenos">375</span></a>
</span><span id="SearchEngine.run-376"><a href="#SearchEngine.run-376"><span class="linenos">376</span></a>            <span class="c1"># Go through the running workflows and see if we need to submit</span>
</span><span id="SearchEngine.run-377"><a href="#SearchEngine.run-377"><span class="linenos">377</span></a>            <span class="c1"># new ones to meet our steadystate target(s)</span>
</span><span id="SearchEngine.run-378"><a href="#SearchEngine.run-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_steadystate_workflows</span><span class="p">()</span>
</span><span id="SearchEngine.run-379"><a href="#SearchEngine.run-379"><span class="linenos">379</span></a>
</span><span id="SearchEngine.run-380"><a href="#SearchEngine.run-380"><span class="linenos">380</span></a>            <span class="c1"># TODO: Go through the triggered actions</span>
</span><span id="SearchEngine.run-381"><a href="#SearchEngine.run-381"><span class="linenos">381</span></a>            <span class="c1"># self._check_triggered_actions()</span>
</span><span id="SearchEngine.run-382"><a href="#SearchEngine.run-382"><span class="linenos">382</span></a>
</span><span id="SearchEngine.run-383"><a href="#SearchEngine.run-383"><span class="linenos">383</span></a>            <span class="c1"># To save our database load, sleep until we run checks again.</span>
</span><span id="SearchEngine.run-384"><a href="#SearchEngine.run-384"><span class="linenos">384</span></a>            <span class="c1"># OPTIMIZE: ask Prefect if their is an equivalent to Dask&#39;s gather/wait</span>
</span><span id="SearchEngine.run-385"><a href="#SearchEngine.run-385"><span class="linenos">385</span></a>            <span class="c1"># functions, so we know exactly when a workflow completes</span>
</span><span id="SearchEngine.run-386"><a href="#SearchEngine.run-386"><span class="linenos">386</span></a>            <span class="c1"># https://docs.dask.org/en/stable/futures.html#waiting-on-futures</span>
</span><span id="SearchEngine.run-387"><a href="#SearchEngine.run-387"><span class="linenos">387</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sleeping for </span><span class="si">{</span><span class="n">sleep_step</span><span class="si">}</span><span class="s2"> seconds before running checks again.&quot;</span><span class="p">)</span>
</span><span id="SearchEngine.run-388"><a href="#SearchEngine.run-388"><span class="linenos">388</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_step</span><span class="p">)</span>
</span><span id="SearchEngine.run-389"><a href="#SearchEngine.run-389"><span class="linenos">389</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping the search (remaining calcs will be left to finish).&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>