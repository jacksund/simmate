<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 8.2.0" />
    <title>simmate.workflow_engine.tasks.supervised_staged_shell_task API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style>/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style>/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}.git-button{display:none !important;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../tasks.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;simmate.workflow_engine.tasks</a>

<a href="https://github.com/jacksund/simmate">                        <img src="https://github.com/jacksund/simmate/blob/main/logo/simmate.svg?raw=true" class="logo" alt="project logo"/>
</a>
                        <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                               pattern=".+" required>



                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#S3Task">S3Task</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#S3Task.__init__">S3Task</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.command">command</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.requires_structure">requires_structure</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.error_handlers">error_handlers</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.max_corrections">max_corrections</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.monitor">monitor</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.polling_timestep">polling_timestep</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.monitor_freq">monitor_freq</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.setup">setup</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.execute">execute</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.workup">workup</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.get_config">get_config</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.print_config">print_config</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MaxCorrectionsError">MaxCorrectionsError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#NonZeroExitError">NonZeroExitError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#StructureRequiredError">StructureRequiredError</a>
                            <ul class="memberlist">
                </ul>

            </li>
    </ul>



                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                        <a class="pdoc-button git-button" href="https://github.com/jacksund/simmate/tree/main/src/simmate/workflow_engine/tasks/supervised_staged_shell_task.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../../../simmate.html">simmate</a><wbr>.<a href="./../../workflow_engine.html">workflow_engine</a><wbr>.<a href="./../tasks.html">tasks</a><wbr>.supervised_staged_shell_task    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">pandas</span>

<span class="kn">import</span> <span class="nn">prefect</span>
<span class="kn">from</span> <span class="nn">prefect.core.task</span> <span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">prefect.utilities.tasks</span> <span class="kn">import</span> <span class="n">defaults_from_attrs</span>

<span class="kn">from</span> <span class="nn">simmate.utilities</span> <span class="kn">import</span> <span class="n">get_directory</span><span class="p">,</span> <span class="n">make_archive</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">simmate.workflow_engine.error_handler</span> <span class="kn">import</span> <span class="n">ErrorHandler</span>

<span class="c1"># cleanup_on_fail=False, # TODO I should add a Prefect state_handler that can</span>
<span class="c1"># reset the working directory between task retries -- in some cases we may</span>
<span class="c1"># want to delete the entire directory.</span>

<span class="c1"># OPTIMIZE: I think this class would greatly benefit from asyncio so that we</span>
<span class="c1"># know exactly when a shelltask completes, rather than looping and checking every</span>
<span class="c1"># set timestep.</span>
<span class="c1"># https://docs.python.org/3/library/asyncio-subprocess.html#asyncio.create_subprocess_exec</span>


<span class="k">class</span> <span class="nc">S3Task</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Supervised-Staged-Shell Task (aka &quot;S3Task&quot;)</span>
<span class="sd">    -----------------------------------------------</span>

<span class="sd">    This class contains the core functionality to **supervise** a **staged** task</span>
<span class="sd">    involving some **shell** command.</span>

<span class="sd">    Let&#39;s breakdown what this means...</span>

<span class="sd">    A *shell* command is a single call to some external program. For example,</span>
<span class="sd">    VASP requires that we call the &quot;vasp_std &gt; vasp.out&quot; command in order to run a</span>
<span class="sd">    calculation. We consider calling external programs a *staged* task made</span>
<span class="sd">    up of three steps:</span>

<span class="sd">    - setup = writing any input files required for the program</span>
<span class="sd">    - execution = actually calling the command and running our program</span>
<span class="sd">    - workup = loading data from output files back into python</span>

<span class="sd">    And for *supervising* the task, this means we monitor the program while the</span>
<span class="sd">    execution stage is running. So once a program is started, Simmate can check</span>
<span class="sd">    output files for common errors/issues. If an error is found, we stop the</span>
<span class="sd">    program, fix the issue, and then restart it. Any fixes that were made are</span>
<span class="sd">    written to &quot;simmate_corrections.csv&quot;.</span>


<span class="sd">    &lt;!--</span>
<span class="sd">    TODO: Make a simple diagram to visualize the overall process and add it here.</span>
<span class="sd">    It will be similar to Custodian&#39;s, but we don&#39;t have a list of jobs here.</span>
<span class="sd">    https://materialsproject.github.io/custodian/index.html#usage</span>
<span class="sd">    The steps are...</span>

<span class="sd">    - Write Input Files based on custom+defualt settings</span>
<span class="sd">    - Run the calculation by calling the program</span>
<span class="sd">    - Load ouput files</span>
<span class="sd">    - check for errors</span>
<span class="sd">    - [correct them, rerun]</span>
<span class="sd">    - postprocess/analysis</span>
<span class="sd">    --&gt;</span>

<span class="sd">    This entire process (the different stages and monitoring) is carried out</span>
<span class="sd">    using the ``run()`` method. You rarely use this class directly. Instead,</span>
<span class="sd">    you typically use a subclass of it. As a user, you really just need to do</span>
<span class="sd">    something like this:</span>

<span class="sd">    ``` python</span>
<span class="sd">       from simmate.calculator.example.tasks import ExampleTask</span>

<span class="sd">       my_task = ExampleTask()</span>
<span class="sd">       my_result = my_task.run()</span>
<span class="sd">    ```</span>

<span class="sd">    And that&#39;s it!</span>

<span class="sd">    For experts, this class can be viewed as a combination of prefect&#39;s ShellTask,</span>
<span class="sd">    a custodian Job, and Custodian monitoring. When subclassing this, we can absorb</span>
<span class="sd">    functionality of pymatgen.io.vasp.sets too. By merging all of these together</span>
<span class="sd">    into one class, we make things much easier for users and creating new Tasks.</span>


<span class="sd">    Inheriting from this class</span>
<span class="sd">    --------------------------</span>

<span class="sd">    This class is commonly used to make tasks for our calculator modules, so you</span>
<span class="sd">    will likely want to subclass this. Here is a basic example of inheriting</span>
<span class="sd">    and then running a task:</span>

<span class="sd">    ``` python</span>

<span class="sd">    from simmate.workflow_engine.tasks.supervised_staged_shell_task import (</span>
<span class="sd">        S3Task as SSSTask,</span>
<span class="sd">    )</span>
<span class="sd">    from example.error_handlers import PossibleError1, PossibleError2</span>


<span class="sd">    class ExampleTask(SSSTask):</span>

<span class="sd">        command = &quot;echo example&quot;  # just prints out &quot;example&quot;</span>
<span class="sd">        max_corrections = 7</span>
<span class="sd">        error_handlers = [PossibleError1, PossibleError2]</span>
<span class="sd">        polling_timestep = 0.1</span>
<span class="sd">        monitor_freq = 10</span>
<span class="sd">        some_new_setting = 123</span>

<span class="sd">        def setup(self, structure, directory):  # &lt;-- MUST have these two args</span>
<span class="sd">            print(&quot;I&#39;m setting things up!&quot;)</span>
<span class="sd">            print(f&quot;My new setting is {some_new_setting}&quot;)</span>

<span class="sd">        def workup(self, directory):  # &lt;-- MUST have this arg</span>
<span class="sd">            print(&quot;I&#39;m working things up!&quot;)</span>


<span class="sd">    task = ExampleTask()</span>
<span class="sd">    result = task.run()</span>
<span class="sd">    ```</span>

<span class="sd">    There are a couple things to note here:</span>

<span class="sd">    - It&#39;s optional to set/overwrite attributes. You can also add new ones too.</span>
<span class="sd">    - It&#39;s optional to write a new __init__, setup, or workup methods</span>
<span class="sd">    - make sure you include the structure/directory inputs, even if you don&#39;t use them.</span>
<span class="sd">    - Don&#39;t add new kwargs to methods. Instead handle these options through attributes.</span>

<span class="sd">    For a full (and advanced) example, of a subclass take a look at</span>
<span class="sd">    `simmate.calculators.vasp.tasks.base.VaspTask`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># I set this here so that I don&#39;t have to copy/paste the init method</span>
    <span class="c1"># every time I inherit from this class and want to update the default</span>
    <span class="c1"># command to use for the child class.</span>
    <span class="n">command</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The defualt shell command to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># While it&#39;s not needed for a number of cases, it&#39;s extremely common for the</span>
    <span class="c1"># setup method to need an input structure in matsci. I therefore include</span>
    <span class="c1"># this rather than having a nearly identical subclass that could cause</span>
    <span class="c1"># some confusion.</span>
    <span class="n">requires_structure</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Indicates whether a structure is needed if for the run() method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error_handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of ErrorHandler objects to use in order of priority (that is, highest</span>
<span class="sd">    priority is first).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_corrections</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    maximum number of times we can apply a correction and retry the shell command</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Monitoring settings.</span>
    <span class="c1"># These are only ever relevent if there are ErrorHandlers added that have</span>
    <span class="c1"># is_monitor=True. These handlers run while the shelltask itself is also</span>
    <span class="c1"># running. Read more about ErrorHandlers for more info.</span>

    <span class="n">monitor</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Whether to run monitor handlers while the shelltask runs. False means</span>
<span class="sd">    wait until the job has completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">polling_timestep</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If we are monitoring the job for errors while it runs, this is how often</span>
<span class="sd">    (in seconds) we should check the status of our job. Note this check is</span>
<span class="sd">    just whether the job is done or not. This is NOT how often we check for</span>
<span class="sd">    errors. See monitor_freq for that.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">monitor_freq</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The frequency we should run check for errors with our monitors. This is</span>
<span class="sd">    based on the polling_timestep loops. For example, if we have a</span>
<span class="sd">    polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
<span class="sd">    the monitor checks every other loop -- or every 2x10 = 20 seconds. Another</span>
<span class="sd">    example is values of polling_timestep=10 and monitor_freq=30. Here, we&#39;d</span>
<span class="sd">    run monitoring functions every 5 minutes (10x30=300s=5min).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">error_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simmate_corrections.csv&quot;</span><span class="p">,</span>
        <span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Creates a task instance of this class. The parameters passed will be the</span>
<span class="sd">        same every time you call the task.run() method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required. Typically, this</span>
<span class="sd">            class is ran for multiple structures, where you can pass this</span>
<span class="sd">            option to the task.run() method instead.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
<span class="sd">            function simmate.ulitities.get_directory</span>
<span class="sd">        - `error_handlers`:</span>
<span class="sd">            The list of error handler objects to use. These should be listing in</span>
<span class="sd">            order of priority, where to highest priority is first. If one handler</span>
<span class="sd">            is triggered, the correction will be applied and none of the</span>
<span class="sd">            following handlers will be checked.</span>
<span class="sd">        - `max_corrections`:</span>
<span class="sd">            The maximum number of times that corrections will be made before</span>
<span class="sd">            giving up on the calculation. Note, once this limit is exceeded, the</span>
<span class="sd">            error is stored without correcting or restarting the run.</span>
<span class="sd">        - `monitor`:</span>
<span class="sd">            Whether to run monitor handlers while the command runs. False means</span>
<span class="sd">            wait until the job has completed.</span>
<span class="sd">        - `polling_timestep`:</span>
<span class="sd">            If we are monitoring the job for errors while it runs, this is how often</span>
<span class="sd">            (in seconds) we should check the status of our job. Note this check is</span>
<span class="sd">            just whether the job is done or not. This is NOT how often we check for</span>
<span class="sd">            errors. See monitor_freq for that.</span>
<span class="sd">        - `monitor_freq`:</span>
<span class="sd">            The frequency we should run check for errors with our monitors. This is</span>
<span class="sd">            based on the polling_timestep loops. For example, if we have a</span>
<span class="sd">            polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
<span class="sd">            the monitor checks every other loop -- or every 2x10 = 20 seconds. The</span>
<span class="sd">            default values of polling_timestep=10 and monitor_freq=30 indicate that</span>
<span class="sd">            we run monitoring functions every 5 minutes (10x30=300s=5min).</span>
<span class="sd">        - `save_corrections_to_file`:</span>
<span class="sd">            Whether to write a log file of the corrections made. The default is True.</span>
<span class="sd">        - `corrections_filename`:</span>
<span class="sd">            If save_corrections_to_file is True, this is the filename of where</span>
<span class="sd">            to write the corrections. The default is &quot;simmate_corrections.csv&quot;.</span>
<span class="sd">        - `compress_output`:</span>
<span class="sd">            Whether to compress the directory to a zip file at the end of the</span>
<span class="sd">            task run. After compression, it will also delete the directory.</span>
<span class="sd">            The default is False.</span>
<span class="sd">        - `**kwargs`:</span>
<span class="sd">            All extra arguments supported by</span>
<span class="sd">            [prefect.core.task.Task](https://docs.prefect.io/api/latest/core/task.html).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if any of these input parameters were given, overwrite the default</span>
        <span class="c1"># Note to python devs: this odd formatting is because we set our defaults</span>
        <span class="c1"># to None in __init__ while our actual default values are defined above</span>
        <span class="c1"># as class attributes. This may seem funky at first glance, but it</span>
        <span class="c1"># makes inheriting from this class extremely pretty :)</span>
        <span class="c1"># This code is effectively the same as @defaults_from_attrs(...).</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="k">if</span> <span class="n">error_handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="n">error_handlers</span>
        <span class="k">if</span> <span class="n">monitor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="k">if</span> <span class="n">max_corrections</span> <span class="ow">or</span> <span class="n">max_corrections</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span> <span class="o">=</span> <span class="n">max_corrections</span>
        <span class="k">if</span> <span class="n">polling_timestep</span> <span class="ow">or</span> <span class="n">polling_timestep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span> <span class="o">=</span> <span class="n">polling_timestep</span>
        <span class="k">if</span> <span class="n">monitor_freq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">=</span> <span class="n">monitor_freq</span>
        <span class="c1"># These parameters will never have a default which is set to the attribute,</span>
        <span class="c1"># so go ahead and set them from what was given in the init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span> <span class="o">=</span> <span class="n">compress_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="o">=</span> <span class="n">save_corrections_to_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span> <span class="o">=</span> <span class="n">corrections_filename</span>

        <span class="c1"># now inherit the parent Prefect Task class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This abstract method is ran before the command is actually executed. This</span>
<span class="sd">        allows for some pre-processing, such as writing input files or any other</span>
<span class="sd">        analysis.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase setup() is normally called within the run() method.</span>

<span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
<span class="sd">        doesn&#39;t nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. Must exist already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Be sure to include directory and structure (or **kwargs) as input arguments</span>
        <span class="c1"># for higher-level compatibility with the run method.</span>
        <span class="c1"># You should never need to call this method directly!</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This calls the command within the target directory and handles all error</span>
<span class="sd">        handling as well as monitoring of the job.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase `execute` is normally called within the `run` method.</span>

<span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
<span class="sd">        does nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        - `corrections`</span>
<span class="sd">            A list of tuples where each entry is a error identified and the</span>
<span class="sd">            correction applied. Ex: [(&quot;ExampleError&quot;, &quot;ExampleCorrection&quot;)]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># some error_handlers run while the shelltask is running. These are known as</span>
        <span class="c1"># Monitors and are labled via the is_monitor attribute. It&#39;s good for us</span>
        <span class="c1"># to separate these out from other error_handlers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_monitor</span>
        <span class="p">]</span>

        <span class="c1"># We start with zero corrections that we slowly add to. This can be</span>
        <span class="c1"># thought of as a table with headers of...</span>
        <span class="c1">#   (&quot;applied_errorhandler&quot;, &quot;correction_applied&quot;)</span>
        <span class="c1"># NOTE: I took out the table headers and may add them back in</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ------ start of main while loop ------</span>

        <span class="c1"># we can try running the shelltask up to max_corrections. Because only one</span>
        <span class="c1"># correction is applied per attempt, you can view this as the maximum</span>
        <span class="c1"># number of attempts made on the calculation.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>

            <span class="c1"># launch the shelltask without waiting for it to complete. Also,</span>
            <span class="c1"># make sure to use common shell commands and to set the working</span>
            <span class="c1"># directory.</span>
            <span class="c1"># The preexec_fn keyword allows us to properly terminate jobs that</span>
            <span class="c1"># are launched with parallel processes (such as mpirun). This assigns</span>
            <span class="c1"># a parent id to it that we use when killing a job (if an error</span>
            <span class="c1"># handler calls for us to do so). This isn&#39;t possible on Windows though.</span>
            <span class="c1"># Stderr keyword indicates that we should capture the error if one</span>
            <span class="c1"># occurs so that we can report it to the user.</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">preexec_fn</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Assume the shelltask has no errors until proven otherwise</span>
            <span class="n">has_error</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># If monitor=True, then we want to supervise this shelltask as it</span>
            <span class="c1"># runs. If montors=[m1,m2,...], then we have monitors in place to actually</span>
            <span class="c1"># perform the monitoring. If both of these cases are true, then we</span>
            <span class="c1"># want to go through the error_handlers to check for errors until</span>
            <span class="c1"># the shelltask completes.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>

                <span class="c1"># ------ start of monitor while loop ------</span>

                <span class="c1"># We want to loop until we find an error and keep track of</span>
                <span class="c1"># which loops to run the monitor function on because we don&#39;t</span>
                <span class="c1"># want them to run nonstop. This variable allows us to monitor</span>
                <span class="c1"># checks every Nth loop, while we check the shelltask status</span>
                <span class="c1"># on all other loops.</span>
                <span class="n">monitor_freq_n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                    <span class="n">monitor_freq_n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Sleep the set amount before checking the shelltask status</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span><span class="p">)</span>

                    <span class="c1"># check if the shelltasks is complete. poll will return 0</span>
                    <span class="c1"># when it&#39;s done, in which case we break the loop</span>
                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="c1"># check whether we should run monitors on this poll loop</span>
                    <span class="k">if</span> <span class="n">monitor_freq_n</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># iterate through each monitor</span>
                        <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
                            <span class="c1"># check if there&#39;s an error with this error_handler</span>
                            <span class="c1"># and grab the error if so</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                                <span class="c1"># determine if it is_terminating</span>
                                <span class="k">if</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">is_terminating</span><span class="p">:</span>
                                    <span class="c1"># If so, we kill the process but don&#39;t apply</span>
                                    <span class="c1"># the fix quite yet. That step is done below.</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                                <span class="c1"># Otherwise apply the fix and let the shelltask end</span>
                                <span class="c1"># naturally. An example of this is for codes</span>
                                <span class="c1"># where you add a STOP file to get it to</span>
                                <span class="c1"># finish rather than just killing the process.</span>
                                <span class="c1"># This is the special case error_handler that I talk</span>
                                <span class="c1"># about in my notes, where we really want to</span>
                                <span class="c1"># end the shelltask right away.</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># apply the fix now</span>
                                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                                    <span class="c1"># record what&#39;s been changed</span>
                                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
                                <span class="c1"># there&#39;s no need to look at the other monitors</span>
                                <span class="c1"># so break from the for-loop. We also don&#39;t</span>
                                <span class="c1"># need to monitor the stagedtask anymore since we just</span>
                                <span class="c1"># terminated it or signaled for its graceful</span>
                                <span class="c1"># end. So update the while-loop condition.</span>
                                <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                <span class="c1"># ------ end of monitor while loop ------</span>
            <span class="c1"># Now just wait for the process to finish. Note we use communicate</span>
            <span class="c1"># instead of the .wait() method. This is the recommended method</span>
            <span class="c1"># when we have stderr=subprocess.PIPE, which we use above.</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="c1"># check if the return code is non-zero and thus failed.</span>
            <span class="c1"># The &#39;not has_error&#39; is because terminate() will give a nonzero</span>
            <span class="c1"># when a monitor is triggered. We don&#39;t want to raise that</span>
            <span class="c1"># exception here but instead let the monitor handle that</span>
            <span class="c1"># error in the code below.</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="c1"># convert the error from bytes to a string</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1"># and report the error to the user</span>
                <span class="k">raise</span> <span class="n">NonZeroExitError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The command (</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">) failed. The error output was...</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Check for errors again, because a non-monitor may be higher</span>
            <span class="c1"># priority than the monitor triggered above (if there was one).</span>
            <span class="c1"># Since the error_handlers are in order of priority, only the first</span>
            <span class="c1"># will actually be applied and then we can retry the calc.</span>
            <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>

                <span class="c1"># NOTE - The following special case is handled above:</span>
                <span class="c1">#   error_handler.is_monitor and not error_handler.is_terminating</span>
                <span class="c1"># BUG: I can see this being a source of bugs in the process so I</span>
                <span class="c1"># need to reconsider subclassing this special case. For now,</span>
                <span class="c1"># users should have this case at the lowest priority.</span>

                <span class="c1"># check if there&#39;s an error with this error_handler and grab the</span>
                <span class="c1"># error if there is one</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="c1"># record the error in case it wasn&#39;t done so above</span>
                    <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># And apply the proper correction if there is one.</span>
                    <span class="c1"># Some error_handlers will even raise an error here signaling</span>
                    <span class="c1"># that the stagedtask is unrecoverable and a lost cause.</span>
                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="c1"># record what&#39;s been changed</span>
                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
                    <span class="c1"># break from the error_handler for-loop as we only apply the</span>
                    <span class="c1"># highest priority fix and nothing else.</span>
                    <span class="k">break</span>
            <span class="c1"># write the log of corrections to file if requested. This is written</span>
            <span class="c1"># as a CSV file format and done every while-loop cycle because it</span>
            <span class="c1"># lets the user monitor the calculation and error handlers applied</span>
            <span class="c1"># as it goes. If no corrections were applied, we skip writing the file.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="ow">and</span> <span class="n">corrections</span><span class="p">:</span>
                <span class="c1"># compile the corrections metadata into a dataframe</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">corrections</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_applied&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="c1"># write the dataframe to a csv file</span>
                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># now that we&#39;ve gone through the error_handlers, let&#39;s see if any</span>
            <span class="c1"># non-terminating errors were found (terminating ones would raise</span>
            <span class="c1"># an error above). If there are no errors, we&#39;ve finished the</span>
            <span class="c1"># calculation and can exit the while loop. Otherwise, just leave</span>
            <span class="c1"># everything where it&#39;s at and restart the while-loop with a new</span>
            <span class="c1"># attempt</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="c1"># break the while-loop</span>
                <span class="k">break</span>
        <span class="c1"># ------ end of main while loop ------</span>

        <span class="c1"># make sure the while loop didn&#39;t exit because of the correction limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxCorrectionsError</span><span class="p">(</span>
                <span class="s2">&quot;The number of maximum corrections has been exceeded. Note the final &quot;</span>
                <span class="s2">&quot;error and its fix are still listed in the corrections file, but it &quot;</span>
                <span class="s2">&quot;was never used.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># now return the corrections for them to stored/used elsewhere</span>
        <span class="k">return</span> <span class="n">corrections</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stopping the command we submitted can be a tricky business if we are running</span>
<span class="sd">        scripts in parallel (such as using mpirun). Different computers and OSs</span>
<span class="sd">        can require a different &#39;kill&#39; command so we establish this separate</span>
<span class="sd">        method that can be overwritten.</span>

<span class="sd">        If you know your command needs a special case to kill all of its spawn</span>
<span class="sd">        processes, you can overwrite this method as well.</span>

<span class="sd">        Users should never call this directly becuase this is instead applied</span>
<span class="sd">        within the execute() method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `process`:</span>
<span class="sd">            The process object that will be terminated.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            the command used to launch the process. This is sometimes useful</span>
<span class="sd">            when searching for all running processes under this name.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The operating system (Windows, OSX, or Linux) will give us the best guess</span>
        <span class="c1"># as to where to access the blender command. The results are as you&#39;d expect</span>
        <span class="c1"># except for Macs, which return &quot;Darwin&quot;.</span>
        <span class="c1">#   Linux: Linux</span>
        <span class="c1">#   Mac: Darwin</span>
        <span class="c1">#   Windows: Windows</span>
        <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

        <span class="c1"># The normal line to end a popen process is just...</span>
        <span class="c1">#   process.terminate()</span>
        <span class="c1"># However this struggles to kill all &quot;child&quot; processes if we are using</span>
        <span class="c1"># something like mpirun to run things in parallel. Instead, we use the</span>
        <span class="c1"># os module to grab the parent id and send that the termination signal,</span>
        <span class="c1"># which # is also passed on to all child processes.</span>
        <span class="c1"># This command also doesn not work on windows, so I need to address this</span>
        <span class="c1"># as well.</span>
        <span class="k">if</span> <span class="n">operating_system</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
        <span class="c1"># note: SIGTERM is the normal signal but I use SIGKILL to try to address</span>
        <span class="c1"># permission errors.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

        <span class="c1"># As an example of an alternative approach to killing a job, here is</span>
        <span class="c1"># what Custodian (Materials Project) tries when killing a VASP job</span>
        <span class="c1"># submitted through mpirun:</span>
        <span class="c1"># try:</span>
        <span class="c1">#     os.system(&quot;killall vasp&quot;)</span>
        <span class="c1"># except Exception:</span>
        <span class="c1">#     pass</span>

        <span class="c1"># TODO: make it so terminate scripts can be loaded from the user&#39;s config</span>
        <span class="c1"># directory, which will make it so they don&#39;t have to overwrite all the</span>
        <span class="c1"># classes that inherit from this one.</span>

    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called at the end of a job, *after* error detection.</span>
<span class="sd">        This allows post-processing, such as cleanup, analysis of results,</span>
<span class="sd">        etc. This should return the result of the entire job, such as a</span>
<span class="sd">        the final structure or final energy calculated.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase workup() is normally called within the run() method.</span>

<span class="sd">        Some tasks don&#39;t require a workup() method, so by default, this method</span>
<span class="sd">        does nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Be sure to include directory (or **kwargs) as input argument for</span>
        <span class="c1"># higher-level compatibility with the run method and SupervisedStagedTask</span>
        <span class="c1"># You should never need to call this method directly!</span>
        <span class="k">pass</span>

    <span class="nd">@defaults_from_attrs</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the entire staged task (setup, execution, workup), which includes</span>
<span class="sd">        supervising during execution.</span>

<span class="sd">        Call this method once you have your task initialized. For each run you</span>
<span class="sd">        can provide a new structure, directory, or command. For example,</span>

<span class="sd">        ``` python</span>
<span class="sd">        from simmate.calculator.example.tasks import ExampleTask</span>

<span class="sd">        my_task = ExampleTask()</span>
<span class="sd">        my_result = my_task.run(structure=my_structure, command=my_command)</span>
<span class="sd">        ```</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
<span class="sd">            function simmate.ulitities.get_directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        - a dictionary of the result, corrections, and working directory used</span>
<span class="sd">        for this task run</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># because the command is something that is frequently changed at the</span>
        <span class="c1"># workflow level, then we want to make it so the user can set it for</span>
        <span class="c1"># each unique task.run() call. Otherwise we grab the default from the</span>
        <span class="c1"># class attribute</span>

        <span class="c1"># make sure a structure was given if it&#39;s required</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_structure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StructureRequiredError</span><span class="p">(</span><span class="s2">&quot;a structure is required as an input&quot;</span><span class="p">)</span>
        <span class="c1"># establish the working directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># run the setup stage of the task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

        <span class="c1"># run the shelltask and error supervision stages. This method returns</span>
        <span class="c1"># a list of any corrections applied during the run.</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

        <span class="c1"># run the workup stage of the task. This is where the data/info is pull</span>
        <span class="c1"># out from the calculation and is thus our &quot;result&quot;.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workup</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># if requested, compresses the directory to a zip file and then removes</span>
        <span class="c1"># the directory.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span><span class="p">:</span>
            <span class="n">make_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="c1"># Return our final information as a dictionary</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="n">corrections</span><span class="p">,</span>
            <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;prefect_flow_run_id&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">flow_run_id</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;flow_run_id&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># when not ran within a prefect flow, there won&#39;t be an id</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grabs the overall settings from the class.</span>

<span class="sd">        By default, this will just grab the class&#39;s __dict__ attribute but this</span>
<span class="sd">        can be overwritten to show only relevent information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the result of get_config and prints it in a yaml format that is</span>
<span class="sd">        easier to read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>


<span class="c1"># Custom errors that indicate exactly what causes the SupervisedStagedTask</span>
<span class="c1"># to exit.</span>


<span class="k">class</span> <span class="nc">MaxCorrectionsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">NonZeroExitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">StructureRequiredError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

        </details>

            </section>
                <section id="S3Task">
                                <div class="attr class">
        <a class="headerlink" href="#S3Task">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">S3Task</span><wbr>(<span class="base">prefect.core.task.Task</span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">S3Task</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Supervised-Staged-Shell Task (aka &quot;S3Task&quot;)</span>
<span class="sd">    -----------------------------------------------</span>

<span class="sd">    This class contains the core functionality to **supervise** a **staged** task</span>
<span class="sd">    involving some **shell** command.</span>

<span class="sd">    Let&#39;s breakdown what this means...</span>

<span class="sd">    A *shell* command is a single call to some external program. For example,</span>
<span class="sd">    VASP requires that we call the &quot;vasp_std &gt; vasp.out&quot; command in order to run a</span>
<span class="sd">    calculation. We consider calling external programs a *staged* task made</span>
<span class="sd">    up of three steps:</span>

<span class="sd">    - setup = writing any input files required for the program</span>
<span class="sd">    - execution = actually calling the command and running our program</span>
<span class="sd">    - workup = loading data from output files back into python</span>

<span class="sd">    And for *supervising* the task, this means we monitor the program while the</span>
<span class="sd">    execution stage is running. So once a program is started, Simmate can check</span>
<span class="sd">    output files for common errors/issues. If an error is found, we stop the</span>
<span class="sd">    program, fix the issue, and then restart it. Any fixes that were made are</span>
<span class="sd">    written to &quot;simmate_corrections.csv&quot;.</span>


<span class="sd">    &lt;!--</span>
<span class="sd">    TODO: Make a simple diagram to visualize the overall process and add it here.</span>
<span class="sd">    It will be similar to Custodian&#39;s, but we don&#39;t have a list of jobs here.</span>
<span class="sd">    https://materialsproject.github.io/custodian/index.html#usage</span>
<span class="sd">    The steps are...</span>

<span class="sd">    - Write Input Files based on custom+defualt settings</span>
<span class="sd">    - Run the calculation by calling the program</span>
<span class="sd">    - Load ouput files</span>
<span class="sd">    - check for errors</span>
<span class="sd">    - [correct them, rerun]</span>
<span class="sd">    - postprocess/analysis</span>
<span class="sd">    --&gt;</span>

<span class="sd">    This entire process (the different stages and monitoring) is carried out</span>
<span class="sd">    using the ``run()`` method. You rarely use this class directly. Instead,</span>
<span class="sd">    you typically use a subclass of it. As a user, you really just need to do</span>
<span class="sd">    something like this:</span>

<span class="sd">    ``` python</span>
<span class="sd">       from simmate.calculator.example.tasks import ExampleTask</span>

<span class="sd">       my_task = ExampleTask()</span>
<span class="sd">       my_result = my_task.run()</span>
<span class="sd">    ```</span>

<span class="sd">    And that&#39;s it!</span>

<span class="sd">    For experts, this class can be viewed as a combination of prefect&#39;s ShellTask,</span>
<span class="sd">    a custodian Job, and Custodian monitoring. When subclassing this, we can absorb</span>
<span class="sd">    functionality of pymatgen.io.vasp.sets too. By merging all of these together</span>
<span class="sd">    into one class, we make things much easier for users and creating new Tasks.</span>


<span class="sd">    Inheriting from this class</span>
<span class="sd">    --------------------------</span>

<span class="sd">    This class is commonly used to make tasks for our calculator modules, so you</span>
<span class="sd">    will likely want to subclass this. Here is a basic example of inheriting</span>
<span class="sd">    and then running a task:</span>

<span class="sd">    ``` python</span>

<span class="sd">    from simmate.workflow_engine.tasks.supervised_staged_shell_task import (</span>
<span class="sd">        S3Task as SSSTask,</span>
<span class="sd">    )</span>
<span class="sd">    from example.error_handlers import PossibleError1, PossibleError2</span>


<span class="sd">    class ExampleTask(SSSTask):</span>

<span class="sd">        command = &quot;echo example&quot;  # just prints out &quot;example&quot;</span>
<span class="sd">        max_corrections = 7</span>
<span class="sd">        error_handlers = [PossibleError1, PossibleError2]</span>
<span class="sd">        polling_timestep = 0.1</span>
<span class="sd">        monitor_freq = 10</span>
<span class="sd">        some_new_setting = 123</span>

<span class="sd">        def setup(self, structure, directory):  # &lt;-- MUST have these two args</span>
<span class="sd">            print(&quot;I&#39;m setting things up!&quot;)</span>
<span class="sd">            print(f&quot;My new setting is {some_new_setting}&quot;)</span>

<span class="sd">        def workup(self, directory):  # &lt;-- MUST have this arg</span>
<span class="sd">            print(&quot;I&#39;m working things up!&quot;)</span>


<span class="sd">    task = ExampleTask()</span>
<span class="sd">    result = task.run()</span>
<span class="sd">    ```</span>

<span class="sd">    There are a couple things to note here:</span>

<span class="sd">    - It&#39;s optional to set/overwrite attributes. You can also add new ones too.</span>
<span class="sd">    - It&#39;s optional to write a new __init__, setup, or workup methods</span>
<span class="sd">    - make sure you include the structure/directory inputs, even if you don&#39;t use them.</span>
<span class="sd">    - Don&#39;t add new kwargs to methods. Instead handle these options through attributes.</span>

<span class="sd">    For a full (and advanced) example, of a subclass take a look at</span>
<span class="sd">    `simmate.calculators.vasp.tasks.base.VaspTask`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># I set this here so that I don&#39;t have to copy/paste the init method</span>
    <span class="c1"># every time I inherit from this class and want to update the default</span>
    <span class="c1"># command to use for the child class.</span>
    <span class="n">command</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The defualt shell command to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># While it&#39;s not needed for a number of cases, it&#39;s extremely common for the</span>
    <span class="c1"># setup method to need an input structure in matsci. I therefore include</span>
    <span class="c1"># this rather than having a nearly identical subclass that could cause</span>
    <span class="c1"># some confusion.</span>
    <span class="n">requires_structure</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Indicates whether a structure is needed if for the run() method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error_handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of ErrorHandler objects to use in order of priority (that is, highest</span>
<span class="sd">    priority is first).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_corrections</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    maximum number of times we can apply a correction and retry the shell command</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Monitoring settings.</span>
    <span class="c1"># These are only ever relevent if there are ErrorHandlers added that have</span>
    <span class="c1"># is_monitor=True. These handlers run while the shelltask itself is also</span>
    <span class="c1"># running. Read more about ErrorHandlers for more info.</span>

    <span class="n">monitor</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Whether to run monitor handlers while the shelltask runs. False means</span>
<span class="sd">    wait until the job has completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">polling_timestep</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If we are monitoring the job for errors while it runs, this is how often</span>
<span class="sd">    (in seconds) we should check the status of our job. Note this check is</span>
<span class="sd">    just whether the job is done or not. This is NOT how often we check for</span>
<span class="sd">    errors. See monitor_freq for that.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">monitor_freq</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The frequency we should run check for errors with our monitors. This is</span>
<span class="sd">    based on the polling_timestep loops. For example, if we have a</span>
<span class="sd">    polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
<span class="sd">    the monitor checks every other loop -- or every 2x10 = 20 seconds. Another</span>
<span class="sd">    example is values of polling_timestep=10 and monitor_freq=30. Here, we&#39;d</span>
<span class="sd">    run monitoring functions every 5 minutes (10x30=300s=5min).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">error_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simmate_corrections.csv&quot;</span><span class="p">,</span>
        <span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Creates a task instance of this class. The parameters passed will be the</span>
<span class="sd">        same every time you call the task.run() method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required. Typically, this</span>
<span class="sd">            class is ran for multiple structures, where you can pass this</span>
<span class="sd">            option to the task.run() method instead.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
<span class="sd">            function simmate.ulitities.get_directory</span>
<span class="sd">        - `error_handlers`:</span>
<span class="sd">            The list of error handler objects to use. These should be listing in</span>
<span class="sd">            order of priority, where to highest priority is first. If one handler</span>
<span class="sd">            is triggered, the correction will be applied and none of the</span>
<span class="sd">            following handlers will be checked.</span>
<span class="sd">        - `max_corrections`:</span>
<span class="sd">            The maximum number of times that corrections will be made before</span>
<span class="sd">            giving up on the calculation. Note, once this limit is exceeded, the</span>
<span class="sd">            error is stored without correcting or restarting the run.</span>
<span class="sd">        - `monitor`:</span>
<span class="sd">            Whether to run monitor handlers while the command runs. False means</span>
<span class="sd">            wait until the job has completed.</span>
<span class="sd">        - `polling_timestep`:</span>
<span class="sd">            If we are monitoring the job for errors while it runs, this is how often</span>
<span class="sd">            (in seconds) we should check the status of our job. Note this check is</span>
<span class="sd">            just whether the job is done or not. This is NOT how often we check for</span>
<span class="sd">            errors. See monitor_freq for that.</span>
<span class="sd">        - `monitor_freq`:</span>
<span class="sd">            The frequency we should run check for errors with our monitors. This is</span>
<span class="sd">            based on the polling_timestep loops. For example, if we have a</span>
<span class="sd">            polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
<span class="sd">            the monitor checks every other loop -- or every 2x10 = 20 seconds. The</span>
<span class="sd">            default values of polling_timestep=10 and monitor_freq=30 indicate that</span>
<span class="sd">            we run monitoring functions every 5 minutes (10x30=300s=5min).</span>
<span class="sd">        - `save_corrections_to_file`:</span>
<span class="sd">            Whether to write a log file of the corrections made. The default is True.</span>
<span class="sd">        - `corrections_filename`:</span>
<span class="sd">            If save_corrections_to_file is True, this is the filename of where</span>
<span class="sd">            to write the corrections. The default is &quot;simmate_corrections.csv&quot;.</span>
<span class="sd">        - `compress_output`:</span>
<span class="sd">            Whether to compress the directory to a zip file at the end of the</span>
<span class="sd">            task run. After compression, it will also delete the directory.</span>
<span class="sd">            The default is False.</span>
<span class="sd">        - `**kwargs`:</span>
<span class="sd">            All extra arguments supported by</span>
<span class="sd">            [prefect.core.task.Task](https://docs.prefect.io/api/latest/core/task.html).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if any of these input parameters were given, overwrite the default</span>
        <span class="c1"># Note to python devs: this odd formatting is because we set our defaults</span>
        <span class="c1"># to None in __init__ while our actual default values are defined above</span>
        <span class="c1"># as class attributes. This may seem funky at first glance, but it</span>
        <span class="c1"># makes inheriting from this class extremely pretty :)</span>
        <span class="c1"># This code is effectively the same as @defaults_from_attrs(...).</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="k">if</span> <span class="n">error_handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="n">error_handlers</span>
        <span class="k">if</span> <span class="n">monitor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="k">if</span> <span class="n">max_corrections</span> <span class="ow">or</span> <span class="n">max_corrections</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span> <span class="o">=</span> <span class="n">max_corrections</span>
        <span class="k">if</span> <span class="n">polling_timestep</span> <span class="ow">or</span> <span class="n">polling_timestep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span> <span class="o">=</span> <span class="n">polling_timestep</span>
        <span class="k">if</span> <span class="n">monitor_freq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">=</span> <span class="n">monitor_freq</span>
        <span class="c1"># These parameters will never have a default which is set to the attribute,</span>
        <span class="c1"># so go ahead and set them from what was given in the init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span> <span class="o">=</span> <span class="n">compress_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="o">=</span> <span class="n">save_corrections_to_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span> <span class="o">=</span> <span class="n">corrections_filename</span>

        <span class="c1"># now inherit the parent Prefect Task class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This abstract method is ran before the command is actually executed. This</span>
<span class="sd">        allows for some pre-processing, such as writing input files or any other</span>
<span class="sd">        analysis.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase setup() is normally called within the run() method.</span>

<span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
<span class="sd">        doesn&#39;t nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. Must exist already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Be sure to include directory and structure (or **kwargs) as input arguments</span>
        <span class="c1"># for higher-level compatibility with the run method.</span>
        <span class="c1"># You should never need to call this method directly!</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This calls the command within the target directory and handles all error</span>
<span class="sd">        handling as well as monitoring of the job.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase `execute` is normally called within the `run` method.</span>

<span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
<span class="sd">        does nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        - `corrections`</span>
<span class="sd">            A list of tuples where each entry is a error identified and the</span>
<span class="sd">            correction applied. Ex: [(&quot;ExampleError&quot;, &quot;ExampleCorrection&quot;)]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># some error_handlers run while the shelltask is running. These are known as</span>
        <span class="c1"># Monitors and are labled via the is_monitor attribute. It&#39;s good for us</span>
        <span class="c1"># to separate these out from other error_handlers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_monitor</span>
        <span class="p">]</span>

        <span class="c1"># We start with zero corrections that we slowly add to. This can be</span>
        <span class="c1"># thought of as a table with headers of...</span>
        <span class="c1">#   (&quot;applied_errorhandler&quot;, &quot;correction_applied&quot;)</span>
        <span class="c1"># NOTE: I took out the table headers and may add them back in</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ------ start of main while loop ------</span>

        <span class="c1"># we can try running the shelltask up to max_corrections. Because only one</span>
        <span class="c1"># correction is applied per attempt, you can view this as the maximum</span>
        <span class="c1"># number of attempts made on the calculation.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>

            <span class="c1"># launch the shelltask without waiting for it to complete. Also,</span>
            <span class="c1"># make sure to use common shell commands and to set the working</span>
            <span class="c1"># directory.</span>
            <span class="c1"># The preexec_fn keyword allows us to properly terminate jobs that</span>
            <span class="c1"># are launched with parallel processes (such as mpirun). This assigns</span>
            <span class="c1"># a parent id to it that we use when killing a job (if an error</span>
            <span class="c1"># handler calls for us to do so). This isn&#39;t possible on Windows though.</span>
            <span class="c1"># Stderr keyword indicates that we should capture the error if one</span>
            <span class="c1"># occurs so that we can report it to the user.</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">preexec_fn</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Assume the shelltask has no errors until proven otherwise</span>
            <span class="n">has_error</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># If monitor=True, then we want to supervise this shelltask as it</span>
            <span class="c1"># runs. If montors=[m1,m2,...], then we have monitors in place to actually</span>
            <span class="c1"># perform the monitoring. If both of these cases are true, then we</span>
            <span class="c1"># want to go through the error_handlers to check for errors until</span>
            <span class="c1"># the shelltask completes.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>

                <span class="c1"># ------ start of monitor while loop ------</span>

                <span class="c1"># We want to loop until we find an error and keep track of</span>
                <span class="c1"># which loops to run the monitor function on because we don&#39;t</span>
                <span class="c1"># want them to run nonstop. This variable allows us to monitor</span>
                <span class="c1"># checks every Nth loop, while we check the shelltask status</span>
                <span class="c1"># on all other loops.</span>
                <span class="n">monitor_freq_n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                    <span class="n">monitor_freq_n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Sleep the set amount before checking the shelltask status</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span><span class="p">)</span>

                    <span class="c1"># check if the shelltasks is complete. poll will return 0</span>
                    <span class="c1"># when it&#39;s done, in which case we break the loop</span>
                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="c1"># check whether we should run monitors on this poll loop</span>
                    <span class="k">if</span> <span class="n">monitor_freq_n</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># iterate through each monitor</span>
                        <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
                            <span class="c1"># check if there&#39;s an error with this error_handler</span>
                            <span class="c1"># and grab the error if so</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                                <span class="c1"># determine if it is_terminating</span>
                                <span class="k">if</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">is_terminating</span><span class="p">:</span>
                                    <span class="c1"># If so, we kill the process but don&#39;t apply</span>
                                    <span class="c1"># the fix quite yet. That step is done below.</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                                <span class="c1"># Otherwise apply the fix and let the shelltask end</span>
                                <span class="c1"># naturally. An example of this is for codes</span>
                                <span class="c1"># where you add a STOP file to get it to</span>
                                <span class="c1"># finish rather than just killing the process.</span>
                                <span class="c1"># This is the special case error_handler that I talk</span>
                                <span class="c1"># about in my notes, where we really want to</span>
                                <span class="c1"># end the shelltask right away.</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># apply the fix now</span>
                                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                                    <span class="c1"># record what&#39;s been changed</span>
                                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
                                <span class="c1"># there&#39;s no need to look at the other monitors</span>
                                <span class="c1"># so break from the for-loop. We also don&#39;t</span>
                                <span class="c1"># need to monitor the stagedtask anymore since we just</span>
                                <span class="c1"># terminated it or signaled for its graceful</span>
                                <span class="c1"># end. So update the while-loop condition.</span>
                                <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                <span class="c1"># ------ end of monitor while loop ------</span>
            <span class="c1"># Now just wait for the process to finish. Note we use communicate</span>
            <span class="c1"># instead of the .wait() method. This is the recommended method</span>
            <span class="c1"># when we have stderr=subprocess.PIPE, which we use above.</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="c1"># check if the return code is non-zero and thus failed.</span>
            <span class="c1"># The &#39;not has_error&#39; is because terminate() will give a nonzero</span>
            <span class="c1"># when a monitor is triggered. We don&#39;t want to raise that</span>
            <span class="c1"># exception here but instead let the monitor handle that</span>
            <span class="c1"># error in the code below.</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="c1"># convert the error from bytes to a string</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1"># and report the error to the user</span>
                <span class="k">raise</span> <span class="n">NonZeroExitError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The command (</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">) failed. The error output was...</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Check for errors again, because a non-monitor may be higher</span>
            <span class="c1"># priority than the monitor triggered above (if there was one).</span>
            <span class="c1"># Since the error_handlers are in order of priority, only the first</span>
            <span class="c1"># will actually be applied and then we can retry the calc.</span>
            <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>

                <span class="c1"># NOTE - The following special case is handled above:</span>
                <span class="c1">#   error_handler.is_monitor and not error_handler.is_terminating</span>
                <span class="c1"># BUG: I can see this being a source of bugs in the process so I</span>
                <span class="c1"># need to reconsider subclassing this special case. For now,</span>
                <span class="c1"># users should have this case at the lowest priority.</span>

                <span class="c1"># check if there&#39;s an error with this error_handler and grab the</span>
                <span class="c1"># error if there is one</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="c1"># record the error in case it wasn&#39;t done so above</span>
                    <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># And apply the proper correction if there is one.</span>
                    <span class="c1"># Some error_handlers will even raise an error here signaling</span>
                    <span class="c1"># that the stagedtask is unrecoverable and a lost cause.</span>
                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="c1"># record what&#39;s been changed</span>
                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
                    <span class="c1"># break from the error_handler for-loop as we only apply the</span>
                    <span class="c1"># highest priority fix and nothing else.</span>
                    <span class="k">break</span>
            <span class="c1"># write the log of corrections to file if requested. This is written</span>
            <span class="c1"># as a CSV file format and done every while-loop cycle because it</span>
            <span class="c1"># lets the user monitor the calculation and error handlers applied</span>
            <span class="c1"># as it goes. If no corrections were applied, we skip writing the file.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="ow">and</span> <span class="n">corrections</span><span class="p">:</span>
                <span class="c1"># compile the corrections metadata into a dataframe</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">corrections</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_applied&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="c1"># write the dataframe to a csv file</span>
                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># now that we&#39;ve gone through the error_handlers, let&#39;s see if any</span>
            <span class="c1"># non-terminating errors were found (terminating ones would raise</span>
            <span class="c1"># an error above). If there are no errors, we&#39;ve finished the</span>
            <span class="c1"># calculation and can exit the while loop. Otherwise, just leave</span>
            <span class="c1"># everything where it&#39;s at and restart the while-loop with a new</span>
            <span class="c1"># attempt</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="c1"># break the while-loop</span>
                <span class="k">break</span>
        <span class="c1"># ------ end of main while loop ------</span>

        <span class="c1"># make sure the while loop didn&#39;t exit because of the correction limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxCorrectionsError</span><span class="p">(</span>
                <span class="s2">&quot;The number of maximum corrections has been exceeded. Note the final &quot;</span>
                <span class="s2">&quot;error and its fix are still listed in the corrections file, but it &quot;</span>
                <span class="s2">&quot;was never used.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># now return the corrections for them to stored/used elsewhere</span>
        <span class="k">return</span> <span class="n">corrections</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stopping the command we submitted can be a tricky business if we are running</span>
<span class="sd">        scripts in parallel (such as using mpirun). Different computers and OSs</span>
<span class="sd">        can require a different &#39;kill&#39; command so we establish this separate</span>
<span class="sd">        method that can be overwritten.</span>

<span class="sd">        If you know your command needs a special case to kill all of its spawn</span>
<span class="sd">        processes, you can overwrite this method as well.</span>

<span class="sd">        Users should never call this directly becuase this is instead applied</span>
<span class="sd">        within the execute() method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `process`:</span>
<span class="sd">            The process object that will be terminated.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            the command used to launch the process. This is sometimes useful</span>
<span class="sd">            when searching for all running processes under this name.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The operating system (Windows, OSX, or Linux) will give us the best guess</span>
        <span class="c1"># as to where to access the blender command. The results are as you&#39;d expect</span>
        <span class="c1"># except for Macs, which return &quot;Darwin&quot;.</span>
        <span class="c1">#   Linux: Linux</span>
        <span class="c1">#   Mac: Darwin</span>
        <span class="c1">#   Windows: Windows</span>
        <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

        <span class="c1"># The normal line to end a popen process is just...</span>
        <span class="c1">#   process.terminate()</span>
        <span class="c1"># However this struggles to kill all &quot;child&quot; processes if we are using</span>
        <span class="c1"># something like mpirun to run things in parallel. Instead, we use the</span>
        <span class="c1"># os module to grab the parent id and send that the termination signal,</span>
        <span class="c1"># which # is also passed on to all child processes.</span>
        <span class="c1"># This command also doesn not work on windows, so I need to address this</span>
        <span class="c1"># as well.</span>
        <span class="k">if</span> <span class="n">operating_system</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
        <span class="c1"># note: SIGTERM is the normal signal but I use SIGKILL to try to address</span>
        <span class="c1"># permission errors.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

        <span class="c1"># As an example of an alternative approach to killing a job, here is</span>
        <span class="c1"># what Custodian (Materials Project) tries when killing a VASP job</span>
        <span class="c1"># submitted through mpirun:</span>
        <span class="c1"># try:</span>
        <span class="c1">#     os.system(&quot;killall vasp&quot;)</span>
        <span class="c1"># except Exception:</span>
        <span class="c1">#     pass</span>

        <span class="c1"># TODO: make it so terminate scripts can be loaded from the user&#39;s config</span>
        <span class="c1"># directory, which will make it so they don&#39;t have to overwrite all the</span>
        <span class="c1"># classes that inherit from this one.</span>

    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called at the end of a job, *after* error detection.</span>
<span class="sd">        This allows post-processing, such as cleanup, analysis of results,</span>
<span class="sd">        etc. This should return the result of the entire job, such as a</span>
<span class="sd">        the final structure or final energy calculated.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase workup() is normally called within the run() method.</span>

<span class="sd">        Some tasks don&#39;t require a workup() method, so by default, this method</span>
<span class="sd">        does nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Be sure to include directory (or **kwargs) as input argument for</span>
        <span class="c1"># higher-level compatibility with the run method and SupervisedStagedTask</span>
        <span class="c1"># You should never need to call this method directly!</span>
        <span class="k">pass</span>

    <span class="nd">@defaults_from_attrs</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the entire staged task (setup, execution, workup), which includes</span>
<span class="sd">        supervising during execution.</span>

<span class="sd">        Call this method once you have your task initialized. For each run you</span>
<span class="sd">        can provide a new structure, directory, or command. For example,</span>

<span class="sd">        ``` python</span>
<span class="sd">        from simmate.calculator.example.tasks import ExampleTask</span>

<span class="sd">        my_task = ExampleTask()</span>
<span class="sd">        my_result = my_task.run(structure=my_structure, command=my_command)</span>
<span class="sd">        ```</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
<span class="sd">            function simmate.ulitities.get_directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        - a dictionary of the result, corrections, and working directory used</span>
<span class="sd">        for this task run</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># because the command is something that is frequently changed at the</span>
        <span class="c1"># workflow level, then we want to make it so the user can set it for</span>
        <span class="c1"># each unique task.run() call. Otherwise we grab the default from the</span>
        <span class="c1"># class attribute</span>

        <span class="c1"># make sure a structure was given if it&#39;s required</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_structure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StructureRequiredError</span><span class="p">(</span><span class="s2">&quot;a structure is required as an input&quot;</span><span class="p">)</span>
        <span class="c1"># establish the working directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># run the setup stage of the task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

        <span class="c1"># run the shelltask and error supervision stages. This method returns</span>
        <span class="c1"># a list of any corrections applied during the run.</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

        <span class="c1"># run the workup stage of the task. This is where the data/info is pull</span>
        <span class="c1"># out from the calculation and is thus our &quot;result&quot;.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workup</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># if requested, compresses the directory to a zip file and then removes</span>
        <span class="c1"># the directory.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span><span class="p">:</span>
            <span class="n">make_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="c1"># Return our final information as a dictionary</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="n">corrections</span><span class="p">,</span>
            <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;prefect_flow_run_id&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">flow_run_id</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;flow_run_id&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># when not ran within a prefect flow, there won&#39;t be an id</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grabs the overall settings from the class.</span>

<span class="sd">        By default, this will just grab the class&#39;s __dict__ attribute but this</span>
<span class="sd">        can be overwritten to show only relevent information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the result of get_config and prints it in a yaml format that is</span>
<span class="sd">        easier to read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</pre></div>

        </details>

            <div class="docstring"><h2 id="the-supervised-staged-shell-task-aka-s3task">The Supervised-Staged-Shell Task (aka "S3Task")</h2>

<p>This class contains the core functionality to <strong>supervise</strong> a <strong>staged</strong> task
involving some <strong>shell</strong> command.</p>

<p>Let's breakdown what this means...</p>

<p>A <em>shell</em> command is a single call to some external program. For example,
VASP requires that we call the "vasp_std &gt; vasp.out" command in order to run a
calculation. We consider calling external programs a <em>staged</em> task made
up of three steps:</p>

<ul>
<li>setup = writing any input files required for the program</li>
<li>execution = actually calling the command and running our program</li>
<li>workup = loading data from output files back into python</li>
</ul>

<p>And for <em>supervising</em> the task, this means we monitor the program while the
execution stage is running. So once a program is started, Simmate can check
output files for common errors/issues. If an error is found, we stop the
program, fix the issue, and then restart it. Any fixes that were made are
written to "simmate_corrections.csv".</p>

<!--
TODO: Make a simple diagram to visualize the overall process and add it here.
It will be similar to Custodian's, but we don't have a list of jobs here.
https://materialsproject.github.io/custodian/index.html#usage
The steps are...

- Write Input Files based on custom+defualt settings
- Run the calculation by calling the program
- Load ouput files
- check for errors
- [correct them, rerun]
- postprocess/analysis
-->

<p>This entire process (the different stages and monitoring) is carried out
using the <code><a href="#S3Task.run">run()</a></code> method. You rarely use this class directly. Instead,
you typically use a subclass of it. As a user, you really just need to do
something like this:</p>

<div class="codehilite"><pre><span></span><code>   <span class="kn">from</span> <span class="nn"><a href="../../../simmate.html#calculator.example.tasks">simmate.calculator.example.tasks</a></span> <span class="kn">import</span> <span class="n">ExampleTask</span>

   <span class="n">my_task</span> <span class="o">=</span> <span class="n">ExampleTask</span><span class="p">()</span>
   <span class="n">my_result</span> <span class="o">=</span> <span class="n">my_task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>And that's it!</p>

<p>For experts, this class can be viewed as a combination of prefect's ShellTask,
a custodian Job, and Custodian monitoring. When subclassing this, we can absorb
functionality of pymatgen.io.vasp.sets too. By merging all of these together
into one class, we make things much easier for users and creating new Tasks.</p>

<h2 id="inheriting-from-this-class">Inheriting from this class</h2>

<p>This class is commonly used to make tasks for our calculator modules, so you
will likely want to subclass this. Here is a basic example of inheriting
and then running a task:</p>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="">simmate.workflow_engine.tasks.supervised_staged_shell_task</a></span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">S3Task</span> <span class="k">as</span> <span class="n">SSSTask</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">example.error_handlers</span> <span class="kn">import</span> <span class="n">PossibleError1</span><span class="p">,</span> <span class="n">PossibleError2</span>


<span class="k">class</span> <span class="nc">ExampleTask</span><span class="p">(</span><span class="n">SSSTask</span><span class="p">):</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;echo example&quot;</span>  <span class="c1"># just prints out &quot;example&quot;</span>
    <span class="n">max_corrections</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">error_handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">PossibleError1</span><span class="p">,</span> <span class="n">PossibleError2</span><span class="p">]</span>
    <span class="n">polling_timestep</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">monitor_freq</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">some_new_setting</span> <span class="o">=</span> <span class="mi">123</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>  <span class="c1"># &lt;-- MUST have these two args</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m setting things up!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;My new setting is </span><span class="si">{</span><span class="n">some_new_setting</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>  <span class="c1"># &lt;-- MUST have this arg</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m working things up!&quot;</span><span class="p">)</span>


<span class="n">task</span> <span class="o">=</span> <span class="n">ExampleTask</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>There are a couple things to note here:</p>

<ul>
<li>It's optional to set/overwrite attributes. You can also add new ones too.</li>
<li>It's optional to write a new __init__, setup, or workup methods</li>
<li>make sure you include the structure/directory inputs, even if you don't use them.</li>
<li>Don't add new kwargs to methods. Instead handle these options through attributes.</li>
</ul>

<p>For a full (and advanced) example, of a subclass take a look at
<code><a href="../../calculators/vasp/tasks/base.html#VaspTask">simmate.calculators.vasp.tasks.base.VaspTask</a></code>.</p>
</div>


                            <div id="S3Task.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">S3Task</span><span class="signature">(
    structure: pymatgen.core.structure.Structure = None,
    command: str = None,
    directory: str = None,
    error_handlers: List[<a href="../error_handler.html#ErrorHandler">simmate.workflow_engine.error_handler.ErrorHandler</a>] = None,
    max_corrections: int = None,
    monitor: bool = None,
    polling_timestep: float = None,
    monitor_freq: int = None,
    save_corrections_to_file: bool = True,
    corrections_filename: str = &#39;simmate_corrections.csv&#39;,
    compress_output: bool = False,
    **kwargs: Any
)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">error_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simmate_corrections.csv&quot;</span><span class="p">,</span>
        <span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Creates a task instance of this class. The parameters passed will be the</span>
<span class="sd">        same every time you call the task.run() method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required. Typically, this</span>
<span class="sd">            class is ran for multiple structures, where you can pass this</span>
<span class="sd">            option to the task.run() method instead.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
<span class="sd">            function simmate.ulitities.get_directory</span>
<span class="sd">        - `error_handlers`:</span>
<span class="sd">            The list of error handler objects to use. These should be listing in</span>
<span class="sd">            order of priority, where to highest priority is first. If one handler</span>
<span class="sd">            is triggered, the correction will be applied and none of the</span>
<span class="sd">            following handlers will be checked.</span>
<span class="sd">        - `max_corrections`:</span>
<span class="sd">            The maximum number of times that corrections will be made before</span>
<span class="sd">            giving up on the calculation. Note, once this limit is exceeded, the</span>
<span class="sd">            error is stored without correcting or restarting the run.</span>
<span class="sd">        - `monitor`:</span>
<span class="sd">            Whether to run monitor handlers while the command runs. False means</span>
<span class="sd">            wait until the job has completed.</span>
<span class="sd">        - `polling_timestep`:</span>
<span class="sd">            If we are monitoring the job for errors while it runs, this is how often</span>
<span class="sd">            (in seconds) we should check the status of our job. Note this check is</span>
<span class="sd">            just whether the job is done or not. This is NOT how often we check for</span>
<span class="sd">            errors. See monitor_freq for that.</span>
<span class="sd">        - `monitor_freq`:</span>
<span class="sd">            The frequency we should run check for errors with our monitors. This is</span>
<span class="sd">            based on the polling_timestep loops. For example, if we have a</span>
<span class="sd">            polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
<span class="sd">            the monitor checks every other loop -- or every 2x10 = 20 seconds. The</span>
<span class="sd">            default values of polling_timestep=10 and monitor_freq=30 indicate that</span>
<span class="sd">            we run monitoring functions every 5 minutes (10x30=300s=5min).</span>
<span class="sd">        - `save_corrections_to_file`:</span>
<span class="sd">            Whether to write a log file of the corrections made. The default is True.</span>
<span class="sd">        - `corrections_filename`:</span>
<span class="sd">            If save_corrections_to_file is True, this is the filename of where</span>
<span class="sd">            to write the corrections. The default is &quot;simmate_corrections.csv&quot;.</span>
<span class="sd">        - `compress_output`:</span>
<span class="sd">            Whether to compress the directory to a zip file at the end of the</span>
<span class="sd">            task run. After compression, it will also delete the directory.</span>
<span class="sd">            The default is False.</span>
<span class="sd">        - `**kwargs`:</span>
<span class="sd">            All extra arguments supported by</span>
<span class="sd">            [prefect.core.task.Task](https://docs.prefect.io/api/latest/core/task.html).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if any of these input parameters were given, overwrite the default</span>
        <span class="c1"># Note to python devs: this odd formatting is because we set our defaults</span>
        <span class="c1"># to None in __init__ while our actual default values are defined above</span>
        <span class="c1"># as class attributes. This may seem funky at first glance, but it</span>
        <span class="c1"># makes inheriting from this class extremely pretty :)</span>
        <span class="c1"># This code is effectively the same as @defaults_from_attrs(...).</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="k">if</span> <span class="n">error_handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="n">error_handlers</span>
        <span class="k">if</span> <span class="n">monitor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="k">if</span> <span class="n">max_corrections</span> <span class="ow">or</span> <span class="n">max_corrections</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span> <span class="o">=</span> <span class="n">max_corrections</span>
        <span class="k">if</span> <span class="n">polling_timestep</span> <span class="ow">or</span> <span class="n">polling_timestep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span> <span class="o">=</span> <span class="n">polling_timestep</span>
        <span class="k">if</span> <span class="n">monitor_freq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">=</span> <span class="n">monitor_freq</span>
        <span class="c1"># These parameters will never have a default which is set to the attribute,</span>
        <span class="c1"># so go ahead and set them from what was given in the init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span> <span class="o">=</span> <span class="n">compress_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="o">=</span> <span class="n">save_corrections_to_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span> <span class="o">=</span> <span class="n">corrections_filename</span>

        <span class="c1"># now inherit the parent Prefect Task class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Creates a task instance of this class. The parameters passed will be the
same every time you call the task.run() method.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><code>structure</code>:
The structure to use for the task, if one is required. Typically, this
class is ran for multiple structures, where you can pass this
option to the task.run() method instead.</li>
<li><code><a href="#S3Task.command">command</a></code>:
The command that will be called during execution.</li>
<li><code>directory</code>:
The directory to run everything in. This is passed to the ulitities
function <a href="../../../simmate.html#ulitities.get_directory">simmate.ulitities.get_directory</a></li>
<li><code><a href="#S3Task.error_handlers">error_handlers</a></code>:
The list of error handler objects to use. These should be listing in
order of priority, where to highest priority is first. If one handler
is triggered, the correction will be applied and none of the
following handlers will be checked.</li>
<li><code><a href="#S3Task.max_corrections">max_corrections</a></code>:
The maximum number of times that corrections will be made before
giving up on the calculation. Note, once this limit is exceeded, the
error is stored without correcting or restarting the run.</li>
<li><code><a href="#S3Task.monitor">monitor</a></code>:
Whether to run monitor handlers while the command runs. False means
wait until the job has completed.</li>
<li><code><a href="#S3Task.polling_timestep">polling_timestep</a></code>:
If we are monitoring the job for errors while it runs, this is how often
(in seconds) we should check the status of our job. Note this check is
just whether the job is done or not. This is NOT how often we check for
errors. See monitor_freq for that.</li>
<li><code><a href="#S3Task.monitor_freq">monitor_freq</a></code>:
The frequency we should run check for errors with our monitors. This is
based on the polling_timestep loops. For example, if we have a
polling_timestep of 10 seconds and a monitor_freq of 2, then we would run
the monitor checks every other loop -- or every 2x10 = 20 seconds. The
default values of polling_timestep=10 and monitor_freq=30 indicate that
we run monitoring functions every 5 minutes (10x30=300s=5min).</li>
<li><code>save_corrections_to_file</code>:
Whether to write a log file of the corrections made. The default is True.</li>
<li><code>corrections_filename</code>:
If save_corrections_to_file is True, this is the filename of where
to write the corrections. The default is "simmate_corrections.csv".</li>
<li><code>compress_output</code>:
Whether to compress the directory to a zip file at the end of the
task run. After compression, it will also delete the directory.
The default is False.</li>
<li><code>**kwargs</code>:
All extra arguments supported by
<a href="https://docs.prefect.io/api/latest/core/task.html">prefect.core.task.Task</a>.</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.command" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.command">#&nbsp;&nbsp</a>

        <span class="name">command</span><span class="default_value"> = None</span>
    </div>

            <div class="docstring"><p>The defualt shell command to use.</p>
</div>


                            </div>
                            <div id="S3Task.requires_structure" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.requires_structure">#&nbsp;&nbsp</a>

        <span class="name">requires_structure</span><span class="default_value"> = False</span>
    </div>

            <div class="docstring"><p>Indicates whether a structure is needed if for the run() method.</p>
</div>


                            </div>
                            <div id="S3Task.error_handlers" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.error_handlers">#&nbsp;&nbsp</a>

        <span class="name">error_handlers</span><span class="default_value"> = []</span>
    </div>

            <div class="docstring"><p>A list of ErrorHandler objects to use in order of priority (that is, highest
priority is first).</p>
</div>


                            </div>
                            <div id="S3Task.max_corrections" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.max_corrections">#&nbsp;&nbsp</a>

        <span class="name">max_corrections</span><span class="default_value"> = 5</span>
    </div>

            <div class="docstring"><p>maximum number of times we can apply a correction and retry the shell command</p>
</div>


                            </div>
                            <div id="S3Task.monitor" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.monitor">#&nbsp;&nbsp</a>

        <span class="name">monitor</span><span class="default_value"> = True</span>
    </div>

            <div class="docstring"><p>Whether to run monitor handlers while the shelltask runs. False means
wait until the job has completed.</p>
</div>


                            </div>
                            <div id="S3Task.polling_timestep" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.polling_timestep">#&nbsp;&nbsp</a>

        <span class="name">polling_timestep</span><span class="default_value"> = 1</span>
    </div>

            <div class="docstring"><p>If we are monitoring the job for errors while it runs, this is how often
(in seconds) we should check the status of our job. Note this check is
just whether the job is done or not. This is NOT how often we check for
errors. See monitor_freq for that.</p>
</div>


                            </div>
                            <div id="S3Task.monitor_freq" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#S3Task.monitor_freq">#&nbsp;&nbsp</a>

        <span class="name">monitor_freq</span><span class="default_value"> = 300</span>
    </div>

            <div class="docstring"><p>The frequency we should run check for errors with our monitors. This is
based on the polling_timestep loops. For example, if we have a
polling_timestep of 10 seconds and a monitor_freq of 2, then we would run
the monitor checks every other loop -- or every 2x10 = 20 seconds. Another
example is values of polling_timestep=10 and monitor_freq=30. Here, we'd
run monitoring functions every 5 minutes (10x30=300s=5min).</p>
</div>


                            </div>
                            <div id="S3Task.setup" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.setup">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">setup</span><span class="signature">(self, structure: pymatgen.core.structure.Structure, directory: str)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This abstract method is ran before the command is actually executed. This</span>
<span class="sd">        allows for some pre-processing, such as writing input files or any other</span>
<span class="sd">        analysis.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase setup() is normally called within the run() method.</span>

<span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
<span class="sd">        doesn&#39;t nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. Must exist already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Be sure to include directory and structure (or **kwargs) as input arguments</span>
        <span class="c1"># for higher-level compatibility with the run method.</span>
        <span class="c1"># You should never need to call this method directly!</span>
        <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>This abstract method is ran before the command is actually executed. This
allows for some pre-processing, such as writing input files or any other
analysis.</p>

<p>You should never call this method directly unless you are debugging. This
is becuase setup() is normally called within the run() method.</p>

<p>Some tasks don't require a setup() method, so by default, this method
doesn't nothing but "pass".</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><code>structure</code>:
The structure to use for the task, if one is required.</li>
<li><code>directory</code>:
The directory to run everything in. Must exist already.</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.execute" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.execute">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">execute</span><span class="signature">(self, directory: str, command: str)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This calls the command within the target directory and handles all error</span>
<span class="sd">        handling as well as monitoring of the job.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase `execute` is normally called within the `run` method.</span>

<span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
<span class="sd">        does nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        - `corrections`</span>
<span class="sd">            A list of tuples where each entry is a error identified and the</span>
<span class="sd">            correction applied. Ex: [(&quot;ExampleError&quot;, &quot;ExampleCorrection&quot;)]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># some error_handlers run while the shelltask is running. These are known as</span>
        <span class="c1"># Monitors and are labled via the is_monitor attribute. It&#39;s good for us</span>
        <span class="c1"># to separate these out from other error_handlers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_monitor</span>
        <span class="p">]</span>

        <span class="c1"># We start with zero corrections that we slowly add to. This can be</span>
        <span class="c1"># thought of as a table with headers of...</span>
        <span class="c1">#   (&quot;applied_errorhandler&quot;, &quot;correction_applied&quot;)</span>
        <span class="c1"># NOTE: I took out the table headers and may add them back in</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ------ start of main while loop ------</span>

        <span class="c1"># we can try running the shelltask up to max_corrections. Because only one</span>
        <span class="c1"># correction is applied per attempt, you can view this as the maximum</span>
        <span class="c1"># number of attempts made on the calculation.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>

            <span class="c1"># launch the shelltask without waiting for it to complete. Also,</span>
            <span class="c1"># make sure to use common shell commands and to set the working</span>
            <span class="c1"># directory.</span>
            <span class="c1"># The preexec_fn keyword allows us to properly terminate jobs that</span>
            <span class="c1"># are launched with parallel processes (such as mpirun). This assigns</span>
            <span class="c1"># a parent id to it that we use when killing a job (if an error</span>
            <span class="c1"># handler calls for us to do so). This isn&#39;t possible on Windows though.</span>
            <span class="c1"># Stderr keyword indicates that we should capture the error if one</span>
            <span class="c1"># occurs so that we can report it to the user.</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">preexec_fn</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Assume the shelltask has no errors until proven otherwise</span>
            <span class="n">has_error</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># If monitor=True, then we want to supervise this shelltask as it</span>
            <span class="c1"># runs. If montors=[m1,m2,...], then we have monitors in place to actually</span>
            <span class="c1"># perform the monitoring. If both of these cases are true, then we</span>
            <span class="c1"># want to go through the error_handlers to check for errors until</span>
            <span class="c1"># the shelltask completes.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>

                <span class="c1"># ------ start of monitor while loop ------</span>

                <span class="c1"># We want to loop until we find an error and keep track of</span>
                <span class="c1"># which loops to run the monitor function on because we don&#39;t</span>
                <span class="c1"># want them to run nonstop. This variable allows us to monitor</span>
                <span class="c1"># checks every Nth loop, while we check the shelltask status</span>
                <span class="c1"># on all other loops.</span>
                <span class="n">monitor_freq_n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                    <span class="n">monitor_freq_n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Sleep the set amount before checking the shelltask status</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span><span class="p">)</span>

                    <span class="c1"># check if the shelltasks is complete. poll will return 0</span>
                    <span class="c1"># when it&#39;s done, in which case we break the loop</span>
                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="c1"># check whether we should run monitors on this poll loop</span>
                    <span class="k">if</span> <span class="n">monitor_freq_n</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># iterate through each monitor</span>
                        <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
                            <span class="c1"># check if there&#39;s an error with this error_handler</span>
                            <span class="c1"># and grab the error if so</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                                <span class="c1"># determine if it is_terminating</span>
                                <span class="k">if</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">is_terminating</span><span class="p">:</span>
                                    <span class="c1"># If so, we kill the process but don&#39;t apply</span>
                                    <span class="c1"># the fix quite yet. That step is done below.</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                                <span class="c1"># Otherwise apply the fix and let the shelltask end</span>
                                <span class="c1"># naturally. An example of this is for codes</span>
                                <span class="c1"># where you add a STOP file to get it to</span>
                                <span class="c1"># finish rather than just killing the process.</span>
                                <span class="c1"># This is the special case error_handler that I talk</span>
                                <span class="c1"># about in my notes, where we really want to</span>
                                <span class="c1"># end the shelltask right away.</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># apply the fix now</span>
                                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                                    <span class="c1"># record what&#39;s been changed</span>
                                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
                                <span class="c1"># there&#39;s no need to look at the other monitors</span>
                                <span class="c1"># so break from the for-loop. We also don&#39;t</span>
                                <span class="c1"># need to monitor the stagedtask anymore since we just</span>
                                <span class="c1"># terminated it or signaled for its graceful</span>
                                <span class="c1"># end. So update the while-loop condition.</span>
                                <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                <span class="c1"># ------ end of monitor while loop ------</span>
            <span class="c1"># Now just wait for the process to finish. Note we use communicate</span>
            <span class="c1"># instead of the .wait() method. This is the recommended method</span>
            <span class="c1"># when we have stderr=subprocess.PIPE, which we use above.</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="c1"># check if the return code is non-zero and thus failed.</span>
            <span class="c1"># The &#39;not has_error&#39; is because terminate() will give a nonzero</span>
            <span class="c1"># when a monitor is triggered. We don&#39;t want to raise that</span>
            <span class="c1"># exception here but instead let the monitor handle that</span>
            <span class="c1"># error in the code below.</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="c1"># convert the error from bytes to a string</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1"># and report the error to the user</span>
                <span class="k">raise</span> <span class="n">NonZeroExitError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The command (</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">) failed. The error output was...</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Check for errors again, because a non-monitor may be higher</span>
            <span class="c1"># priority than the monitor triggered above (if there was one).</span>
            <span class="c1"># Since the error_handlers are in order of priority, only the first</span>
            <span class="c1"># will actually be applied and then we can retry the calc.</span>
            <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>

                <span class="c1"># NOTE - The following special case is handled above:</span>
                <span class="c1">#   error_handler.is_monitor and not error_handler.is_terminating</span>
                <span class="c1"># BUG: I can see this being a source of bugs in the process so I</span>
                <span class="c1"># need to reconsider subclassing this special case. For now,</span>
                <span class="c1"># users should have this case at the lowest priority.</span>

                <span class="c1"># check if there&#39;s an error with this error_handler and grab the</span>
                <span class="c1"># error if there is one</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="c1"># record the error in case it wasn&#39;t done so above</span>
                    <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># And apply the proper correction if there is one.</span>
                    <span class="c1"># Some error_handlers will even raise an error here signaling</span>
                    <span class="c1"># that the stagedtask is unrecoverable and a lost cause.</span>
                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="c1"># record what&#39;s been changed</span>
                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
                    <span class="c1"># break from the error_handler for-loop as we only apply the</span>
                    <span class="c1"># highest priority fix and nothing else.</span>
                    <span class="k">break</span>
            <span class="c1"># write the log of corrections to file if requested. This is written</span>
            <span class="c1"># as a CSV file format and done every while-loop cycle because it</span>
            <span class="c1"># lets the user monitor the calculation and error handlers applied</span>
            <span class="c1"># as it goes. If no corrections were applied, we skip writing the file.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="ow">and</span> <span class="n">corrections</span><span class="p">:</span>
                <span class="c1"># compile the corrections metadata into a dataframe</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">corrections</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_applied&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="c1"># write the dataframe to a csv file</span>
                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># now that we&#39;ve gone through the error_handlers, let&#39;s see if any</span>
            <span class="c1"># non-terminating errors were found (terminating ones would raise</span>
            <span class="c1"># an error above). If there are no errors, we&#39;ve finished the</span>
            <span class="c1"># calculation and can exit the while loop. Otherwise, just leave</span>
            <span class="c1"># everything where it&#39;s at and restart the while-loop with a new</span>
            <span class="c1"># attempt</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
                <span class="c1"># break the while-loop</span>
                <span class="k">break</span>
        <span class="c1"># ------ end of main while loop ------</span>

        <span class="c1"># make sure the while loop didn&#39;t exit because of the correction limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxCorrectionsError</span><span class="p">(</span>
                <span class="s2">&quot;The number of maximum corrections has been exceeded. Note the final &quot;</span>
                <span class="s2">&quot;error and its fix are still listed in the corrections file, but it &quot;</span>
                <span class="s2">&quot;was never used.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># now return the corrections for them to stored/used elsewhere</span>
        <span class="k">return</span> <span class="n">corrections</span>
</pre></div>

        </details>

            <div class="docstring"><p>This calls the command within the target directory and handles all error
handling as well as monitoring of the job.</p>

<p>You should never call this method directly unless you are debugging. This
is becuase <code><a href="#S3Task.execute">execute</a></code> is normally called within the <code><a href="#S3Task.run">run</a></code> method.</p>

<p>Some tasks don't require a setup() method, so by default, this method
does nothing but "pass".</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><code>directory</code>:
The directory to run everything in.</li>
<li><code><a href="#S3Task.command">command</a></code>:
The command that will be called during execution.</li>
</ul>

<h2 id="returns">Returns</h2>

<ul>
<li><code>corrections</code>
A list of tuples where each entry is a error identified and the
correction applied. Ex: [("ExampleError", "ExampleCorrection")]</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.workup" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.workup">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">workup</span><span class="signature">(self, directory: str)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called at the end of a job, *after* error detection.</span>
<span class="sd">        This allows post-processing, such as cleanup, analysis of results,</span>
<span class="sd">        etc. This should return the result of the entire job, such as a</span>
<span class="sd">        the final structure or final energy calculated.</span>

<span class="sd">        You should never call this method directly unless you are debugging. This</span>
<span class="sd">        is becuase workup() is normally called within the run() method.</span>

<span class="sd">        Some tasks don&#39;t require a workup() method, so by default, this method</span>
<span class="sd">        does nothing but &quot;pass&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Be sure to include directory (or **kwargs) as input argument for</span>
        <span class="c1"># higher-level compatibility with the run method and SupervisedStagedTask</span>
        <span class="c1"># You should never need to call this method directly!</span>
        <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>This method is called at the end of a job, <em>after</em> error detection.
This allows post-processing, such as cleanup, analysis of results,
etc. This should return the result of the entire job, such as a
the final structure or final energy calculated.</p>

<p>You should never call this method directly unless you are debugging. This
is becuase workup() is normally called within the run() method.</p>

<p>Some tasks don't require a workup() method, so by default, this method
does nothing but "pass".</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><code>directory</code>:
The directory to run everything in.</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.run" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.run">#&nbsp;&nbsp</a>

                <div class="decorator">@defaults_from_attrs(&#39;structure&#39;, &#39;directory&#39;, &#39;command&#39;)</div>

            <span class="def">def</span>
            <span class="name">run</span><span class="signature">(
    self,
    structure: pymatgen.core.structure.Structure = None,
    directory: str = None,
    command: str = None
)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@defaults_from_attrs</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the entire staged task (setup, execution, workup), which includes</span>
<span class="sd">        supervising during execution.</span>

<span class="sd">        Call this method once you have your task initialized. For each run you</span>
<span class="sd">        can provide a new structure, directory, or command. For example,</span>

<span class="sd">        ``` python</span>
<span class="sd">        from simmate.calculator.example.tasks import ExampleTask</span>

<span class="sd">        my_task = ExampleTask()</span>
<span class="sd">        my_result = my_task.run(structure=my_structure, command=my_command)</span>
<span class="sd">        ```</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        - `structure`:</span>
<span class="sd">            The structure to use for the task, if one is required.</span>
<span class="sd">        - `command`:</span>
<span class="sd">            The command that will be called during execution.</span>
<span class="sd">        - `directory`:</span>
<span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
<span class="sd">            function simmate.ulitities.get_directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        - a dictionary of the result, corrections, and working directory used</span>
<span class="sd">        for this task run</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># because the command is something that is frequently changed at the</span>
        <span class="c1"># workflow level, then we want to make it so the user can set it for</span>
        <span class="c1"># each unique task.run() call. Otherwise we grab the default from the</span>
        <span class="c1"># class attribute</span>

        <span class="c1"># make sure a structure was given if it&#39;s required</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_structure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StructureRequiredError</span><span class="p">(</span><span class="s2">&quot;a structure is required as an input&quot;</span><span class="p">)</span>
        <span class="c1"># establish the working directory</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># run the setup stage of the task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

        <span class="c1"># run the shelltask and error supervision stages. This method returns</span>
        <span class="c1"># a list of any corrections applied during the run.</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

        <span class="c1"># run the workup stage of the task. This is where the data/info is pull</span>
        <span class="c1"># out from the calculation and is thus our &quot;result&quot;.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workup</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># if requested, compresses the directory to a zip file and then removes</span>
        <span class="c1"># the directory.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span><span class="p">:</span>
            <span class="n">make_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="c1"># Return our final information as a dictionary</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="n">corrections</span><span class="p">,</span>
            <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
            <span class="s2">&quot;prefect_flow_run_id&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">flow_run_id</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;flow_run_id&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># when not ran within a prefect flow, there won&#39;t be an id</span>
        <span class="p">}</span>
</pre></div>

        </details>

            <div class="docstring"><p>Runs the entire staged task (setup, execution, workup), which includes
supervising during execution.</p>

<p>Call this method once you have your task initialized. For each run you
can provide a new structure, directory, or command. For example,</p>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="../../../simmate.html#calculator.example.tasks">simmate.calculator.example.tasks</a></span> <span class="kn">import</span> <span class="n">ExampleTask</span>

<span class="n">my_task</span> <span class="o">=</span> <span class="n">ExampleTask</span><span class="p">()</span>
<span class="n">my_result</span> <span class="o">=</span> <span class="n">my_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">my_structure</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">my_command</span><span class="p">)</span>
</code></pre></div>

<h2 id="parameters">Parameters</h2>

<ul>
<li><code>structure</code>:
The structure to use for the task, if one is required.</li>
<li><code><a href="#S3Task.command">command</a></code>:
The command that will be called during execution.</li>
<li><code>directory</code>:
The directory to run everything in. This is passed to the ulitities
function <a href="../../../simmate.html#ulitities.get_directory">simmate.ulitities.get_directory</a></li>
</ul>

<h2 id="returns">Returns</h2>

<ul>
<li>a dictionary of the result, corrections, and working directory used
for this task run</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.get_config" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.get_config">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">get_config</span><span class="signature">(cls)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grabs the overall settings from the class.</span>

<span class="sd">        By default, this will just grab the class&#39;s __dict__ attribute but this</span>
<span class="sd">        can be overwritten to show only relevent information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Grabs the overall settings from the class.</p>

<p>By default, this will just grab the class's __dict__ attribute but this
can be overwritten to show only relevent information.</p>
</div>


                            </div>
                            <div id="S3Task.print_config" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#S3Task.print_config">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">print_config</span><span class="signature">(cls)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the result of get_config and prints it in a yaml format that is</span>
<span class="sd">        easier to read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</pre></div>

        </details>

            <div class="docstring"><p>Takes the result of get_config and prints it in a yaml format that is
easier to read.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>prefect.core.task.Task</dt>
                                <dd id="S3Task.copy" class="function">copy</dd>
                <dd id="S3Task.bind" class="function">bind</dd>
                <dd id="S3Task.map" class="function">map</dd>
                <dd id="S3Task.set_dependencies" class="function">set_dependencies</dd>
                <dd id="S3Task.set_upstream" class="function">set_upstream</dd>
                <dd id="S3Task.set_downstream" class="function">set_downstream</dd>
                <dd id="S3Task.inputs" class="function">inputs</dd>
                <dd id="S3Task.outputs" class="function">outputs</dd>
                <dd id="S3Task.serialize" class="function">serialize</dd>
                <dd id="S3Task.is_equal" class="function">is_equal</dd>
                <dd id="S3Task.is_not_equal" class="function">is_not_equal</dd>
                <dd id="S3Task.not_" class="function">not_</dd>
                <dd id="S3Task.or_" class="function">or_</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MaxCorrectionsError">
                                <div class="attr class">
        <a class="headerlink" href="#MaxCorrectionsError">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">MaxCorrectionsError</span><wbr>(<span class="base">builtins.Exception</span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MaxCorrectionsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="MaxCorrectionsError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="MaxCorrectionsError.with_traceback" class="function">with_traceback</dd>
                <dd id="MaxCorrectionsError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="NonZeroExitError">
                                <div class="attr class">
        <a class="headerlink" href="#NonZeroExitError">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">NonZeroExitError</span><wbr>(<span class="base">builtins.Exception</span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">NonZeroExitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="NonZeroExitError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="NonZeroExitError.with_traceback" class="function">with_traceback</dd>
                <dd id="NonZeroExitError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="StructureRequiredError">
                                <div class="attr class">
        <a class="headerlink" href="#StructureRequiredError">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">StructureRequiredError</span><wbr>(<span class="base">builtins.Exception</span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StructureRequiredError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="StructureRequiredError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="StructureRequiredError.with_traceback" class="function">with_traceback</dd>
                <dd id="StructureRequiredError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">(${doc.parameters.join(", ")})</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>