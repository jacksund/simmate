<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.2"/>
    <title>simmate.workflow_engine.supervised_staged_shell_task API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../workflow_engine.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;simmate.workflow_engine</a>

<a href="https://github.com/jacksund/simmate">            <img src="https://github.com/jacksund/simmate/blob/main/src/simmate/website/static_files/images/simmate-logo.svg?raw=true" class="logo" alt="project logo"/>
</a>
            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#S3Task">S3Task</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#S3Task.__init__">S3Task</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.command">command</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.requires_structure">requires_structure</a>
                        </li>
                        <li>
                                <a class="variable" href="#S3Task.error_handlers">error_handlers</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.setup">setup</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.execute">execute</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.workup">workup</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.get_config">get_config</a>
                        </li>
                        <li>
                                <a class="function" href="#S3Task.print_config">print_config</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MaxCorrectionsError">MaxCorrectionsError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#NonZeroExitError">NonZeroExitError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#StructureRequiredError">StructureRequiredError</a>
                            <ul class="memberlist">
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                        <a class="pdoc-button git-button" href="https://github.com/jacksund/simmate/tree/main/src/simmate/workflow_engine/supervised_staged_shell_task.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../../simmate.html">simmate</a><wbr>.<a href="./../workflow_engine.html">workflow_engine</a><wbr>.supervised_staged_shell_task    </h1>

                
                        <input id="supervised_staged_shell_task-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="supervised_staged_shell_task-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">platform</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">signal</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span> <span class="nn">pandas</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">prefect</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">prefect.core.task</span> <span class="kn">import</span> <span class="n">Task</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">prefect.utilities.tasks</span> <span class="kn">import</span> <span class="n">defaults_from_attrs</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">simmate.toolkit</span> <span class="kn">import</span> <span class="n">Structure</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">simmate.workflow_engine</span> <span class="kn">import</span> <span class="n">ErrorHandler</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span> <span class="nn">simmate.utilities</span> <span class="kn">import</span> <span class="n">get_directory</span><span class="p">,</span> <span class="n">make_archive</span><span class="p">,</span> <span class="n">make_error_archive</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="c1"># cleanup_on_fail=False, # TODO I should add a Prefect state_handler that can</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="c1"># reset the working directory between task retries -- in some cases we may</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="c1"># want to delete the entire directory.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="c1"># OPTIMIZE: I think this class would greatly benefit from asyncio so that we</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="c1"># know exactly when a shelltask completes, rather than looping and checking every</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="c1"># set timestep.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="c1"># https://docs.python.org/3/library/asyncio-subprocess.html#asyncio.create_subprocess_exec</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="k">class</span> <span class="nc">S3Task</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    The Supervised-Staged-Shell Task (aka &quot;S3Task&quot;)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    -----------------------------------------------</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    This class contains the core functionality to **supervise** a **staged** task</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    involving some **shell** command.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">    Let&#39;s breakdown what this means...</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    A *shell* command is a single call to some external program. For example,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    VASP requires that we call the &quot;vasp_std &gt; vasp.out&quot; command in order to run a</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    calculation. We consider calling external programs a *staged* task made</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    up of three steps:</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    - setup = writing any input files required for the program</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    - execution = actually calling the command and running our program</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    - workup = loading data from output files back into python</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    And for *supervising* the task, this means we monitor the program while the</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    execution stage is running. So once a program is started, Simmate can check</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    output files for common errors/issues. If an error is found, we stop the</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    program, fix the issue, and then restart it. Any fixes that were made are</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    written to &quot;simmate_corrections.csv&quot;.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    &lt;!--</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    TODO: Make a simple diagram to visualize the overall process and add it here.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    It will be similar to Custodian&#39;s, but we don&#39;t have a list of jobs here.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    https://materialsproject.github.io/custodian/index.html#usage</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    The steps are...</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">    - Write Input Files based on custom+defualt settings</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    - Run the calculation by calling the program</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">    - Load ouput files</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    - check for errors</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    - [correct them, rerun]</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">    - postprocess/analysis</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">    --&gt;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">    This entire process (the different stages and monitoring) is carried out</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">    using the ``run()`` method. You rarely use this class directly. Instead,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">    you typically use a subclass of it. As a user, you really just need to do</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">    something like this:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">    ``` python</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">       from simmate.calculator.example.tasks import ExampleTask</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">       my_task = ExampleTask()</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">       my_result = my_task.run()</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    ```</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">    And that&#39;s it!</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">    For experts, this class can be viewed as a combination of prefect&#39;s ShellTask,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">    a custodian Job, and Custodian monitoring. When subclassing this, we can absorb</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">    functionality of pymatgen.io.vasp.sets too. By merging all of these together</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">    into one class, we make things much easier for users and creating new Tasks.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    Inheriting from this class</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">    --------------------------</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">    This class is commonly used to make tasks for our calculator modules, so you</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">    will likely want to subclass this. Here is a basic example of inheriting</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">    and then running a task:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    ``` python</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    from simmate.workflow_engine import S3Task</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    from example.error_handlers import PossibleError1, PossibleError2</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">    class ExampleTask(SSSTask):</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        command = &quot;echo example&quot;  # just prints out &quot;example&quot;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        max_corrections = 7</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        error_handlers = [PossibleError1, PossibleError2]</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">        polling_timestep = 0.1</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        monitor_freq = 10</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">        some_new_setting = 123</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        def setup(self, structure, directory):  # &lt;-- MUST have these two args</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            print(&quot;I&#39;m setting things up!&quot;)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">            print(f&quot;My new setting is {some_new_setting}&quot;)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        def workup(self, directory):  # &lt;-- MUST have this arg</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">            print(&quot;I&#39;m working things up!&quot;)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">    task = ExampleTask()</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">    result = task.run()</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">    ```</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">    There are a couple things to note here:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    - It&#39;s optional to set/overwrite attributes. You can also add new ones too.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    - It&#39;s optional to write a new __init__, setup, or workup methods</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    - make sure you include the structure/directory inputs, even if you don&#39;t use them.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">    - Don&#39;t add new kwargs to methods. Instead handle these options through attributes.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">    For a full (and advanced) example, of a subclass take a look at</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">    `simmate.calculators.vasp.tasks.base.VaspTask`.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="c1"># I set this here so that I don&#39;t have to copy/paste the init method</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="c1"># every time I inherit from this class and want to update the default</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="c1"># command to use for the child class.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    The defualt shell command to use.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="c1"># While it&#39;s not needed for a number of cases, it&#39;s extremely common for the</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="c1"># setup method to need an input structure in matsci. I therefore include</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    <span class="c1"># this rather than having a nearly identical subclass that could cause</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>    <span class="c1"># some confusion.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>    <span class="n">requires_structure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">    Indicates whether a structure is needed if for the run() method.</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="n">error_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorHandler</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">    A list of ErrorHandler objects to use in order of priority (that is, highest</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">    priority is first). If one handler is triggered, the correction will be </span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">    applied and none of the following handlers will be checked.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simmate_corrections.csv&quot;</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="p">):</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        Creates a task instance of this class. The parameters passed will be the</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        same every time you call the task.run() method.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        Note, many of the parameters here are for the Monitoring settings. These</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        are only ever relevent if there are ErrorHandlers added that have</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        is_monitor=True. These handlers run while the shelltask itself is also</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        running. Read more about ErrorHandlers for more info.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">        - `max_corrections`:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">            The maximum number of times we can apply a correction and retry the shell</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">            command. The maximum number of times that corrections will be made (and</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">            shell command reran) before giving up on the calculation. Note, once this</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">            limit is exceeded, the error is stored without correcting or restarting</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">            the run.</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">        - `monitor`:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">            Whether to run monitor handlers while the command runs. False means</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">            wait until the job has completed.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        - `polling_timestep`:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">            If we are monitoring the job for errors while it runs, this is how often</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">            (in seconds) we should check the status of our job. Note this check is</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">            just whether the job is done or not. This is NOT how often we check for</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">            errors. See monitor_freq for that.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        - `monitor_freq`:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">            The frequency we should run check for errors with our monitors. This is</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">            based on the polling_timestep loops. For example, if we have a</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">            polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">            the monitor checks every other loop -- or every 2x10 = 20 seconds. The</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">            default values of polling_timestep=10 and monitor_freq=30 indicate that</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">            we run monitoring functions every 5 minutes (10x30=300s=5min).</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        - `save_corrections_to_file`:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">            Whether to write a log file of the corrections made. The default is True.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        - `corrections_filename`:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">            If save_corrections_to_file is True, this is the filename of where</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">            to write the corrections. The default is &quot;simmate_corrections.csv&quot;.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        - `compress_output`:</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">            Whether to compress the directory to a zip file at the end of the</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">            task run. After compression, it will also delete the directory.</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">            The default is False.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            All extra arguments supported by</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">            [prefect.core.task.Task](https://docs.prefect.io/api/latest/core/task.html).</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="c1"># Save the provided settings</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span> <span class="o">=</span> <span class="n">max_corrections</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span> <span class="o">=</span> <span class="n">polling_timestep</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">=</span> <span class="n">monitor_freq</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span> <span class="o">=</span> <span class="n">compress_output</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="o">=</span> <span class="n">save_corrections_to_file</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span> <span class="o">=</span> <span class="n">corrections_filename</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="c1"># now inherit the parent Prefect Task class</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        This abstract method is ran before the command is actually executed. This</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        allows for some pre-processing, such as writing input files or any other</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        analysis.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        is becuase setup() is normally called within the run() method.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        doesn&#39;t nothing but &quot;pass&quot;.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        - `structure`:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            The structure to use for the task, if one is required.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        - `directory`:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">            The directory to run everything in. Must exist already.</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">            Extra kwargs that may be passed to some function within. Because</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            Simmate prefers fixed settings for their workflows, this is typically</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">            not used, but instead, keywords should be explicitly defined when</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">            writing a setup method.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="c1"># Be sure to include directory and structure (or **kwargs) as input</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="c1"># arguments for higher-level compatibility with the run method.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="k">pass</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">        This calls the command within the target directory and handles all error</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">        handling as well as monitoring of the job.</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        is becuase `execute` is normally called within the `run` method.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">        does nothing but &quot;pass&quot;.</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        - `directory`:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">            The directory to run everything in.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        - `command`:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">            The command that will be called during execution.</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">        #### Returns</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        - `corrections`</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">            A list of tuples where each entry is a error identified and the</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">            correction applied. Ex: [(&quot;ExampleError&quot;, &quot;ExampleCorrection&quot;)]</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="c1"># some error_handlers run while the shelltask is running. These are known as</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="c1"># Monitors and are labled via the is_monitor attribute. It&#39;s good for us</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="c1"># to separate these out from other error_handlers.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_monitor</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="p">]</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="c1"># We start with zero corrections that we slowly add to. This can be</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="c1"># thought of as a table with headers of...</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="c1">#   (&quot;applied_errorhandler&quot;, &quot;correction_applied&quot;)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="c1"># NOTE: I took out the table headers and may add them back in</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="c1"># ------ start of main while loop ------</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="c1"># we can try running the shelltask up to max_corrections. Because only one</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="c1"># correction is applied per attempt, you can view this as the maximum</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="c1"># number of attempts made on the calculation.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>            <span class="c1"># launch the shelltask without waiting for it to complete. Also,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="c1"># make sure to use common shell commands and to set the working</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="c1"># directory.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="c1">#</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="c1"># Stderr keyword indicates that we should capture the error if one</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="c1"># occurs so that we can report it to the user.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="c1">#</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="c1"># The preexec_fn keyword allows us to properly terminate jobs that</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="c1"># are launched with parallel processes (such as mpirun). This assigns</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="c1"># a parent id to it that we use when killing a job (if an error</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="c1"># handler calls for us to do so). This isn&#39;t possible on Windows though.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="c1">#</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="c1"># OPTIMIZE / BUG: preexec_fn adds about 0.02s overhead to the calculation</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="c1"># so we may not want to always use it... Instead we could try to only</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="c1"># use it when the command includes &quot;mpirun&quot;. Though this may introduce</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="c1"># a bug if another is another parallel command used besides mpirun.</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="c1"># An example of this might be deepmd which automatically submits</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="c1"># things in parallel without calling mpirun up-front.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="n">command</span><span class="p">,</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="n">preexec_fn</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="c1"># or &quot;mpirun&quot; not in command  # See bug/optimize comment above</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="c1"># Assume the shelltask has no errors until proven otherwise</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="n">has_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="c1"># If monitor=True, then we want to supervise this shelltask as it</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="c1"># runs. If montors=[m1,m2,...], then we have monitors in place to actually</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="c1"># perform the monitoring. If both of these cases are true, then we</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="c1"># want to go through the error_handlers to check for errors until</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="c1"># the shelltask completes.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                <span class="c1"># ------ start of monitor while loop ------</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                <span class="c1"># We want to loop until we find an error and keep track of</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                <span class="c1"># which loops to run the monitor function on because we don&#39;t</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                <span class="c1"># want them to run nonstop. This variable allows us to monitor</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                <span class="c1"># checks every Nth loop, while we check the shelltask status</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                <span class="c1"># on all other loops.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                <span class="n">monitor_freq_n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                <span class="k">while</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                    <span class="n">monitor_freq_n</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                    <span class="c1"># Sleep the set amount before checking the shelltask status</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                    <span class="c1"># check if the shelltasks is complete. poll will return 0</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                    <span class="c1"># when it&#39;s done, in which case we break the loop</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                        <span class="k">break</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                    <span class="c1"># check whether we should run monitors on this poll loop</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                    <span class="k">if</span> <span class="n">monitor_freq_n</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                        <span class="c1"># iterate through each monitor</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                        <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                            <span class="c1"># check if there&#39;s an error with this error_handler</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                            <span class="c1"># and grab the error if so</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                            <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                                <span class="c1"># determine if it is_terminating</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                                <span class="k">if</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">is_terminating</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                                    <span class="c1"># If so, we kill the process but don&#39;t apply</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                                    <span class="c1"># the fix quite yet. That step is done below.</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                                <span class="c1"># Otherwise apply the fix and let the shelltask end</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                                <span class="c1"># naturally. An example of this is for codes</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                                <span class="c1"># where you add a STOP file to get it to</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                                <span class="c1"># finish rather than just killing the process.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                                <span class="c1"># This is the special case error_handler that I talk</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                                <span class="c1"># about in my notes, where we really want to</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                                <span class="c1"># end the shelltask right away.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                                    <span class="c1"># make a copy of the directory contents and</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                                    <span class="c1"># store as an archive within the same directory</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                                    <span class="n">make_error_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                                    <span class="c1"># apply the fix now</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                                    <span class="c1"># record what&#39;s been changed</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                                <span class="c1"># there&#39;s no need to look at the other monitors</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                                <span class="c1"># so break from the for-loop. We also don&#39;t</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                                <span class="c1"># need to monitor the stagedtask anymore since we just</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                                <span class="c1"># terminated it or signaled for its graceful</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                                <span class="c1"># end. So update the while-loop condition.</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                                <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                                <span class="k">break</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="c1"># ------ end of monitor while loop ------</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="c1"># Now just wait for the process to finish. Note we use communicate</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>            <span class="c1"># instead of the .wait() method. This is the recommended method</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>            <span class="c1"># when we have stderr=subprocess.PIPE, which we use above.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>            <span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="c1"># check if the return code is non-zero and thus failed.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>            <span class="c1"># The &#39;not has_error&#39; is because terminate() will give a nonzero</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="c1"># when a monitor is triggered. We don&#39;t want to raise that</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="c1"># exception here but instead let the monitor handle that</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="c1"># error in the code below.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="c1"># convert the error from bytes to a string</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                <span class="c1"># and report the error to the user</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                <span class="k">raise</span> <span class="n">NonZeroExitError</span><span class="p">(</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                    <span class="sa">f</span><span class="s2">&quot;The command (</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">) failed. The error output was...</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="c1"># Check for errors again, because a non-monitor may be higher</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="c1"># priority than the monitor triggered above (if there was one).</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="c1"># Since the error_handlers are in order of priority, only the first</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            <span class="c1"># will actually be applied and then we can retry the calc.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                <span class="c1"># NOTE - The following special case is handled above:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                <span class="c1">#   error_handler.is_monitor and not error_handler.is_terminating</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                <span class="c1"># BUG: I can see this being a source of bugs in the process so I</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="c1"># need to reconsider subclassing this special case. For now,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                <span class="c1"># users should have this case at the lowest priority.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="c1"># check if there&#39;s an error with this error_handler and grab the</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                <span class="c1"># error if there is one</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                    <span class="c1"># record the error in case it wasn&#39;t done so above</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                    <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                    <span class="c1"># make a copy of the directory contents and</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                    <span class="c1"># store as an archive within the same directory</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                    <span class="n">make_error_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                    <span class="c1"># And apply the proper correction if there is one.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                    <span class="c1"># Some error_handlers will even raise an error here signaling</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                    <span class="c1"># that the stagedtask is unrecoverable and a lost cause.</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                    <span class="c1"># record what&#39;s been changed</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                    <span class="c1"># break from the error_handler for-loop as we only apply the</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                    <span class="c1"># highest priority fix and nothing else.</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                    <span class="k">break</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="c1"># write the log of corrections to file if requested. This is written</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="c1"># as a CSV file format and done every while-loop cycle because it</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="c1"># lets the user monitor the calculation and error handlers applied</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="c1"># as it goes. If no corrections were applied, we skip writing the file.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="ow">and</span> <span class="n">corrections</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                <span class="c1"># compile the corrections metadata into a dataframe</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                    <span class="n">corrections</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_applied&quot;</span><span class="p">],</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                <span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                <span class="c1"># write the dataframe to a csv file</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span><span class="p">),</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                <span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="c1"># now that we&#39;ve gone through the error_handlers, let&#39;s see if any</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="c1"># non-terminating errors were found (terminating ones would raise</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="c1"># an error above). If there are no errors, we&#39;ve finished the</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="c1"># calculation and can exit the while loop. Otherwise, just leave</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            <span class="c1"># everything where it&#39;s at and restart the while-loop with a new</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="c1"># attempt</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                <span class="c1"># break the while-loop</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                <span class="k">break</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="c1"># ------ end of main while loop ------</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="c1"># make sure the while loop didn&#39;t exit because of the correction limit</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="k">raise</span> <span class="n">MaxCorrectionsError</span><span class="p">(</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="s2">&quot;The number of maximum corrections has been exceeded. Note the final &quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="s2">&quot;error and its fix are still listed in the corrections file, but it &quot;</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="s2">&quot;was never used.&quot;</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="c1"># now return the corrections for them to stored/used elsewhere</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="n">corrections</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="k">def</span> <span class="nf">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        Stopping the command we submitted can be a tricky business if we are running</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        scripts in parallel (such as using mpirun). Different computers and OSs</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        can require a different &#39;kill&#39; command so we establish this separate</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">        method that can be overwritten.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">        If you know your command needs a special case to kill all of its spawn</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">        processes, you can overwrite this method as well.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">        Users should never call this directly becuase this is instead applied</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a><span class="sd">        within the execute() method.</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">        - `process`:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a><span class="sd">            The process object that will be terminated.</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">        - `command`:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">            the command used to launch the process. This is sometimes useful</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">            when searching for all running processes under this name.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="c1"># The operating system (Windows, OSX, or Linux) will give us the best guess</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="c1"># as to where to access the running command. The results are as you&#39;d expect</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="c1"># except for Macs, which returns &quot;Darwin&quot;.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="c1">#   Linux: Linux</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="c1">#   Mac: Darwin</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="c1">#   Windows: Windows</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="c1"># The normal line to end a popen process is just...</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="c1">#   process.terminate()</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="c1"># However this struggles to kill all &quot;child&quot; processes if we are using</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="c1"># something like mpirun to run things in parallel. Instead, we use the</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="c1"># os module to grab the parent id and send that the termination signal,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="c1"># which is also passed on to all child processes.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="c1"># This command also doesn not work on windows, so I need to address this</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="c1"># as well.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="k">if</span> <span class="n">operating_system</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="c1"># note: SIGTERM is the normal signal but I use SIGKILL to try to address</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="c1"># permission errors.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>        <span class="c1"># As an example of an alternative approach to killing a job, here is</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="c1"># what Custodian (Materials Project) tries when killing a VASP job</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="c1"># submitted through mpirun:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="c1"># try:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="c1">#     os.system(&quot;killall vasp&quot;)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="c1"># except Exception:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="c1">#     pass</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="c1"># TODO: make it so terminate scripts can be loaded from the user&#39;s config</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>        <span class="c1"># directory, which will make it so they don&#39;t have to overwrite all the</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="c1"># classes that inherit from this one.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">        This method is called at the end of a job, *after* error detection.</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">        This allows post-processing, such as cleanup, analysis of results,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">        etc. This should return the result of the entire job, such as a</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="sd">        the final structure or final energy calculated.</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        is becuase workup() is normally called within the run() method.</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="sd">        Some tasks don&#39;t require a workup() method, so by default, this method</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a><span class="sd">        does nothing but &quot;pass&quot;.</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a><span class="sd">        - `directory`:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a><span class="sd">            The directory to run everything in.</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="c1"># Be sure to include directory (or **kwargs) as input argument for</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="c1"># higher-level compatibility with the run method and SupervisedStagedTask</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="c1"># You should never need to call this method directly!</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="k">pass</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="nd">@defaults_from_attrs</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="p">):</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">        Runs the entire staged task (setup, execution, workup), which includes</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">        supervising during execution.</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="sd">        Call this method once you have your task initialized. For each run you</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">        can provide a new structure, directory, or command. For example,</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">        ``` python</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="sd">        from simmate.calculator.example.tasks import ExampleTask</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">        my_task = ExampleTask()</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">        my_result = my_task.run(structure=my_structure, command=my_command)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">        ```</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">        #### Parameters</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">        - `structure`:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">            The structure to use for the task, if one is required.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        - `command`:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">            The command that will be called during execution.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        - `directory`:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">            function simmate.ulitities.get_directory</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">            Any extra keywords that should be passed to the setup() method.</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">        Returns</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">        -------</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">        - a dictionary of the result, corrections, and working directory used</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="sd">        for this task run</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="c1"># because the command is something that is frequently changed at the</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="c1"># workflow level, then we want to make it so the user can set it for</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="c1"># each unique task.run() call. Otherwise we grab the default from the</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="c1"># class attribute</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="c1"># make sure a structure was given if it&#39;s required</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_structure</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="k">raise</span> <span class="n">StructureRequiredError</span><span class="p">(</span><span class="s2">&quot;a structure is required as an input&quot;</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="c1"># establish the working directory</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="n">directory</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="c1"># run the setup stage of the task</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="c1"># run the shelltask and error supervision stages. This method returns</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>        <span class="c1"># a list of any corrections applied during the run.</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="n">corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="c1"># run the workup stage of the task. This is where the data/info is pull</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="c1"># out from the calculation and is thus our &quot;result&quot;.</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workup</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="c1"># if requested, compresses the directory to a zip file and then removes</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="c1"># the directory.</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="n">make_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="c1"># Return our final information as a dictionary</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="n">corrections</span><span class="p">,</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>            <span class="s2">&quot;prefect_flow_run_id&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">flow_run_id</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;flow_run_id&quot;</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># when not ran within a prefect flow, there won&#39;t be an id</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>        <span class="p">}</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a><span class="sd">        Grabs the overall settings from the class.</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a><span class="sd">        By default, this will just grab the class&#39;s __dict__ attribute but this</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a><span class="sd">        can be overwritten to show only relevent information.</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        Takes the result of get_config and prints it in a yaml format that is</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">        easier to read.</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a><span class="c1"># Custom errors that indicate exactly what causes the S3Task to exit.</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a><span class="k">class</span> <span class="nc">MaxCorrectionsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>    <span class="k">pass</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a><span class="k">class</span> <span class="nc">NonZeroExitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>    <span class="k">pass</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a><span class="k">class</span> <span class="nc">StructureRequiredError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="k">pass</span>
</span></pre></div>


            </section>
                <section id="S3Task">
                            <input id="S3Task-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">S3Task</span><wbr>(<span class="base">prefect.core.task.Task</span>):

                <label class="view-source-button" for="S3Task-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task-32"><a href="#S3Task-32"><span class="linenos"> 32</span></a><span class="k">class</span> <span class="nc">S3Task</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
</span><span id="S3Task-33"><a href="#S3Task-33"><span class="linenos"> 33</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-34"><a href="#S3Task-34"><span class="linenos"> 34</span></a><span class="sd">    The Supervised-Staged-Shell Task (aka &quot;S3Task&quot;)</span>
</span><span id="S3Task-35"><a href="#S3Task-35"><span class="linenos"> 35</span></a><span class="sd">    -----------------------------------------------</span>
</span><span id="S3Task-36"><a href="#S3Task-36"><span class="linenos"> 36</span></a>
</span><span id="S3Task-37"><a href="#S3Task-37"><span class="linenos"> 37</span></a><span class="sd">    This class contains the core functionality to **supervise** a **staged** task</span>
</span><span id="S3Task-38"><a href="#S3Task-38"><span class="linenos"> 38</span></a><span class="sd">    involving some **shell** command.</span>
</span><span id="S3Task-39"><a href="#S3Task-39"><span class="linenos"> 39</span></a>
</span><span id="S3Task-40"><a href="#S3Task-40"><span class="linenos"> 40</span></a><span class="sd">    Let&#39;s breakdown what this means...</span>
</span><span id="S3Task-41"><a href="#S3Task-41"><span class="linenos"> 41</span></a>
</span><span id="S3Task-42"><a href="#S3Task-42"><span class="linenos"> 42</span></a><span class="sd">    A *shell* command is a single call to some external program. For example,</span>
</span><span id="S3Task-43"><a href="#S3Task-43"><span class="linenos"> 43</span></a><span class="sd">    VASP requires that we call the &quot;vasp_std &gt; vasp.out&quot; command in order to run a</span>
</span><span id="S3Task-44"><a href="#S3Task-44"><span class="linenos"> 44</span></a><span class="sd">    calculation. We consider calling external programs a *staged* task made</span>
</span><span id="S3Task-45"><a href="#S3Task-45"><span class="linenos"> 45</span></a><span class="sd">    up of three steps:</span>
</span><span id="S3Task-46"><a href="#S3Task-46"><span class="linenos"> 46</span></a>
</span><span id="S3Task-47"><a href="#S3Task-47"><span class="linenos"> 47</span></a><span class="sd">    - setup = writing any input files required for the program</span>
</span><span id="S3Task-48"><a href="#S3Task-48"><span class="linenos"> 48</span></a><span class="sd">    - execution = actually calling the command and running our program</span>
</span><span id="S3Task-49"><a href="#S3Task-49"><span class="linenos"> 49</span></a><span class="sd">    - workup = loading data from output files back into python</span>
</span><span id="S3Task-50"><a href="#S3Task-50"><span class="linenos"> 50</span></a>
</span><span id="S3Task-51"><a href="#S3Task-51"><span class="linenos"> 51</span></a><span class="sd">    And for *supervising* the task, this means we monitor the program while the</span>
</span><span id="S3Task-52"><a href="#S3Task-52"><span class="linenos"> 52</span></a><span class="sd">    execution stage is running. So once a program is started, Simmate can check</span>
</span><span id="S3Task-53"><a href="#S3Task-53"><span class="linenos"> 53</span></a><span class="sd">    output files for common errors/issues. If an error is found, we stop the</span>
</span><span id="S3Task-54"><a href="#S3Task-54"><span class="linenos"> 54</span></a><span class="sd">    program, fix the issue, and then restart it. Any fixes that were made are</span>
</span><span id="S3Task-55"><a href="#S3Task-55"><span class="linenos"> 55</span></a><span class="sd">    written to &quot;simmate_corrections.csv&quot;.</span>
</span><span id="S3Task-56"><a href="#S3Task-56"><span class="linenos"> 56</span></a>
</span><span id="S3Task-57"><a href="#S3Task-57"><span class="linenos"> 57</span></a>
</span><span id="S3Task-58"><a href="#S3Task-58"><span class="linenos"> 58</span></a><span class="sd">    &lt;!--</span>
</span><span id="S3Task-59"><a href="#S3Task-59"><span class="linenos"> 59</span></a><span class="sd">    TODO: Make a simple diagram to visualize the overall process and add it here.</span>
</span><span id="S3Task-60"><a href="#S3Task-60"><span class="linenos"> 60</span></a><span class="sd">    It will be similar to Custodian&#39;s, but we don&#39;t have a list of jobs here.</span>
</span><span id="S3Task-61"><a href="#S3Task-61"><span class="linenos"> 61</span></a><span class="sd">    https://materialsproject.github.io/custodian/index.html#usage</span>
</span><span id="S3Task-62"><a href="#S3Task-62"><span class="linenos"> 62</span></a><span class="sd">    The steps are...</span>
</span><span id="S3Task-63"><a href="#S3Task-63"><span class="linenos"> 63</span></a>
</span><span id="S3Task-64"><a href="#S3Task-64"><span class="linenos"> 64</span></a><span class="sd">    - Write Input Files based on custom+defualt settings</span>
</span><span id="S3Task-65"><a href="#S3Task-65"><span class="linenos"> 65</span></a><span class="sd">    - Run the calculation by calling the program</span>
</span><span id="S3Task-66"><a href="#S3Task-66"><span class="linenos"> 66</span></a><span class="sd">    - Load ouput files</span>
</span><span id="S3Task-67"><a href="#S3Task-67"><span class="linenos"> 67</span></a><span class="sd">    - check for errors</span>
</span><span id="S3Task-68"><a href="#S3Task-68"><span class="linenos"> 68</span></a><span class="sd">    - [correct them, rerun]</span>
</span><span id="S3Task-69"><a href="#S3Task-69"><span class="linenos"> 69</span></a><span class="sd">    - postprocess/analysis</span>
</span><span id="S3Task-70"><a href="#S3Task-70"><span class="linenos"> 70</span></a><span class="sd">    --&gt;</span>
</span><span id="S3Task-71"><a href="#S3Task-71"><span class="linenos"> 71</span></a>
</span><span id="S3Task-72"><a href="#S3Task-72"><span class="linenos"> 72</span></a><span class="sd">    This entire process (the different stages and monitoring) is carried out</span>
</span><span id="S3Task-73"><a href="#S3Task-73"><span class="linenos"> 73</span></a><span class="sd">    using the ``run()`` method. You rarely use this class directly. Instead,</span>
</span><span id="S3Task-74"><a href="#S3Task-74"><span class="linenos"> 74</span></a><span class="sd">    you typically use a subclass of it. As a user, you really just need to do</span>
</span><span id="S3Task-75"><a href="#S3Task-75"><span class="linenos"> 75</span></a><span class="sd">    something like this:</span>
</span><span id="S3Task-76"><a href="#S3Task-76"><span class="linenos"> 76</span></a>
</span><span id="S3Task-77"><a href="#S3Task-77"><span class="linenos"> 77</span></a><span class="sd">    ``` python</span>
</span><span id="S3Task-78"><a href="#S3Task-78"><span class="linenos"> 78</span></a><span class="sd">       from simmate.calculator.example.tasks import ExampleTask</span>
</span><span id="S3Task-79"><a href="#S3Task-79"><span class="linenos"> 79</span></a>
</span><span id="S3Task-80"><a href="#S3Task-80"><span class="linenos"> 80</span></a><span class="sd">       my_task = ExampleTask()</span>
</span><span id="S3Task-81"><a href="#S3Task-81"><span class="linenos"> 81</span></a><span class="sd">       my_result = my_task.run()</span>
</span><span id="S3Task-82"><a href="#S3Task-82"><span class="linenos"> 82</span></a><span class="sd">    ```</span>
</span><span id="S3Task-83"><a href="#S3Task-83"><span class="linenos"> 83</span></a>
</span><span id="S3Task-84"><a href="#S3Task-84"><span class="linenos"> 84</span></a><span class="sd">    And that&#39;s it!</span>
</span><span id="S3Task-85"><a href="#S3Task-85"><span class="linenos"> 85</span></a>
</span><span id="S3Task-86"><a href="#S3Task-86"><span class="linenos"> 86</span></a><span class="sd">    For experts, this class can be viewed as a combination of prefect&#39;s ShellTask,</span>
</span><span id="S3Task-87"><a href="#S3Task-87"><span class="linenos"> 87</span></a><span class="sd">    a custodian Job, and Custodian monitoring. When subclassing this, we can absorb</span>
</span><span id="S3Task-88"><a href="#S3Task-88"><span class="linenos"> 88</span></a><span class="sd">    functionality of pymatgen.io.vasp.sets too. By merging all of these together</span>
</span><span id="S3Task-89"><a href="#S3Task-89"><span class="linenos"> 89</span></a><span class="sd">    into one class, we make things much easier for users and creating new Tasks.</span>
</span><span id="S3Task-90"><a href="#S3Task-90"><span class="linenos"> 90</span></a>
</span><span id="S3Task-91"><a href="#S3Task-91"><span class="linenos"> 91</span></a>
</span><span id="S3Task-92"><a href="#S3Task-92"><span class="linenos"> 92</span></a><span class="sd">    Inheriting from this class</span>
</span><span id="S3Task-93"><a href="#S3Task-93"><span class="linenos"> 93</span></a><span class="sd">    --------------------------</span>
</span><span id="S3Task-94"><a href="#S3Task-94"><span class="linenos"> 94</span></a>
</span><span id="S3Task-95"><a href="#S3Task-95"><span class="linenos"> 95</span></a><span class="sd">    This class is commonly used to make tasks for our calculator modules, so you</span>
</span><span id="S3Task-96"><a href="#S3Task-96"><span class="linenos"> 96</span></a><span class="sd">    will likely want to subclass this. Here is a basic example of inheriting</span>
</span><span id="S3Task-97"><a href="#S3Task-97"><span class="linenos"> 97</span></a><span class="sd">    and then running a task:</span>
</span><span id="S3Task-98"><a href="#S3Task-98"><span class="linenos"> 98</span></a>
</span><span id="S3Task-99"><a href="#S3Task-99"><span class="linenos"> 99</span></a><span class="sd">    ``` python</span>
</span><span id="S3Task-100"><a href="#S3Task-100"><span class="linenos">100</span></a>
</span><span id="S3Task-101"><a href="#S3Task-101"><span class="linenos">101</span></a><span class="sd">    from simmate.workflow_engine import S3Task</span>
</span><span id="S3Task-102"><a href="#S3Task-102"><span class="linenos">102</span></a><span class="sd">    from example.error_handlers import PossibleError1, PossibleError2</span>
</span><span id="S3Task-103"><a href="#S3Task-103"><span class="linenos">103</span></a>
</span><span id="S3Task-104"><a href="#S3Task-104"><span class="linenos">104</span></a>
</span><span id="S3Task-105"><a href="#S3Task-105"><span class="linenos">105</span></a><span class="sd">    class ExampleTask(SSSTask):</span>
</span><span id="S3Task-106"><a href="#S3Task-106"><span class="linenos">106</span></a>
</span><span id="S3Task-107"><a href="#S3Task-107"><span class="linenos">107</span></a><span class="sd">        command = &quot;echo example&quot;  # just prints out &quot;example&quot;</span>
</span><span id="S3Task-108"><a href="#S3Task-108"><span class="linenos">108</span></a><span class="sd">        max_corrections = 7</span>
</span><span id="S3Task-109"><a href="#S3Task-109"><span class="linenos">109</span></a><span class="sd">        error_handlers = [PossibleError1, PossibleError2]</span>
</span><span id="S3Task-110"><a href="#S3Task-110"><span class="linenos">110</span></a><span class="sd">        polling_timestep = 0.1</span>
</span><span id="S3Task-111"><a href="#S3Task-111"><span class="linenos">111</span></a><span class="sd">        monitor_freq = 10</span>
</span><span id="S3Task-112"><a href="#S3Task-112"><span class="linenos">112</span></a><span class="sd">        some_new_setting = 123</span>
</span><span id="S3Task-113"><a href="#S3Task-113"><span class="linenos">113</span></a>
</span><span id="S3Task-114"><a href="#S3Task-114"><span class="linenos">114</span></a><span class="sd">        def setup(self, structure, directory):  # &lt;-- MUST have these two args</span>
</span><span id="S3Task-115"><a href="#S3Task-115"><span class="linenos">115</span></a><span class="sd">            print(&quot;I&#39;m setting things up!&quot;)</span>
</span><span id="S3Task-116"><a href="#S3Task-116"><span class="linenos">116</span></a><span class="sd">            print(f&quot;My new setting is {some_new_setting}&quot;)</span>
</span><span id="S3Task-117"><a href="#S3Task-117"><span class="linenos">117</span></a>
</span><span id="S3Task-118"><a href="#S3Task-118"><span class="linenos">118</span></a><span class="sd">        def workup(self, directory):  # &lt;-- MUST have this arg</span>
</span><span id="S3Task-119"><a href="#S3Task-119"><span class="linenos">119</span></a><span class="sd">            print(&quot;I&#39;m working things up!&quot;)</span>
</span><span id="S3Task-120"><a href="#S3Task-120"><span class="linenos">120</span></a>
</span><span id="S3Task-121"><a href="#S3Task-121"><span class="linenos">121</span></a>
</span><span id="S3Task-122"><a href="#S3Task-122"><span class="linenos">122</span></a><span class="sd">    task = ExampleTask()</span>
</span><span id="S3Task-123"><a href="#S3Task-123"><span class="linenos">123</span></a><span class="sd">    result = task.run()</span>
</span><span id="S3Task-124"><a href="#S3Task-124"><span class="linenos">124</span></a><span class="sd">    ```</span>
</span><span id="S3Task-125"><a href="#S3Task-125"><span class="linenos">125</span></a>
</span><span id="S3Task-126"><a href="#S3Task-126"><span class="linenos">126</span></a><span class="sd">    There are a couple things to note here:</span>
</span><span id="S3Task-127"><a href="#S3Task-127"><span class="linenos">127</span></a>
</span><span id="S3Task-128"><a href="#S3Task-128"><span class="linenos">128</span></a><span class="sd">    - It&#39;s optional to set/overwrite attributes. You can also add new ones too.</span>
</span><span id="S3Task-129"><a href="#S3Task-129"><span class="linenos">129</span></a><span class="sd">    - It&#39;s optional to write a new __init__, setup, or workup methods</span>
</span><span id="S3Task-130"><a href="#S3Task-130"><span class="linenos">130</span></a><span class="sd">    - make sure you include the structure/directory inputs, even if you don&#39;t use them.</span>
</span><span id="S3Task-131"><a href="#S3Task-131"><span class="linenos">131</span></a><span class="sd">    - Don&#39;t add new kwargs to methods. Instead handle these options through attributes.</span>
</span><span id="S3Task-132"><a href="#S3Task-132"><span class="linenos">132</span></a>
</span><span id="S3Task-133"><a href="#S3Task-133"><span class="linenos">133</span></a><span class="sd">    For a full (and advanced) example, of a subclass take a look at</span>
</span><span id="S3Task-134"><a href="#S3Task-134"><span class="linenos">134</span></a><span class="sd">    `simmate.calculators.vasp.tasks.base.VaspTask`.</span>
</span><span id="S3Task-135"><a href="#S3Task-135"><span class="linenos">135</span></a>
</span><span id="S3Task-136"><a href="#S3Task-136"><span class="linenos">136</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="S3Task-137"><a href="#S3Task-137"><span class="linenos">137</span></a>
</span><span id="S3Task-138"><a href="#S3Task-138"><span class="linenos">138</span></a>    <span class="c1"># I set this here so that I don&#39;t have to copy/paste the init method</span>
</span><span id="S3Task-139"><a href="#S3Task-139"><span class="linenos">139</span></a>    <span class="c1"># every time I inherit from this class and want to update the default</span>
</span><span id="S3Task-140"><a href="#S3Task-140"><span class="linenos">140</span></a>    <span class="c1"># command to use for the child class.</span>
</span><span id="S3Task-141"><a href="#S3Task-141"><span class="linenos">141</span></a>    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="S3Task-142"><a href="#S3Task-142"><span class="linenos">142</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-143"><a href="#S3Task-143"><span class="linenos">143</span></a><span class="sd">    The defualt shell command to use.</span>
</span><span id="S3Task-144"><a href="#S3Task-144"><span class="linenos">144</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="S3Task-145"><a href="#S3Task-145"><span class="linenos">145</span></a>
</span><span id="S3Task-146"><a href="#S3Task-146"><span class="linenos">146</span></a>    <span class="c1"># While it&#39;s not needed for a number of cases, it&#39;s extremely common for the</span>
</span><span id="S3Task-147"><a href="#S3Task-147"><span class="linenos">147</span></a>    <span class="c1"># setup method to need an input structure in matsci. I therefore include</span>
</span><span id="S3Task-148"><a href="#S3Task-148"><span class="linenos">148</span></a>    <span class="c1"># this rather than having a nearly identical subclass that could cause</span>
</span><span id="S3Task-149"><a href="#S3Task-149"><span class="linenos">149</span></a>    <span class="c1"># some confusion.</span>
</span><span id="S3Task-150"><a href="#S3Task-150"><span class="linenos">150</span></a>    <span class="n">requires_structure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="S3Task-151"><a href="#S3Task-151"><span class="linenos">151</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-152"><a href="#S3Task-152"><span class="linenos">152</span></a><span class="sd">    Indicates whether a structure is needed if for the run() method.</span>
</span><span id="S3Task-153"><a href="#S3Task-153"><span class="linenos">153</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="S3Task-154"><a href="#S3Task-154"><span class="linenos">154</span></a>
</span><span id="S3Task-155"><a href="#S3Task-155"><span class="linenos">155</span></a>    <span class="n">error_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorHandler</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="S3Task-156"><a href="#S3Task-156"><span class="linenos">156</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-157"><a href="#S3Task-157"><span class="linenos">157</span></a><span class="sd">    A list of ErrorHandler objects to use in order of priority (that is, highest</span>
</span><span id="S3Task-158"><a href="#S3Task-158"><span class="linenos">158</span></a><span class="sd">    priority is first). If one handler is triggered, the correction will be </span>
</span><span id="S3Task-159"><a href="#S3Task-159"><span class="linenos">159</span></a><span class="sd">    applied and none of the following handlers will be checked.</span>
</span><span id="S3Task-160"><a href="#S3Task-160"><span class="linenos">160</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="S3Task-161"><a href="#S3Task-161"><span class="linenos">161</span></a>
</span><span id="S3Task-162"><a href="#S3Task-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="S3Task-163"><a href="#S3Task-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="S3Task-164"><a href="#S3Task-164"><span class="linenos">164</span></a>        <span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="S3Task-165"><a href="#S3Task-165"><span class="linenos">165</span></a>        <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="S3Task-166"><a href="#S3Task-166"><span class="linenos">166</span></a>        <span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="S3Task-167"><a href="#S3Task-167"><span class="linenos">167</span></a>        <span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="S3Task-168"><a href="#S3Task-168"><span class="linenos">168</span></a>        <span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="S3Task-169"><a href="#S3Task-169"><span class="linenos">169</span></a>        <span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simmate_corrections.csv&quot;</span><span class="p">,</span>
</span><span id="S3Task-170"><a href="#S3Task-170"><span class="linenos">170</span></a>        <span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="S3Task-171"><a href="#S3Task-171"><span class="linenos">171</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="S3Task-172"><a href="#S3Task-172"><span class="linenos">172</span></a>    <span class="p">):</span>
</span><span id="S3Task-173"><a href="#S3Task-173"><span class="linenos">173</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-174"><a href="#S3Task-174"><span class="linenos">174</span></a><span class="sd">        Creates a task instance of this class. The parameters passed will be the</span>
</span><span id="S3Task-175"><a href="#S3Task-175"><span class="linenos">175</span></a><span class="sd">        same every time you call the task.run() method.</span>
</span><span id="S3Task-176"><a href="#S3Task-176"><span class="linenos">176</span></a>
</span><span id="S3Task-177"><a href="#S3Task-177"><span class="linenos">177</span></a><span class="sd">        Note, many of the parameters here are for the Monitoring settings. These</span>
</span><span id="S3Task-178"><a href="#S3Task-178"><span class="linenos">178</span></a><span class="sd">        are only ever relevent if there are ErrorHandlers added that have</span>
</span><span id="S3Task-179"><a href="#S3Task-179"><span class="linenos">179</span></a><span class="sd">        is_monitor=True. These handlers run while the shelltask itself is also</span>
</span><span id="S3Task-180"><a href="#S3Task-180"><span class="linenos">180</span></a><span class="sd">        running. Read more about ErrorHandlers for more info.</span>
</span><span id="S3Task-181"><a href="#S3Task-181"><span class="linenos">181</span></a>
</span><span id="S3Task-182"><a href="#S3Task-182"><span class="linenos">182</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task-183"><a href="#S3Task-183"><span class="linenos">183</span></a>
</span><span id="S3Task-184"><a href="#S3Task-184"><span class="linenos">184</span></a><span class="sd">        - `max_corrections`:</span>
</span><span id="S3Task-185"><a href="#S3Task-185"><span class="linenos">185</span></a><span class="sd">            The maximum number of times we can apply a correction and retry the shell</span>
</span><span id="S3Task-186"><a href="#S3Task-186"><span class="linenos">186</span></a><span class="sd">            command. The maximum number of times that corrections will be made (and</span>
</span><span id="S3Task-187"><a href="#S3Task-187"><span class="linenos">187</span></a><span class="sd">            shell command reran) before giving up on the calculation. Note, once this</span>
</span><span id="S3Task-188"><a href="#S3Task-188"><span class="linenos">188</span></a><span class="sd">            limit is exceeded, the error is stored without correcting or restarting</span>
</span><span id="S3Task-189"><a href="#S3Task-189"><span class="linenos">189</span></a><span class="sd">            the run.</span>
</span><span id="S3Task-190"><a href="#S3Task-190"><span class="linenos">190</span></a><span class="sd">        - `monitor`:</span>
</span><span id="S3Task-191"><a href="#S3Task-191"><span class="linenos">191</span></a><span class="sd">            Whether to run monitor handlers while the command runs. False means</span>
</span><span id="S3Task-192"><a href="#S3Task-192"><span class="linenos">192</span></a><span class="sd">            wait until the job has completed.</span>
</span><span id="S3Task-193"><a href="#S3Task-193"><span class="linenos">193</span></a><span class="sd">        - `polling_timestep`:</span>
</span><span id="S3Task-194"><a href="#S3Task-194"><span class="linenos">194</span></a><span class="sd">            If we are monitoring the job for errors while it runs, this is how often</span>
</span><span id="S3Task-195"><a href="#S3Task-195"><span class="linenos">195</span></a><span class="sd">            (in seconds) we should check the status of our job. Note this check is</span>
</span><span id="S3Task-196"><a href="#S3Task-196"><span class="linenos">196</span></a><span class="sd">            just whether the job is done or not. This is NOT how often we check for</span>
</span><span id="S3Task-197"><a href="#S3Task-197"><span class="linenos">197</span></a><span class="sd">            errors. See monitor_freq for that.</span>
</span><span id="S3Task-198"><a href="#S3Task-198"><span class="linenos">198</span></a><span class="sd">        - `monitor_freq`:</span>
</span><span id="S3Task-199"><a href="#S3Task-199"><span class="linenos">199</span></a><span class="sd">            The frequency we should run check for errors with our monitors. This is</span>
</span><span id="S3Task-200"><a href="#S3Task-200"><span class="linenos">200</span></a><span class="sd">            based on the polling_timestep loops. For example, if we have a</span>
</span><span id="S3Task-201"><a href="#S3Task-201"><span class="linenos">201</span></a><span class="sd">            polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
</span><span id="S3Task-202"><a href="#S3Task-202"><span class="linenos">202</span></a><span class="sd">            the monitor checks every other loop -- or every 2x10 = 20 seconds. The</span>
</span><span id="S3Task-203"><a href="#S3Task-203"><span class="linenos">203</span></a><span class="sd">            default values of polling_timestep=10 and monitor_freq=30 indicate that</span>
</span><span id="S3Task-204"><a href="#S3Task-204"><span class="linenos">204</span></a><span class="sd">            we run monitoring functions every 5 minutes (10x30=300s=5min).</span>
</span><span id="S3Task-205"><a href="#S3Task-205"><span class="linenos">205</span></a><span class="sd">        - `save_corrections_to_file`:</span>
</span><span id="S3Task-206"><a href="#S3Task-206"><span class="linenos">206</span></a><span class="sd">            Whether to write a log file of the corrections made. The default is True.</span>
</span><span id="S3Task-207"><a href="#S3Task-207"><span class="linenos">207</span></a><span class="sd">        - `corrections_filename`:</span>
</span><span id="S3Task-208"><a href="#S3Task-208"><span class="linenos">208</span></a><span class="sd">            If save_corrections_to_file is True, this is the filename of where</span>
</span><span id="S3Task-209"><a href="#S3Task-209"><span class="linenos">209</span></a><span class="sd">            to write the corrections. The default is &quot;simmate_corrections.csv&quot;.</span>
</span><span id="S3Task-210"><a href="#S3Task-210"><span class="linenos">210</span></a><span class="sd">        - `compress_output`:</span>
</span><span id="S3Task-211"><a href="#S3Task-211"><span class="linenos">211</span></a><span class="sd">            Whether to compress the directory to a zip file at the end of the</span>
</span><span id="S3Task-212"><a href="#S3Task-212"><span class="linenos">212</span></a><span class="sd">            task run. After compression, it will also delete the directory.</span>
</span><span id="S3Task-213"><a href="#S3Task-213"><span class="linenos">213</span></a><span class="sd">            The default is False.</span>
</span><span id="S3Task-214"><a href="#S3Task-214"><span class="linenos">214</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="S3Task-215"><a href="#S3Task-215"><span class="linenos">215</span></a><span class="sd">            All extra arguments supported by</span>
</span><span id="S3Task-216"><a href="#S3Task-216"><span class="linenos">216</span></a><span class="sd">            [prefect.core.task.Task](https://docs.prefect.io/api/latest/core/task.html).</span>
</span><span id="S3Task-217"><a href="#S3Task-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-218"><a href="#S3Task-218"><span class="linenos">218</span></a>
</span><span id="S3Task-219"><a href="#S3Task-219"><span class="linenos">219</span></a>        <span class="c1"># Save the provided settings</span>
</span><span id="S3Task-220"><a href="#S3Task-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
</span><span id="S3Task-221"><a href="#S3Task-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span> <span class="o">=</span> <span class="n">max_corrections</span>
</span><span id="S3Task-222"><a href="#S3Task-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span> <span class="o">=</span> <span class="n">polling_timestep</span>
</span><span id="S3Task-223"><a href="#S3Task-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">=</span> <span class="n">monitor_freq</span>
</span><span id="S3Task-224"><a href="#S3Task-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span> <span class="o">=</span> <span class="n">compress_output</span>
</span><span id="S3Task-225"><a href="#S3Task-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="o">=</span> <span class="n">save_corrections_to_file</span>
</span><span id="S3Task-226"><a href="#S3Task-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span> <span class="o">=</span> <span class="n">corrections_filename</span>
</span><span id="S3Task-227"><a href="#S3Task-227"><span class="linenos">227</span></a>
</span><span id="S3Task-228"><a href="#S3Task-228"><span class="linenos">228</span></a>        <span class="c1"># now inherit the parent Prefect Task class</span>
</span><span id="S3Task-229"><a href="#S3Task-229"><span class="linenos">229</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="S3Task-230"><a href="#S3Task-230"><span class="linenos">230</span></a>
</span><span id="S3Task-231"><a href="#S3Task-231"><span class="linenos">231</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="S3Task-232"><a href="#S3Task-232"><span class="linenos">232</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-233"><a href="#S3Task-233"><span class="linenos">233</span></a><span class="sd">        This abstract method is ran before the command is actually executed. This</span>
</span><span id="S3Task-234"><a href="#S3Task-234"><span class="linenos">234</span></a><span class="sd">        allows for some pre-processing, such as writing input files or any other</span>
</span><span id="S3Task-235"><a href="#S3Task-235"><span class="linenos">235</span></a><span class="sd">        analysis.</span>
</span><span id="S3Task-236"><a href="#S3Task-236"><span class="linenos">236</span></a>
</span><span id="S3Task-237"><a href="#S3Task-237"><span class="linenos">237</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="S3Task-238"><a href="#S3Task-238"><span class="linenos">238</span></a><span class="sd">        is becuase setup() is normally called within the run() method.</span>
</span><span id="S3Task-239"><a href="#S3Task-239"><span class="linenos">239</span></a>
</span><span id="S3Task-240"><a href="#S3Task-240"><span class="linenos">240</span></a><span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
</span><span id="S3Task-241"><a href="#S3Task-241"><span class="linenos">241</span></a><span class="sd">        doesn&#39;t nothing but &quot;pass&quot;.</span>
</span><span id="S3Task-242"><a href="#S3Task-242"><span class="linenos">242</span></a>
</span><span id="S3Task-243"><a href="#S3Task-243"><span class="linenos">243</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task-244"><a href="#S3Task-244"><span class="linenos">244</span></a>
</span><span id="S3Task-245"><a href="#S3Task-245"><span class="linenos">245</span></a><span class="sd">        - `structure`:</span>
</span><span id="S3Task-246"><a href="#S3Task-246"><span class="linenos">246</span></a><span class="sd">            The structure to use for the task, if one is required.</span>
</span><span id="S3Task-247"><a href="#S3Task-247"><span class="linenos">247</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task-248"><a href="#S3Task-248"><span class="linenos">248</span></a><span class="sd">            The directory to run everything in. Must exist already.</span>
</span><span id="S3Task-249"><a href="#S3Task-249"><span class="linenos">249</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="S3Task-250"><a href="#S3Task-250"><span class="linenos">250</span></a><span class="sd">            Extra kwargs that may be passed to some function within. Because</span>
</span><span id="S3Task-251"><a href="#S3Task-251"><span class="linenos">251</span></a><span class="sd">            Simmate prefers fixed settings for their workflows, this is typically</span>
</span><span id="S3Task-252"><a href="#S3Task-252"><span class="linenos">252</span></a><span class="sd">            not used, but instead, keywords should be explicitly defined when</span>
</span><span id="S3Task-253"><a href="#S3Task-253"><span class="linenos">253</span></a><span class="sd">            writing a setup method.</span>
</span><span id="S3Task-254"><a href="#S3Task-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-255"><a href="#S3Task-255"><span class="linenos">255</span></a>        <span class="c1"># Be sure to include directory and structure (or **kwargs) as input</span>
</span><span id="S3Task-256"><a href="#S3Task-256"><span class="linenos">256</span></a>        <span class="c1"># arguments for higher-level compatibility with the run method.</span>
</span><span id="S3Task-257"><a href="#S3Task-257"><span class="linenos">257</span></a>        <span class="k">pass</span>
</span><span id="S3Task-258"><a href="#S3Task-258"><span class="linenos">258</span></a>
</span><span id="S3Task-259"><a href="#S3Task-259"><span class="linenos">259</span></a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="S3Task-260"><a href="#S3Task-260"><span class="linenos">260</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-261"><a href="#S3Task-261"><span class="linenos">261</span></a><span class="sd">        This calls the command within the target directory and handles all error</span>
</span><span id="S3Task-262"><a href="#S3Task-262"><span class="linenos">262</span></a><span class="sd">        handling as well as monitoring of the job.</span>
</span><span id="S3Task-263"><a href="#S3Task-263"><span class="linenos">263</span></a>
</span><span id="S3Task-264"><a href="#S3Task-264"><span class="linenos">264</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="S3Task-265"><a href="#S3Task-265"><span class="linenos">265</span></a><span class="sd">        is becuase `execute` is normally called within the `run` method.</span>
</span><span id="S3Task-266"><a href="#S3Task-266"><span class="linenos">266</span></a>
</span><span id="S3Task-267"><a href="#S3Task-267"><span class="linenos">267</span></a><span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
</span><span id="S3Task-268"><a href="#S3Task-268"><span class="linenos">268</span></a><span class="sd">        does nothing but &quot;pass&quot;.</span>
</span><span id="S3Task-269"><a href="#S3Task-269"><span class="linenos">269</span></a>
</span><span id="S3Task-270"><a href="#S3Task-270"><span class="linenos">270</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task-271"><a href="#S3Task-271"><span class="linenos">271</span></a>
</span><span id="S3Task-272"><a href="#S3Task-272"><span class="linenos">272</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task-273"><a href="#S3Task-273"><span class="linenos">273</span></a><span class="sd">            The directory to run everything in.</span>
</span><span id="S3Task-274"><a href="#S3Task-274"><span class="linenos">274</span></a><span class="sd">        - `command`:</span>
</span><span id="S3Task-275"><a href="#S3Task-275"><span class="linenos">275</span></a><span class="sd">            The command that will be called during execution.</span>
</span><span id="S3Task-276"><a href="#S3Task-276"><span class="linenos">276</span></a>
</span><span id="S3Task-277"><a href="#S3Task-277"><span class="linenos">277</span></a><span class="sd">        #### Returns</span>
</span><span id="S3Task-278"><a href="#S3Task-278"><span class="linenos">278</span></a>
</span><span id="S3Task-279"><a href="#S3Task-279"><span class="linenos">279</span></a><span class="sd">        - `corrections`</span>
</span><span id="S3Task-280"><a href="#S3Task-280"><span class="linenos">280</span></a><span class="sd">            A list of tuples where each entry is a error identified and the</span>
</span><span id="S3Task-281"><a href="#S3Task-281"><span class="linenos">281</span></a><span class="sd">            correction applied. Ex: [(&quot;ExampleError&quot;, &quot;ExampleCorrection&quot;)]</span>
</span><span id="S3Task-282"><a href="#S3Task-282"><span class="linenos">282</span></a>
</span><span id="S3Task-283"><a href="#S3Task-283"><span class="linenos">283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-284"><a href="#S3Task-284"><span class="linenos">284</span></a>
</span><span id="S3Task-285"><a href="#S3Task-285"><span class="linenos">285</span></a>        <span class="c1"># some error_handlers run while the shelltask is running. These are known as</span>
</span><span id="S3Task-286"><a href="#S3Task-286"><span class="linenos">286</span></a>        <span class="c1"># Monitors and are labled via the is_monitor attribute. It&#39;s good for us</span>
</span><span id="S3Task-287"><a href="#S3Task-287"><span class="linenos">287</span></a>        <span class="c1"># to separate these out from other error_handlers.</span>
</span><span id="S3Task-288"><a href="#S3Task-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="S3Task-289"><a href="#S3Task-289"><span class="linenos">289</span></a>            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_monitor</span>
</span><span id="S3Task-290"><a href="#S3Task-290"><span class="linenos">290</span></a>        <span class="p">]</span>
</span><span id="S3Task-291"><a href="#S3Task-291"><span class="linenos">291</span></a>
</span><span id="S3Task-292"><a href="#S3Task-292"><span class="linenos">292</span></a>        <span class="c1"># We start with zero corrections that we slowly add to. This can be</span>
</span><span id="S3Task-293"><a href="#S3Task-293"><span class="linenos">293</span></a>        <span class="c1"># thought of as a table with headers of...</span>
</span><span id="S3Task-294"><a href="#S3Task-294"><span class="linenos">294</span></a>        <span class="c1">#   (&quot;applied_errorhandler&quot;, &quot;correction_applied&quot;)</span>
</span><span id="S3Task-295"><a href="#S3Task-295"><span class="linenos">295</span></a>        <span class="c1"># NOTE: I took out the table headers and may add them back in</span>
</span><span id="S3Task-296"><a href="#S3Task-296"><span class="linenos">296</span></a>        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="S3Task-297"><a href="#S3Task-297"><span class="linenos">297</span></a>
</span><span id="S3Task-298"><a href="#S3Task-298"><span class="linenos">298</span></a>        <span class="c1"># ------ start of main while loop ------</span>
</span><span id="S3Task-299"><a href="#S3Task-299"><span class="linenos">299</span></a>
</span><span id="S3Task-300"><a href="#S3Task-300"><span class="linenos">300</span></a>        <span class="c1"># we can try running the shelltask up to max_corrections. Because only one</span>
</span><span id="S3Task-301"><a href="#S3Task-301"><span class="linenos">301</span></a>        <span class="c1"># correction is applied per attempt, you can view this as the maximum</span>
</span><span id="S3Task-302"><a href="#S3Task-302"><span class="linenos">302</span></a>        <span class="c1"># number of attempts made on the calculation.</span>
</span><span id="S3Task-303"><a href="#S3Task-303"><span class="linenos">303</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
</span><span id="S3Task-304"><a href="#S3Task-304"><span class="linenos">304</span></a>
</span><span id="S3Task-305"><a href="#S3Task-305"><span class="linenos">305</span></a>            <span class="c1"># launch the shelltask without waiting for it to complete. Also,</span>
</span><span id="S3Task-306"><a href="#S3Task-306"><span class="linenos">306</span></a>            <span class="c1"># make sure to use common shell commands and to set the working</span>
</span><span id="S3Task-307"><a href="#S3Task-307"><span class="linenos">307</span></a>            <span class="c1"># directory.</span>
</span><span id="S3Task-308"><a href="#S3Task-308"><span class="linenos">308</span></a>            <span class="c1">#</span>
</span><span id="S3Task-309"><a href="#S3Task-309"><span class="linenos">309</span></a>            <span class="c1"># Stderr keyword indicates that we should capture the error if one</span>
</span><span id="S3Task-310"><a href="#S3Task-310"><span class="linenos">310</span></a>            <span class="c1"># occurs so that we can report it to the user.</span>
</span><span id="S3Task-311"><a href="#S3Task-311"><span class="linenos">311</span></a>            <span class="c1">#</span>
</span><span id="S3Task-312"><a href="#S3Task-312"><span class="linenos">312</span></a>            <span class="c1"># The preexec_fn keyword allows us to properly terminate jobs that</span>
</span><span id="S3Task-313"><a href="#S3Task-313"><span class="linenos">313</span></a>            <span class="c1"># are launched with parallel processes (such as mpirun). This assigns</span>
</span><span id="S3Task-314"><a href="#S3Task-314"><span class="linenos">314</span></a>            <span class="c1"># a parent id to it that we use when killing a job (if an error</span>
</span><span id="S3Task-315"><a href="#S3Task-315"><span class="linenos">315</span></a>            <span class="c1"># handler calls for us to do so). This isn&#39;t possible on Windows though.</span>
</span><span id="S3Task-316"><a href="#S3Task-316"><span class="linenos">316</span></a>            <span class="c1">#</span>
</span><span id="S3Task-317"><a href="#S3Task-317"><span class="linenos">317</span></a>            <span class="c1"># OPTIMIZE / BUG: preexec_fn adds about 0.02s overhead to the calculation</span>
</span><span id="S3Task-318"><a href="#S3Task-318"><span class="linenos">318</span></a>            <span class="c1"># so we may not want to always use it... Instead we could try to only</span>
</span><span id="S3Task-319"><a href="#S3Task-319"><span class="linenos">319</span></a>            <span class="c1"># use it when the command includes &quot;mpirun&quot;. Though this may introduce</span>
</span><span id="S3Task-320"><a href="#S3Task-320"><span class="linenos">320</span></a>            <span class="c1"># a bug if another is another parallel command used besides mpirun.</span>
</span><span id="S3Task-321"><a href="#S3Task-321"><span class="linenos">321</span></a>            <span class="c1"># An example of this might be deepmd which automatically submits</span>
</span><span id="S3Task-322"><a href="#S3Task-322"><span class="linenos">322</span></a>            <span class="c1"># things in parallel without calling mpirun up-front.</span>
</span><span id="S3Task-323"><a href="#S3Task-323"><span class="linenos">323</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
</span><span id="S3Task-324"><a href="#S3Task-324"><span class="linenos">324</span></a>                <span class="n">command</span><span class="p">,</span>
</span><span id="S3Task-325"><a href="#S3Task-325"><span class="linenos">325</span></a>                <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
</span><span id="S3Task-326"><a href="#S3Task-326"><span class="linenos">326</span></a>                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="S3Task-327"><a href="#S3Task-327"><span class="linenos">327</span></a>                <span class="n">preexec_fn</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span>
</span><span id="S3Task-328"><a href="#S3Task-328"><span class="linenos">328</span></a>                <span class="c1"># or &quot;mpirun&quot; not in command  # See bug/optimize comment above</span>
</span><span id="S3Task-329"><a href="#S3Task-329"><span class="linenos">329</span></a>                <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
</span><span id="S3Task-330"><a href="#S3Task-330"><span class="linenos">330</span></a>                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="S3Task-331"><a href="#S3Task-331"><span class="linenos">331</span></a>            <span class="p">)</span>
</span><span id="S3Task-332"><a href="#S3Task-332"><span class="linenos">332</span></a>
</span><span id="S3Task-333"><a href="#S3Task-333"><span class="linenos">333</span></a>            <span class="c1"># Assume the shelltask has no errors until proven otherwise</span>
</span><span id="S3Task-334"><a href="#S3Task-334"><span class="linenos">334</span></a>            <span class="n">has_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="S3Task-335"><a href="#S3Task-335"><span class="linenos">335</span></a>
</span><span id="S3Task-336"><a href="#S3Task-336"><span class="linenos">336</span></a>            <span class="c1"># If monitor=True, then we want to supervise this shelltask as it</span>
</span><span id="S3Task-337"><a href="#S3Task-337"><span class="linenos">337</span></a>            <span class="c1"># runs. If montors=[m1,m2,...], then we have monitors in place to actually</span>
</span><span id="S3Task-338"><a href="#S3Task-338"><span class="linenos">338</span></a>            <span class="c1"># perform the monitoring. If both of these cases are true, then we</span>
</span><span id="S3Task-339"><a href="#S3Task-339"><span class="linenos">339</span></a>            <span class="c1"># want to go through the error_handlers to check for errors until</span>
</span><span id="S3Task-340"><a href="#S3Task-340"><span class="linenos">340</span></a>            <span class="c1"># the shelltask completes.</span>
</span><span id="S3Task-341"><a href="#S3Task-341"><span class="linenos">341</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
</span><span id="S3Task-342"><a href="#S3Task-342"><span class="linenos">342</span></a>
</span><span id="S3Task-343"><a href="#S3Task-343"><span class="linenos">343</span></a>                <span class="c1"># ------ start of monitor while loop ------</span>
</span><span id="S3Task-344"><a href="#S3Task-344"><span class="linenos">344</span></a>
</span><span id="S3Task-345"><a href="#S3Task-345"><span class="linenos">345</span></a>                <span class="c1"># We want to loop until we find an error and keep track of</span>
</span><span id="S3Task-346"><a href="#S3Task-346"><span class="linenos">346</span></a>                <span class="c1"># which loops to run the monitor function on because we don&#39;t</span>
</span><span id="S3Task-347"><a href="#S3Task-347"><span class="linenos">347</span></a>                <span class="c1"># want them to run nonstop. This variable allows us to monitor</span>
</span><span id="S3Task-348"><a href="#S3Task-348"><span class="linenos">348</span></a>                <span class="c1"># checks every Nth loop, while we check the shelltask status</span>
</span><span id="S3Task-349"><a href="#S3Task-349"><span class="linenos">349</span></a>                <span class="c1"># on all other loops.</span>
</span><span id="S3Task-350"><a href="#S3Task-350"><span class="linenos">350</span></a>                <span class="n">monitor_freq_n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="S3Task-351"><a href="#S3Task-351"><span class="linenos">351</span></a>                <span class="k">while</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="S3Task-352"><a href="#S3Task-352"><span class="linenos">352</span></a>                    <span class="n">monitor_freq_n</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="S3Task-353"><a href="#S3Task-353"><span class="linenos">353</span></a>                    <span class="c1"># Sleep the set amount before checking the shelltask status</span>
</span><span id="S3Task-354"><a href="#S3Task-354"><span class="linenos">354</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span><span class="p">)</span>
</span><span id="S3Task-355"><a href="#S3Task-355"><span class="linenos">355</span></a>
</span><span id="S3Task-356"><a href="#S3Task-356"><span class="linenos">356</span></a>                    <span class="c1"># check if the shelltasks is complete. poll will return 0</span>
</span><span id="S3Task-357"><a href="#S3Task-357"><span class="linenos">357</span></a>                    <span class="c1"># when it&#39;s done, in which case we break the loop</span>
</span><span id="S3Task-358"><a href="#S3Task-358"><span class="linenos">358</span></a>                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="S3Task-359"><a href="#S3Task-359"><span class="linenos">359</span></a>                        <span class="k">break</span>
</span><span id="S3Task-360"><a href="#S3Task-360"><span class="linenos">360</span></a>                    <span class="c1"># check whether we should run monitors on this poll loop</span>
</span><span id="S3Task-361"><a href="#S3Task-361"><span class="linenos">361</span></a>                    <span class="k">if</span> <span class="n">monitor_freq_n</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="S3Task-362"><a href="#S3Task-362"><span class="linenos">362</span></a>                        <span class="c1"># iterate through each monitor</span>
</span><span id="S3Task-363"><a href="#S3Task-363"><span class="linenos">363</span></a>                        <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
</span><span id="S3Task-364"><a href="#S3Task-364"><span class="linenos">364</span></a>                            <span class="c1"># check if there&#39;s an error with this error_handler</span>
</span><span id="S3Task-365"><a href="#S3Task-365"><span class="linenos">365</span></a>                            <span class="c1"># and grab the error if so</span>
</span><span id="S3Task-366"><a href="#S3Task-366"><span class="linenos">366</span></a>                            <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-367"><a href="#S3Task-367"><span class="linenos">367</span></a>                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span><span id="S3Task-368"><a href="#S3Task-368"><span class="linenos">368</span></a>                                <span class="c1"># determine if it is_terminating</span>
</span><span id="S3Task-369"><a href="#S3Task-369"><span class="linenos">369</span></a>                                <span class="k">if</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">is_terminating</span><span class="p">:</span>
</span><span id="S3Task-370"><a href="#S3Task-370"><span class="linenos">370</span></a>                                    <span class="c1"># If so, we kill the process but don&#39;t apply</span>
</span><span id="S3Task-371"><a href="#S3Task-371"><span class="linenos">371</span></a>                                    <span class="c1"># the fix quite yet. That step is done below.</span>
</span><span id="S3Task-372"><a href="#S3Task-372"><span class="linenos">372</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="S3Task-373"><a href="#S3Task-373"><span class="linenos">373</span></a>                                <span class="c1"># Otherwise apply the fix and let the shelltask end</span>
</span><span id="S3Task-374"><a href="#S3Task-374"><span class="linenos">374</span></a>                                <span class="c1"># naturally. An example of this is for codes</span>
</span><span id="S3Task-375"><a href="#S3Task-375"><span class="linenos">375</span></a>                                <span class="c1"># where you add a STOP file to get it to</span>
</span><span id="S3Task-376"><a href="#S3Task-376"><span class="linenos">376</span></a>                                <span class="c1"># finish rather than just killing the process.</span>
</span><span id="S3Task-377"><a href="#S3Task-377"><span class="linenos">377</span></a>                                <span class="c1"># This is the special case error_handler that I talk</span>
</span><span id="S3Task-378"><a href="#S3Task-378"><span class="linenos">378</span></a>                                <span class="c1"># about in my notes, where we really want to</span>
</span><span id="S3Task-379"><a href="#S3Task-379"><span class="linenos">379</span></a>                                <span class="c1"># end the shelltask right away.</span>
</span><span id="S3Task-380"><a href="#S3Task-380"><span class="linenos">380</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="S3Task-381"><a href="#S3Task-381"><span class="linenos">381</span></a>                                    <span class="c1"># make a copy of the directory contents and</span>
</span><span id="S3Task-382"><a href="#S3Task-382"><span class="linenos">382</span></a>                                    <span class="c1"># store as an archive within the same directory</span>
</span><span id="S3Task-383"><a href="#S3Task-383"><span class="linenos">383</span></a>                                    <span class="n">make_error_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-384"><a href="#S3Task-384"><span class="linenos">384</span></a>                                    <span class="c1"># apply the fix now</span>
</span><span id="S3Task-385"><a href="#S3Task-385"><span class="linenos">385</span></a>                                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-386"><a href="#S3Task-386"><span class="linenos">386</span></a>                                    <span class="c1"># record what&#39;s been changed</span>
</span><span id="S3Task-387"><a href="#S3Task-387"><span class="linenos">387</span></a>                                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
</span><span id="S3Task-388"><a href="#S3Task-388"><span class="linenos">388</span></a>                                <span class="c1"># there&#39;s no need to look at the other monitors</span>
</span><span id="S3Task-389"><a href="#S3Task-389"><span class="linenos">389</span></a>                                <span class="c1"># so break from the for-loop. We also don&#39;t</span>
</span><span id="S3Task-390"><a href="#S3Task-390"><span class="linenos">390</span></a>                                <span class="c1"># need to monitor the stagedtask anymore since we just</span>
</span><span id="S3Task-391"><a href="#S3Task-391"><span class="linenos">391</span></a>                                <span class="c1"># terminated it or signaled for its graceful</span>
</span><span id="S3Task-392"><a href="#S3Task-392"><span class="linenos">392</span></a>                                <span class="c1"># end. So update the while-loop condition.</span>
</span><span id="S3Task-393"><a href="#S3Task-393"><span class="linenos">393</span></a>                                <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="S3Task-394"><a href="#S3Task-394"><span class="linenos">394</span></a>                                <span class="k">break</span>
</span><span id="S3Task-395"><a href="#S3Task-395"><span class="linenos">395</span></a>                <span class="c1"># ------ end of monitor while loop ------</span>
</span><span id="S3Task-396"><a href="#S3Task-396"><span class="linenos">396</span></a>            <span class="c1"># Now just wait for the process to finish. Note we use communicate</span>
</span><span id="S3Task-397"><a href="#S3Task-397"><span class="linenos">397</span></a>            <span class="c1"># instead of the .wait() method. This is the recommended method</span>
</span><span id="S3Task-398"><a href="#S3Task-398"><span class="linenos">398</span></a>            <span class="c1"># when we have stderr=subprocess.PIPE, which we use above.</span>
</span><span id="S3Task-399"><a href="#S3Task-399"><span class="linenos">399</span></a>            <span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="S3Task-400"><a href="#S3Task-400"><span class="linenos">400</span></a>            <span class="c1"># check if the return code is non-zero and thus failed.</span>
</span><span id="S3Task-401"><a href="#S3Task-401"><span class="linenos">401</span></a>            <span class="c1"># The &#39;not has_error&#39; is because terminate() will give a nonzero</span>
</span><span id="S3Task-402"><a href="#S3Task-402"><span class="linenos">402</span></a>            <span class="c1"># when a monitor is triggered. We don&#39;t want to raise that</span>
</span><span id="S3Task-403"><a href="#S3Task-403"><span class="linenos">403</span></a>            <span class="c1"># exception here but instead let the monitor handle that</span>
</span><span id="S3Task-404"><a href="#S3Task-404"><span class="linenos">404</span></a>            <span class="c1"># error in the code below.</span>
</span><span id="S3Task-405"><a href="#S3Task-405"><span class="linenos">405</span></a>            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="S3Task-406"><a href="#S3Task-406"><span class="linenos">406</span></a>                <span class="c1"># convert the error from bytes to a string</span>
</span><span id="S3Task-407"><a href="#S3Task-407"><span class="linenos">407</span></a>                <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="S3Task-408"><a href="#S3Task-408"><span class="linenos">408</span></a>                <span class="c1"># and report the error to the user</span>
</span><span id="S3Task-409"><a href="#S3Task-409"><span class="linenos">409</span></a>                <span class="k">raise</span> <span class="n">NonZeroExitError</span><span class="p">(</span>
</span><span id="S3Task-410"><a href="#S3Task-410"><span class="linenos">410</span></a>                    <span class="sa">f</span><span class="s2">&quot;The command (</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">) failed. The error output was...</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="S3Task-411"><a href="#S3Task-411"><span class="linenos">411</span></a>                <span class="p">)</span>
</span><span id="S3Task-412"><a href="#S3Task-412"><span class="linenos">412</span></a>            <span class="c1"># Check for errors again, because a non-monitor may be higher</span>
</span><span id="S3Task-413"><a href="#S3Task-413"><span class="linenos">413</span></a>            <span class="c1"># priority than the monitor triggered above (if there was one).</span>
</span><span id="S3Task-414"><a href="#S3Task-414"><span class="linenos">414</span></a>            <span class="c1"># Since the error_handlers are in order of priority, only the first</span>
</span><span id="S3Task-415"><a href="#S3Task-415"><span class="linenos">415</span></a>            <span class="c1"># will actually be applied and then we can retry the calc.</span>
</span><span id="S3Task-416"><a href="#S3Task-416"><span class="linenos">416</span></a>            <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
</span><span id="S3Task-417"><a href="#S3Task-417"><span class="linenos">417</span></a>
</span><span id="S3Task-418"><a href="#S3Task-418"><span class="linenos">418</span></a>                <span class="c1"># NOTE - The following special case is handled above:</span>
</span><span id="S3Task-419"><a href="#S3Task-419"><span class="linenos">419</span></a>                <span class="c1">#   error_handler.is_monitor and not error_handler.is_terminating</span>
</span><span id="S3Task-420"><a href="#S3Task-420"><span class="linenos">420</span></a>                <span class="c1"># BUG: I can see this being a source of bugs in the process so I</span>
</span><span id="S3Task-421"><a href="#S3Task-421"><span class="linenos">421</span></a>                <span class="c1"># need to reconsider subclassing this special case. For now,</span>
</span><span id="S3Task-422"><a href="#S3Task-422"><span class="linenos">422</span></a>                <span class="c1"># users should have this case at the lowest priority.</span>
</span><span id="S3Task-423"><a href="#S3Task-423"><span class="linenos">423</span></a>
</span><span id="S3Task-424"><a href="#S3Task-424"><span class="linenos">424</span></a>                <span class="c1"># check if there&#39;s an error with this error_handler and grab the</span>
</span><span id="S3Task-425"><a href="#S3Task-425"><span class="linenos">425</span></a>                <span class="c1"># error if there is one</span>
</span><span id="S3Task-426"><a href="#S3Task-426"><span class="linenos">426</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-427"><a href="#S3Task-427"><span class="linenos">427</span></a>                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span><span id="S3Task-428"><a href="#S3Task-428"><span class="linenos">428</span></a>                    <span class="c1"># record the error in case it wasn&#39;t done so above</span>
</span><span id="S3Task-429"><a href="#S3Task-429"><span class="linenos">429</span></a>                    <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="S3Task-430"><a href="#S3Task-430"><span class="linenos">430</span></a>                    <span class="c1"># make a copy of the directory contents and</span>
</span><span id="S3Task-431"><a href="#S3Task-431"><span class="linenos">431</span></a>                    <span class="c1"># store as an archive within the same directory</span>
</span><span id="S3Task-432"><a href="#S3Task-432"><span class="linenos">432</span></a>                    <span class="n">make_error_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-433"><a href="#S3Task-433"><span class="linenos">433</span></a>                    <span class="c1"># And apply the proper correction if there is one.</span>
</span><span id="S3Task-434"><a href="#S3Task-434"><span class="linenos">434</span></a>                    <span class="c1"># Some error_handlers will even raise an error here signaling</span>
</span><span id="S3Task-435"><a href="#S3Task-435"><span class="linenos">435</span></a>                    <span class="c1"># that the stagedtask is unrecoverable and a lost cause.</span>
</span><span id="S3Task-436"><a href="#S3Task-436"><span class="linenos">436</span></a>                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-437"><a href="#S3Task-437"><span class="linenos">437</span></a>                    <span class="c1"># record what&#39;s been changed</span>
</span><span id="S3Task-438"><a href="#S3Task-438"><span class="linenos">438</span></a>                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
</span><span id="S3Task-439"><a href="#S3Task-439"><span class="linenos">439</span></a>                    <span class="c1"># break from the error_handler for-loop as we only apply the</span>
</span><span id="S3Task-440"><a href="#S3Task-440"><span class="linenos">440</span></a>                    <span class="c1"># highest priority fix and nothing else.</span>
</span><span id="S3Task-441"><a href="#S3Task-441"><span class="linenos">441</span></a>                    <span class="k">break</span>
</span><span id="S3Task-442"><a href="#S3Task-442"><span class="linenos">442</span></a>            <span class="c1"># write the log of corrections to file if requested. This is written</span>
</span><span id="S3Task-443"><a href="#S3Task-443"><span class="linenos">443</span></a>            <span class="c1"># as a CSV file format and done every while-loop cycle because it</span>
</span><span id="S3Task-444"><a href="#S3Task-444"><span class="linenos">444</span></a>            <span class="c1"># lets the user monitor the calculation and error handlers applied</span>
</span><span id="S3Task-445"><a href="#S3Task-445"><span class="linenos">445</span></a>            <span class="c1"># as it goes. If no corrections were applied, we skip writing the file.</span>
</span><span id="S3Task-446"><a href="#S3Task-446"><span class="linenos">446</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="ow">and</span> <span class="n">corrections</span><span class="p">:</span>
</span><span id="S3Task-447"><a href="#S3Task-447"><span class="linenos">447</span></a>                <span class="c1"># compile the corrections metadata into a dataframe</span>
</span><span id="S3Task-448"><a href="#S3Task-448"><span class="linenos">448</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="S3Task-449"><a href="#S3Task-449"><span class="linenos">449</span></a>                    <span class="n">corrections</span><span class="p">,</span>
</span><span id="S3Task-450"><a href="#S3Task-450"><span class="linenos">450</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_applied&quot;</span><span class="p">],</span>
</span><span id="S3Task-451"><a href="#S3Task-451"><span class="linenos">451</span></a>                <span class="p">)</span>
</span><span id="S3Task-452"><a href="#S3Task-452"><span class="linenos">452</span></a>                <span class="c1"># write the dataframe to a csv file</span>
</span><span id="S3Task-453"><a href="#S3Task-453"><span class="linenos">453</span></a>                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="S3Task-454"><a href="#S3Task-454"><span class="linenos">454</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span><span class="p">),</span>
</span><span id="S3Task-455"><a href="#S3Task-455"><span class="linenos">455</span></a>                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="S3Task-456"><a href="#S3Task-456"><span class="linenos">456</span></a>                <span class="p">)</span>
</span><span id="S3Task-457"><a href="#S3Task-457"><span class="linenos">457</span></a>            <span class="c1"># now that we&#39;ve gone through the error_handlers, let&#39;s see if any</span>
</span><span id="S3Task-458"><a href="#S3Task-458"><span class="linenos">458</span></a>            <span class="c1"># non-terminating errors were found (terminating ones would raise</span>
</span><span id="S3Task-459"><a href="#S3Task-459"><span class="linenos">459</span></a>            <span class="c1"># an error above). If there are no errors, we&#39;ve finished the</span>
</span><span id="S3Task-460"><a href="#S3Task-460"><span class="linenos">460</span></a>            <span class="c1"># calculation and can exit the while loop. Otherwise, just leave</span>
</span><span id="S3Task-461"><a href="#S3Task-461"><span class="linenos">461</span></a>            <span class="c1"># everything where it&#39;s at and restart the while-loop with a new</span>
</span><span id="S3Task-462"><a href="#S3Task-462"><span class="linenos">462</span></a>            <span class="c1"># attempt</span>
</span><span id="S3Task-463"><a href="#S3Task-463"><span class="linenos">463</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="S3Task-464"><a href="#S3Task-464"><span class="linenos">464</span></a>                <span class="c1"># break the while-loop</span>
</span><span id="S3Task-465"><a href="#S3Task-465"><span class="linenos">465</span></a>                <span class="k">break</span>
</span><span id="S3Task-466"><a href="#S3Task-466"><span class="linenos">466</span></a>        <span class="c1"># ------ end of main while loop ------</span>
</span><span id="S3Task-467"><a href="#S3Task-467"><span class="linenos">467</span></a>
</span><span id="S3Task-468"><a href="#S3Task-468"><span class="linenos">468</span></a>        <span class="c1"># make sure the while loop didn&#39;t exit because of the correction limit</span>
</span><span id="S3Task-469"><a href="#S3Task-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
</span><span id="S3Task-470"><a href="#S3Task-470"><span class="linenos">470</span></a>            <span class="k">raise</span> <span class="n">MaxCorrectionsError</span><span class="p">(</span>
</span><span id="S3Task-471"><a href="#S3Task-471"><span class="linenos">471</span></a>                <span class="s2">&quot;The number of maximum corrections has been exceeded. Note the final &quot;</span>
</span><span id="S3Task-472"><a href="#S3Task-472"><span class="linenos">472</span></a>                <span class="s2">&quot;error and its fix are still listed in the corrections file, but it &quot;</span>
</span><span id="S3Task-473"><a href="#S3Task-473"><span class="linenos">473</span></a>                <span class="s2">&quot;was never used.&quot;</span>
</span><span id="S3Task-474"><a href="#S3Task-474"><span class="linenos">474</span></a>            <span class="p">)</span>
</span><span id="S3Task-475"><a href="#S3Task-475"><span class="linenos">475</span></a>        <span class="c1"># now return the corrections for them to stored/used elsewhere</span>
</span><span id="S3Task-476"><a href="#S3Task-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">corrections</span>
</span><span id="S3Task-477"><a href="#S3Task-477"><span class="linenos">477</span></a>
</span><span id="S3Task-478"><a href="#S3Task-478"><span class="linenos">478</span></a>    <span class="nd">@staticmethod</span>
</span><span id="S3Task-479"><a href="#S3Task-479"><span class="linenos">479</span></a>    <span class="k">def</span> <span class="nf">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="S3Task-480"><a href="#S3Task-480"><span class="linenos">480</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-481"><a href="#S3Task-481"><span class="linenos">481</span></a><span class="sd">        Stopping the command we submitted can be a tricky business if we are running</span>
</span><span id="S3Task-482"><a href="#S3Task-482"><span class="linenos">482</span></a><span class="sd">        scripts in parallel (such as using mpirun). Different computers and OSs</span>
</span><span id="S3Task-483"><a href="#S3Task-483"><span class="linenos">483</span></a><span class="sd">        can require a different &#39;kill&#39; command so we establish this separate</span>
</span><span id="S3Task-484"><a href="#S3Task-484"><span class="linenos">484</span></a><span class="sd">        method that can be overwritten.</span>
</span><span id="S3Task-485"><a href="#S3Task-485"><span class="linenos">485</span></a>
</span><span id="S3Task-486"><a href="#S3Task-486"><span class="linenos">486</span></a><span class="sd">        If you know your command needs a special case to kill all of its spawn</span>
</span><span id="S3Task-487"><a href="#S3Task-487"><span class="linenos">487</span></a><span class="sd">        processes, you can overwrite this method as well.</span>
</span><span id="S3Task-488"><a href="#S3Task-488"><span class="linenos">488</span></a>
</span><span id="S3Task-489"><a href="#S3Task-489"><span class="linenos">489</span></a><span class="sd">        Users should never call this directly becuase this is instead applied</span>
</span><span id="S3Task-490"><a href="#S3Task-490"><span class="linenos">490</span></a><span class="sd">        within the execute() method.</span>
</span><span id="S3Task-491"><a href="#S3Task-491"><span class="linenos">491</span></a>
</span><span id="S3Task-492"><a href="#S3Task-492"><span class="linenos">492</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task-493"><a href="#S3Task-493"><span class="linenos">493</span></a>
</span><span id="S3Task-494"><a href="#S3Task-494"><span class="linenos">494</span></a><span class="sd">        - `process`:</span>
</span><span id="S3Task-495"><a href="#S3Task-495"><span class="linenos">495</span></a><span class="sd">            The process object that will be terminated.</span>
</span><span id="S3Task-496"><a href="#S3Task-496"><span class="linenos">496</span></a><span class="sd">        - `command`:</span>
</span><span id="S3Task-497"><a href="#S3Task-497"><span class="linenos">497</span></a><span class="sd">            the command used to launch the process. This is sometimes useful</span>
</span><span id="S3Task-498"><a href="#S3Task-498"><span class="linenos">498</span></a><span class="sd">            when searching for all running processes under this name.</span>
</span><span id="S3Task-499"><a href="#S3Task-499"><span class="linenos">499</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-500"><a href="#S3Task-500"><span class="linenos">500</span></a>
</span><span id="S3Task-501"><a href="#S3Task-501"><span class="linenos">501</span></a>        <span class="c1"># The operating system (Windows, OSX, or Linux) will give us the best guess</span>
</span><span id="S3Task-502"><a href="#S3Task-502"><span class="linenos">502</span></a>        <span class="c1"># as to where to access the running command. The results are as you&#39;d expect</span>
</span><span id="S3Task-503"><a href="#S3Task-503"><span class="linenos">503</span></a>        <span class="c1"># except for Macs, which returns &quot;Darwin&quot;.</span>
</span><span id="S3Task-504"><a href="#S3Task-504"><span class="linenos">504</span></a>        <span class="c1">#   Linux: Linux</span>
</span><span id="S3Task-505"><a href="#S3Task-505"><span class="linenos">505</span></a>        <span class="c1">#   Mac: Darwin</span>
</span><span id="S3Task-506"><a href="#S3Task-506"><span class="linenos">506</span></a>        <span class="c1">#   Windows: Windows</span>
</span><span id="S3Task-507"><a href="#S3Task-507"><span class="linenos">507</span></a>        <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
</span><span id="S3Task-508"><a href="#S3Task-508"><span class="linenos">508</span></a>
</span><span id="S3Task-509"><a href="#S3Task-509"><span class="linenos">509</span></a>        <span class="c1"># The normal line to end a popen process is just...</span>
</span><span id="S3Task-510"><a href="#S3Task-510"><span class="linenos">510</span></a>        <span class="c1">#   process.terminate()</span>
</span><span id="S3Task-511"><a href="#S3Task-511"><span class="linenos">511</span></a>        <span class="c1"># However this struggles to kill all &quot;child&quot; processes if we are using</span>
</span><span id="S3Task-512"><a href="#S3Task-512"><span class="linenos">512</span></a>        <span class="c1"># something like mpirun to run things in parallel. Instead, we use the</span>
</span><span id="S3Task-513"><a href="#S3Task-513"><span class="linenos">513</span></a>        <span class="c1"># os module to grab the parent id and send that the termination signal,</span>
</span><span id="S3Task-514"><a href="#S3Task-514"><span class="linenos">514</span></a>        <span class="c1"># which is also passed on to all child processes.</span>
</span><span id="S3Task-515"><a href="#S3Task-515"><span class="linenos">515</span></a>        <span class="c1"># This command also doesn not work on windows, so I need to address this</span>
</span><span id="S3Task-516"><a href="#S3Task-516"><span class="linenos">516</span></a>        <span class="c1"># as well.</span>
</span><span id="S3Task-517"><a href="#S3Task-517"><span class="linenos">517</span></a>        <span class="k">if</span> <span class="n">operating_system</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
</span><span id="S3Task-518"><a href="#S3Task-518"><span class="linenos">518</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
</span><span id="S3Task-519"><a href="#S3Task-519"><span class="linenos">519</span></a>        <span class="c1"># note: SIGTERM is the normal signal but I use SIGKILL to try to address</span>
</span><span id="S3Task-520"><a href="#S3Task-520"><span class="linenos">520</span></a>        <span class="c1"># permission errors.</span>
</span><span id="S3Task-521"><a href="#S3Task-521"><span class="linenos">521</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="S3Task-522"><a href="#S3Task-522"><span class="linenos">522</span></a>            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="S3Task-523"><a href="#S3Task-523"><span class="linenos">523</span></a>
</span><span id="S3Task-524"><a href="#S3Task-524"><span class="linenos">524</span></a>        <span class="c1"># As an example of an alternative approach to killing a job, here is</span>
</span><span id="S3Task-525"><a href="#S3Task-525"><span class="linenos">525</span></a>        <span class="c1"># what Custodian (Materials Project) tries when killing a VASP job</span>
</span><span id="S3Task-526"><a href="#S3Task-526"><span class="linenos">526</span></a>        <span class="c1"># submitted through mpirun:</span>
</span><span id="S3Task-527"><a href="#S3Task-527"><span class="linenos">527</span></a>        <span class="c1"># try:</span>
</span><span id="S3Task-528"><a href="#S3Task-528"><span class="linenos">528</span></a>        <span class="c1">#     os.system(&quot;killall vasp&quot;)</span>
</span><span id="S3Task-529"><a href="#S3Task-529"><span class="linenos">529</span></a>        <span class="c1"># except Exception:</span>
</span><span id="S3Task-530"><a href="#S3Task-530"><span class="linenos">530</span></a>        <span class="c1">#     pass</span>
</span><span id="S3Task-531"><a href="#S3Task-531"><span class="linenos">531</span></a>
</span><span id="S3Task-532"><a href="#S3Task-532"><span class="linenos">532</span></a>        <span class="c1"># TODO: make it so terminate scripts can be loaded from the user&#39;s config</span>
</span><span id="S3Task-533"><a href="#S3Task-533"><span class="linenos">533</span></a>        <span class="c1"># directory, which will make it so they don&#39;t have to overwrite all the</span>
</span><span id="S3Task-534"><a href="#S3Task-534"><span class="linenos">534</span></a>        <span class="c1"># classes that inherit from this one.</span>
</span><span id="S3Task-535"><a href="#S3Task-535"><span class="linenos">535</span></a>
</span><span id="S3Task-536"><a href="#S3Task-536"><span class="linenos">536</span></a>    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="S3Task-537"><a href="#S3Task-537"><span class="linenos">537</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-538"><a href="#S3Task-538"><span class="linenos">538</span></a><span class="sd">        This method is called at the end of a job, *after* error detection.</span>
</span><span id="S3Task-539"><a href="#S3Task-539"><span class="linenos">539</span></a><span class="sd">        This allows post-processing, such as cleanup, analysis of results,</span>
</span><span id="S3Task-540"><a href="#S3Task-540"><span class="linenos">540</span></a><span class="sd">        etc. This should return the result of the entire job, such as a</span>
</span><span id="S3Task-541"><a href="#S3Task-541"><span class="linenos">541</span></a><span class="sd">        the final structure or final energy calculated.</span>
</span><span id="S3Task-542"><a href="#S3Task-542"><span class="linenos">542</span></a>
</span><span id="S3Task-543"><a href="#S3Task-543"><span class="linenos">543</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="S3Task-544"><a href="#S3Task-544"><span class="linenos">544</span></a><span class="sd">        is becuase workup() is normally called within the run() method.</span>
</span><span id="S3Task-545"><a href="#S3Task-545"><span class="linenos">545</span></a>
</span><span id="S3Task-546"><a href="#S3Task-546"><span class="linenos">546</span></a><span class="sd">        Some tasks don&#39;t require a workup() method, so by default, this method</span>
</span><span id="S3Task-547"><a href="#S3Task-547"><span class="linenos">547</span></a><span class="sd">        does nothing but &quot;pass&quot;.</span>
</span><span id="S3Task-548"><a href="#S3Task-548"><span class="linenos">548</span></a>
</span><span id="S3Task-549"><a href="#S3Task-549"><span class="linenos">549</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task-550"><a href="#S3Task-550"><span class="linenos">550</span></a>
</span><span id="S3Task-551"><a href="#S3Task-551"><span class="linenos">551</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task-552"><a href="#S3Task-552"><span class="linenos">552</span></a><span class="sd">            The directory to run everything in.</span>
</span><span id="S3Task-553"><a href="#S3Task-553"><span class="linenos">553</span></a>
</span><span id="S3Task-554"><a href="#S3Task-554"><span class="linenos">554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-555"><a href="#S3Task-555"><span class="linenos">555</span></a>        <span class="c1"># Be sure to include directory (or **kwargs) as input argument for</span>
</span><span id="S3Task-556"><a href="#S3Task-556"><span class="linenos">556</span></a>        <span class="c1"># higher-level compatibility with the run method and SupervisedStagedTask</span>
</span><span id="S3Task-557"><a href="#S3Task-557"><span class="linenos">557</span></a>        <span class="c1"># You should never need to call this method directly!</span>
</span><span id="S3Task-558"><a href="#S3Task-558"><span class="linenos">558</span></a>        <span class="k">pass</span>
</span><span id="S3Task-559"><a href="#S3Task-559"><span class="linenos">559</span></a>
</span><span id="S3Task-560"><a href="#S3Task-560"><span class="linenos">560</span></a>    <span class="nd">@defaults_from_attrs</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
</span><span id="S3Task-561"><a href="#S3Task-561"><span class="linenos">561</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="S3Task-562"><a href="#S3Task-562"><span class="linenos">562</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="S3Task-563"><a href="#S3Task-563"><span class="linenos">563</span></a>        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="S3Task-564"><a href="#S3Task-564"><span class="linenos">564</span></a>        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="S3Task-565"><a href="#S3Task-565"><span class="linenos">565</span></a>        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="S3Task-566"><a href="#S3Task-566"><span class="linenos">566</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="S3Task-567"><a href="#S3Task-567"><span class="linenos">567</span></a>    <span class="p">):</span>
</span><span id="S3Task-568"><a href="#S3Task-568"><span class="linenos">568</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-569"><a href="#S3Task-569"><span class="linenos">569</span></a><span class="sd">        Runs the entire staged task (setup, execution, workup), which includes</span>
</span><span id="S3Task-570"><a href="#S3Task-570"><span class="linenos">570</span></a><span class="sd">        supervising during execution.</span>
</span><span id="S3Task-571"><a href="#S3Task-571"><span class="linenos">571</span></a>
</span><span id="S3Task-572"><a href="#S3Task-572"><span class="linenos">572</span></a><span class="sd">        Call this method once you have your task initialized. For each run you</span>
</span><span id="S3Task-573"><a href="#S3Task-573"><span class="linenos">573</span></a><span class="sd">        can provide a new structure, directory, or command. For example,</span>
</span><span id="S3Task-574"><a href="#S3Task-574"><span class="linenos">574</span></a>
</span><span id="S3Task-575"><a href="#S3Task-575"><span class="linenos">575</span></a><span class="sd">        ``` python</span>
</span><span id="S3Task-576"><a href="#S3Task-576"><span class="linenos">576</span></a><span class="sd">        from simmate.calculator.example.tasks import ExampleTask</span>
</span><span id="S3Task-577"><a href="#S3Task-577"><span class="linenos">577</span></a>
</span><span id="S3Task-578"><a href="#S3Task-578"><span class="linenos">578</span></a><span class="sd">        my_task = ExampleTask()</span>
</span><span id="S3Task-579"><a href="#S3Task-579"><span class="linenos">579</span></a><span class="sd">        my_result = my_task.run(structure=my_structure, command=my_command)</span>
</span><span id="S3Task-580"><a href="#S3Task-580"><span class="linenos">580</span></a><span class="sd">        ```</span>
</span><span id="S3Task-581"><a href="#S3Task-581"><span class="linenos">581</span></a>
</span><span id="S3Task-582"><a href="#S3Task-582"><span class="linenos">582</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task-583"><a href="#S3Task-583"><span class="linenos">583</span></a>
</span><span id="S3Task-584"><a href="#S3Task-584"><span class="linenos">584</span></a><span class="sd">        - `structure`:</span>
</span><span id="S3Task-585"><a href="#S3Task-585"><span class="linenos">585</span></a><span class="sd">            The structure to use for the task, if one is required.</span>
</span><span id="S3Task-586"><a href="#S3Task-586"><span class="linenos">586</span></a><span class="sd">        - `command`:</span>
</span><span id="S3Task-587"><a href="#S3Task-587"><span class="linenos">587</span></a><span class="sd">            The command that will be called during execution.</span>
</span><span id="S3Task-588"><a href="#S3Task-588"><span class="linenos">588</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task-589"><a href="#S3Task-589"><span class="linenos">589</span></a><span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
</span><span id="S3Task-590"><a href="#S3Task-590"><span class="linenos">590</span></a><span class="sd">            function simmate.ulitities.get_directory</span>
</span><span id="S3Task-591"><a href="#S3Task-591"><span class="linenos">591</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="S3Task-592"><a href="#S3Task-592"><span class="linenos">592</span></a><span class="sd">            Any extra keywords that should be passed to the setup() method.</span>
</span><span id="S3Task-593"><a href="#S3Task-593"><span class="linenos">593</span></a>
</span><span id="S3Task-594"><a href="#S3Task-594"><span class="linenos">594</span></a><span class="sd">        Returns</span>
</span><span id="S3Task-595"><a href="#S3Task-595"><span class="linenos">595</span></a><span class="sd">        -------</span>
</span><span id="S3Task-596"><a href="#S3Task-596"><span class="linenos">596</span></a><span class="sd">        - a dictionary of the result, corrections, and working directory used</span>
</span><span id="S3Task-597"><a href="#S3Task-597"><span class="linenos">597</span></a><span class="sd">        for this task run</span>
</span><span id="S3Task-598"><a href="#S3Task-598"><span class="linenos">598</span></a>
</span><span id="S3Task-599"><a href="#S3Task-599"><span class="linenos">599</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-600"><a href="#S3Task-600"><span class="linenos">600</span></a>
</span><span id="S3Task-601"><a href="#S3Task-601"><span class="linenos">601</span></a>        <span class="c1"># because the command is something that is frequently changed at the</span>
</span><span id="S3Task-602"><a href="#S3Task-602"><span class="linenos">602</span></a>        <span class="c1"># workflow level, then we want to make it so the user can set it for</span>
</span><span id="S3Task-603"><a href="#S3Task-603"><span class="linenos">603</span></a>        <span class="c1"># each unique task.run() call. Otherwise we grab the default from the</span>
</span><span id="S3Task-604"><a href="#S3Task-604"><span class="linenos">604</span></a>        <span class="c1"># class attribute</span>
</span><span id="S3Task-605"><a href="#S3Task-605"><span class="linenos">605</span></a>
</span><span id="S3Task-606"><a href="#S3Task-606"><span class="linenos">606</span></a>        <span class="c1"># make sure a structure was given if it&#39;s required</span>
</span><span id="S3Task-607"><a href="#S3Task-607"><span class="linenos">607</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_structure</span><span class="p">:</span>
</span><span id="S3Task-608"><a href="#S3Task-608"><span class="linenos">608</span></a>            <span class="k">raise</span> <span class="n">StructureRequiredError</span><span class="p">(</span><span class="s2">&quot;a structure is required as an input&quot;</span><span class="p">)</span>
</span><span id="S3Task-609"><a href="#S3Task-609"><span class="linenos">609</span></a>        <span class="c1"># establish the working directory</span>
</span><span id="S3Task-610"><a href="#S3Task-610"><span class="linenos">610</span></a>        <span class="n">directory</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-611"><a href="#S3Task-611"><span class="linenos">611</span></a>
</span><span id="S3Task-612"><a href="#S3Task-612"><span class="linenos">612</span></a>        <span class="c1"># run the setup stage of the task</span>
</span><span id="S3Task-613"><a href="#S3Task-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="S3Task-614"><a href="#S3Task-614"><span class="linenos">614</span></a>
</span><span id="S3Task-615"><a href="#S3Task-615"><span class="linenos">615</span></a>        <span class="c1"># run the shelltask and error supervision stages. This method returns</span>
</span><span id="S3Task-616"><a href="#S3Task-616"><span class="linenos">616</span></a>        <span class="c1"># a list of any corrections applied during the run.</span>
</span><span id="S3Task-617"><a href="#S3Task-617"><span class="linenos">617</span></a>        <span class="n">corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="S3Task-618"><a href="#S3Task-618"><span class="linenos">618</span></a>
</span><span id="S3Task-619"><a href="#S3Task-619"><span class="linenos">619</span></a>        <span class="c1"># run the workup stage of the task. This is where the data/info is pull</span>
</span><span id="S3Task-620"><a href="#S3Task-620"><span class="linenos">620</span></a>        <span class="c1"># out from the calculation and is thus our &quot;result&quot;.</span>
</span><span id="S3Task-621"><a href="#S3Task-621"><span class="linenos">621</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workup</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-622"><a href="#S3Task-622"><span class="linenos">622</span></a>
</span><span id="S3Task-623"><a href="#S3Task-623"><span class="linenos">623</span></a>        <span class="c1"># if requested, compresses the directory to a zip file and then removes</span>
</span><span id="S3Task-624"><a href="#S3Task-624"><span class="linenos">624</span></a>        <span class="c1"># the directory.</span>
</span><span id="S3Task-625"><a href="#S3Task-625"><span class="linenos">625</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span><span class="p">:</span>
</span><span id="S3Task-626"><a href="#S3Task-626"><span class="linenos">626</span></a>            <span class="n">make_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task-627"><a href="#S3Task-627"><span class="linenos">627</span></a>        <span class="c1"># Return our final information as a dictionary</span>
</span><span id="S3Task-628"><a href="#S3Task-628"><span class="linenos">628</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="S3Task-629"><a href="#S3Task-629"><span class="linenos">629</span></a>            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
</span><span id="S3Task-630"><a href="#S3Task-630"><span class="linenos">630</span></a>            <span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="n">corrections</span><span class="p">,</span>
</span><span id="S3Task-631"><a href="#S3Task-631"><span class="linenos">631</span></a>            <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
</span><span id="S3Task-632"><a href="#S3Task-632"><span class="linenos">632</span></a>            <span class="s2">&quot;prefect_flow_run_id&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">flow_run_id</span>
</span><span id="S3Task-633"><a href="#S3Task-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;flow_run_id&quot;</span><span class="p">)</span>
</span><span id="S3Task-634"><a href="#S3Task-634"><span class="linenos">634</span></a>            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># when not ran within a prefect flow, there won&#39;t be an id</span>
</span><span id="S3Task-635"><a href="#S3Task-635"><span class="linenos">635</span></a>        <span class="p">}</span>
</span><span id="S3Task-636"><a href="#S3Task-636"><span class="linenos">636</span></a>
</span><span id="S3Task-637"><a href="#S3Task-637"><span class="linenos">637</span></a>    <span class="nd">@classmethod</span>
</span><span id="S3Task-638"><a href="#S3Task-638"><span class="linenos">638</span></a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="S3Task-639"><a href="#S3Task-639"><span class="linenos">639</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-640"><a href="#S3Task-640"><span class="linenos">640</span></a><span class="sd">        Grabs the overall settings from the class.</span>
</span><span id="S3Task-641"><a href="#S3Task-641"><span class="linenos">641</span></a>
</span><span id="S3Task-642"><a href="#S3Task-642"><span class="linenos">642</span></a><span class="sd">        By default, this will just grab the class&#39;s __dict__ attribute but this</span>
</span><span id="S3Task-643"><a href="#S3Task-643"><span class="linenos">643</span></a><span class="sd">        can be overwritten to show only relevent information.</span>
</span><span id="S3Task-644"><a href="#S3Task-644"><span class="linenos">644</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-645"><a href="#S3Task-645"><span class="linenos">645</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="S3Task-646"><a href="#S3Task-646"><span class="linenos">646</span></a>
</span><span id="S3Task-647"><a href="#S3Task-647"><span class="linenos">647</span></a>    <span class="nd">@classmethod</span>
</span><span id="S3Task-648"><a href="#S3Task-648"><span class="linenos">648</span></a>    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="S3Task-649"><a href="#S3Task-649"><span class="linenos">649</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task-650"><a href="#S3Task-650"><span class="linenos">650</span></a><span class="sd">        Takes the result of get_config and prints it in a yaml format that is</span>
</span><span id="S3Task-651"><a href="#S3Task-651"><span class="linenos">651</span></a><span class="sd">        easier to read.</span>
</span><span id="S3Task-652"><a href="#S3Task-652"><span class="linenos">652</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task-653"><a href="#S3Task-653"><span class="linenos">653</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
</span><span id="S3Task-654"><a href="#S3Task-654"><span class="linenos">654</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><h2 id="the-supervised-staged-shell-task-aka-s3task">The Supervised-Staged-Shell Task (aka "S3Task")</h2>

<p>This class contains the core functionality to <strong>supervise</strong> a <strong>staged</strong> task
involving some <strong>shell</strong> command.</p>

<p>Let's breakdown what this means...</p>

<p>A <em>shell</em> command is a single call to some external program. For example,
VASP requires that we call the "vasp_std &gt; vasp.out" command in order to run a
calculation. We consider calling external programs a <em>staged</em> task made
up of three steps:</p>

<ul>
<li>setup = writing any input files required for the program</li>
<li>execution = actually calling the command and running our program</li>
<li>workup = loading data from output files back into python</li>
</ul>

<p>And for <em>supervising</em> the task, this means we monitor the program while the
execution stage is running. So once a program is started, Simmate can check
output files for common errors/issues. If an error is found, we stop the
program, fix the issue, and then restart it. Any fixes that were made are
written to "simmate_corrections.csv".</p>

<!--
TODO: Make a simple diagram to visualize the overall process and add it here.
It will be similar to Custodian's, but we don't have a list of jobs here.
https://materialsproject.github.io/custodian/index.html#usage
The steps are...

- Write Input Files based on custom+defualt settings
- Run the calculation by calling the program
- Load ouput files
- check for errors
- [correct them, rerun]
- postprocess/analysis
-->

<p>This entire process (the different stages and monitoring) is carried out
using the <code><a href="#S3Task.run">run()</a></code> method. You rarely use this class directly. Instead,
you typically use a subclass of it. As a user, you really just need to do
something like this:</p>

<div class="pdoc-code codehilite"><pre><span></span><code>   <span class="kn">from</span> <span class="nn">simmate.calculator.example.tasks</span> <span class="kn">import</span> <span class="n">ExampleTask</span>

   <span class="n">my_task</span> <span class="o">=</span> <span class="n">ExampleTask</span><span class="p">()</span>
   <span class="n">my_result</span> <span class="o">=</span> <span class="n">my_task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>And that's it!</p>

<p>For experts, this class can be viewed as a combination of prefect's ShellTask,
a custodian Job, and Custodian monitoring. When subclassing this, we can absorb
functionality of pymatgen.io.vasp.sets too. By merging all of these together
into one class, we make things much easier for users and creating new Tasks.</p>

<h2 id="inheriting-from-this-class">Inheriting from this class</h2>

<p>This class is commonly used to make tasks for our calculator modules, so you
will likely want to subclass this. Here is a basic example of inheriting
and then running a task:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="../workflow_engine.html">simmate.workflow_engine</a></span> <span class="kn">import</span> <span class="n">S3Task</span>
<span class="kn">from</span> <span class="nn">example.error_handlers</span> <span class="kn">import</span> <span class="n">PossibleError1</span><span class="p">,</span> <span class="n">PossibleError2</span>


<span class="k">class</span> <span class="nc">ExampleTask</span><span class="p">(</span><span class="n">SSSTask</span><span class="p">):</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;echo example&quot;</span>  <span class="c1"># just prints out &quot;example&quot;</span>
    <span class="n">max_corrections</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">error_handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">PossibleError1</span><span class="p">,</span> <span class="n">PossibleError2</span><span class="p">]</span>
    <span class="n">polling_timestep</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">monitor_freq</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">some_new_setting</span> <span class="o">=</span> <span class="mi">123</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>  <span class="c1"># &lt;-- MUST have these two args</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m setting things up!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;My new setting is </span><span class="si">{</span><span class="n">some_new_setting</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>  <span class="c1"># &lt;-- MUST have this arg</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m working things up!&quot;</span><span class="p">)</span>


<span class="n">task</span> <span class="o">=</span> <span class="n">ExampleTask</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>There are a couple things to note here:</p>

<ul>
<li>It's optional to set/overwrite attributes. You can also add new ones too.</li>
<li>It's optional to write a new __init__, setup, or workup methods</li>
<li>make sure you include the structure/directory inputs, even if you don't use them.</li>
<li>Don't add new kwargs to methods. Instead handle these options through attributes.</li>
</ul>

<p>For a full (and advanced) example, of a subclass take a look at
<code><a href="../calculators/vasp/tasks/base.html#VaspTask">simmate.calculators.vasp.tasks.base.VaspTask</a></code>.</p>
</div>


                            <div id="S3Task.__init__" class="classattr">
                                        <input id="S3Task.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">S3Task</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>,</span><span class="param">	<span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;simmate_corrections.csv&#39;</span>,</span><span class="param">	<span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span>)</span>

                <label class="view-source-button" for="S3Task.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.__init__-162"><a href="#S3Task.__init__-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="S3Task.__init__-163"><a href="#S3Task.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="S3Task.__init__-164"><a href="#S3Task.__init__-164"><span class="linenos">164</span></a>        <span class="n">max_corrections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="S3Task.__init__-165"><a href="#S3Task.__init__-165"><span class="linenos">165</span></a>        <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="S3Task.__init__-166"><a href="#S3Task.__init__-166"><span class="linenos">166</span></a>        <span class="n">polling_timestep</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="S3Task.__init__-167"><a href="#S3Task.__init__-167"><span class="linenos">167</span></a>        <span class="n">monitor_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="S3Task.__init__-168"><a href="#S3Task.__init__-168"><span class="linenos">168</span></a>        <span class="n">save_corrections_to_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="S3Task.__init__-169"><a href="#S3Task.__init__-169"><span class="linenos">169</span></a>        <span class="n">corrections_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simmate_corrections.csv&quot;</span><span class="p">,</span>
</span><span id="S3Task.__init__-170"><a href="#S3Task.__init__-170"><span class="linenos">170</span></a>        <span class="n">compress_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="S3Task.__init__-171"><a href="#S3Task.__init__-171"><span class="linenos">171</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="S3Task.__init__-172"><a href="#S3Task.__init__-172"><span class="linenos">172</span></a>    <span class="p">):</span>
</span><span id="S3Task.__init__-173"><a href="#S3Task.__init__-173"><span class="linenos">173</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.__init__-174"><a href="#S3Task.__init__-174"><span class="linenos">174</span></a><span class="sd">        Creates a task instance of this class. The parameters passed will be the</span>
</span><span id="S3Task.__init__-175"><a href="#S3Task.__init__-175"><span class="linenos">175</span></a><span class="sd">        same every time you call the task.run() method.</span>
</span><span id="S3Task.__init__-176"><a href="#S3Task.__init__-176"><span class="linenos">176</span></a>
</span><span id="S3Task.__init__-177"><a href="#S3Task.__init__-177"><span class="linenos">177</span></a><span class="sd">        Note, many of the parameters here are for the Monitoring settings. These</span>
</span><span id="S3Task.__init__-178"><a href="#S3Task.__init__-178"><span class="linenos">178</span></a><span class="sd">        are only ever relevent if there are ErrorHandlers added that have</span>
</span><span id="S3Task.__init__-179"><a href="#S3Task.__init__-179"><span class="linenos">179</span></a><span class="sd">        is_monitor=True. These handlers run while the shelltask itself is also</span>
</span><span id="S3Task.__init__-180"><a href="#S3Task.__init__-180"><span class="linenos">180</span></a><span class="sd">        running. Read more about ErrorHandlers for more info.</span>
</span><span id="S3Task.__init__-181"><a href="#S3Task.__init__-181"><span class="linenos">181</span></a>
</span><span id="S3Task.__init__-182"><a href="#S3Task.__init__-182"><span class="linenos">182</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task.__init__-183"><a href="#S3Task.__init__-183"><span class="linenos">183</span></a>
</span><span id="S3Task.__init__-184"><a href="#S3Task.__init__-184"><span class="linenos">184</span></a><span class="sd">        - `max_corrections`:</span>
</span><span id="S3Task.__init__-185"><a href="#S3Task.__init__-185"><span class="linenos">185</span></a><span class="sd">            The maximum number of times we can apply a correction and retry the shell</span>
</span><span id="S3Task.__init__-186"><a href="#S3Task.__init__-186"><span class="linenos">186</span></a><span class="sd">            command. The maximum number of times that corrections will be made (and</span>
</span><span id="S3Task.__init__-187"><a href="#S3Task.__init__-187"><span class="linenos">187</span></a><span class="sd">            shell command reran) before giving up on the calculation. Note, once this</span>
</span><span id="S3Task.__init__-188"><a href="#S3Task.__init__-188"><span class="linenos">188</span></a><span class="sd">            limit is exceeded, the error is stored without correcting or restarting</span>
</span><span id="S3Task.__init__-189"><a href="#S3Task.__init__-189"><span class="linenos">189</span></a><span class="sd">            the run.</span>
</span><span id="S3Task.__init__-190"><a href="#S3Task.__init__-190"><span class="linenos">190</span></a><span class="sd">        - `monitor`:</span>
</span><span id="S3Task.__init__-191"><a href="#S3Task.__init__-191"><span class="linenos">191</span></a><span class="sd">            Whether to run monitor handlers while the command runs. False means</span>
</span><span id="S3Task.__init__-192"><a href="#S3Task.__init__-192"><span class="linenos">192</span></a><span class="sd">            wait until the job has completed.</span>
</span><span id="S3Task.__init__-193"><a href="#S3Task.__init__-193"><span class="linenos">193</span></a><span class="sd">        - `polling_timestep`:</span>
</span><span id="S3Task.__init__-194"><a href="#S3Task.__init__-194"><span class="linenos">194</span></a><span class="sd">            If we are monitoring the job for errors while it runs, this is how often</span>
</span><span id="S3Task.__init__-195"><a href="#S3Task.__init__-195"><span class="linenos">195</span></a><span class="sd">            (in seconds) we should check the status of our job. Note this check is</span>
</span><span id="S3Task.__init__-196"><a href="#S3Task.__init__-196"><span class="linenos">196</span></a><span class="sd">            just whether the job is done or not. This is NOT how often we check for</span>
</span><span id="S3Task.__init__-197"><a href="#S3Task.__init__-197"><span class="linenos">197</span></a><span class="sd">            errors. See monitor_freq for that.</span>
</span><span id="S3Task.__init__-198"><a href="#S3Task.__init__-198"><span class="linenos">198</span></a><span class="sd">        - `monitor_freq`:</span>
</span><span id="S3Task.__init__-199"><a href="#S3Task.__init__-199"><span class="linenos">199</span></a><span class="sd">            The frequency we should run check for errors with our monitors. This is</span>
</span><span id="S3Task.__init__-200"><a href="#S3Task.__init__-200"><span class="linenos">200</span></a><span class="sd">            based on the polling_timestep loops. For example, if we have a</span>
</span><span id="S3Task.__init__-201"><a href="#S3Task.__init__-201"><span class="linenos">201</span></a><span class="sd">            polling_timestep of 10 seconds and a monitor_freq of 2, then we would run</span>
</span><span id="S3Task.__init__-202"><a href="#S3Task.__init__-202"><span class="linenos">202</span></a><span class="sd">            the monitor checks every other loop -- or every 2x10 = 20 seconds. The</span>
</span><span id="S3Task.__init__-203"><a href="#S3Task.__init__-203"><span class="linenos">203</span></a><span class="sd">            default values of polling_timestep=10 and monitor_freq=30 indicate that</span>
</span><span id="S3Task.__init__-204"><a href="#S3Task.__init__-204"><span class="linenos">204</span></a><span class="sd">            we run monitoring functions every 5 minutes (10x30=300s=5min).</span>
</span><span id="S3Task.__init__-205"><a href="#S3Task.__init__-205"><span class="linenos">205</span></a><span class="sd">        - `save_corrections_to_file`:</span>
</span><span id="S3Task.__init__-206"><a href="#S3Task.__init__-206"><span class="linenos">206</span></a><span class="sd">            Whether to write a log file of the corrections made. The default is True.</span>
</span><span id="S3Task.__init__-207"><a href="#S3Task.__init__-207"><span class="linenos">207</span></a><span class="sd">        - `corrections_filename`:</span>
</span><span id="S3Task.__init__-208"><a href="#S3Task.__init__-208"><span class="linenos">208</span></a><span class="sd">            If save_corrections_to_file is True, this is the filename of where</span>
</span><span id="S3Task.__init__-209"><a href="#S3Task.__init__-209"><span class="linenos">209</span></a><span class="sd">            to write the corrections. The default is &quot;simmate_corrections.csv&quot;.</span>
</span><span id="S3Task.__init__-210"><a href="#S3Task.__init__-210"><span class="linenos">210</span></a><span class="sd">        - `compress_output`:</span>
</span><span id="S3Task.__init__-211"><a href="#S3Task.__init__-211"><span class="linenos">211</span></a><span class="sd">            Whether to compress the directory to a zip file at the end of the</span>
</span><span id="S3Task.__init__-212"><a href="#S3Task.__init__-212"><span class="linenos">212</span></a><span class="sd">            task run. After compression, it will also delete the directory.</span>
</span><span id="S3Task.__init__-213"><a href="#S3Task.__init__-213"><span class="linenos">213</span></a><span class="sd">            The default is False.</span>
</span><span id="S3Task.__init__-214"><a href="#S3Task.__init__-214"><span class="linenos">214</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="S3Task.__init__-215"><a href="#S3Task.__init__-215"><span class="linenos">215</span></a><span class="sd">            All extra arguments supported by</span>
</span><span id="S3Task.__init__-216"><a href="#S3Task.__init__-216"><span class="linenos">216</span></a><span class="sd">            [prefect.core.task.Task](https://docs.prefect.io/api/latest/core/task.html).</span>
</span><span id="S3Task.__init__-217"><a href="#S3Task.__init__-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.__init__-218"><a href="#S3Task.__init__-218"><span class="linenos">218</span></a>
</span><span id="S3Task.__init__-219"><a href="#S3Task.__init__-219"><span class="linenos">219</span></a>        <span class="c1"># Save the provided settings</span>
</span><span id="S3Task.__init__-220"><a href="#S3Task.__init__-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
</span><span id="S3Task.__init__-221"><a href="#S3Task.__init__-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span> <span class="o">=</span> <span class="n">max_corrections</span>
</span><span id="S3Task.__init__-222"><a href="#S3Task.__init__-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span> <span class="o">=</span> <span class="n">polling_timestep</span>
</span><span id="S3Task.__init__-223"><a href="#S3Task.__init__-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">=</span> <span class="n">monitor_freq</span>
</span><span id="S3Task.__init__-224"><a href="#S3Task.__init__-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span> <span class="o">=</span> <span class="n">compress_output</span>
</span><span id="S3Task.__init__-225"><a href="#S3Task.__init__-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="o">=</span> <span class="n">save_corrections_to_file</span>
</span><span id="S3Task.__init__-226"><a href="#S3Task.__init__-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span> <span class="o">=</span> <span class="n">corrections_filename</span>
</span><span id="S3Task.__init__-227"><a href="#S3Task.__init__-227"><span class="linenos">227</span></a>
</span><span id="S3Task.__init__-228"><a href="#S3Task.__init__-228"><span class="linenos">228</span></a>        <span class="c1"># now inherit the parent Prefect Task class</span>
</span><span id="S3Task.__init__-229"><a href="#S3Task.__init__-229"><span class="linenos">229</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates a task instance of this class. The parameters passed will be the
same every time you call the task.run() method.</p>

<p>Note, many of the parameters here are for the Monitoring settings. These
are only ever relevent if there are ErrorHandlers added that have
is_monitor=True. These handlers run while the shelltask itself is also
running. Read more about ErrorHandlers for more info.</p>

<h4 id="parameters">Parameters</h4>

<ul>
<li><code>max_corrections</code>:
The maximum number of times we can apply a correction and retry the shell
command. The maximum number of times that corrections will be made (and
shell command reran) before giving up on the calculation. Note, once this
limit is exceeded, the error is stored without correcting or restarting
the run.</li>
<li><code>monitor</code>:
Whether to run monitor handlers while the command runs. False means
wait until the job has completed.</li>
<li><code>polling_timestep</code>:
If we are monitoring the job for errors while it runs, this is how often
(in seconds) we should check the status of our job. Note this check is
just whether the job is done or not. This is NOT how often we check for
errors. See monitor_freq for that.</li>
<li><code>monitor_freq</code>:
The frequency we should run check for errors with our monitors. This is
based on the polling_timestep loops. For example, if we have a
polling_timestep of 10 seconds and a monitor_freq of 2, then we would run
the monitor checks every other loop -- or every 2x10 = 20 seconds. The
default values of polling_timestep=10 and monitor_freq=30 indicate that
we run monitoring functions every 5 minutes (10x30=300s=5min).</li>
<li><code>save_corrections_to_file</code>:
Whether to write a log file of the corrections made. The default is True.</li>
<li><code>corrections_filename</code>:
If save_corrections_to_file is True, this is the filename of where
to write the corrections. The default is "simmate_corrections.csv".</li>
<li><code>compress_output</code>:
Whether to compress the directory to a zip file at the end of the
task run. After compression, it will also delete the directory.
The default is False.</li>
<li><code>**kwargs</code>:
All extra arguments supported by
<a href="https://docs.prefect.io/api/latest/core/task.html">prefect.core.task.Task</a>.</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.command" class="classattr">
                                <div class="attr variable">
            <span class="name">command</span><span class="annotation">: str</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#S3Task.command"></a>
    
            <div class="docstring"><p>The defualt shell command to use.</p>
</div>


                            </div>
                            <div id="S3Task.requires_structure" class="classattr">
                                <div class="attr variable">
            <span class="name">requires_structure</span><span class="annotation">: bool</span><span class="default_value"> = False</span>

        
    </div>
    <a class="headerlink" href="#S3Task.requires_structure"></a>
    
            <div class="docstring"><p>Indicates whether a structure is needed if for the run() method.</p>
</div>


                            </div>
                            <div id="S3Task.error_handlers" class="classattr">
                                <div class="attr variable">
            <span class="name">error_handlers</span><span class="annotation">: List[<a href="error_handler.html#ErrorHandler">simmate.workflow_engine.error_handler.ErrorHandler</a>]</span><span class="default_value"> = []</span>

        
    </div>
    <a class="headerlink" href="#S3Task.error_handlers"></a>
    
            <div class="docstring"><p>A list of ErrorHandler objects to use in order of priority (that is, highest
priority is first). If one handler is triggered, the correction will be 
applied and none of the following handlers will be checked.</p>
</div>


                            </div>
                            <div id="S3Task.setup" class="classattr">
                                        <input id="S3Task.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">structure</span><span class="p">:</span> <span class="n"><a href="../toolkit/base_data_types/structure.html#Structure">simmate.toolkit.base_data_types.structure.Structure</a></span>,</span><span class="param">	<span class="n">directory</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="S3Task.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.setup-231"><a href="#S3Task.setup-231"><span class="linenos">231</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="S3Task.setup-232"><a href="#S3Task.setup-232"><span class="linenos">232</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.setup-233"><a href="#S3Task.setup-233"><span class="linenos">233</span></a><span class="sd">        This abstract method is ran before the command is actually executed. This</span>
</span><span id="S3Task.setup-234"><a href="#S3Task.setup-234"><span class="linenos">234</span></a><span class="sd">        allows for some pre-processing, such as writing input files or any other</span>
</span><span id="S3Task.setup-235"><a href="#S3Task.setup-235"><span class="linenos">235</span></a><span class="sd">        analysis.</span>
</span><span id="S3Task.setup-236"><a href="#S3Task.setup-236"><span class="linenos">236</span></a>
</span><span id="S3Task.setup-237"><a href="#S3Task.setup-237"><span class="linenos">237</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="S3Task.setup-238"><a href="#S3Task.setup-238"><span class="linenos">238</span></a><span class="sd">        is becuase setup() is normally called within the run() method.</span>
</span><span id="S3Task.setup-239"><a href="#S3Task.setup-239"><span class="linenos">239</span></a>
</span><span id="S3Task.setup-240"><a href="#S3Task.setup-240"><span class="linenos">240</span></a><span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
</span><span id="S3Task.setup-241"><a href="#S3Task.setup-241"><span class="linenos">241</span></a><span class="sd">        doesn&#39;t nothing but &quot;pass&quot;.</span>
</span><span id="S3Task.setup-242"><a href="#S3Task.setup-242"><span class="linenos">242</span></a>
</span><span id="S3Task.setup-243"><a href="#S3Task.setup-243"><span class="linenos">243</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task.setup-244"><a href="#S3Task.setup-244"><span class="linenos">244</span></a>
</span><span id="S3Task.setup-245"><a href="#S3Task.setup-245"><span class="linenos">245</span></a><span class="sd">        - `structure`:</span>
</span><span id="S3Task.setup-246"><a href="#S3Task.setup-246"><span class="linenos">246</span></a><span class="sd">            The structure to use for the task, if one is required.</span>
</span><span id="S3Task.setup-247"><a href="#S3Task.setup-247"><span class="linenos">247</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task.setup-248"><a href="#S3Task.setup-248"><span class="linenos">248</span></a><span class="sd">            The directory to run everything in. Must exist already.</span>
</span><span id="S3Task.setup-249"><a href="#S3Task.setup-249"><span class="linenos">249</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="S3Task.setup-250"><a href="#S3Task.setup-250"><span class="linenos">250</span></a><span class="sd">            Extra kwargs that may be passed to some function within. Because</span>
</span><span id="S3Task.setup-251"><a href="#S3Task.setup-251"><span class="linenos">251</span></a><span class="sd">            Simmate prefers fixed settings for their workflows, this is typically</span>
</span><span id="S3Task.setup-252"><a href="#S3Task.setup-252"><span class="linenos">252</span></a><span class="sd">            not used, but instead, keywords should be explicitly defined when</span>
</span><span id="S3Task.setup-253"><a href="#S3Task.setup-253"><span class="linenos">253</span></a><span class="sd">            writing a setup method.</span>
</span><span id="S3Task.setup-254"><a href="#S3Task.setup-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.setup-255"><a href="#S3Task.setup-255"><span class="linenos">255</span></a>        <span class="c1"># Be sure to include directory and structure (or **kwargs) as input</span>
</span><span id="S3Task.setup-256"><a href="#S3Task.setup-256"><span class="linenos">256</span></a>        <span class="c1"># arguments for higher-level compatibility with the run method.</span>
</span><span id="S3Task.setup-257"><a href="#S3Task.setup-257"><span class="linenos">257</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>This abstract method is ran before the command is actually executed. This
allows for some pre-processing, such as writing input files or any other
analysis.</p>

<p>You should never call this method directly unless you are debugging. This
is becuase setup() is normally called within the run() method.</p>

<p>Some tasks don't require a setup() method, so by default, this method
doesn't nothing but "pass".</p>

<h4 id="parameters">Parameters</h4>

<ul>
<li><code>structure</code>:
The structure to use for the task, if one is required.</li>
<li><code>directory</code>:
The directory to run everything in. Must exist already.</li>
<li><code>**kwargs</code>:
Extra kwargs that may be passed to some function within. Because
Simmate prefers fixed settings for their workflows, this is typically
not used, but instead, keywords should be explicitly defined when
writing a setup method.</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.execute" class="classattr">
                                        <input id="S3Task.execute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">execute</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">command</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="S3Task.execute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.execute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.execute-259"><a href="#S3Task.execute-259"><span class="linenos">259</span></a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="S3Task.execute-260"><a href="#S3Task.execute-260"><span class="linenos">260</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.execute-261"><a href="#S3Task.execute-261"><span class="linenos">261</span></a><span class="sd">        This calls the command within the target directory and handles all error</span>
</span><span id="S3Task.execute-262"><a href="#S3Task.execute-262"><span class="linenos">262</span></a><span class="sd">        handling as well as monitoring of the job.</span>
</span><span id="S3Task.execute-263"><a href="#S3Task.execute-263"><span class="linenos">263</span></a>
</span><span id="S3Task.execute-264"><a href="#S3Task.execute-264"><span class="linenos">264</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="S3Task.execute-265"><a href="#S3Task.execute-265"><span class="linenos">265</span></a><span class="sd">        is becuase `execute` is normally called within the `run` method.</span>
</span><span id="S3Task.execute-266"><a href="#S3Task.execute-266"><span class="linenos">266</span></a>
</span><span id="S3Task.execute-267"><a href="#S3Task.execute-267"><span class="linenos">267</span></a><span class="sd">        Some tasks don&#39;t require a setup() method, so by default, this method</span>
</span><span id="S3Task.execute-268"><a href="#S3Task.execute-268"><span class="linenos">268</span></a><span class="sd">        does nothing but &quot;pass&quot;.</span>
</span><span id="S3Task.execute-269"><a href="#S3Task.execute-269"><span class="linenos">269</span></a>
</span><span id="S3Task.execute-270"><a href="#S3Task.execute-270"><span class="linenos">270</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task.execute-271"><a href="#S3Task.execute-271"><span class="linenos">271</span></a>
</span><span id="S3Task.execute-272"><a href="#S3Task.execute-272"><span class="linenos">272</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task.execute-273"><a href="#S3Task.execute-273"><span class="linenos">273</span></a><span class="sd">            The directory to run everything in.</span>
</span><span id="S3Task.execute-274"><a href="#S3Task.execute-274"><span class="linenos">274</span></a><span class="sd">        - `command`:</span>
</span><span id="S3Task.execute-275"><a href="#S3Task.execute-275"><span class="linenos">275</span></a><span class="sd">            The command that will be called during execution.</span>
</span><span id="S3Task.execute-276"><a href="#S3Task.execute-276"><span class="linenos">276</span></a>
</span><span id="S3Task.execute-277"><a href="#S3Task.execute-277"><span class="linenos">277</span></a><span class="sd">        #### Returns</span>
</span><span id="S3Task.execute-278"><a href="#S3Task.execute-278"><span class="linenos">278</span></a>
</span><span id="S3Task.execute-279"><a href="#S3Task.execute-279"><span class="linenos">279</span></a><span class="sd">        - `corrections`</span>
</span><span id="S3Task.execute-280"><a href="#S3Task.execute-280"><span class="linenos">280</span></a><span class="sd">            A list of tuples where each entry is a error identified and the</span>
</span><span id="S3Task.execute-281"><a href="#S3Task.execute-281"><span class="linenos">281</span></a><span class="sd">            correction applied. Ex: [(&quot;ExampleError&quot;, &quot;ExampleCorrection&quot;)]</span>
</span><span id="S3Task.execute-282"><a href="#S3Task.execute-282"><span class="linenos">282</span></a>
</span><span id="S3Task.execute-283"><a href="#S3Task.execute-283"><span class="linenos">283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.execute-284"><a href="#S3Task.execute-284"><span class="linenos">284</span></a>
</span><span id="S3Task.execute-285"><a href="#S3Task.execute-285"><span class="linenos">285</span></a>        <span class="c1"># some error_handlers run while the shelltask is running. These are known as</span>
</span><span id="S3Task.execute-286"><a href="#S3Task.execute-286"><span class="linenos">286</span></a>        <span class="c1"># Monitors and are labled via the is_monitor attribute. It&#39;s good for us</span>
</span><span id="S3Task.execute-287"><a href="#S3Task.execute-287"><span class="linenos">287</span></a>        <span class="c1"># to separate these out from other error_handlers.</span>
</span><span id="S3Task.execute-288"><a href="#S3Task.execute-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="S3Task.execute-289"><a href="#S3Task.execute-289"><span class="linenos">289</span></a>            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_monitor</span>
</span><span id="S3Task.execute-290"><a href="#S3Task.execute-290"><span class="linenos">290</span></a>        <span class="p">]</span>
</span><span id="S3Task.execute-291"><a href="#S3Task.execute-291"><span class="linenos">291</span></a>
</span><span id="S3Task.execute-292"><a href="#S3Task.execute-292"><span class="linenos">292</span></a>        <span class="c1"># We start with zero corrections that we slowly add to. This can be</span>
</span><span id="S3Task.execute-293"><a href="#S3Task.execute-293"><span class="linenos">293</span></a>        <span class="c1"># thought of as a table with headers of...</span>
</span><span id="S3Task.execute-294"><a href="#S3Task.execute-294"><span class="linenos">294</span></a>        <span class="c1">#   (&quot;applied_errorhandler&quot;, &quot;correction_applied&quot;)</span>
</span><span id="S3Task.execute-295"><a href="#S3Task.execute-295"><span class="linenos">295</span></a>        <span class="c1"># NOTE: I took out the table headers and may add them back in</span>
</span><span id="S3Task.execute-296"><a href="#S3Task.execute-296"><span class="linenos">296</span></a>        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="S3Task.execute-297"><a href="#S3Task.execute-297"><span class="linenos">297</span></a>
</span><span id="S3Task.execute-298"><a href="#S3Task.execute-298"><span class="linenos">298</span></a>        <span class="c1"># ------ start of main while loop ------</span>
</span><span id="S3Task.execute-299"><a href="#S3Task.execute-299"><span class="linenos">299</span></a>
</span><span id="S3Task.execute-300"><a href="#S3Task.execute-300"><span class="linenos">300</span></a>        <span class="c1"># we can try running the shelltask up to max_corrections. Because only one</span>
</span><span id="S3Task.execute-301"><a href="#S3Task.execute-301"><span class="linenos">301</span></a>        <span class="c1"># correction is applied per attempt, you can view this as the maximum</span>
</span><span id="S3Task.execute-302"><a href="#S3Task.execute-302"><span class="linenos">302</span></a>        <span class="c1"># number of attempts made on the calculation.</span>
</span><span id="S3Task.execute-303"><a href="#S3Task.execute-303"><span class="linenos">303</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
</span><span id="S3Task.execute-304"><a href="#S3Task.execute-304"><span class="linenos">304</span></a>
</span><span id="S3Task.execute-305"><a href="#S3Task.execute-305"><span class="linenos">305</span></a>            <span class="c1"># launch the shelltask without waiting for it to complete. Also,</span>
</span><span id="S3Task.execute-306"><a href="#S3Task.execute-306"><span class="linenos">306</span></a>            <span class="c1"># make sure to use common shell commands and to set the working</span>
</span><span id="S3Task.execute-307"><a href="#S3Task.execute-307"><span class="linenos">307</span></a>            <span class="c1"># directory.</span>
</span><span id="S3Task.execute-308"><a href="#S3Task.execute-308"><span class="linenos">308</span></a>            <span class="c1">#</span>
</span><span id="S3Task.execute-309"><a href="#S3Task.execute-309"><span class="linenos">309</span></a>            <span class="c1"># Stderr keyword indicates that we should capture the error if one</span>
</span><span id="S3Task.execute-310"><a href="#S3Task.execute-310"><span class="linenos">310</span></a>            <span class="c1"># occurs so that we can report it to the user.</span>
</span><span id="S3Task.execute-311"><a href="#S3Task.execute-311"><span class="linenos">311</span></a>            <span class="c1">#</span>
</span><span id="S3Task.execute-312"><a href="#S3Task.execute-312"><span class="linenos">312</span></a>            <span class="c1"># The preexec_fn keyword allows us to properly terminate jobs that</span>
</span><span id="S3Task.execute-313"><a href="#S3Task.execute-313"><span class="linenos">313</span></a>            <span class="c1"># are launched with parallel processes (such as mpirun). This assigns</span>
</span><span id="S3Task.execute-314"><a href="#S3Task.execute-314"><span class="linenos">314</span></a>            <span class="c1"># a parent id to it that we use when killing a job (if an error</span>
</span><span id="S3Task.execute-315"><a href="#S3Task.execute-315"><span class="linenos">315</span></a>            <span class="c1"># handler calls for us to do so). This isn&#39;t possible on Windows though.</span>
</span><span id="S3Task.execute-316"><a href="#S3Task.execute-316"><span class="linenos">316</span></a>            <span class="c1">#</span>
</span><span id="S3Task.execute-317"><a href="#S3Task.execute-317"><span class="linenos">317</span></a>            <span class="c1"># OPTIMIZE / BUG: preexec_fn adds about 0.02s overhead to the calculation</span>
</span><span id="S3Task.execute-318"><a href="#S3Task.execute-318"><span class="linenos">318</span></a>            <span class="c1"># so we may not want to always use it... Instead we could try to only</span>
</span><span id="S3Task.execute-319"><a href="#S3Task.execute-319"><span class="linenos">319</span></a>            <span class="c1"># use it when the command includes &quot;mpirun&quot;. Though this may introduce</span>
</span><span id="S3Task.execute-320"><a href="#S3Task.execute-320"><span class="linenos">320</span></a>            <span class="c1"># a bug if another is another parallel command used besides mpirun.</span>
</span><span id="S3Task.execute-321"><a href="#S3Task.execute-321"><span class="linenos">321</span></a>            <span class="c1"># An example of this might be deepmd which automatically submits</span>
</span><span id="S3Task.execute-322"><a href="#S3Task.execute-322"><span class="linenos">322</span></a>            <span class="c1"># things in parallel without calling mpirun up-front.</span>
</span><span id="S3Task.execute-323"><a href="#S3Task.execute-323"><span class="linenos">323</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
</span><span id="S3Task.execute-324"><a href="#S3Task.execute-324"><span class="linenos">324</span></a>                <span class="n">command</span><span class="p">,</span>
</span><span id="S3Task.execute-325"><a href="#S3Task.execute-325"><span class="linenos">325</span></a>                <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
</span><span id="S3Task.execute-326"><a href="#S3Task.execute-326"><span class="linenos">326</span></a>                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="S3Task.execute-327"><a href="#S3Task.execute-327"><span class="linenos">327</span></a>                <span class="n">preexec_fn</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span>
</span><span id="S3Task.execute-328"><a href="#S3Task.execute-328"><span class="linenos">328</span></a>                <span class="c1"># or &quot;mpirun&quot; not in command  # See bug/optimize comment above</span>
</span><span id="S3Task.execute-329"><a href="#S3Task.execute-329"><span class="linenos">329</span></a>                <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
</span><span id="S3Task.execute-330"><a href="#S3Task.execute-330"><span class="linenos">330</span></a>                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="S3Task.execute-331"><a href="#S3Task.execute-331"><span class="linenos">331</span></a>            <span class="p">)</span>
</span><span id="S3Task.execute-332"><a href="#S3Task.execute-332"><span class="linenos">332</span></a>
</span><span id="S3Task.execute-333"><a href="#S3Task.execute-333"><span class="linenos">333</span></a>            <span class="c1"># Assume the shelltask has no errors until proven otherwise</span>
</span><span id="S3Task.execute-334"><a href="#S3Task.execute-334"><span class="linenos">334</span></a>            <span class="n">has_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="S3Task.execute-335"><a href="#S3Task.execute-335"><span class="linenos">335</span></a>
</span><span id="S3Task.execute-336"><a href="#S3Task.execute-336"><span class="linenos">336</span></a>            <span class="c1"># If monitor=True, then we want to supervise this shelltask as it</span>
</span><span id="S3Task.execute-337"><a href="#S3Task.execute-337"><span class="linenos">337</span></a>            <span class="c1"># runs. If montors=[m1,m2,...], then we have monitors in place to actually</span>
</span><span id="S3Task.execute-338"><a href="#S3Task.execute-338"><span class="linenos">338</span></a>            <span class="c1"># perform the monitoring. If both of these cases are true, then we</span>
</span><span id="S3Task.execute-339"><a href="#S3Task.execute-339"><span class="linenos">339</span></a>            <span class="c1"># want to go through the error_handlers to check for errors until</span>
</span><span id="S3Task.execute-340"><a href="#S3Task.execute-340"><span class="linenos">340</span></a>            <span class="c1"># the shelltask completes.</span>
</span><span id="S3Task.execute-341"><a href="#S3Task.execute-341"><span class="linenos">341</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
</span><span id="S3Task.execute-342"><a href="#S3Task.execute-342"><span class="linenos">342</span></a>
</span><span id="S3Task.execute-343"><a href="#S3Task.execute-343"><span class="linenos">343</span></a>                <span class="c1"># ------ start of monitor while loop ------</span>
</span><span id="S3Task.execute-344"><a href="#S3Task.execute-344"><span class="linenos">344</span></a>
</span><span id="S3Task.execute-345"><a href="#S3Task.execute-345"><span class="linenos">345</span></a>                <span class="c1"># We want to loop until we find an error and keep track of</span>
</span><span id="S3Task.execute-346"><a href="#S3Task.execute-346"><span class="linenos">346</span></a>                <span class="c1"># which loops to run the monitor function on because we don&#39;t</span>
</span><span id="S3Task.execute-347"><a href="#S3Task.execute-347"><span class="linenos">347</span></a>                <span class="c1"># want them to run nonstop. This variable allows us to monitor</span>
</span><span id="S3Task.execute-348"><a href="#S3Task.execute-348"><span class="linenos">348</span></a>                <span class="c1"># checks every Nth loop, while we check the shelltask status</span>
</span><span id="S3Task.execute-349"><a href="#S3Task.execute-349"><span class="linenos">349</span></a>                <span class="c1"># on all other loops.</span>
</span><span id="S3Task.execute-350"><a href="#S3Task.execute-350"><span class="linenos">350</span></a>                <span class="n">monitor_freq_n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="S3Task.execute-351"><a href="#S3Task.execute-351"><span class="linenos">351</span></a>                <span class="k">while</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="S3Task.execute-352"><a href="#S3Task.execute-352"><span class="linenos">352</span></a>                    <span class="n">monitor_freq_n</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="S3Task.execute-353"><a href="#S3Task.execute-353"><span class="linenos">353</span></a>                    <span class="c1"># Sleep the set amount before checking the shelltask status</span>
</span><span id="S3Task.execute-354"><a href="#S3Task.execute-354"><span class="linenos">354</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_timestep</span><span class="p">)</span>
</span><span id="S3Task.execute-355"><a href="#S3Task.execute-355"><span class="linenos">355</span></a>
</span><span id="S3Task.execute-356"><a href="#S3Task.execute-356"><span class="linenos">356</span></a>                    <span class="c1"># check if the shelltasks is complete. poll will return 0</span>
</span><span id="S3Task.execute-357"><a href="#S3Task.execute-357"><span class="linenos">357</span></a>                    <span class="c1"># when it&#39;s done, in which case we break the loop</span>
</span><span id="S3Task.execute-358"><a href="#S3Task.execute-358"><span class="linenos">358</span></a>                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="S3Task.execute-359"><a href="#S3Task.execute-359"><span class="linenos">359</span></a>                        <span class="k">break</span>
</span><span id="S3Task.execute-360"><a href="#S3Task.execute-360"><span class="linenos">360</span></a>                    <span class="c1"># check whether we should run monitors on this poll loop</span>
</span><span id="S3Task.execute-361"><a href="#S3Task.execute-361"><span class="linenos">361</span></a>                    <span class="k">if</span> <span class="n">monitor_freq_n</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="S3Task.execute-362"><a href="#S3Task.execute-362"><span class="linenos">362</span></a>                        <span class="c1"># iterate through each monitor</span>
</span><span id="S3Task.execute-363"><a href="#S3Task.execute-363"><span class="linenos">363</span></a>                        <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
</span><span id="S3Task.execute-364"><a href="#S3Task.execute-364"><span class="linenos">364</span></a>                            <span class="c1"># check if there&#39;s an error with this error_handler</span>
</span><span id="S3Task.execute-365"><a href="#S3Task.execute-365"><span class="linenos">365</span></a>                            <span class="c1"># and grab the error if so</span>
</span><span id="S3Task.execute-366"><a href="#S3Task.execute-366"><span class="linenos">366</span></a>                            <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.execute-367"><a href="#S3Task.execute-367"><span class="linenos">367</span></a>                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span><span id="S3Task.execute-368"><a href="#S3Task.execute-368"><span class="linenos">368</span></a>                                <span class="c1"># determine if it is_terminating</span>
</span><span id="S3Task.execute-369"><a href="#S3Task.execute-369"><span class="linenos">369</span></a>                                <span class="k">if</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">is_terminating</span><span class="p">:</span>
</span><span id="S3Task.execute-370"><a href="#S3Task.execute-370"><span class="linenos">370</span></a>                                    <span class="c1"># If so, we kill the process but don&#39;t apply</span>
</span><span id="S3Task.execute-371"><a href="#S3Task.execute-371"><span class="linenos">371</span></a>                                    <span class="c1"># the fix quite yet. That step is done below.</span>
</span><span id="S3Task.execute-372"><a href="#S3Task.execute-372"><span class="linenos">372</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_job</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="S3Task.execute-373"><a href="#S3Task.execute-373"><span class="linenos">373</span></a>                                <span class="c1"># Otherwise apply the fix and let the shelltask end</span>
</span><span id="S3Task.execute-374"><a href="#S3Task.execute-374"><span class="linenos">374</span></a>                                <span class="c1"># naturally. An example of this is for codes</span>
</span><span id="S3Task.execute-375"><a href="#S3Task.execute-375"><span class="linenos">375</span></a>                                <span class="c1"># where you add a STOP file to get it to</span>
</span><span id="S3Task.execute-376"><a href="#S3Task.execute-376"><span class="linenos">376</span></a>                                <span class="c1"># finish rather than just killing the process.</span>
</span><span id="S3Task.execute-377"><a href="#S3Task.execute-377"><span class="linenos">377</span></a>                                <span class="c1"># This is the special case error_handler that I talk</span>
</span><span id="S3Task.execute-378"><a href="#S3Task.execute-378"><span class="linenos">378</span></a>                                <span class="c1"># about in my notes, where we really want to</span>
</span><span id="S3Task.execute-379"><a href="#S3Task.execute-379"><span class="linenos">379</span></a>                                <span class="c1"># end the shelltask right away.</span>
</span><span id="S3Task.execute-380"><a href="#S3Task.execute-380"><span class="linenos">380</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="S3Task.execute-381"><a href="#S3Task.execute-381"><span class="linenos">381</span></a>                                    <span class="c1"># make a copy of the directory contents and</span>
</span><span id="S3Task.execute-382"><a href="#S3Task.execute-382"><span class="linenos">382</span></a>                                    <span class="c1"># store as an archive within the same directory</span>
</span><span id="S3Task.execute-383"><a href="#S3Task.execute-383"><span class="linenos">383</span></a>                                    <span class="n">make_error_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.execute-384"><a href="#S3Task.execute-384"><span class="linenos">384</span></a>                                    <span class="c1"># apply the fix now</span>
</span><span id="S3Task.execute-385"><a href="#S3Task.execute-385"><span class="linenos">385</span></a>                                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.execute-386"><a href="#S3Task.execute-386"><span class="linenos">386</span></a>                                    <span class="c1"># record what&#39;s been changed</span>
</span><span id="S3Task.execute-387"><a href="#S3Task.execute-387"><span class="linenos">387</span></a>                                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
</span><span id="S3Task.execute-388"><a href="#S3Task.execute-388"><span class="linenos">388</span></a>                                <span class="c1"># there&#39;s no need to look at the other monitors</span>
</span><span id="S3Task.execute-389"><a href="#S3Task.execute-389"><span class="linenos">389</span></a>                                <span class="c1"># so break from the for-loop. We also don&#39;t</span>
</span><span id="S3Task.execute-390"><a href="#S3Task.execute-390"><span class="linenos">390</span></a>                                <span class="c1"># need to monitor the stagedtask anymore since we just</span>
</span><span id="S3Task.execute-391"><a href="#S3Task.execute-391"><span class="linenos">391</span></a>                                <span class="c1"># terminated it or signaled for its graceful</span>
</span><span id="S3Task.execute-392"><a href="#S3Task.execute-392"><span class="linenos">392</span></a>                                <span class="c1"># end. So update the while-loop condition.</span>
</span><span id="S3Task.execute-393"><a href="#S3Task.execute-393"><span class="linenos">393</span></a>                                <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="S3Task.execute-394"><a href="#S3Task.execute-394"><span class="linenos">394</span></a>                                <span class="k">break</span>
</span><span id="S3Task.execute-395"><a href="#S3Task.execute-395"><span class="linenos">395</span></a>                <span class="c1"># ------ end of monitor while loop ------</span>
</span><span id="S3Task.execute-396"><a href="#S3Task.execute-396"><span class="linenos">396</span></a>            <span class="c1"># Now just wait for the process to finish. Note we use communicate</span>
</span><span id="S3Task.execute-397"><a href="#S3Task.execute-397"><span class="linenos">397</span></a>            <span class="c1"># instead of the .wait() method. This is the recommended method</span>
</span><span id="S3Task.execute-398"><a href="#S3Task.execute-398"><span class="linenos">398</span></a>            <span class="c1"># when we have stderr=subprocess.PIPE, which we use above.</span>
</span><span id="S3Task.execute-399"><a href="#S3Task.execute-399"><span class="linenos">399</span></a>            <span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="S3Task.execute-400"><a href="#S3Task.execute-400"><span class="linenos">400</span></a>            <span class="c1"># check if the return code is non-zero and thus failed.</span>
</span><span id="S3Task.execute-401"><a href="#S3Task.execute-401"><span class="linenos">401</span></a>            <span class="c1"># The &#39;not has_error&#39; is because terminate() will give a nonzero</span>
</span><span id="S3Task.execute-402"><a href="#S3Task.execute-402"><span class="linenos">402</span></a>            <span class="c1"># when a monitor is triggered. We don&#39;t want to raise that</span>
</span><span id="S3Task.execute-403"><a href="#S3Task.execute-403"><span class="linenos">403</span></a>            <span class="c1"># exception here but instead let the monitor handle that</span>
</span><span id="S3Task.execute-404"><a href="#S3Task.execute-404"><span class="linenos">404</span></a>            <span class="c1"># error in the code below.</span>
</span><span id="S3Task.execute-405"><a href="#S3Task.execute-405"><span class="linenos">405</span></a>            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="S3Task.execute-406"><a href="#S3Task.execute-406"><span class="linenos">406</span></a>                <span class="c1"># convert the error from bytes to a string</span>
</span><span id="S3Task.execute-407"><a href="#S3Task.execute-407"><span class="linenos">407</span></a>                <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="S3Task.execute-408"><a href="#S3Task.execute-408"><span class="linenos">408</span></a>                <span class="c1"># and report the error to the user</span>
</span><span id="S3Task.execute-409"><a href="#S3Task.execute-409"><span class="linenos">409</span></a>                <span class="k">raise</span> <span class="n">NonZeroExitError</span><span class="p">(</span>
</span><span id="S3Task.execute-410"><a href="#S3Task.execute-410"><span class="linenos">410</span></a>                    <span class="sa">f</span><span class="s2">&quot;The command (</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">) failed. The error output was...</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="S3Task.execute-411"><a href="#S3Task.execute-411"><span class="linenos">411</span></a>                <span class="p">)</span>
</span><span id="S3Task.execute-412"><a href="#S3Task.execute-412"><span class="linenos">412</span></a>            <span class="c1"># Check for errors again, because a non-monitor may be higher</span>
</span><span id="S3Task.execute-413"><a href="#S3Task.execute-413"><span class="linenos">413</span></a>            <span class="c1"># priority than the monitor triggered above (if there was one).</span>
</span><span id="S3Task.execute-414"><a href="#S3Task.execute-414"><span class="linenos">414</span></a>            <span class="c1"># Since the error_handlers are in order of priority, only the first</span>
</span><span id="S3Task.execute-415"><a href="#S3Task.execute-415"><span class="linenos">415</span></a>            <span class="c1"># will actually be applied and then we can retry the calc.</span>
</span><span id="S3Task.execute-416"><a href="#S3Task.execute-416"><span class="linenos">416</span></a>            <span class="k">for</span> <span class="n">error_handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
</span><span id="S3Task.execute-417"><a href="#S3Task.execute-417"><span class="linenos">417</span></a>
</span><span id="S3Task.execute-418"><a href="#S3Task.execute-418"><span class="linenos">418</span></a>                <span class="c1"># NOTE - The following special case is handled above:</span>
</span><span id="S3Task.execute-419"><a href="#S3Task.execute-419"><span class="linenos">419</span></a>                <span class="c1">#   error_handler.is_monitor and not error_handler.is_terminating</span>
</span><span id="S3Task.execute-420"><a href="#S3Task.execute-420"><span class="linenos">420</span></a>                <span class="c1"># BUG: I can see this being a source of bugs in the process so I</span>
</span><span id="S3Task.execute-421"><a href="#S3Task.execute-421"><span class="linenos">421</span></a>                <span class="c1"># need to reconsider subclassing this special case. For now,</span>
</span><span id="S3Task.execute-422"><a href="#S3Task.execute-422"><span class="linenos">422</span></a>                <span class="c1"># users should have this case at the lowest priority.</span>
</span><span id="S3Task.execute-423"><a href="#S3Task.execute-423"><span class="linenos">423</span></a>
</span><span id="S3Task.execute-424"><a href="#S3Task.execute-424"><span class="linenos">424</span></a>                <span class="c1"># check if there&#39;s an error with this error_handler and grab the</span>
</span><span id="S3Task.execute-425"><a href="#S3Task.execute-425"><span class="linenos">425</span></a>                <span class="c1"># error if there is one</span>
</span><span id="S3Task.execute-426"><a href="#S3Task.execute-426"><span class="linenos">426</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.execute-427"><a href="#S3Task.execute-427"><span class="linenos">427</span></a>                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span><span id="S3Task.execute-428"><a href="#S3Task.execute-428"><span class="linenos">428</span></a>                    <span class="c1"># record the error in case it wasn&#39;t done so above</span>
</span><span id="S3Task.execute-429"><a href="#S3Task.execute-429"><span class="linenos">429</span></a>                    <span class="n">has_error</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="S3Task.execute-430"><a href="#S3Task.execute-430"><span class="linenos">430</span></a>                    <span class="c1"># make a copy of the directory contents and</span>
</span><span id="S3Task.execute-431"><a href="#S3Task.execute-431"><span class="linenos">431</span></a>                    <span class="c1"># store as an archive within the same directory</span>
</span><span id="S3Task.execute-432"><a href="#S3Task.execute-432"><span class="linenos">432</span></a>                    <span class="n">make_error_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.execute-433"><a href="#S3Task.execute-433"><span class="linenos">433</span></a>                    <span class="c1"># And apply the proper correction if there is one.</span>
</span><span id="S3Task.execute-434"><a href="#S3Task.execute-434"><span class="linenos">434</span></a>                    <span class="c1"># Some error_handlers will even raise an error here signaling</span>
</span><span id="S3Task.execute-435"><a href="#S3Task.execute-435"><span class="linenos">435</span></a>                    <span class="c1"># that the stagedtask is unrecoverable and a lost cause.</span>
</span><span id="S3Task.execute-436"><a href="#S3Task.execute-436"><span class="linenos">436</span></a>                    <span class="n">correction</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.execute-437"><a href="#S3Task.execute-437"><span class="linenos">437</span></a>                    <span class="c1"># record what&#39;s been changed</span>
</span><span id="S3Task.execute-438"><a href="#S3Task.execute-438"><span class="linenos">438</span></a>                    <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error_handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">correction</span><span class="p">))</span>
</span><span id="S3Task.execute-439"><a href="#S3Task.execute-439"><span class="linenos">439</span></a>                    <span class="c1"># break from the error_handler for-loop as we only apply the</span>
</span><span id="S3Task.execute-440"><a href="#S3Task.execute-440"><span class="linenos">440</span></a>                    <span class="c1"># highest priority fix and nothing else.</span>
</span><span id="S3Task.execute-441"><a href="#S3Task.execute-441"><span class="linenos">441</span></a>                    <span class="k">break</span>
</span><span id="S3Task.execute-442"><a href="#S3Task.execute-442"><span class="linenos">442</span></a>            <span class="c1"># write the log of corrections to file if requested. This is written</span>
</span><span id="S3Task.execute-443"><a href="#S3Task.execute-443"><span class="linenos">443</span></a>            <span class="c1"># as a CSV file format and done every while-loop cycle because it</span>
</span><span id="S3Task.execute-444"><a href="#S3Task.execute-444"><span class="linenos">444</span></a>            <span class="c1"># lets the user monitor the calculation and error handlers applied</span>
</span><span id="S3Task.execute-445"><a href="#S3Task.execute-445"><span class="linenos">445</span></a>            <span class="c1"># as it goes. If no corrections were applied, we skip writing the file.</span>
</span><span id="S3Task.execute-446"><a href="#S3Task.execute-446"><span class="linenos">446</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_corrections_to_file</span> <span class="ow">and</span> <span class="n">corrections</span><span class="p">:</span>
</span><span id="S3Task.execute-447"><a href="#S3Task.execute-447"><span class="linenos">447</span></a>                <span class="c1"># compile the corrections metadata into a dataframe</span>
</span><span id="S3Task.execute-448"><a href="#S3Task.execute-448"><span class="linenos">448</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="S3Task.execute-449"><a href="#S3Task.execute-449"><span class="linenos">449</span></a>                    <span class="n">corrections</span><span class="p">,</span>
</span><span id="S3Task.execute-450"><a href="#S3Task.execute-450"><span class="linenos">450</span></a>                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_applied&quot;</span><span class="p">],</span>
</span><span id="S3Task.execute-451"><a href="#S3Task.execute-451"><span class="linenos">451</span></a>                <span class="p">)</span>
</span><span id="S3Task.execute-452"><a href="#S3Task.execute-452"><span class="linenos">452</span></a>                <span class="c1"># write the dataframe to a csv file</span>
</span><span id="S3Task.execute-453"><a href="#S3Task.execute-453"><span class="linenos">453</span></a>                <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
</span><span id="S3Task.execute-454"><a href="#S3Task.execute-454"><span class="linenos">454</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections_filename</span><span class="p">),</span>
</span><span id="S3Task.execute-455"><a href="#S3Task.execute-455"><span class="linenos">455</span></a>                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="S3Task.execute-456"><a href="#S3Task.execute-456"><span class="linenos">456</span></a>                <span class="p">)</span>
</span><span id="S3Task.execute-457"><a href="#S3Task.execute-457"><span class="linenos">457</span></a>            <span class="c1"># now that we&#39;ve gone through the error_handlers, let&#39;s see if any</span>
</span><span id="S3Task.execute-458"><a href="#S3Task.execute-458"><span class="linenos">458</span></a>            <span class="c1"># non-terminating errors were found (terminating ones would raise</span>
</span><span id="S3Task.execute-459"><a href="#S3Task.execute-459"><span class="linenos">459</span></a>            <span class="c1"># an error above). If there are no errors, we&#39;ve finished the</span>
</span><span id="S3Task.execute-460"><a href="#S3Task.execute-460"><span class="linenos">460</span></a>            <span class="c1"># calculation and can exit the while loop. Otherwise, just leave</span>
</span><span id="S3Task.execute-461"><a href="#S3Task.execute-461"><span class="linenos">461</span></a>            <span class="c1"># everything where it&#39;s at and restart the while-loop with a new</span>
</span><span id="S3Task.execute-462"><a href="#S3Task.execute-462"><span class="linenos">462</span></a>            <span class="c1"># attempt</span>
</span><span id="S3Task.execute-463"><a href="#S3Task.execute-463"><span class="linenos">463</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_error</span><span class="p">:</span>
</span><span id="S3Task.execute-464"><a href="#S3Task.execute-464"><span class="linenos">464</span></a>                <span class="c1"># break the while-loop</span>
</span><span id="S3Task.execute-465"><a href="#S3Task.execute-465"><span class="linenos">465</span></a>                <span class="k">break</span>
</span><span id="S3Task.execute-466"><a href="#S3Task.execute-466"><span class="linenos">466</span></a>        <span class="c1"># ------ end of main while loop ------</span>
</span><span id="S3Task.execute-467"><a href="#S3Task.execute-467"><span class="linenos">467</span></a>
</span><span id="S3Task.execute-468"><a href="#S3Task.execute-468"><span class="linenos">468</span></a>        <span class="c1"># make sure the while loop didn&#39;t exit because of the correction limit</span>
</span><span id="S3Task.execute-469"><a href="#S3Task.execute-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corrections</span><span class="p">:</span>
</span><span id="S3Task.execute-470"><a href="#S3Task.execute-470"><span class="linenos">470</span></a>            <span class="k">raise</span> <span class="n">MaxCorrectionsError</span><span class="p">(</span>
</span><span id="S3Task.execute-471"><a href="#S3Task.execute-471"><span class="linenos">471</span></a>                <span class="s2">&quot;The number of maximum corrections has been exceeded. Note the final &quot;</span>
</span><span id="S3Task.execute-472"><a href="#S3Task.execute-472"><span class="linenos">472</span></a>                <span class="s2">&quot;error and its fix are still listed in the corrections file, but it &quot;</span>
</span><span id="S3Task.execute-473"><a href="#S3Task.execute-473"><span class="linenos">473</span></a>                <span class="s2">&quot;was never used.&quot;</span>
</span><span id="S3Task.execute-474"><a href="#S3Task.execute-474"><span class="linenos">474</span></a>            <span class="p">)</span>
</span><span id="S3Task.execute-475"><a href="#S3Task.execute-475"><span class="linenos">475</span></a>        <span class="c1"># now return the corrections for them to stored/used elsewhere</span>
</span><span id="S3Task.execute-476"><a href="#S3Task.execute-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">corrections</span>
</span></pre></div>


            <div class="docstring"><p>This calls the command within the target directory and handles all error
handling as well as monitoring of the job.</p>

<p>You should never call this method directly unless you are debugging. This
is becuase <code><a href="#S3Task.execute">execute</a></code> is normally called within the <code><a href="#S3Task.run">run</a></code> method.</p>

<p>Some tasks don't require a setup() method, so by default, this method
does nothing but "pass".</p>

<h4 id="parameters">Parameters</h4>

<ul>
<li><code>directory</code>:
The directory to run everything in.</li>
<li><code><a href="#S3Task.command">command</a></code>:
The command that will be called during execution.</li>
</ul>

<h4 id="returns">Returns</h4>

<ul>
<li><code>corrections</code>
A list of tuples where each entry is a error identified and the
correction applied. Ex: [("ExampleError", "ExampleCorrection")]</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.workup" class="classattr">
                                        <input id="S3Task.workup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">workup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="S3Task.workup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.workup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.workup-536"><a href="#S3Task.workup-536"><span class="linenos">536</span></a>    <span class="k">def</span> <span class="nf">workup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="S3Task.workup-537"><a href="#S3Task.workup-537"><span class="linenos">537</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.workup-538"><a href="#S3Task.workup-538"><span class="linenos">538</span></a><span class="sd">        This method is called at the end of a job, *after* error detection.</span>
</span><span id="S3Task.workup-539"><a href="#S3Task.workup-539"><span class="linenos">539</span></a><span class="sd">        This allows post-processing, such as cleanup, analysis of results,</span>
</span><span id="S3Task.workup-540"><a href="#S3Task.workup-540"><span class="linenos">540</span></a><span class="sd">        etc. This should return the result of the entire job, such as a</span>
</span><span id="S3Task.workup-541"><a href="#S3Task.workup-541"><span class="linenos">541</span></a><span class="sd">        the final structure or final energy calculated.</span>
</span><span id="S3Task.workup-542"><a href="#S3Task.workup-542"><span class="linenos">542</span></a>
</span><span id="S3Task.workup-543"><a href="#S3Task.workup-543"><span class="linenos">543</span></a><span class="sd">        You should never call this method directly unless you are debugging. This</span>
</span><span id="S3Task.workup-544"><a href="#S3Task.workup-544"><span class="linenos">544</span></a><span class="sd">        is becuase workup() is normally called within the run() method.</span>
</span><span id="S3Task.workup-545"><a href="#S3Task.workup-545"><span class="linenos">545</span></a>
</span><span id="S3Task.workup-546"><a href="#S3Task.workup-546"><span class="linenos">546</span></a><span class="sd">        Some tasks don&#39;t require a workup() method, so by default, this method</span>
</span><span id="S3Task.workup-547"><a href="#S3Task.workup-547"><span class="linenos">547</span></a><span class="sd">        does nothing but &quot;pass&quot;.</span>
</span><span id="S3Task.workup-548"><a href="#S3Task.workup-548"><span class="linenos">548</span></a>
</span><span id="S3Task.workup-549"><a href="#S3Task.workup-549"><span class="linenos">549</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task.workup-550"><a href="#S3Task.workup-550"><span class="linenos">550</span></a>
</span><span id="S3Task.workup-551"><a href="#S3Task.workup-551"><span class="linenos">551</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task.workup-552"><a href="#S3Task.workup-552"><span class="linenos">552</span></a><span class="sd">            The directory to run everything in.</span>
</span><span id="S3Task.workup-553"><a href="#S3Task.workup-553"><span class="linenos">553</span></a>
</span><span id="S3Task.workup-554"><a href="#S3Task.workup-554"><span class="linenos">554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.workup-555"><a href="#S3Task.workup-555"><span class="linenos">555</span></a>        <span class="c1"># Be sure to include directory (or **kwargs) as input argument for</span>
</span><span id="S3Task.workup-556"><a href="#S3Task.workup-556"><span class="linenos">556</span></a>        <span class="c1"># higher-level compatibility with the run method and SupervisedStagedTask</span>
</span><span id="S3Task.workup-557"><a href="#S3Task.workup-557"><span class="linenos">557</span></a>        <span class="c1"># You should never need to call this method directly!</span>
</span><span id="S3Task.workup-558"><a href="#S3Task.workup-558"><span class="linenos">558</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>This method is called at the end of a job, <em>after</em> error detection.
This allows post-processing, such as cleanup, analysis of results,
etc. This should return the result of the entire job, such as a
the final structure or final energy calculated.</p>

<p>You should never call this method directly unless you are debugging. This
is becuase workup() is normally called within the run() method.</p>

<p>Some tasks don't require a workup() method, so by default, this method
does nothing but "pass".</p>

<h4 id="parameters">Parameters</h4>

<ul>
<li><code>directory</code>:
The directory to run everything in.</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.run" class="classattr">
                                        <input id="S3Task.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@defaults_from_attrs(&#39;command&#39;)</div>

        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">structure</span><span class="p">:</span> <span class="n"><a href="../toolkit/base_data_types/structure.html#Structure">simmate.toolkit.base_data_types.structure.Structure</a></span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="S3Task.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.run-560"><a href="#S3Task.run-560"><span class="linenos">560</span></a>    <span class="nd">@defaults_from_attrs</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
</span><span id="S3Task.run-561"><a href="#S3Task.run-561"><span class="linenos">561</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="S3Task.run-562"><a href="#S3Task.run-562"><span class="linenos">562</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="S3Task.run-563"><a href="#S3Task.run-563"><span class="linenos">563</span></a>        <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="S3Task.run-564"><a href="#S3Task.run-564"><span class="linenos">564</span></a>        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="S3Task.run-565"><a href="#S3Task.run-565"><span class="linenos">565</span></a>        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="S3Task.run-566"><a href="#S3Task.run-566"><span class="linenos">566</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="S3Task.run-567"><a href="#S3Task.run-567"><span class="linenos">567</span></a>    <span class="p">):</span>
</span><span id="S3Task.run-568"><a href="#S3Task.run-568"><span class="linenos">568</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.run-569"><a href="#S3Task.run-569"><span class="linenos">569</span></a><span class="sd">        Runs the entire staged task (setup, execution, workup), which includes</span>
</span><span id="S3Task.run-570"><a href="#S3Task.run-570"><span class="linenos">570</span></a><span class="sd">        supervising during execution.</span>
</span><span id="S3Task.run-571"><a href="#S3Task.run-571"><span class="linenos">571</span></a>
</span><span id="S3Task.run-572"><a href="#S3Task.run-572"><span class="linenos">572</span></a><span class="sd">        Call this method once you have your task initialized. For each run you</span>
</span><span id="S3Task.run-573"><a href="#S3Task.run-573"><span class="linenos">573</span></a><span class="sd">        can provide a new structure, directory, or command. For example,</span>
</span><span id="S3Task.run-574"><a href="#S3Task.run-574"><span class="linenos">574</span></a>
</span><span id="S3Task.run-575"><a href="#S3Task.run-575"><span class="linenos">575</span></a><span class="sd">        ``` python</span>
</span><span id="S3Task.run-576"><a href="#S3Task.run-576"><span class="linenos">576</span></a><span class="sd">        from simmate.calculator.example.tasks import ExampleTask</span>
</span><span id="S3Task.run-577"><a href="#S3Task.run-577"><span class="linenos">577</span></a>
</span><span id="S3Task.run-578"><a href="#S3Task.run-578"><span class="linenos">578</span></a><span class="sd">        my_task = ExampleTask()</span>
</span><span id="S3Task.run-579"><a href="#S3Task.run-579"><span class="linenos">579</span></a><span class="sd">        my_result = my_task.run(structure=my_structure, command=my_command)</span>
</span><span id="S3Task.run-580"><a href="#S3Task.run-580"><span class="linenos">580</span></a><span class="sd">        ```</span>
</span><span id="S3Task.run-581"><a href="#S3Task.run-581"><span class="linenos">581</span></a>
</span><span id="S3Task.run-582"><a href="#S3Task.run-582"><span class="linenos">582</span></a><span class="sd">        #### Parameters</span>
</span><span id="S3Task.run-583"><a href="#S3Task.run-583"><span class="linenos">583</span></a>
</span><span id="S3Task.run-584"><a href="#S3Task.run-584"><span class="linenos">584</span></a><span class="sd">        - `structure`:</span>
</span><span id="S3Task.run-585"><a href="#S3Task.run-585"><span class="linenos">585</span></a><span class="sd">            The structure to use for the task, if one is required.</span>
</span><span id="S3Task.run-586"><a href="#S3Task.run-586"><span class="linenos">586</span></a><span class="sd">        - `command`:</span>
</span><span id="S3Task.run-587"><a href="#S3Task.run-587"><span class="linenos">587</span></a><span class="sd">            The command that will be called during execution.</span>
</span><span id="S3Task.run-588"><a href="#S3Task.run-588"><span class="linenos">588</span></a><span class="sd">        - `directory`:</span>
</span><span id="S3Task.run-589"><a href="#S3Task.run-589"><span class="linenos">589</span></a><span class="sd">            The directory to run everything in. This is passed to the ulitities</span>
</span><span id="S3Task.run-590"><a href="#S3Task.run-590"><span class="linenos">590</span></a><span class="sd">            function simmate.ulitities.get_directory</span>
</span><span id="S3Task.run-591"><a href="#S3Task.run-591"><span class="linenos">591</span></a><span class="sd">        - `**kwargs`:</span>
</span><span id="S3Task.run-592"><a href="#S3Task.run-592"><span class="linenos">592</span></a><span class="sd">            Any extra keywords that should be passed to the setup() method.</span>
</span><span id="S3Task.run-593"><a href="#S3Task.run-593"><span class="linenos">593</span></a>
</span><span id="S3Task.run-594"><a href="#S3Task.run-594"><span class="linenos">594</span></a><span class="sd">        Returns</span>
</span><span id="S3Task.run-595"><a href="#S3Task.run-595"><span class="linenos">595</span></a><span class="sd">        -------</span>
</span><span id="S3Task.run-596"><a href="#S3Task.run-596"><span class="linenos">596</span></a><span class="sd">        - a dictionary of the result, corrections, and working directory used</span>
</span><span id="S3Task.run-597"><a href="#S3Task.run-597"><span class="linenos">597</span></a><span class="sd">        for this task run</span>
</span><span id="S3Task.run-598"><a href="#S3Task.run-598"><span class="linenos">598</span></a>
</span><span id="S3Task.run-599"><a href="#S3Task.run-599"><span class="linenos">599</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.run-600"><a href="#S3Task.run-600"><span class="linenos">600</span></a>
</span><span id="S3Task.run-601"><a href="#S3Task.run-601"><span class="linenos">601</span></a>        <span class="c1"># because the command is something that is frequently changed at the</span>
</span><span id="S3Task.run-602"><a href="#S3Task.run-602"><span class="linenos">602</span></a>        <span class="c1"># workflow level, then we want to make it so the user can set it for</span>
</span><span id="S3Task.run-603"><a href="#S3Task.run-603"><span class="linenos">603</span></a>        <span class="c1"># each unique task.run() call. Otherwise we grab the default from the</span>
</span><span id="S3Task.run-604"><a href="#S3Task.run-604"><span class="linenos">604</span></a>        <span class="c1"># class attribute</span>
</span><span id="S3Task.run-605"><a href="#S3Task.run-605"><span class="linenos">605</span></a>
</span><span id="S3Task.run-606"><a href="#S3Task.run-606"><span class="linenos">606</span></a>        <span class="c1"># make sure a structure was given if it&#39;s required</span>
</span><span id="S3Task.run-607"><a href="#S3Task.run-607"><span class="linenos">607</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_structure</span><span class="p">:</span>
</span><span id="S3Task.run-608"><a href="#S3Task.run-608"><span class="linenos">608</span></a>            <span class="k">raise</span> <span class="n">StructureRequiredError</span><span class="p">(</span><span class="s2">&quot;a structure is required as an input&quot;</span><span class="p">)</span>
</span><span id="S3Task.run-609"><a href="#S3Task.run-609"><span class="linenos">609</span></a>        <span class="c1"># establish the working directory</span>
</span><span id="S3Task.run-610"><a href="#S3Task.run-610"><span class="linenos">610</span></a>        <span class="n">directory</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.run-611"><a href="#S3Task.run-611"><span class="linenos">611</span></a>
</span><span id="S3Task.run-612"><a href="#S3Task.run-612"><span class="linenos">612</span></a>        <span class="c1"># run the setup stage of the task</span>
</span><span id="S3Task.run-613"><a href="#S3Task.run-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="S3Task.run-614"><a href="#S3Task.run-614"><span class="linenos">614</span></a>
</span><span id="S3Task.run-615"><a href="#S3Task.run-615"><span class="linenos">615</span></a>        <span class="c1"># run the shelltask and error supervision stages. This method returns</span>
</span><span id="S3Task.run-616"><a href="#S3Task.run-616"><span class="linenos">616</span></a>        <span class="c1"># a list of any corrections applied during the run.</span>
</span><span id="S3Task.run-617"><a href="#S3Task.run-617"><span class="linenos">617</span></a>        <span class="n">corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="S3Task.run-618"><a href="#S3Task.run-618"><span class="linenos">618</span></a>
</span><span id="S3Task.run-619"><a href="#S3Task.run-619"><span class="linenos">619</span></a>        <span class="c1"># run the workup stage of the task. This is where the data/info is pull</span>
</span><span id="S3Task.run-620"><a href="#S3Task.run-620"><span class="linenos">620</span></a>        <span class="c1"># out from the calculation and is thus our &quot;result&quot;.</span>
</span><span id="S3Task.run-621"><a href="#S3Task.run-621"><span class="linenos">621</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workup</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.run-622"><a href="#S3Task.run-622"><span class="linenos">622</span></a>
</span><span id="S3Task.run-623"><a href="#S3Task.run-623"><span class="linenos">623</span></a>        <span class="c1"># if requested, compresses the directory to a zip file and then removes</span>
</span><span id="S3Task.run-624"><a href="#S3Task.run-624"><span class="linenos">624</span></a>        <span class="c1"># the directory.</span>
</span><span id="S3Task.run-625"><a href="#S3Task.run-625"><span class="linenos">625</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_output</span><span class="p">:</span>
</span><span id="S3Task.run-626"><a href="#S3Task.run-626"><span class="linenos">626</span></a>            <span class="n">make_archive</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="S3Task.run-627"><a href="#S3Task.run-627"><span class="linenos">627</span></a>        <span class="c1"># Return our final information as a dictionary</span>
</span><span id="S3Task.run-628"><a href="#S3Task.run-628"><span class="linenos">628</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="S3Task.run-629"><a href="#S3Task.run-629"><span class="linenos">629</span></a>            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
</span><span id="S3Task.run-630"><a href="#S3Task.run-630"><span class="linenos">630</span></a>            <span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="n">corrections</span><span class="p">,</span>
</span><span id="S3Task.run-631"><a href="#S3Task.run-631"><span class="linenos">631</span></a>            <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
</span><span id="S3Task.run-632"><a href="#S3Task.run-632"><span class="linenos">632</span></a>            <span class="s2">&quot;prefect_flow_run_id&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">flow_run_id</span>
</span><span id="S3Task.run-633"><a href="#S3Task.run-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;flow_run_id&quot;</span><span class="p">)</span>
</span><span id="S3Task.run-634"><a href="#S3Task.run-634"><span class="linenos">634</span></a>            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># when not ran within a prefect flow, there won&#39;t be an id</span>
</span><span id="S3Task.run-635"><a href="#S3Task.run-635"><span class="linenos">635</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Runs the entire staged task (setup, execution, workup), which includes
supervising during execution.</p>

<p>Call this method once you have your task initialized. For each run you
can provide a new structure, directory, or command. For example,</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">simmate.calculator.example.tasks</span> <span class="kn">import</span> <span class="n">ExampleTask</span>

<span class="n">my_task</span> <span class="o">=</span> <span class="n">ExampleTask</span><span class="p">()</span>
<span class="n">my_result</span> <span class="o">=</span> <span class="n">my_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">my_structure</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">my_command</span><span class="p">)</span>
</code></pre></div>

<h4 id="parameters">Parameters</h4>

<ul>
<li><code>structure</code>:
The structure to use for the task, if one is required.</li>
<li><code><a href="#S3Task.command">command</a></code>:
The command that will be called during execution.</li>
<li><code>directory</code>:
The directory to run everything in. This is passed to the ulitities
function simmate.ulitities.get_directory</li>
<li><code>**kwargs</code>:
Any extra keywords that should be passed to the setup() method.</li>
</ul>

<h2 id="returns">Returns</h2>

<ul>
<li>a dictionary of the result, corrections, and working directory used
for this task run</li>
</ul>
</div>


                            </div>
                            <div id="S3Task.get_config" class="classattr">
                                        <input id="S3Task.get_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">get_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span>)</span>

                <label class="view-source-button" for="S3Task.get_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.get_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.get_config-637"><a href="#S3Task.get_config-637"><span class="linenos">637</span></a>    <span class="nd">@classmethod</span>
</span><span id="S3Task.get_config-638"><a href="#S3Task.get_config-638"><span class="linenos">638</span></a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="S3Task.get_config-639"><a href="#S3Task.get_config-639"><span class="linenos">639</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.get_config-640"><a href="#S3Task.get_config-640"><span class="linenos">640</span></a><span class="sd">        Grabs the overall settings from the class.</span>
</span><span id="S3Task.get_config-641"><a href="#S3Task.get_config-641"><span class="linenos">641</span></a>
</span><span id="S3Task.get_config-642"><a href="#S3Task.get_config-642"><span class="linenos">642</span></a><span class="sd">        By default, this will just grab the class&#39;s __dict__ attribute but this</span>
</span><span id="S3Task.get_config-643"><a href="#S3Task.get_config-643"><span class="linenos">643</span></a><span class="sd">        can be overwritten to show only relevent information.</span>
</span><span id="S3Task.get_config-644"><a href="#S3Task.get_config-644"><span class="linenos">644</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.get_config-645"><a href="#S3Task.get_config-645"><span class="linenos">645</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Grabs the overall settings from the class.</p>

<p>By default, this will just grab the class's __dict__ attribute but this
can be overwritten to show only relevent information.</p>
</div>


                            </div>
                            <div id="S3Task.print_config" class="classattr">
                                        <input id="S3Task.print_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">print_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span>)</span>

                <label class="view-source-button" for="S3Task.print_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#S3Task.print_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="S3Task.print_config-647"><a href="#S3Task.print_config-647"><span class="linenos">647</span></a>    <span class="nd">@classmethod</span>
</span><span id="S3Task.print_config-648"><a href="#S3Task.print_config-648"><span class="linenos">648</span></a>    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="S3Task.print_config-649"><a href="#S3Task.print_config-649"><span class="linenos">649</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="S3Task.print_config-650"><a href="#S3Task.print_config-650"><span class="linenos">650</span></a><span class="sd">        Takes the result of get_config and prints it in a yaml format that is</span>
</span><span id="S3Task.print_config-651"><a href="#S3Task.print_config-651"><span class="linenos">651</span></a><span class="sd">        easier to read.</span>
</span><span id="S3Task.print_config-652"><a href="#S3Task.print_config-652"><span class="linenos">652</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="S3Task.print_config-653"><a href="#S3Task.print_config-653"><span class="linenos">653</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
</span><span id="S3Task.print_config-654"><a href="#S3Task.print_config-654"><span class="linenos">654</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Takes the result of get_config and prints it in a yaml format that is
easier to read.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>prefect.core.task.Task</dt>
                                <dd id="S3Task.copy" class="function">copy</dd>
                <dd id="S3Task.bind" class="function">bind</dd>
                <dd id="S3Task.map" class="function">map</dd>
                <dd id="S3Task.set_dependencies" class="function">set_dependencies</dd>
                <dd id="S3Task.set_upstream" class="function">set_upstream</dd>
                <dd id="S3Task.set_downstream" class="function">set_downstream</dd>
                <dd id="S3Task.inputs" class="function">inputs</dd>
                <dd id="S3Task.outputs" class="function">outputs</dd>
                <dd id="S3Task.pipe" class="function">pipe</dd>
                <dd id="S3Task.serialize" class="function">serialize</dd>
                <dd id="S3Task.is_equal" class="function">is_equal</dd>
                <dd id="S3Task.is_not_equal" class="function">is_not_equal</dd>
                <dd id="S3Task.not_" class="function">not_</dd>
                <dd id="S3Task.or_" class="function">or_</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MaxCorrectionsError">
                            <input id="MaxCorrectionsError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MaxCorrectionsError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="MaxCorrectionsError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MaxCorrectionsError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MaxCorrectionsError-660"><a href="#MaxCorrectionsError-660"><span class="linenos">660</span></a><span class="k">class</span> <span class="nc">MaxCorrectionsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="MaxCorrectionsError-661"><a href="#MaxCorrectionsError-661"><span class="linenos">661</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="MaxCorrectionsError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="MaxCorrectionsError.with_traceback" class="function">with_traceback</dd>
                <dd id="MaxCorrectionsError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="NonZeroExitError">
                            <input id="NonZeroExitError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NonZeroExitError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="NonZeroExitError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NonZeroExitError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NonZeroExitError-664"><a href="#NonZeroExitError-664"><span class="linenos">664</span></a><span class="k">class</span> <span class="nc">NonZeroExitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="NonZeroExitError-665"><a href="#NonZeroExitError-665"><span class="linenos">665</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="NonZeroExitError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="NonZeroExitError.with_traceback" class="function">with_traceback</dd>
                <dd id="NonZeroExitError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="StructureRequiredError">
                            <input id="StructureRequiredError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StructureRequiredError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="StructureRequiredError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StructureRequiredError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StructureRequiredError-668"><a href="#StructureRequiredError-668"><span class="linenos">668</span></a><span class="k">class</span> <span class="nc">StructureRequiredError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="StructureRequiredError-669"><a href="#StructureRequiredError-669"><span class="linenos">669</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="StructureRequiredError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="StructureRequiredError.with_traceback" class="function">with_traceback</dd>
                <dd id="StructureRequiredError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>